<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 科學文本斷詞系統 | Science Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        researcher: { light: '#e9d5ff', DEFAULT: '#a855f7', dark: '#7e22ce' },
                        glass: {
                            100: 'rgba(255, 255, 255, 0.1)',
                            200: 'rgba(255, 255, 255, 0.2)',
                            700: 'rgba(255, 255, 255, 0.7)',
                            900: 'rgba(255, 255, 255, 0.9)',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', "Segoe UI", 'Roboto', "Helvetica Neue", 'Arial', 'sans-serif'],
                        mono: ['JetBrains Mono', 'Menlo', 'Monaco', 'Courier New', 'monospace'],
                    },
                    animation: {
                        "fade-in-up": "fadeInUp 0.6s ease-out forwards",
                    },
                    keyframes: {
                        "fadeInUp": {
                            "0%": { opacity: "0", transform: "translateY(20px)" },
                            "100%": { opacity: "1", transform: "translateY(0)" }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* 繼承 Researcher 風格 */
        body { background-color: #f8fafc; color: #334155; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .input-area:focus {
            outline: none;
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.15);
        }
        
        .title-3d {
            background: linear-gradient(135deg, #581c87 0%, #7e22ce 50%, #a855f7 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: drop-shadow(1px 1px 0px rgba(168, 85, 247, 0.4)) 
                    drop-shadow(3px 3px 0px rgba(88, 28, 135, 0.1));
        }

        /* === 斷詞結果樣式 (流動式文本) === */
        .token-unit {
            display: inline; /* 讓文字自然流動 */
            font-size: 1.15rem;
            line-height: 2;
            white-space: pre-wrap; /* 保留換行 */
        }

        .token-word {
            font-weight: 900; /* 黑粗體 */
            color: #0f172a;   /* 純黑 */
        }

        .token-pos {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            font-weight: 700;
            margin-left: 1px;
        }

        /* 詞性顏色定義 (文字顏色) */
        .pos-n { color: #2563eb; } /* 名詞 - 藍 */
        .pos-v { color: #dc2626; } /* 動詞 - 紅 */
        .pos-a { color: #16a34a; } /* 形容詞 - 綠 */
        .pos-d { color: #d97706; } /* 副詞 - 橘黃 */
        .pos-m { color: #7c3aed; } /* 量詞 - 紫 */
        .pos-o { color: #64748b; } /* 其他 - 灰 */

        /* 統計卡片樣式 */
        .stat-card {
            background: #fff;
            border-radius: 1rem;
            padding: 1.25rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: transform 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
        }
        .stat-title { font-size: 0.875rem; font-weight: 700; color: #64748b; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; }
        .stat-val-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.25rem; }
        .stat-label { font-size: 0.75rem; color: #94a3b8; font-weight: 600; }
        .stat-num { font-size: 1.25rem; font-weight: 800; color: #334155; font-family: 'JetBrains Mono', monospace; }
        .stat-bar-bg { width: 100%; height: 6px; background: #f1f5f9; border-radius: 3px; overflow: hidden; margin-top: 4px; }
        .stat-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease-out; }

        /* 背景動畫 */
        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; overflow: hidden;
            background: linear-gradient(135deg, #fdfbff 0%, #f5f3ff 100%);
        }
        
        select { font-size: 0.95rem; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="canvas-container">
        <canvas id="network-canvas"></canvas>
    </div>

    <!-- 導航列 -->
    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-slate-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer group" onclick="window.location.href='researcher.html'">
                <div class="bg-purple-100 p-2 rounded-xl text-purple-600 transition group-hover:bg-purple-600 group-hover:text-white">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <span class="text-lg font-bold text-slate-700 group-hover:text-purple-700 transition" data-i18n="back_researcher">返回研究中心</span>
            </div>
            <div class="flex items-center space-x-4">
                <select id="language-selector" onchange="changeLanguage()" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block p-2">
                    <option value="zh-TW">繁體中文</option>
                    <option value="en">English</option>
                    <option value="ja">日本語</option>
                    <option value="zh-CN">简体中文</option>
                </select>
                <div class="flex items-center gap-2 px-3 py-1.5 bg-purple-50 text-purple-700 rounded-full text-sm font-bold border border-purple-200">
                    <i class="fa-solid fa-scissors"></i> <span data-i18n="tool_name">AI 科學文本斷詞</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主內容區 -->
    <main class="flex-1 p-6 md:p-10 max-w-7xl mx-auto w-full">
        <div class="animate-fade-in-up space-y-8">
            
            <!-- 標題與說明 -->
            <div class="text-center">
                <h1 class="text-4xl font-black text-slate-800 mb-2 tracking-tight title-3d" data-i18n="page_title">AI 科學文本斷詞系統</h1>
                <p class="text-slate-500 font-medium" data-i18n="page_subtitle">CKIP Standard Segmentation & POS Tagging</p>
            </div>

            <!-- 輸入區塊 -->
            <div class="glass-panel p-8 rounded-[2.5rem] mb-8 border border-white/60">
                <div class="flex justify-between items-center mb-4">
                    <label class="text-lg font-bold text-purple-900 flex items-center gap-2">
                        <i class="fa-regular fa-file-lines"></i> <span data-i18n="label_input">原始文本</span>
                    </label>
                    <div class="flex gap-3">
                        <button onclick="loadDemo()" class="text-xs font-bold text-purple-600 bg-purple-50 hover:bg-purple-100 px-3 py-1.5 rounded-lg transition border border-purple-200">
                            <i class="fa-solid fa-flask mr-1"></i> <span data-i18n="btn_demo">載入範例</span>
                        </button>
                        <button onclick="clearText()" class="text-xs font-bold text-slate-500 bg-slate-50 hover:bg-red-50 hover:text-red-500 px-3 py-1.5 rounded-lg transition border border-slate-200">
                            <i class="fa-solid fa-trash-can mr-1"></i> <span data-i18n="btn_clear">清空</span>
                        </button>
                    </div>
                </div>
                
                <textarea id="inputText" class="input-area w-full h-48 p-5 rounded-2xl border border-slate-200 bg-white/70 text-slate-700 leading-relaxed resize-none mb-6 font-mono text-lg" placeholder="請在此貼上科學文章..."></textarea>

                <div class="flex justify-center">
                    <button id="runBtn" onclick="runSegmentation()" class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-10 py-3.5 rounded-2xl font-bold text-lg shadow-lg hover:shadow-purple-500/30 transition transform active:scale-95 flex items-center gap-2">
                        <i class="fa-solid fa-microchip"></i> <span data-i18n="btn_analyze">開始 AI 斷詞</span>
                    </button>
                </div>
            </div>

            <!-- 結果區 (預設隱藏) -->
            <div id="result-panel" class="hidden animate-fade-in-up">
                
                <!-- 1. 統計儀表板 (新增) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                    <!-- 總計 -->
                    <div class="stat-card border-l-4 border-slate-500">
                        <div class="stat-title"><i class="fa-solid fa-chart-pie"></i> Total</div>
                        <div class="stat-val-row">
                            <span class="stat-label">Tokens</span>
                            <span class="stat-num text-slate-700" id="stat-total-token">0</span>
                        </div>
                        <div class="stat-val-row">
                            <span class="stat-label">Types</span>
                            <span class="stat-num text-slate-500" id="stat-total-type">0</span>
                        </div>
                        <div class="text-xs text-right text-slate-400 mt-1">TTR: <span id="stat-total-ttr">0.00</span></div>
                    </div>
                    <!-- 名詞 -->
                    <div class="stat-card border-l-4 border-blue-500">
                        <div class="stat-title text-blue-600"><span class="w-2 h-2 rounded-full bg-blue-500"></span> Noun (N)</div>
                        <div class="stat-val-row">
                            <span class="stat-label">Tokens</span>
                            <span class="stat-num text-blue-700" id="stat-n-token">0</span>
                        </div>
                        <div class="stat-bar-bg"><div id="bar-n" class="stat-bar-fill bg-blue-500" style="width: 0%"></div></div>
                    </div>
                    <!-- 動詞 -->
                    <div class="stat-card border-l-4 border-red-500">
                        <div class="stat-title text-red-600"><span class="w-2 h-2 rounded-full bg-red-500"></span> Verb (V)</div>
                        <div class="stat-val-row">
                            <span class="stat-label">Tokens</span>
                            <span class="stat-num text-red-700" id="stat-v-token">0</span>
                        </div>
                        <div class="stat-bar-bg"><div id="bar-v" class="stat-bar-fill bg-red-500" style="width: 0%"></div></div>
                    </div>
                    <!-- 形容詞 -->
                    <div class="stat-card border-l-4 border-green-500">
                        <div class="stat-title text-green-600"><span class="w-2 h-2 rounded-full bg-green-500"></span> Adj (A/VH)</div>
                        <div class="stat-val-row">
                            <span class="stat-label">Tokens</span>
                            <span class="stat-num text-green-700" id="stat-a-token">0</span>
                        </div>
                        <div class="stat-bar-bg"><div id="bar-a" class="stat-bar-fill bg-green-500" style="width: 0%"></div></div>
                    </div>
                    <!-- 副詞 -->
                    <div class="stat-card border-l-4 border-amber-500">
                        <div class="stat-title text-amber-600"><span class="w-2 h-2 rounded-full bg-amber-500"></span> Adv (D)</div>
                        <div class="stat-val-row">
                            <span class="stat-label">Tokens</span>
                            <span class="stat-num text-amber-700" id="stat-d-token">0</span>
                        </div>
                        <div class="stat-bar-bg"><div id="bar-d" class="stat-bar-fill bg-amber-500" style="width: 0%"></div></div>
                    </div>
                </div>

                <!-- 2. 斷詞結果面板 -->
                <div class="glass-panel p-8 rounded-[2.5rem] border border-white/60 relative overflow-hidden">
                    
                    <!-- 頂部工具列 -->
                    <div class="flex flex-wrap justify-between items-center mb-6 border-b border-purple-100 pb-4 gap-4">
                        <div class="flex items-center gap-4">
                            <h3 class="text-xl font-bold text-slate-700 flex items-center gap-2">
                                <i class="fa-solid fa-tags text-purple-500"></i> <span data-i18n="result_title">斷詞結果</span>
                            </h3>
                            <!-- 圖例 (文字顏色) -->
                            <div class="hidden md:flex gap-4 text-xs font-bold text-slate-400">
                                <span class="flex items-center gap-1"><span class="text-blue-600">● Noun</span></span>
                                <span class="flex items-center gap-1"><span class="text-red-600">● Verb</span></span>
                                <span class="flex items-center gap-1"><span class="text-green-600">● Adj</span></span>
                                <span class="flex items-center gap-1"><span class="text-amber-600">● Adv</span></span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="copyResult()" class="text-xs font-bold text-slate-500 hover:text-purple-600 border border-slate-200 px-3 py-1.5 rounded-lg transition hover:bg-white flex items-center gap-1">
                                <i class="fa-regular fa-copy"></i> <span data-i18n="btn_copy_text">複製純文字</span>
                            </button>
                            <button onclick="downloadTxt()" class="text-xs font-bold text-slate-500 hover:text-purple-600 border border-slate-200 px-3 py-1.5 rounded-lg transition hover:bg-white flex items-center gap-1">
                                <i class="fa-solid fa-download"></i> <span data-i18n="btn_download">下載 .txt</span>
                            </button>
                        </div>
                    </div>

                    <!-- 載入動畫 -->
                    <div id="loadingState" class="hidden flex flex-col items-center justify-center py-12 text-purple-500">
                        <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4"></i>
                        <span class="font-bold animate-pulse" data-i18n="msg_processing">AI 正在依據科學規則進行斷詞...</span>
                    </div>

                    <!-- 斷詞顯示區 (文字流排版) -->
                    <div id="tokensContainer" class="leading-loose min-h-[200px] p-6 bg-white/60 rounded-3xl border border-slate-100/50 shadow-inner text-lg"></div>

                </div>
            </div>
            
        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl opacity-0 translate-y-10 z-50 transition-all duration-300 pointer-events-none font-bold text-sm flex items-center gap-2">
        <i class="fa-solid fa-check-circle text-green-400"></i> <span id="toast-msg"></span>
    </div>

    <script>
        const apiKey = ""; // API Key will be injected

        // *** 多語系字典 ***
        const translations = {
            "zh-TW": {
                "back_researcher": "返回研究中心", "tool_name": "AI 科學文本斷詞", "page_title": "AI 科學文本斷詞系統", "page_subtitle": "CKIP Standard Segmentation & POS Tagging",
                "label_input": "原始文本", "btn_demo": "載入範例", "btn_clear": "清空", "btn_analyze": "開始 AI 斷詞",
                "result_title": "斷詞結果", "btn_copy_text": "複製純文字", "btn_download": "下載 .txt",
                "msg_processing": "AI 正在依據科學規則進行斷詞...", "msg_input_error": "請先輸入文本", "msg_success": "斷詞完成！", "msg_copied": "已複製結果", "msg_downloaded": "檔案下載中...", "msg_error": "系統繁忙，請稍後再試", "msg_demo_loaded": "範例已載入",
                "demo_text": "光合作用是植物利用葉綠素吸收太陽能，將水和二氧化碳轉化為葡萄糖與氧氣的過程。這個過程不僅為植物本身提供能量，也是地球上絕大多數生命能量的來源。"
            },
            "en": {
                "back_researcher": "Back to Research Center", "tool_name": "AI Tokenizer", "page_title": "Scientific Text Segmentation", "page_subtitle": "CKIP Standard Segmentation & POS Tagging",
                "label_input": "Raw Text", "btn_demo": "Load Demo", "btn_clear": "Clear", "btn_analyze": "Start Segmentation",
                "result_title": "Results", "btn_copy_text": "Copy Text", "btn_download": "Download .txt",
                "msg_processing": "AI is processing based on scientific rules...", "msg_input_error": "Please input text first", "msg_success": "Segmentation Complete!", "msg_copied": "Copied!", "msg_downloaded": "Downloading...", "msg_error": "System Error, try again later", "msg_demo_loaded": "Demo Loaded",
                "demo_text": "Photosynthesis is the process used by plants to convert light energy into chemical energy that can later be released to fuel the organism's activities."
            },
            "ja": {
                "back_researcher": "研究センターへ戻る", "tool_name": "AI 形態素解析", "page_title": "科学テキスト形態素解析", "page_subtitle": "CKIP Standard Segmentation & POS Tagging",
                "label_input": "テキスト入力", "btn_demo": "デモをロード", "btn_clear": "クリア", "btn_analyze": "解析開始",
                "result_title": "解析結果", "btn_copy_text": "テキストをコピー", "btn_download": "ダウンロード .txt",
                "msg_processing": "AIが科学ルールに基づいて解析中...", "msg_input_error": "テキストを入力してください", "msg_success": "解析完了！", "msg_copied": "コピーしました", "msg_downloaded": "ダウンロード中...", "msg_error": "エラーが発生しました", "msg_demo_loaded": "デモデータをロードしました",
                "demo_text": "光合成は、植物が光エネルギーを利用して、水と二酸化炭素をグルコースと酸素に変換するプロセスです。"
            },
            "zh-CN": {
                "back_researcher": "返回研究中心", "tool_name": "AI 科学文本分词", "page_title": "AI 科学文本分词系统", "page_subtitle": "CKIP Standard Segmentation & POS Tagging",
                "label_input": "原始文本", "btn_demo": "载入范例", "btn_clear": "清空", "btn_analyze": "开始 AI 分词",
                "result_title": "分词结果", "btn_copy_text": "复制纯文本", "btn_download": "下载 .txt",
                "msg_processing": "AI 正在依据科学规则进行分词...", "msg_input_error": "请先输入文本", "msg_success": "分词完成！", "msg_copied": "已复制结果", "msg_downloaded": "文件下载中...", "msg_error": "系统繁忙，请稍后再试", "msg_demo_loaded": "范例已载入",
                "demo_text": "光合作用是植物利用叶绿素吸收太阳能，将水和二氧化碳转化为葡萄糖与氧气的过程。这个过程不仅为植物本身提供能量，也是地球上绝大多数生命能量的来源。"
            }
        };

        function getMsg(key) {
            const lang = document.getElementById("language-selector").value;
            return (translations[lang] || translations['zh-TW'])[key] || key;
        }

        function changeLanguage() {
            const lang = document.getElementById("language-selector").value;
            document.querySelectorAll("[data-i18n]").forEach(el => {
                el.innerText = getMsg(el.getAttribute("data-i18n"));
            });
            const input = document.getElementById('inputText');
            if(lang === 'en') input.placeholder = "Paste text here...";
            else input.placeholder = "請在此貼上科學文章...";
        }

        // *** UI 操作 ***
        function loadDemo() {
            const lang = document.getElementById("language-selector").value;
            const t = translations[lang] || translations['zh-TW'];
            document.getElementById('inputText').value = t.demo_text;
            showToast(getMsg('msg_demo_loaded'));
        }

        function clearText() {
            document.getElementById('inputText').value = '';
            document.getElementById('result-panel').classList.add('hidden');
        }

        function showToast(msg, type='normal') {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.querySelector('i').className = type==='error' ? 'fa-solid fa-triangle-exclamation text-red-400' : 'fa-solid fa-check-circle text-green-400';
            t.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(()=>t.classList.add('opacity-0', 'translate-y-10'), 3000);
        }

        // *** Gemini API 核心斷詞邏輯 ***
        async function runSegmentation() {
            const text = document.getElementById('inputText').value.trim();
            if (!text) { showToast(getMsg('msg_input_error'), 'error'); return; }

            const panel = document.getElementById('result-panel');
            const loading = document.getElementById('loadingState');
            const container = document.getElementById('tokensContainer');
            const btn = document.getElementById('runBtn');
            
            panel.classList.remove('hidden');
            loading.classList.remove('hidden');
            container.innerHTML = ''; 
            btn.disabled = true; btn.classList.add('opacity-50');
            
            panel.scrollIntoView({ behavior: 'smooth', block: 'start' });

            // ★ 嚴格斷詞規則 Prompt (完整植入)
            const rules = `
            A. 全域格式規則格式永遠優先：A1. 詞彙間一定要使用全形空格（　），物質(Na)／(FW)就沒有斷詞，是錯誤例子。不論原文本是否換行，詞與詞之間一律使用全形空格分開。如果文本本來就換行，禁止自動合併成單行。A2.不可出現半形空格，若偵測到半形空格，一律自動轉為全形空格。A3.去除符號與異常字元，例如「|」符號全部移除。「(WHITESPACE)」字樣刪除。✓符號移除。節數標記為Neu，例如：1-1(Neu)。餘此類推。A4.你的斷詞與POS要有自我學習的能力，從經歷過或修正過的斷詞中學習以後自動保持一致性。A5.禁止「過度合併」詞彙！！，例如任意將兩個詞彙合併：恢復原狀不應合併，影響平衡狀態(Na)不應合併，產生二氧化碳的(VHC)過度合併了，我發現你愈來愈有過度合併的情況，請改善，餘此類推。每一個詞都要正確標記CKIP的POS，且不要過度合併，逗號與頓號明確區分。A6.「的」後方詞性規則（非常關鍵）：F1.「的」＋動詞 → 後詞一律改標記為名詞（Na）。F2.「的節」必須拆成兩詞：的(DE)　節(Na)。

            B. 固定單詞規則（整組視為單詞，不可再拆）：B1.科學專有名詞（物理、化學、生物、地科、資訊、科技、數學、工程等詞彙均視為單詞），例如：虹吸現象(Na)、自然光(Na)、綠色能源(Na)、再生能源(Na)、可再生能源(Na)、不可再生能源(Na)、發光二極體(Na)、不良導體(Na)、廢電池(Na)、魚鰓(Na)、小馬達(Na)、玩具車(Na)、平板電腦(Na)、完全變態(Na)、不完全變態(Na)、大藍閃蝶(Na)、細縫(Na)、風力風向計(Na)、維他命C(Na)、維他命C錠(Na)、小蘇打粉(Na)、毛細現象(Na)等等。B2. 植物、動物、物品名稱（若為固定名詞，一律合併），例如番薯葉(Na)、臺灣欒樹(Na)、小石頭(Na)、小孩(Na)、小草(Na)（「小」＋名詞 → 單詞）、長春花(Na)（注意：雖原標記 VH，但語義為名詞）、甲端(Na)、乙端(Na)、兩端(Ncd)、兩側(Ncd)等。B3. 地名要合併（如新北市等等）、機關名要合併（如玉山國家公園等等）、特定專有名詞要合併（如巴黎協議、京都議定書等等），未來若出現類似名稱，一律視為單詞。B4. 「XX定律」「XX原理」視為單詞，例如牛頓第二運動定律、連通管原理等等。

            C. 動詞短語與特殊複合詞（視為單詞）：C1.「一顆、一個、一條、一座、一端、一本、一段、一節、一種、一對等等」類似詞彙全部視為單詞。C2. 動作重複詞語，例如試試看、說說看、查查看、想想看、試一試、比一比、跑一跑、跳一跳、說一說、聞一聞、摸一摸、查一查、想一想、連連看等等都視為單詞。C3. 常用語意整體詞，例如：不可以、不一樣、不一致、不相同、不一定、再也(D)、也是、也能、也可以、也會、不是、都會(D)、都能、就要(D)等等都視為單詞。C4.方向/位置詞，例如管內、圖中、地上、樹上、水邊、腳上、門外、土裡、水中、海邊、家裡、壺內、碗底、湯中等等都視為單詞。C5.如果有單詞「成」，前面有動詞，則合併在一起，例如：化合成、轉化成、轉換成、製作而成(VG)等等，餘此類推。C6.語意合併詞，整體視為單詞，例如：才能(D)、還能(D)、就會(D)、直竄(VA)、有些(Vspa)、也能(D)、幾種(Nf)。

            D. 科學語句固定拆分規則：D1.「水能」不是單詞 → 必須拆：水(Na)　能(D)。D2.「走樓梯」必須拆：走(VA)　樓梯(Na)。D3.「拿尺量」要拆成三詞：拿　尺　量。D4.「從　力　的　大小　和　方向　圖中」句法修正成「從　力　的　大小　和　方向　，　圖中　…」、「沒有(VJ)　生命(Na)　的(DE)　是非(Na)　生物(Na)」要斷成「沒有　生命　的　是　非生物」。「具導電性(Na)」應為「具(VC)　導電性(Na)」這些細微語意容易斷錯，要特別注意。

            E. 斷詞一致性（出現一次就永久固定）：任何詞彙，只要在任何一次斷詞中被定義為「單詞」，未來每次都必須以同樣方式斷詞。例如：戶外教學、魚鰓、小馬達、玩具車、平板電腦、番薯葉、小石頭、小孩、小草、甲端、乙端、不良導體、廢電池、記錄者、小白點、刮平(VC)　匙面(Na)、液體量(Na)、一次性(Na)、再製(VH)、櫃子門(Na)、加(VC)　鐵片(Na)、小農夫(Na)、直晒(VC)　太陽(Na)、一次(Nf)、一顆(Nf)、一大片(Nf)、四季(Nd)、紀錄者(Na)、水裡(Ncd)、小烏來瀑布(Na)、海上(Ncd)、高美溼地(Nc)、一張(Nf)、溯溪(VA)、老梅石槽(Na)、拉姆薩溼地公約(Na)、波光粼粼(VH)、冷氣(Na)、都要(D)、也會(D)、都會(D)、二顆(Nf)、正負極(Na)、小石頭(Na)、開車(VA)、太魯閣峽谷(Na)、福隆海水浴場(Nc)、的(DE)　串聯(Na)，「的」後面詞性要是Na、地下(Ncd)、光復國中(Nc)、雪山隧道(Na)、草漯沙丘(Na)、十分瀑布(Na)、雙心石滬(Na)、一片(Nf)、也會(D)、陰陽海(Na)、碳酸飲料(Na)、秤重(VE)、碗底(Ncd)、都是(SHI)、雷射筆(Na)、室外(Ncd)、變高(VH)、色光(Na)、新北市(Nc)、夏至(Nd)、井仔腳鹽田(Na)、冬至(Nd)、找一找(VC)、八大行星(Na)、冬季大三角(Na)、春季大三角(Na)、夏季大三角(Na)、秋季四邊形(Na)、天津四(Na)、雌孔雀(Na)、觀星軟體(Na)、一窺究竟(VA)、一窺究竟(VA)、高度角(Na)、觀測者(Na)、街上(Ncd)、門外(Ncd)、全臺(Nc)、裝水(VC)、高蹺鴴(Na)、榕果小蜂(Na)、下一代(Na)、攀木蜥蜴(Na)、身上(Ncd)、螞蟻窩(Na)、臺灣獼猴(Na)、大杓鷸(Na)、瓶鼻海豚(Na)、攪來攪去(VE)、小碎物(Na)、新生命(Na)、熱空氣(Na)、生存之道(Na)、不一致(VH)、輻射熱(Na)、熱飲(Na)、熱漲冷縮(VH)、小磁鐵、大磁鐵、小車、大車、小樹、大樹、指北端、地磁北極、地磁南極、地理北極、地理南極、單位元(Na)、右下方(Ng)、兩者(Na)、每個(Nesp)、桌下(Ncd)、半個(Nf)、兩極(Na)、靜止不動(VH)、小磁鐵(Na)...等等餘此類推，全部未來皆一致。
            `;

            const prompt = `
            Role: Professional Chinese Tokenizer (CKIP standard).
            Task: Segment the following text into tokens and assign POS tags.
            Input Text: "${text}"
            
            Strictly follow these segmentation rules:
            ${rules}

            Output Format: 
            Return a RAW JSON Array ONLY. No markdown, no code blocks.
            Format: [{"w": "Word", "p": "POS"}, ...]
            POS Tags: N(Noun), V(Verb), A(Adj), D(Adv), M(Measure), P(Prep), C(Conj), O(Other).
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                
                let rawJson = data.candidates[0].content.parts[0].text;
                rawJson = rawJson.replace(/```json/g, '').replace(/```/g, '').trim();
                const tokens = JSON.parse(rawJson);

                renderTokens(tokens);
                showToast(getMsg('msg_success'));

            } catch (error) {
                console.error(error);
                container.innerHTML = `<p class="text-red-500 w-full text-center">${getMsg('msg_error')}: ${error.message}</p>`;
            } finally {
                loading.classList.add('hidden');
                btn.disabled = false; btn.classList.remove('opacity-50');
            }
        }

        function renderTokens(tokens) {
            const container = document.getElementById('tokensContainer');
            window.lastTokens = tokens; 

            // 計算統計數據
            const stats = {
                total: { token: 0, type: new Set() },
                n: { token: 0, type: new Set() },
                v: { token: 0, type: new Set() },
                a: { token: 0, type: new Set() },
                d: { token: 0, type: new Set() }
            };

            tokens.forEach(t => {
                const word = t.w;
                const pos = t.p.toUpperCase();
                const posFirst = pos.charAt(0);

                stats.total.token++;
                stats.total.type.add(word);

                if (posFirst === 'N') {
                    stats.n.token++;
                    stats.n.type.add(word);
                } else if (posFirst === 'V') {
                    stats.v.token++;
                    stats.v.type.add(word);
                } else if (posFirst === 'A' || pos === 'VH' || pos === 'VS') { // 寬鬆形容詞
                    stats.a.token++;
                    stats.a.type.add(word);
                } else if (posFirst === 'D' || pos === 'DE') { // 寬鬆副詞/的
                    stats.d.token++;
                    stats.d.type.add(word);
                }
            });

            // 更新統計 UI
            const updateStatUI = (idSuffix, data) => {
                document.getElementById(`stat-${idSuffix}-token`).innerText = data.token;
                if (document.getElementById(`stat-${idSuffix}-type`)) {
                     document.getElementById(`stat-${idSuffix}-type`).innerText = data.type.size;
                }
                // 更新進度條 (相對於總 Token)
                const bar = document.getElementById(`bar-${idSuffix}`);
                if (bar && stats.total.token > 0) {
                    const pct = (data.token / stats.total.token) * 100;
                    bar.style.width = `${pct}%`;
                }
            };

            updateStatUI('total', stats.total);
            updateStatUI('n', stats.n);
            updateStatUI('v', stats.v);
            updateStatUI('a', stats.a);
            updateStatUI('d', stats.d);

            // 計算 TTR
            const ttr = stats.total.token > 0 ? (stats.total.type.size / stats.total.token).toFixed(2) : "0.00";
            document.getElementById('stat-total-ttr').innerText = ttr;

            // 渲染斷詞文本 (流動式)
            tokens.forEach((t, index) => {
                const span = document.createElement('span');
                span.className = 'token-unit';

                const pUpper = t.p.toUpperCase();
                let colorClass = 'pos-o'; 
                if (pUpper.startsWith('N')) colorClass = 'pos-n';
                else if (pUpper.startsWith('V')) colorClass = 'pos-v';
                else if (pUpper.startsWith('A') || pUpper === 'VH' || pUpper === 'VS') colorClass = 'pos-a';
                else if (pUpper.startsWith('D') || pUpper === 'DE') colorClass = 'pos-d';
                else if (pUpper === 'M' || pUpper === 'NF') colorClass = 'pos-m';
                else if (pUpper.startsWith('P') || pUpper.startsWith('C')) colorClass = 'pos-m';
                
                span.innerHTML = `<span class="token-word">${t.w}</span><span class="token-pos ${colorClass}">(${t.p})</span>`;
                container.appendChild(span);

                if (index < tokens.length - 1) {
                    const space = document.createTextNode('　');
                    container.appendChild(space);
                }
            });

            document.getElementById('result-panel').classList.remove('hidden');
        }

        function formatResultText() {
            if (!window.lastTokens) return "";
            return window.lastTokens.map(t => `${t.w}(${t.p})`).join('　');
        }

        function copyResult() {
            const text = formatResultText();
            if (!text) return;
            navigator.clipboard.writeText(text);
            showToast(getMsg('msg_copied'));
        }

        function downloadTxt() {
            const text = formatResultText();
            if (!text) return;
            
            const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `segmentation_result_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(getMsg('msg_downloaded'));
        }

        // *** Background ***
        (function() {
            const canvas = document.getElementById('network-canvas');
            const ctx = canvas.getContext('2d');
            let width, height, particles = [];
            function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; initParticles(); }
            class Particle {
                constructor() { this.x = Math.random() * width; this.y = Math.random() * height; this.vx = (Math.random()-0.5)*0.5; this.vy = (Math.random()-0.5)*0.5; this.size = Math.random()*2+1; this.color = `rgba(168, 85, 247, ${Math.random()*0.4})`; }
                update() { this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>width)this.vx*=-1; if(this.y<0||this.y>height)this.vy*=-1; }
                draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fillStyle=this.color; ctx.fill(); }
            }
            function initParticles() { particles=[]; for(let i=0;i<50;i++) particles.push(new Particle()); }
            function animate() {
                ctx.clearRect(0, 0, width, height);
                particles.forEach(p => { p.update(); p.draw(); });
                for(let i=0;i<particles.length;i++){
                    for(let j=i;j<particles.length;j++){
                        const dx = particles[i].x - particles[j].x; const dy = particles[i].y - particles[j].y;
                        const dist = Math.sqrt(dx*dx+dy*dy);
                        if(dist<150){ ctx.beginPath(); ctx.strokeStyle=`rgba(168,85,247,${0.08 - dist/2000})`; ctx.lineWidth=0.5; ctx.moveTo(particles[i].x,particles[i].y); ctx.lineTo(particles[j].x,particles[j].y); ctx.stroke(); }
                    }
                }
                requestAnimationFrame(animate);
            }
            window.addEventListener('resize', resize); resize(); animate();
        })();
    </script>
</body>
</html>
