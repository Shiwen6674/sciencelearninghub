<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 科學文本斷詞系統 | Science Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        researcher: { light: '#e9d5ff', DEFAULT: '#a855f7', dark: '#7e22ce' },
                        glass: {
                            100: 'rgba(255, 255, 255, 0.1)',
                            200: 'rgba(255, 255, 255, 0.2)',
                            700: 'rgba(255, 255, 255, 0.7)',
                            900: 'rgba(255, 255, 255, 0.9)',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', "Segoe UI", 'Roboto', "Helvetica Neue", 'Arial', 'sans-serif'],
                        mono: ['JetBrains Mono', 'Menlo', 'Monaco', 'Courier New', 'monospace'],
                    },
                    animation: {
                        "fade-in-up": "fadeInUp 0.6s ease-out forwards",
                    },
                    keyframes: {
                        "fadeInUp": {
                            "0%": { opacity: "0", transform: "translateY(20px)" },
                            "100%": { opacity: "1", transform: "translateY(0)" }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* 繼承 Researcher 風格 */
        body { background-color: #f8fafc; color: #334155; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .input-area:focus {
            outline: none;
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.15);
        }
        
        .title-3d {
            background: linear-gradient(135deg, #581c87 0%, #7e22ce 50%, #a855f7 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: drop-shadow(1px 1px 0px rgba(168, 85, 247, 0.4)) 
                    drop-shadow(3px 3px 0px rgba(88, 28, 135, 0.1));
        }

        /* === 斷詞結果樣式 (流動式文本) === */
        .token-unit {
            display: inline; /* 讓文字自然流動 */
            font-size: 1.15rem;
            line-height: 2;
            white-space: pre-wrap; /* 保留換行 */
        }

        .token-word {
            font-weight: 900; /* 黑粗體 */
            color: #0f172a;   /* 純黑 */
        }

        .token-pos {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            font-weight: 700;
            margin-left: 1px;
        }

        /* 詞性顏色定義 (文字顏色) */
        .pos-n { color: #2563eb; } /* 名詞 - 藍 */
        .pos-v { color: #dc2626; } /* 動詞 - 紅 */
        .pos-a { color: #16a34a; } /* 形容詞 - 綠 */
        .pos-d { color: #d97706; } /* 副詞 - 橘黃 */
        .pos-m { color: #7c3aed; } /* 量詞 - 紫 */
        .pos-o { color: #64748b; } /* 其他 - 灰 */

        /* 統計卡片樣式 */
        .stat-card {
            background: #fff;
            border-radius: 1rem;
            padding: 1.25rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: transform 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
        }
        .stat-title { font-size: 0.875rem; font-weight: 700; color: #64748b; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; }
        .stat-val-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.25rem; }
        .stat-label { font-size: 0.75rem; color: #94a3b8; font-weight: 600; }
        .stat-num { font-size: 1.25rem; font-weight: 800; color: #334155; font-family: 'JetBrains Mono', monospace; }
        .stat-bar-bg { width: 100%; height: 6px; background: #f1f5f9; border-radius: 3px; overflow: hidden; margin-top: 4px; }
        .stat-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease-out; }

        /* 背景動畫 */
        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; overflow: hidden;
            background: linear-gradient(135deg, #fdfbff 0%, #f5f3ff 100%);
        }
        
        select { font-size: 0.95rem; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="canvas-container">
        <canvas id="network-canvas"></canvas>
    </div>

    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-slate-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer group" onclick="window.location.href='researcher.html'">
                <div class="bg-purple-100 p-2 rounded-xl text-purple-600 transition group-hover:bg-purple-600 group-hover:text-white">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <span class="text-lg font-bold text-slate-700 group-hover:text-purple-700 transition" data-i18n="back_researcher">返回研究中心</span>
            </div>
            <div class="flex items-center space-x-4">
                <select id="language-selector" onchange="changeLanguage()" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block p-2">
                    <option value="zh-TW">繁體中文</option>
                    <option value="en">English</option>
                    <option value="ja">日本語</option>
                    <option value="zh-CN">简体中文</option>
                </select>
                <div class="flex items-center gap-2 px-3 py-1.5 bg-purple-50 text-purple-700 rounded-full text-sm font-bold border border-purple-200">
                    <i class="fa-solid fa-scissors"></i> <span data-i18n="tool_name">AI 科學文本斷詞</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-1 p-6 md:p-10 max-w-7xl mx-auto w-full">
        <div class="animate-fade-in-up space-y-8">
            
            <div class="text-center">
                <h1 class="text-4xl font-black text-slate-800 mb-2 tracking-tight title-3d" data-i18n="page_title">AI 科學文本斷詞系統</h1>
                <p class="text-slate-500 font-medium" data-i18n="page_subtitle">CKIP Standard Segmentation & POS Tagging</p>
            </div>

            <div class="glass-panel p-8 rounded-[2.5rem] mb-8 border border-white/60">
                <div class="flex justify-between items-center mb-4">
                    <label class="text-lg font-bold text-purple-900 flex items-center gap-2">
                        <i class="fa-regular fa-file-lines"></i> <span data-i18n="label_input">原始文本</span>
                    </label>
                    <div class="flex gap-3">
                        <button onclick="loadDemo()" class="text-xs font-bold text-purple-600 bg-purple-50 hover:bg-purple-100 px-3 py-1.5 rounded-lg transition border border-purple-200">
                            <i class="fa-solid fa-flask mr-1"></i> <span data-i18n="btn_demo">載入範例</span>
                        </button>
                        <button onclick="clearText()" class="text-xs font-bold text-slate-500 bg-slate-50 hover:bg-red-50 hover:text-red-500 px-3 py-1.5 rounded-lg transition border border-slate-200">
                            <i class="fa-solid fa-trash-can mr-1"></i> <span data-i18n="btn_clear">清空</span>
                        </button>
                    </div>
                </div>
                
                <textarea id="inputText" class="input-area w-full h-48 p-5 rounded-2xl border border-slate-200 bg-white/70 text-slate-700 leading-relaxed resize-none mb-6 font-mono text-lg" placeholder="請在此貼上科學文章..."></textarea>

                <div class="flex justify-center">
                    <button id="runBtn" onclick="runSegmentation()" class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-10 py-3.5 rounded-2xl font-bold text-lg shadow-lg hover:shadow-purple-500/30 transition transform active:scale-95 flex items-center gap-2">
                        <i class="fa-solid fa-microchip"></i> <span data-i18n="btn_analyze">開始 AI 斷詞</span>
                    </button>
                </div>
            </div>

            <div id="result-panel" class="hidden animate-fade-in-up">
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                    <div class="stat-card border-l-4 border-slate-500">
                        <div class="stat-title"><i class="fa-solid fa-chart-pie"></i> Total</div>
                        <div class="stat-val-row">
                            <span class="stat-label">Tokens</span>
                            <span class="stat-num text-slate-700" id="stat-total-token">0</span>
                        </div>
                        <div class="stat-val-row">
                            <span class="stat-label">Types</span>
                            <span class="stat-num text-slate-500" id="stat-total-type">0</span>
                        </div>
                        <div class="text-xs text-right text-slate-400 mt-1">TTR: <span id="stat-total-ttr">0.00</span></div>
                    </div>
                    <div class="stat-card border-l-4 border-blue-500">
                        <div class="stat-title text-blue-600"><span class="w-2 h-2 rounded-full bg-blue-500"></span> Noun (N)</div>
                        <div class="stat-val-row">
                            <span class="stat-label">Tokens</span>
                            <span class="stat-num text-blue-700" id="stat-n-token">0</span>
                        </div>
                        <div class="stat-bar-bg"><div id="bar-n" class="stat-bar-fill bg-blue-500" style="width: 0%"></div></div>
                    </div>
                    <div class="stat-card border-l-4 border-red-500">
                        <div class="stat-title text-red-600"><span class="w-2 h-2 rounded-full bg-red-500"></span> Verb (V)</div>
                        <div class="stat-val-row">
                            <span class="stat-label">Tokens</span>
                            <span class="stat-num text-red-700" id="stat-v-token">0</span>
                        </div>
                        <div class="stat-bar-bg"><div id="bar-v" class="stat-bar-fill bg-red-500" style="width: 0%"></div></div>
                    </div>
                    <div class="stat-card border-l-4 border-green-500">
                        <div class="stat-title text-green-600"><span class="w-2 h-2 rounded-full bg-green-500"></span> Adj (A/VH)</div>
                        <div class="stat-val-row">
                            <span class="stat-label">Tokens</span>
                            <span class="stat-num text-green-700" id="stat-a-token">0</span>
                        </div>
                        <div class="stat-bar-bg"><div id="bar-a" class="stat-bar-fill bg-green-500" style="width: 0%"></div></div>
                    </div>
                    <div class="stat-card border-l-4 border-amber-500">
                        <div class="stat-title text-amber-600"><span class="w-2 h-2 rounded-full bg-amber-500"></span> Adv (D)</div>
                        <div class="stat-val-row">
                            <span class="stat-label">Tokens</span>
                            <span class="stat-num text-amber-700" id="stat-d-token">0</span>
                        </div>
                        <div class="stat-bar-bg"><div id="bar-d" class="stat-bar-fill bg-amber-500" style="width: 0%"></div></div>
                    </div>
                </div>

                <div class="glass-panel p-8 rounded-[2.5rem] border border-white/60 relative overflow-hidden">
                    
                    <div class="flex flex-wrap justify-between items-center mb-6 border-b border-purple-100 pb-4 gap-4">
                        <div class="flex items-center gap-4">
                            <h3 class="text-xl font-bold text-slate-700 flex items-center gap-2">
                                <i class="fa-solid fa-tags text-purple-500"></i> <span data-i18n="result_title">斷詞結果</span>
                            </h3>
                            <div class="hidden md:flex gap-4 text-xs font-bold text-slate-400">
                                <span class="flex items-center gap-1"><span class="text-blue-600">● Noun</span></span>
                                <span class="flex items-center gap-1"><span class="text-red-600">● Verb</span></span>
                                <span class="flex items-center gap-1"><span class="text-green-600">● Adj</span></span>
                                <span class="flex items-center gap-1"><span class="text-amber-600">● Adv</span></span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="copyResult()" class="text-xs font-bold text-slate-500 hover:text-purple-600 border border-slate-200 px-3 py-1.5 rounded-lg transition hover:bg-white flex items-center gap-1">
                                <i class="fa-regular fa-copy"></i> <span data-i18n="btn_copy_text">複製純文字</span>
                            </button>
                            <button onclick="downloadTxt()" class="text-xs font-bold text-slate-500 hover:text-purple-600 border border-slate-200 px-3 py-1.5 rounded-lg transition hover:bg-white flex items-center gap-1">
                                <i class="fa-solid fa-download"></i> <span data-i18n="btn_download">下載 .txt</span>
                            </button>
                        </div>
                    </div>

                    <div id="loadingState" class="hidden flex flex-col items-center justify-center py-12 text-purple-500">
                        <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4"></i>
                        <span class="font-bold animate-pulse" data-i18n="msg_processing">AI 正在依據科學規則進行斷詞...</span>
                    </div>

                    <div id="tokensContainer" class="leading-loose min-h-[200px] p-6 bg-white/60 rounded-3xl border border-slate-100/50 shadow-inner text-lg"></div>

                </div>
            </div>
            
        </div>
    </main>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl opacity-0 translate-y-10 z-50 transition-all duration-300 pointer-events-none font-bold text-sm flex items-center gap-2">
        <i class="fa-solid fa-check-circle text-green-400"></i> <span id="toast-msg"></span>
    </div>

    <script>
        // *** 設定 GAS API 網址 (請填入部署後的網址) ***
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxt_6RXtT2DklrwLO7g2jQ4LnfTDEvpS1jQ-f4gRf-N_QOwBzT1_SfaDf1CPNBtZ1Z5Yg/exec"; 

        // *** 多語系字典 ***
        const translations = {
            "zh-TW": {
                "back_researcher": "返回研究中心", "tool_name": "AI 科學文本斷詞", "page_title": "AI 科學文本斷詞系統", "page_subtitle": "CKIP Standard Segmentation & POS Tagging",
                "label_input": "原始文本", "btn_demo": "載入範例", "btn_clear": "清空", "btn_analyze": "開始 AI 斷詞",
                "result_title": "斷詞結果", "btn_copy_text": "複製純文字", "btn_download": "下載 .txt",
                "msg_processing": "AI 正在依據科學規則進行斷詞...", "msg_input_error": "請先輸入文本", "msg_success": "斷詞完成！", "msg_copied": "已複製結果", "msg_downloaded": "檔案下載中...", "msg_error": "系統繁忙，請稍後再試", "msg_demo_loaded": "範例已載入",
                "demo_text": "光合作用是植物利用葉綠素吸收太陽能，將水和二氧化碳轉化為葡萄糖與氧氣的過程。這個過程不僅為植物本身提供能量，也是地球上絕大多數生命能量的來源。"
            },
            "en": {
                "back_researcher": "Back to Research Center", "tool_name": "AI Tokenizer", "page_title": "Scientific Text Segmentation", "page_subtitle": "CKIP Standard Segmentation & POS Tagging",
                "label_input": "Raw Text", "btn_demo": "Load Demo", "btn_clear": "Clear", "btn_analyze": "Start Segmentation",
                "result_title": "Results", "btn_copy_text": "Copy Text", "btn_download": "Download .txt",
                "msg_processing": "AI is processing based on scientific rules...", "msg_input_error": "Please input text first", "msg_success": "Segmentation Complete!", "msg_copied": "Copied!", "msg_downloaded": "Downloading...", "msg_error": "System Error, try again later", "msg_demo_loaded": "Demo Loaded",
                "demo_text": "Photosynthesis is the process used by plants to convert light energy into chemical energy that can later be released to fuel the organism's activities."
            },
            "ja": {
                "back_researcher": "研究センターへ戻る", "tool_name": "AI 形態素解析", "page_title": "科学テキスト形態素解析", "page_subtitle": "CKIP Standard Segmentation & POS Tagging",
                "label_input": "テキスト入力", "btn_demo": "デモをロード", "btn_clear": "クリア", "btn_analyze": "解析開始",
                "result_title": "解析結果", "btn_copy_text": "テキストをコピー", "btn_download": "ダウンロード .txt",
                "msg_processing": "AIが科学ルールに基づいて解析中...", "msg_input_error": "テキストを入力してください", "msg_success": "解析完了！", "msg_copied": "コピーしました", "msg_downloaded": "ダウンロード中...", "msg_error": "エラーが発生しました", "msg_demo_loaded": "デモデータをロードしました",
                "demo_text": "光合成は、植物が光エネルギーを利用して、水と二酸化炭素をグルコースと酸素に変換するプロセスです。"
            },
            "zh-CN": {
                "back_researcher": "返回研究中心", "tool_name": "AI 科学文本分词", "page_title": "AI 科学文本分词系统", "page_subtitle": "CKIP Standard Segmentation & POS Tagging",
                "label_input": "原始文本", "btn_demo": "载入范例", "btn_clear": "清空", "btn_analyze": "开始 AI 分词",
                "result_title": "分词结果", "btn_copy_text": "复制纯文本", "btn_download": "下载 .txt",
                "msg_processing": "AI 正在依据科学规则进行分词...", "msg_input_error": "请先输入文本", "msg_success": "分词完成！", "msg_copied": "已复制结果", "msg_downloaded": "文件下载中...", "msg_error": "系统繁忙，请稍后再试", "msg_demo_loaded": "范例已载入",
                "demo_text": "光合作用是植物利用叶绿素吸收太阳能，将水和二氧化碳转化为葡萄糖与氧气的过程。这个过程不仅为植物本身提供能量，也是地球上绝大多数生命能量的来源。"
            }
        };

        function getMsg(key) {
            const lang = document.getElementById("language-selector").value;
            return (translations[lang] || translations['zh-TW'])[key] || key;
        }

        function changeLanguage() {
            const lang = document.getElementById("language-selector").value;
            document.querySelectorAll("[data-i18n]").forEach(el => {
                el.innerText = getMsg(el.getAttribute("data-i18n"));
            });
            const input = document.getElementById('inputText');
            if(lang === 'en') input.placeholder = "Paste text here...";
            else input.placeholder = "請在此貼上科學文章...";
        }

        // *** UI 操作 ***
        function loadDemo() {
            const lang = document.getElementById("language-selector").value;
            const t = translations[lang] || translations['zh-TW'];
            document.getElementById('inputText').value = t.demo_text;
            showToast(getMsg('msg_demo_loaded'));
        }

        function clearText() {
            document.getElementById('inputText').value = '';
            document.getElementById('result-panel').classList.add('hidden');
        }

        function showToast(msg, type='normal') {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.querySelector('i').className = type==='error' ? 'fa-solid fa-triangle-exclamation text-red-400' : 'fa-solid fa-check-circle text-green-400';
            t.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(()=>t.classList.add('opacity-0', 'translate-y-10'), 3000);
        }

        // *** 核心：呼叫 GAS API 進行斷詞 ***
        async function runSegmentation() {
            const text = document.getElementById('inputText').value.trim();
            if (!text) { showToast(getMsg('msg_input_error'), 'error'); return; }

            // 檢查是否已填入部署網址
            if (!GAS_API_URL || GAS_API_URL.includes("在此填入")) {
                showToast("請先在 HTML 程式碼中填入 GAS 部署網址", 'error');
                return;
            }

            const panel = document.getElementById('result-panel');
            const loading = document.getElementById('loadingState');
            const container = document.getElementById('tokensContainer');
            const btn = document.getElementById('runBtn');
            
            panel.classList.remove('hidden');
            loading.classList.remove('hidden');
            container.innerHTML = ''; 
            btn.disabled = true; btn.classList.add('opacity-50');
            
            panel.scrollIntoView({ behavior: 'smooth', block: 'start' });

            try {
                // 發送 POST 請求給 GAS
                const response = await fetch(GAS_API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=utf-8" }, // 避免 CORS 預檢
                    body: JSON.stringify({ text: text })
                });

                const data = await response.json();

                if (data.status === "success") {
                    // GAS 回傳的是斷詞好的字串 (例: "測試(Na)　一下(D)")
                    // 我們需要把它轉換成物件陣列 [{w:"測試", p:"Na"}, ...] 以便渲染
                    const tokens = parseStringTokens(data.result);
                    renderTokens(tokens);
                    showToast(getMsg('msg_success'));
                } else {
                    throw new Error(data.message || "Unknown Error");
                }

            } catch (error) {
                console.error(error);
                container.innerHTML = `<p class="text-red-500 w-full text-center">${getMsg('msg_error')}: ${error.message}</p>`;
            } finally {
                loading.classList.add('hidden');
                btn.disabled = false; btn.classList.remove('opacity-50');
            }
        }

        // 輔助函式：將斷詞後的字串解析為 Token 物件
        function parseStringTokens(textString) {
            if(!textString) return [];
            // 用全形空格切割
            const parts = textString.split(/　/); 
            return parts.map(p => {
                // 抓取括號內的詞性，例如 "科學(Na)"
                const match = p.match(/^(.*)\((.*)\)$/);
                if (match) {
                    return { w: match[1], p: match[2] };
                }
                // 如果解析失敗，回傳原字並標記為其他
                if (p.trim() !== "") return { w: p, p: "O" };
                return null;
            }).filter(t => t !== null);
        }

        function renderTokens(tokens) {
            const container = document.getElementById('tokensContainer');
            window.lastTokens = tokens; 

            // 計算統計數據
            const stats = {
                total: { token: 0, type: new Set() },
                n: { token: 0, type: new Set() },
                v: { token: 0, type: new Set() },
                a: { token: 0, type: new Set() },
                d: { token: 0, type: new Set() }
            };

            tokens.forEach(t => {
                const word = t.w;
                const pos = t.p.toUpperCase();
                const posFirst = pos.charAt(0);

                stats.total.token++;
                stats.total.type.add(word);

                if (posFirst === 'N') {
                    stats.n.token++;
                    stats.n.type.add(word);
                } else if (posFirst === 'V') {
                    stats.v.token++;
                    stats.v.type.add(word);
                } else if (posFirst === 'A' || pos === 'VH' || pos === 'VS') { 
                    stats.a.token++;
                    stats.a.type.add(word);
                } else if (posFirst === 'D' || pos === 'DE') { 
                    stats.d.token++;
                    stats.d.type.add(word);
                }
            });

            // 更新統計 UI
            const updateStatUI = (idSuffix, data) => {
                document.getElementById(`stat-${idSuffix}-token`).innerText = data.token;
                if (document.getElementById(`stat-${idSuffix}-type`)) {
                     document.getElementById(`stat-${idSuffix}-type`).innerText = data.type.size;
                }
                const bar = document.getElementById(`bar-${idSuffix}`);
                if (bar && stats.total.token > 0) {
                    const pct = (data.token / stats.total.token) * 100;
                    bar.style.width = `${pct}%`;
                }
            };

            updateStatUI('total', stats.total);
            updateStatUI('n', stats.n);
            updateStatUI('v', stats.v);
            updateStatUI('a', stats.a);
            updateStatUI('d', stats.d);

            const ttr = stats.total.token > 0 ? (stats.total.type.size / stats.total.token).toFixed(2) : "0.00";
            document.getElementById('stat-total-ttr').innerText = ttr;

            // 渲染斷詞文本 (流動式)
            tokens.forEach((t, index) => {
                const span = document.createElement('span');
                span.className = 'token-unit';

                const pUpper = t.p.toUpperCase();
                let colorClass = 'pos-o'; 
                if (pUpper.startsWith('N')) colorClass = 'pos-n';
                else if (pUpper.startsWith('V')) colorClass = 'pos-v';
                else if (pUpper.startsWith('A') || pUpper === 'VH' || pUpper === 'VS') colorClass = 'pos-a';
                else if (pUpper.startsWith('D') || pUpper === 'DE') colorClass = 'pos-d';
                else if (pUpper === 'M' || pUpper === 'NF') colorClass = 'pos-m';
                else if (pUpper.startsWith('P') || pUpper.startsWith('C')) colorClass = 'pos-m';
                
                span.innerHTML = `<span class="token-word">${t.w}</span><span class="token-pos ${colorClass}">(${t.p})</span>`;
                container.appendChild(span);

                if (index < tokens.length - 1) {
                    const space = document.createTextNode('　');
                    container.appendChild(space);
                }
            });

            document.getElementById('result-panel').classList.remove('hidden');
        }

        function formatResultText() {
            if (!window.lastTokens) return "";
            return window.lastTokens.map(t => `${t.w}(${t.p})`).join('　');
        }

        function copyResult() {
            const text = formatResultText();
            if (!text) return;
            navigator.clipboard.writeText(text);
            showToast(getMsg('msg_copied'));
        }

        function downloadTxt() {
            const text = formatResultText();
            if (!text) return;
            
            const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `segmentation_result_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(getMsg('msg_downloaded'));
        }

        // *** Background ***
        (function() {
            const canvas = document.getElementById('network-canvas');
            const ctx = canvas.getContext('2d');
            let width, height, particles = [];
            function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; initParticles(); }
            class Particle {
                constructor() { this.x = Math.random() * width; this.y = Math.random() * height; this.vx = (Math.random()-0.5)*0.5; this.vy = (Math.random()-0.5)*0.5; this.size = Math.random()*2+1; this.color = `rgba(168, 85, 247, ${Math.random()*0.4})`; }
                update() { this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>width)this.vx*=-1; if(this.y<0||this.y>height)this.vy*=-1; }
                draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fillStyle=this.color; ctx.fill(); }
            }
            function initParticles() { particles=[]; for(let i=0;i<50;i++) particles.push(new Particle()); }
            function animate() {
                ctx.clearRect(0, 0, width, height);
                particles.forEach(p => { p.update(); p.draw(); });
                for(let i=0;i<particles.length;i++){
                    for(let j=i;j<particles.length;j++){
                        const dx = particles[i].x - particles[j].x; const dy = particles[i].y - particles[j].y;
                        const dist = Math.sqrt(dx*dx+dy*dy);
                        if(dist<150){ ctx.beginPath(); ctx.strokeStyle=`rgba(168,85,247,${0.08 - dist/2000})`; ctx.lineWidth=0.5; ctx.moveTo(particles[i].x,particles[i].y); ctx.lineTo(particles[j].x,particles[j].y); ctx.stroke(); }
                    }
                }
                requestAnimationFrame(animate);
            }
            window.addEventListener('resize', resize); resize(); animate();
        })();
    </script>
</body>
</html>
