<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Word Cloud | Science Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud2.js@1.2.2/src/wordcloud2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Work Sans"', '"Noto Sans TC"', 'sans-serif'],
                    },
                    colors: {
                        brand: { DEFAULT: '#BB50E0', hover: '#9a00cc', light: '#f3e5f5', bg: '#f8fafc' },
                        pos: { n: '#8b5cf6', v: '#10b981', a: '#f59e0b', d: '#3b82f6', c: '#ec4899', o: '#9ca3af' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #fff; color: #212121; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        .nav-link { cursor: pointer; position: relative; font-weight: 600; color: #757575; transition: color 0.3s; font-size: 1rem; }
        .nav-link.active { color: #BB50E0; }
        .nav-link.active::after { content: ''; position: absolute; bottom: -8px; left: 0; width: 100%; height: 3px; background-color: #BB50E0; border-radius: 3px 3px 0 0; }
        .scroller::-webkit-scrollbar { width: 8px; }
        .scroller::-webkit-scrollbar-track { background: #f1f1f1; }
        .scroller::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .scroller::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .loader { width: 24px; height: 24px; border: 3px solid rgba(187, 80, 224, 0.2); border-top-color: #BB50E0; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .pos-chip { display: flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 8px; font-size: 0.9rem; font-weight: 500; border: 1px solid #e5e7eb; background-color: #fff; color: #6b7280; cursor: pointer; transition: all 0.2s; }
        .pos-chip:hover { background-color: #f9fafb; border-color: #d1d5db; }
        .pos-chip.active[data-pos="n"] { background-color: #f5f3ff; color: #8b5cf6; border-color: #8b5cf6; }
        .pos-chip.active[data-pos="v"] { background-color: #ecfdf5; color: #10b981; border-color: #10b981; }
        .pos-chip.active[data-pos="a"] { background-color: #fffbeb; color: #f59e0b; border-color: #f59e0b; }
        .pos-chip.active[data-pos="d"] { background-color: #eff6ff; color: #3b82f6; border-color: #3b82f6; }
        .pos-chip.active[data-pos="c"] { background-color: #fdf2f8; color: #ec4899; border-color: #ec4899; }
        .pos-chip.active[data-pos="o"] { background-color: #f3f4f6; color: #4b5563; border-color: #6b7280; }
        .pos-dot { width: 8px; height: 8px; border-radius: 50%; background-color: currentColor; }
        /* PDF Êà™ÂúñÂ∞àÁî®Ê®£Âºè */
        .pdf-snapshot { background: white; padding: 20px; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="h-16 border-b border-gray-200 bg-white flex items-center justify-between px-6 shrink-0 z-30 shadow-sm">
        <div class="flex items-center gap-6">
            <button onclick="window.location.href='researcher.html'" class="text-gray-500 hover:text-brand transition font-medium flex items-center gap-2 text-base">
                <i class="fa-solid fa-arrow-left"></i> <span data-i18n="back">ËøîÂõûÁ†îÁ©∂‰∏≠ÂøÉ</span>
            </button>
            <div class="h-6 w-px bg-gray-300"></div>
            <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-cloud text-brand"></i>
                <span data-i18n="title">AI Êô∫ËÉΩÊñáÂ≠óÈõ≤</span>
            </h1>
        </div>
        <div class="flex items-center gap-4">
            <select id="language-selector" onchange="App.changeLanguage()" class="bg-gray-50 border border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-brand focus:border-brand block p-2 outline-none cursor-pointer">
                <option value="zh-TW">ÁπÅÈ´î‰∏≠Êñá</option>
                <option value="en">English</option>
                <option value="ja">Êó•Êú¨Ë™û</option>
                <option value="zh-CN">ÁÆÄ‰Ωì‰∏≠Êñá</option>
            </select>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-[45%] min-w-[450px] max-w-[800px] bg-white border-r border-gray-200 flex flex-col h-full shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-20">
            <div class="flex-1 overflow-y-auto scroller p-8"> 
                
                <div class="flex border-b border-gray-200 mb-6">
                    <div class="nav-link active px-4 py-2 text-base" data-i18n="tab_text">ÊñáÂ≠óËº∏ÂÖ•</div>
                </div>

                <div class="mb-8">
                    <div class="bg-brand-bg rounded-xl border border-gray-300 p-4 focus-within:border-brand focus-within:ring-1 focus-within:ring-brand transition">
                        <textarea id="text-input" class="w-full h-40 bg-transparent border-0 outline-none text-gray-700 resize-none leading-relaxed placeholder-gray-400 text-base" placeholder="Ë´ãÂú®Ê≠§Ë≤º‰∏äÊñáÁ´†..."></textarea>
                    </div>
                    <div class="flex justify-end gap-3 mt-3">
                        <button onclick="App.loadExample()" class="text-sm font-bold text-brand hover:text-brand-hover px-4 py-2 rounded border border-brand-light hover:bg-brand-light transition flex items-center gap-2">
                            <i class="fa-solid fa-flask"></i> <span data-i18n="btn_example">ÁØÑ‰æã</span>
                        </button>
                        <button onclick="App.clearInput()" class="text-sm font-bold text-gray-500 hover:text-red-500 px-4 py-2 rounded border border-gray-200 hover:bg-red-50 transition flex items-center gap-2">
                            <i class="fa-solid fa-trash"></i> <span data-i18n="btn_clear">Ê∏ÖÁ©∫</span>
                        </button>
                    </div>
                </div>

                <div class="mb-8 bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h5 class="text-base font-bold mb-4 text-gray-700 flex items-center gap-2" data-i18n="sec_options">
                        <i class="fa-solid fa-sliders"></i> Ë®≠ÂÆöÈÅ∏È†Ö
                    </h5>

                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-500 uppercase mb-2" data-i18n="label_model">Ê¨äÈáçÊ®°Âûã</label>
                            <div class="relative">
                                <select id="model-select" class="w-full p-3 bg-white border border-gray-300 rounded-lg text-base appearance-none focus:border-brand outline-none cursor-pointer font-medium shadow-sm">
                                    <option value="frequency" data-i18n="opt_freq">Ë©ûÈ†ª (Frequency)</option>
                                    <option value="tfidf" data-i18n="opt_tfidf">TF-IDF (Intra-text)</option>
                                    <option value="textrank" data-i18n="opt_textrank">TextRank (Weighted)</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-3 top-4 text-gray-400 text-xs pointer-events-none"></i>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-500 uppercase mb-2" data-i18n="label_shape">ÂΩ¢ÁãÄ</label>
                            <div class="relative">
                                <select id="shape-select" class="w-full p-3 bg-white border border-gray-300 rounded-lg text-base appearance-none focus:border-brand outline-none cursor-pointer font-medium shadow-sm">
                                    <option value="circle" data-i18n="shape_circle">ÂúìÂΩ¢</option>
                                    <option value="square" data-i18n="shape_square">ÊñπÂΩ¢</option>
                                    <option value="cardioid" data-i18n="shape_heart">ÊÑõÂøÉ</option>
                                    <option value="star" data-i18n="shape_star">ÊòüÂΩ¢</option>
                                    <option value="diamond" data-i18n="shape_diamond">Ëè±ÂΩ¢</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-3 top-4 text-gray-400 text-xs pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-bold text-gray-500 uppercase" data-i18n="label_max_words">È°ØÁ§∫Ë©ûÂΩôÊï∏Èáè</label>
                            <span id="max-words-val" class="text-sm font-bold text-brand bg-white px-3 py-1 rounded border border-gray-200">100</span>
                        </div>
                        <input type="range" id="max-words-slider" min="10" max="200" step="10" value="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-brand">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-500 uppercase mb-3" data-i18n="label_pos_filter">Ë©ûÊÄßÈÅéÊøæ</label>
                        <div class="flex flex-wrap gap-3" id="pos-container">
                            <button class="pos-chip active" data-pos="n"><span class="pos-dot"></span> ÂêçË©û</button>
                            <button class="pos-chip active" data-pos="v"><span class="pos-dot"></span> ÂãïË©û</button>
                            <button class="pos-chip active" data-pos="a"><span class="pos-dot"></span> ÂΩ¢ÂÆπË©û</button>
                            <button class="pos-chip" data-pos="d"><span class="pos-dot"></span> ÂâØË©û</button>
                            <button class="pos-chip" data-pos="c"><span class="pos-dot"></span> ÈÄ£Êé•Ë©û</button>
                            <button class="pos-chip" data-pos="o"><span class="pos-dot"></span> ÂÖ∂‰ªñ</button>
                        </div>
                    </div>
                </div>

                <button id="btn-analyze" onclick="App.runAnalysis()" class="w-full bg-brand hover:bg-brand-hover text-white font-bold py-4 rounded-xl shadow-lg shadow-brand/20 transition transform active:scale-[0.98] flex items-center justify-center gap-2 text-base tracking-wide">
                    <span data-i18n="btn_visualize">Áî¢ÁîüÊñáÂ≠óÈõ≤</span> <i class="fa-solid fa-wand-magic-sparkles"></i>
                </button>
            </div>

            <div id="results-container" class="hidden border-t border-gray-200 bg-gray-50 h-[40%] flex flex-col">
                <div class="flex border-b border-gray-200 bg-white px-6 justify-between items-center">
                    <div class="flex">
                        <button onclick="App.switchTab('ai')" id="tab-ai" class="py-3 px-6 text-base font-bold text-brand border-b-2 border-brand transition" data-i18n="tab_ai">AI Ê¥ûÂØü</button>
                        <button onclick="App.switchTab('data')" id="tab-data" class="py-3 px-6 text-base font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition" data-i18n="tab_data">Êï∏ÊìöÂàóË°®</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="App.downloadReport('txt')" class="text-xs font-bold text-gray-500 hover:text-brand bg-gray-100 px-3 py-1.5 rounded transition" title="Download TXT">
                            <i class="fa-solid fa-file-lines"></i> TXT
                        </button>
                        <button onclick="App.downloadReport('pdf')" class="text-xs font-bold text-gray-500 hover:text-brand bg-gray-100 px-3 py-1.5 rounded transition" title="Download PDF">
                            <i class="fa-solid fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>

                <div id="panel-ai" class="flex-1 overflow-y-auto scroller p-6 text-base text-gray-700 leading-relaxed space-y-4 bg-brand-bg"></div>

                <div id="panel-data" class="hidden flex-1 overflow-y-auto scroller p-0">
                    <table class="w-full text-sm text-left border-collapse">
                        <thead class="bg-gray-100 text-gray-500 sticky top-0 shadow-sm z-10">
                            <tr>
                                <th class="p-3 font-semibold pl-6" data-i18n="col_rank">#</th>
                                <th class="p-3 font-semibold" data-i18n="col_word">Ë©ûÂΩô</th>
                                <th class="p-3 font-semibold" data-i18n="col_pos">Ë©ûÊÄß</th>
                                <th class="p-3 text-right font-semibold pr-6" data-i18n="col_weight">Ê¨äÈáç</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="divide-y divide-gray-200 bg-white"></tbody>
                    </table>
                </div>
            </div>
        </aside>

        <div id="resizer" class="w-1.5 bg-gray-200 cursor-col-resize hover:bg-brand transition z-30"></div>

        <main class="flex-1 bg-gray-100 relative flex flex-col items-center justify-center p-8 overflow-hidden">
            <div id="canvas-wrapper" class="w-full h-full bg-white rounded-2xl shadow-sm border border-gray-200 relative flex items-center justify-center overflow-hidden">
                
                <div id="empty-state" class="text-center opacity-60">
                    <img src="https://cdn-icons-png.flaticon.com/512/4047/4047268.png" alt="Cloud" class="w-32 h-32 mx-auto mb-6 opacity-50 grayscale">
                    <h3 class="text-2xl font-bold text-gray-700" data-i18n="state_ready">Ê∫ñÂÇôÂ∞±Á∑í</h3>
                    <p class="text-gray-500 mt-2 text-lg" data-i18n="state_ready_desc">Ë´ãÂú®Â∑¶ÂÅ¥Ëº∏ÂÖ•ÊñáÂ≠ó‰∏¶Áî¢ÁîüÊñáÂ≠óÈõ≤</p>
                </div>

                <div id="loading-state" class="hidden text-center">
                    <div class="loader mx-auto mb-6 w-12 h-12 border-4"></div>
                    <p class="text-brand font-bold text-xl animate-pulse" data-i18n="state_loading">AI Ê≠£Âú®ÈÅãÁÆó‰∏≠...</p>
                </div>

                <canvas id="word-cloud-canvas" class="hidden"></canvas>
            </div>

            <button onclick="App.downloadImage()" id="btn-download" class="hidden absolute bottom-12 right-12 bg-white text-gray-800 hover:text-brand border border-gray-300 px-8 py-4 rounded-full shadow-xl font-bold transition transform hover:-translate-y-1 flex items-center gap-3 z-30 group text-base">
                <span class="group-hover:text-brand transition" data-i18n="btn_download">‰∏ãËºâÂúñÁâá</span> <i class="fa-solid fa-download group-hover:animate-bounce"></i>
            </button>
        </main>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 translate-y-10 transition-all duration-300 pointer-events-none z-50 font-medium text-sm flex items-center gap-3">
        <i class="fa-solid fa-info-circle"></i> <span id="toast-msg">Notification</span>
    </div>

    <script>
        // üî¥üî¥üî¥ Ë´ãÂãôÂøÖÂ°´ÂÖ•ÊÇ®ÈÉ®ÁΩ≤ÂæåÁöÑ GAS Web App URL (ÁµêÂ∞æÊòØ /exec) üî¥üî¥üî¥
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw3UqYr976wAd9aeEsLpTDSlGaUVdBpaErqZi-zHgNzh_Gd0SuggfdI7ldVzrqR1Ygd/exec"; 

        const App = {
            state: {
                words: [],
                resizeTimer: null,
                currentLang: 'zh-TW',
                activePos: new Set(['n', 'v', 'a']),
                maxWords: 100
            },

            translations: {
                "zh-TW": {
                    "back": "ËøîÂõûÁ†îÁ©∂‰∏≠ÂøÉ", "title": "AI Êô∫ËÉΩÊñáÂ≠óÈõ≤", "tab_text": "ÊñáÂ≠óËº∏ÂÖ•", "btn_example": "ËºâÂÖ•ÁØÑ‰æã", "btn_clear": "Ê∏ÖÁ©∫", "sec_options": "Ë®≠ÂÆöÈÅ∏È†Ö", "sec_options_desc": "Ëá™ÂÆöÁæ©ÊÇ®ÁöÑÊñáÂ≠óÈõ≤ÂèÉÊï∏", "label_model": "Ê¨äÈáçÊ®°Âûã", "label_shape": "ÂΩ¢ÁãÄ", "label_pos_filter": "Ë©ûÊÄßÈÅéÊøæ", "label_max_words": "È°ØÁ§∫Ë©ûÂΩôÊï∏Èáè", "opt_freq": "Ë©ûÈ†ª (Frequency)", "opt_tfidf": "TF-IDF (Intra-text)", "opt_textrank": "TextRank (Weighted)", "shape_circle": "ÂúìÂΩ¢", "shape_square": "ÊñπÂΩ¢", "shape_heart": "ÊÑõÂøÉ", "shape_star": "ÊòüÂΩ¢", "shape_diamond": "Ëè±ÂΩ¢", "btn_visualize": "Áî¢ÁîüÊñáÂ≠óÈõ≤", "tab_ai": "AI Ê¥ûÂØü", "tab_data": "Êï∏ÊìöÂàóË°®", "col_rank": "#", "col_word": "Ë©ûÂΩô", "col_pos": "Ë©ûÊÄß", "col_weight": "Ê¨äÈáç", "state_ready": "Ê∫ñÂÇôÂ∞±Á∑í", "state_ready_desc": "Ë´ãÂú®Â∑¶ÂÅ¥Ëº∏ÂÖ•ÊñáÂ≠ó‰∏¶Áî¢ÁîüÊñáÂ≠óÈõ≤", "state_loading": "AI Ê≠£Âú®ÈÅãÁÆó‰∏≠...", "btn_download": "‰∏ãËºâÂúñÁâá", "msg_input_empty": "Ë´ãËº∏ÂÖ•ÊñáÂ≠ó", "msg_processing": "ËôïÁêÜ‰∏≠...", "msg_success": "ÂàÜÊûêÂÆåÊàê", "msg_error": "ÁôºÁîüÈåØË™§"
                },
                "en": {
                    "back": "Back", "title": "AI Word Cloud", "tab_text": "Text Input", "btn_example": "Example", "btn_clear": "Clear", "sec_options": "Options", "sec_options_desc": "Customize options", "label_model": "Model", "label_shape": "Shape", "label_pos_filter": "POS Filters", "label_max_words": "Max Words", "opt_freq": "Frequency", "opt_tfidf": "TF-IDF", "opt_textrank": "TextRank", "shape_circle": "Circle", "shape_square": "Square", "shape_heart": "Heart", "shape_star": "Star", "shape_diamond": "Diamond", "btn_visualize": "VISUALIZE", "tab_ai": "AI Insight", "tab_data": "Data List", "col_rank": "#", "col_word": "Word", "col_pos": "POS", "col_weight": "Weight", "state_ready": "Ready", "state_ready_desc": "Input text to start", "state_loading": "Processing...", "btn_download": "Download", "msg_input_empty": "Input text required", "msg_processing": "Processing...", "msg_success": "Done", "msg_error": "Error"
                },
                "ja": {
                    "back": "Êàª„Çã", "title": "AI „ÉØ„Éº„Éâ„ÇØ„É©„Ç¶„Éâ", "tab_text": "ÂÖ•Âäõ", "btn_example": "‰æãÊñá", "btn_clear": "„ÇØ„É™„Ç¢", "sec_options": "Ë®≠ÂÆö", "sec_options_desc": "„Ç™„Éó„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû", "label_model": "„É¢„Éá„É´", "label_shape": "ÂΩ¢Áä∂", "label_pos_filter": "ÂìÅË©û„Éï„Ç£„É´„Çø", "label_max_words": "ÂçòË™ûÊï∞", "opt_freq": "È†ªÂ∫¶", "opt_tfidf": "TF-IDF", "opt_textrank": "TextRank", "shape_circle": "ÂÜÜÂΩ¢", "shape_square": "ÂõõËßí", "shape_heart": "„Éè„Éº„Éà", "shape_star": "Êòü", "shape_diamond": "Ëè±ÂΩ¢", "btn_visualize": "ÁîüÊàê„Åô„Çã", "tab_ai": "AIÂàÜÊûê", "tab_data": "„Éá„Éº„Çø", "col_rank": "#", "col_word": "ÂçòË™û", "col_pos": "ÂìÅË©û", "col_weight": "Èáç„Åø", "state_ready": "Ê∫ñÂÇôÂÆå‰∫Ü", "state_ready_desc": "„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", "state_loading": "Âá¶ÁêÜ‰∏≠...", "btn_download": "ÁîªÂÉè‰øùÂ≠ò", "msg_input_empty": "ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", "msg_processing": "Ë®àÁÆó‰∏≠...", "msg_success": "ÂÆå‰∫Ü", "msg_error": "„Ç®„É©„Éº"
                },
                "zh-CN": {
                    "back": "ËøîÂõû", "title": "AI Êô∫ËÉΩÊñáÂ≠ó‰∫ë", "tab_text": "ÊñáÂ≠óËæìÂÖ•", "btn_example": "ËåÉ‰æã", "btn_clear": "Ê∏ÖÁ©∫", "sec_options": "ÈÄâÈ°π", "sec_options_desc": "Ëá™ÂÆö‰πâÂèÇÊï∞", "label_model": "ÊùÉÈáçÊ®°Âûã", "label_shape": "ÂΩ¢Áä∂", "label_pos_filter": "ËØçÊÄßËøáÊª§", "label_max_words": "ËØçÊ±áÊï∞Èáè", "opt_freq": "ËØçÈ¢ë", "opt_tfidf": "TF-IDF", "opt_textrank": "TextRank", "shape_circle": "ÂúÜÂΩ¢", "shape_square": "ÊñπÂΩ¢", "shape_heart": "ÂøÉÂΩ¢", "shape_star": "ÊòüÂΩ¢", "shape_diamond": "Ëè±ÂΩ¢", "btn_visualize": "ÁîüÊàêÊñáÂ≠ó‰∫ë", "tab_ai": "AI Ê¥ûÂØü", "tab_data": "Êï∞ÊçÆÂàóË°®", "col_rank": "#", "col_word": "ËØçÊ±á", "col_pos": "ËØçÊÄß", "col_weight": "ÊùÉÈáç", "state_ready": "ÂáÜÂ§áÂ∞±Áª™", "state_ready_desc": "ËØ∑ËæìÂÖ•ÊñáÂ≠ó", "state_loading": "ËøêÁÆó‰∏≠...", "btn_download": "‰∏ãËΩΩÂõæÁâá", "msg_input_empty": "ËØ∑ËæìÂÖ•ÊñáÂ≠ó", "msg_processing": "Â§ÑÁêÜ‰∏≠...", "msg_success": "ÂàÜÊûêÂÆåÊàê", "msg_error": "ÂèëÁîüÈîôËØØ"
                }
            },

            exampleText: "ÈõªÊµÅÁ£ÅÊïàÊáâÊòØÊåáÈõªÊµÅÈÄöÈÅéÂ∞éÁ∑öÊôÇÔºåÊúÉÂú®Â∞éÁ∑öÂë®ÂúçÁî¢ÁîüÁ£ÅÂ†¥ÁöÑÁèæË±°„ÄÇ1820Âπ¥Ôºå‰∏πÈ∫•Áâ©ÁêÜÂ≠∏ÂÆ∂Â•ßÊñØÁâπÁôºÁèæÔºåÁï∂Â∞éÁ∑öÈÄöÈõªÊôÇÔºåÊóÅÈÇäÁöÑÁ£ÅÈáùÊúÉÁôºÁîüÂÅèËΩâÔºåË≠âÊòé‰∫ÜÈõªËàáÁ£Å‰πãÈñìÊúâÂØÜÂàáÁöÑÈóú‰øÇ„ÄÇÁ£ÅÂ†¥ÁöÑÊñπÂêëÂèØ‰ª•Áî®ÂÆâÂüπÂè≥ÊâãÂÆöÂâá‰æÜÂà§Êñ∑ÔºöÁî®Âè≥ÊâãÊè°‰ΩèÂ∞éÁ∑öÔºåÂ§ßÊãáÊåáÊåáÂêëÈõªÊµÅÊñπÂêëÔºåÂõõÊåáÂΩéÊõ≤ÁöÑÊñπÂêëÂ∞±ÊòØÁ£ÅÂ†¥ÊñπÂêë„ÄÇËã•Â∞áÂ∞éÁ∑öÁπûÊàêËû∫Á∑öÁÆ°ÔºåÈÄöÈõªÂæåÂÖßÈÉ®ÊúÉÁî¢ÁîüÂùáÂãªÁ£ÅÂ†¥ÔºåÂÖ∂ÁâπÊÄßÈ°û‰ººÊñºÊ¢ùÂΩ¢Á£ÅÈêµ„ÄÇ",

            init() {
                this.bindEvents();
                this.initResizer();
                document.getElementById('text-input').placeholder = "Ë´ãÂú®Ê≠§Ë≤º‰∏äÊñáÁ´† (Âª∫Ë≠∞ 100 Â≠ó‰ª•‰∏ä)...";
            },

            bindEvents() {
                document.querySelectorAll('.pos-chip').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const target = e.currentTarget;
                        const pos = target.dataset.pos;
                        if (this.state.activePos.has(pos)) {
                            this.state.activePos.delete(pos);
                            target.classList.remove('active');
                        } else {
                            this.state.activePos.add(pos);
                            target.classList.add('active');
                        }
                        if (this.state.words.length > 0) this.renderWordCloud();
                    });
                });

                const slider = document.getElementById('max-words-slider');
                const valDisplay = document.getElementById('max-words-val');
                slider.addEventListener('input', (e) => {
                    this.state.maxWords = parseInt(e.target.value);
                    valDisplay.innerText = this.state.maxWords;
                });

                document.getElementById('shape-select').addEventListener('change', () => {
                    if (this.state.words.length > 0) this.renderWordCloud();
                });
                
                window.addEventListener('resize', () => {
                    if (this.state.words.length > 0) {
                        clearTimeout(this.state.resizeTimer);
                        this.state.resizeTimer = setTimeout(() => this.renderWordCloud(), 300);
                    }
                });
            },

            initResizer() {
                const resizer = document.getElementById('resizer');
                const sidebar = document.querySelector('aside');
                let isResizing = false;

                resizer.addEventListener('mousedown', () => { isResizing = true; document.body.style.cursor = 'col-resize'; });
                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;
                    const w = e.clientX;
                    if (w > 400 && w < window.innerWidth * 0.7) sidebar.style.width = `${w}px`;
                });
                document.addEventListener('mouseup', () => {
                    if (isResizing) {
                        isResizing = false; document.body.style.cursor = 'default';
                        if (this.state.words.length > 0) this.renderWordCloud();
                    }
                });
            },

            loadExample() { document.getElementById('text-input').value = this.exampleText; },
            clearInput() { 
                document.getElementById('text-input').value = ''; 
                document.getElementById('results-container').classList.add('hidden');
                document.getElementById('word-cloud-canvas').classList.add('hidden');
                document.getElementById('btn-download').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
                this.state.words = []; 
            },

            changeLanguage() {
                this.state.currentLang = document.getElementById('language-selector').value;
                const t = this.translations[this.state.currentLang] || this.translations['zh-TW'];
                
                // 1. Êõ¥Êñ∞ DOM ÊñáÊú¨
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if(t[key]) el.innerText = t[key];
                });

                // 2. Êõ¥Êñ∞ Select Option ÊñáÂ≠ó (‰øÆÂæ©Êó•Êñá/Á∞°‰∏≠Â§±ÊïàÂïèÈ°å)
                const selectIds = ['model-select', 'shape-select'];
                selectIds.forEach(id => {
                    const select = document.getElementById(id);
                    Array.from(select.options).forEach(opt => {
                        // ÊâæÂà∞Â∞çÊáâÁöÑ key (ÂÅáË®≠ option value Â∞çÊáâ opt_value)
                        // ÂΩ¢ÁãÄ: circle -> shape_circle
                        // Ê®°Âûã: frequency -> opt_freq (Áâπ‰æã)
                        let key = '';
                        if(id === 'shape-select') key = `shape_${opt.value}`;
                        else if(opt.value === 'frequency') key = 'opt_freq';
                        else if(opt.value === 'tfidf') key = 'opt_tfidf';
                        else if(opt.value === 'textrank') key = 'opt_textrank';
                        
                        if(t[key]) opt.text = t[key];
                    });
                });
            },

            switchTab(tab) {
                const tabAi = document.getElementById('tab-ai');
                const tabData = document.getElementById('tab-data');
                const panelAi = document.getElementById('panel-ai');
                const panelData = document.getElementById('panel-data');

                if (tab === 'ai') {
                    tabAi.className = "py-3 px-6 text-base font-bold text-brand border-b-2 border-brand transition";
                    tabData.className = "py-3 px-6 text-base font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition";
                    panelAi.classList.remove('hidden'); panelData.classList.add('hidden');
                } else {
                    tabAi.className = "py-3 px-6 text-base font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition";
                    tabData.className = "py-3 px-6 text-base font-bold text-brand border-b-2 border-brand transition";
                    panelAi.classList.add('hidden'); panelData.classList.remove('hidden');
                }
            },

            async runAnalysis() {
                const text = document.getElementById('text-input').value.trim();
                const model = document.getElementById('model-select').value;
                const btn = document.getElementById('btn-analyze');
                const t = this.translations[this.state.currentLang];

                if (!text) { this.showToast(t.msg_input_empty, 'error'); return; }
                if (GAS_URL.includes("Âú®Ê≠§Â°´ÂÖ•")) { this.showToast("API URL not set", 'error'); return; }

                const orgBtnHtml = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<div class="loader w-4 h-4 border-2 border-white/30 border-t-white mr-2"></div> ${t.msg_processing}`;
                
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('word-cloud-canvas').classList.add('hidden');
                document.getElementById('btn-download').classList.add('hidden');
                document.getElementById('loading-state').classList.remove('hidden');
                document.getElementById('results-container').classList.add('hidden');

                const payload = { text: text, mode: model, maxTerms: this.state.maxWords };

                try {
                    const res = await fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload),
                        headers: { "Content-Type": "text/plain;charset=utf-8" }
                    });
                    const json = await res.json();

                    if (json.status === 'success') {
                        this.state.words = json.data.wordList;
                        document.getElementById('panel-ai').innerHTML = json.data.aiAnalysis;
                        this.renderTable(json.data.wordList);
                        
                        document.getElementById('loading-state').classList.add('hidden');
                        document.getElementById('results-container').classList.remove('hidden');
                        
                        // üü¢ ‰øÆÂæ©ÔºöÂª∂ÈÅ≤Áπ™Ë£Ω‰ª•Á¢∫‰øùÂÆπÂô®ÂØ¨È´òÊ≠£Á¢∫
                        setTimeout(() => this.renderWordCloud(), 100);
                        this.showToast(t.msg_success, "success");
                    } else {
                        throw new Error(json.message);
                    }
                } catch (error) {
                    console.error(error);
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('empty-state').classList.remove('hidden');
                    this.showToast(t.msg_error + ": " + error.message, "error");
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = orgBtnHtml;
                }
            },

            renderWordCloud() {
                const canvas = document.getElementById('word-cloud-canvas');
                const wrapper = document.getElementById('canvas-wrapper');
                const shape = document.getElementById('shape-select').value;

                const filteredList = this.state.words.filter(item => {
                    const p = (item.pos || 'o').toLowerCase().charAt(0);
                    let type = 'o';
                    if (['n','v','a','d','c'].includes(p)) type = p;
                    return this.state.activePos.has(type);
                });

                if (filteredList.length === 0) {
                    this.showToast("ÁØ©ÈÅ∏ÂæåÁÑ°Ë©ûÂΩô", "error");
                    return;
                }

                canvas.classList.remove('hidden');
                document.getElementById('btn-download').classList.remove('hidden');
                
                // üü¢ ÈóúÈçµÔºöÂº∑Âà∂Êõ¥Êñ∞ Canvas Â∞∫ÂØ∏
                const w = wrapper.clientWidth;
                const h = wrapper.clientHeight;
                canvas.width = w;
                canvas.height = h;

                // Ê¨äÈáçË®àÁÆó
                const maxWeight = Math.max(...filteredList.map(i => i.weight)) || 1;
                // Â≠óÈ´î‰øÇÊï∏ÂÑ™ÂåñÔºöËÆìÊúÄÂ§ßÂ≠ó‰ΩîÂØ¨Â∫¶ 1/8ÔºåÊúÄÂ∞èÂ≠ó 14px
                const factor = (w / 8) / maxWeight; 

                const list = filteredList.map(i => [i.word, i.weight * factor + 14]);

                // Âü∑Ë°å WordCloud
                setTimeout(() => {
                    WordCloud(canvas, {
                        list: list,
                        gridSize: 8, // Á∏ÆÂ∞èÁ∂≤Ê†ºËÆìÊñáÂ≠óÊõ¥Á∑äÊπä
                        weightFactor: 1, // Â∑≤ÊâãÂãïË®àÁÆó
                        fontFamily: '"Work Sans", "Noto Sans TC", sans-serif',
                        fontWeight: 'bold',
                        color: (word) => {
                            const item = this.state.words.find(i => i.word === word);
                            return this.getPosColor(item ? item.pos : 'o');
                        },
                        rotateRatio: 0.2, 
                        rotationSteps: 2,
                        shape: shape,
                        backgroundColor: 'transparent',
                        drawOutOfBound: false,
                        shrinkToFit: true,
                        shuffle: false // Ê¨äÈáçÈ´òËÄÖÂú®‰∏≠ÂøÉ
                    });
                }, 50);
            },

            getPosColor(pos) {
                const p = String(pos).toLowerCase();
                if (p.startsWith('n')) return '#8b5cf6'; 
                if (p.startsWith('v')) return '#10b981'; 
                if (p.startsWith('a')) return '#f59e0b'; 
                if (p.startsWith('d')) return '#3b82f6'; 
                if (p.startsWith('c')) return '#ec4899'; 
                return '#9ca3af'; 
            },

            renderTable(list) {
                const tbody = document.getElementById('data-table-body');
                tbody.innerHTML = list.slice(0, 100).map((item, idx) => `
                    <tr class="hover:bg-gray-50 transition border-b border-gray-100">
                        <td class="p-3 text-gray-400 font-mono text-xs pl-6">${idx + 1}</td>
                        <td class="p-3 font-medium text-gray-800">${item.word}</td>
                        <td class="p-3"><span class="pos-badge text-white" style="background-color: ${this.getPosColor(item.pos)}">${item.pos}</span></td>
                        <td class="p-3 text-right font-mono text-gray-600 pr-6">${item.weight.toFixed(2)}</td>
                    </tr>
                `).join('');
            },

            // üü¢ Êñ∞Â¢ûÔºöÂåØÂá∫Â†±ÂëäÂäüËÉΩ (PDF ‰ΩøÁî® html2canvas Ëß£Ê±∫‰∏≠Êñá‰∫ÇÁ¢º)
            async downloadReport(type) {
                if(this.state.words.length === 0) {
                    this.showToast("Ë´ãÂÖàÁî¢ÁîüÂàÜÊûêÁµêÊûú", "error");
                    return;
                }

                if (type === 'txt') {
                    // TXT ÈÇèËºØÁ∂≠ÊåÅ‰∏çËÆä
                    let content = "AI Êô∫ËÉΩÊñáÂ≠óÈõ≤ - ÂàÜÊûêÂ†±Âëä\n\n";
                    content += "=== AI Ê¥ûÂØü ===\n";
                    content += document.getElementById('panel-ai').innerText + "\n\n";
                    content += "=== Êï∏ÊìöÂàóË°® (Ââç 100 Á≠Ü) ===\n";
                    content += "ÊéíÂêç\tË©ûÂΩô\tË©ûÊÄß\tÊ¨äÈáç\n";
                    this.state.words.slice(0, 100).forEach((w, i) => {
                        content += `${i+1}\t${w.word}\t${w.pos}\t${w.weight.toFixed(2)}\n`;
                    });
                    const blob = new Blob([content], { type: 'text/plain' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `report_${Date.now()}.txt`;
                    link.click();

                } else if (type === 'pdf') {
                    // üü¢ PDF Êà™ÂúñÊ≥ï (Ëß£Ê±∫‰∏≠Êñá‰∫ÇÁ¢º)
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const container = document.getElementById('results-container');
                    
                    // Êö´ÊôÇËß£Èô§ scroll ÈôêÂà∂‰ª•Êà™ÂèñÂÆåÊï¥ÂÖßÂÆπ
                    const originalOverflow = container.style.overflow;
                    const originalHeight = container.style.height;
                    
                    // ÊàëÂÄëÈúÄË¶ÅÈáùÂ∞ç panel-ai Âíå panel-data ÂàÜÂà•Êà™Âúñ
                    // ÂÖàÈ°ØÁ§∫ AI Tab
                    this.switchTab('ai');
                    const aiPanel = document.getElementById('panel-ai');
                    
                    this.showToast("Ê≠£Âú®ÁîüÊàê PDFÔºåË´ãÁ®çÂÄô...", "info");
                    
                    try {
                        // 1. Êà™Âèñ AI ÂàÜÊûêÈù¢Êùø
                        const canvas1 = await html2canvas(aiPanel, { scale: 2 });
                        const imgData1 = canvas1.toDataURL('image/png');
                        const imgProps1 = doc.getImageProperties(imgData1);
                        const pdfWidth = doc.internal.pageSize.getWidth();
                        const pdfHeight1 = (imgProps1.height * pdfWidth) / imgProps1.width;
                        
                        doc.setFontSize(18);
                        doc.text("AI Analysis Report", 14, 20);
                        doc.addImage(imgData1, 'PNG', 0, 30, pdfWidth, pdfHeight1);
                        
                        // 2. Êà™ÂèñÊï∏ÊìöË°®Ê†º (Âè™Êà™ÂèØË¶ãÈÉ®ÂàÜÔºåÂõ†ÁÇ∫ÂÆåÊï¥Ë°®Ê†ºÂ§™Èï∑)
                        // Ëã•Ë¶ÅÂÆåÊï¥Ë°®Ê†ºÔºåÈúÄË¶ÅÊõ¥Ë§áÈõúÁöÑËôïÁêÜÔºåÈÄôË£°ÂÖàÊà™ÂèñÁï∂ÂâçË¶ñÂúñ
                        this.switchTab('data');
                        const dataPanel = document.getElementById('panel-data');
                        // ÁÇ∫‰∫ÜÊà™ÂúñÂÆåÊï¥ÔºåÊö´ÊôÇÂ±ïÈñã
                        dataPanel.style.height = 'auto';
                        dataPanel.style.overflow = 'visible';
                        
                        doc.addPage();
                        const canvas2 = await html2canvas(dataPanel, { scale: 2 });
                        const imgData2 = canvas2.toDataURL('image/png');
                        const imgProps2 = doc.getImageProperties(imgData2);
                        const pdfHeight2 = (imgProps2.height * pdfWidth) / imgProps2.width;

                        doc.text("Data List", 14, 20);
                        // Ëã•ÂúñÁâáÂ§™Èï∑ÔºåÂè™È°ØÁ§∫Á¨¨‰∏ÄÈ†Å‰ªΩÈáè
                        doc.addImage(imgData2, 'PNG', 0, 30, pdfWidth, Math.min(pdfHeight2, 250));

                        doc.save(`report_${Date.now()}.pdf`);
                        this.showToast("PDF ‰∏ãËºâÊàêÂäü", "success");

                    } catch (err) {
                        console.error(err);
                        this.showToast("PDF ÁîüÊàêÂ§±Êïó", "error");
                    } finally {
                        // ÊÅ¢Âæ©Ê®£Âºè
                        dataPanel.style.height = '';
                        dataPanel.style.overflow = '';
                    }
                }
            },

            downloadImage() {
                const canvas = document.getElementById('word-cloud-canvas');
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const ctx = tempCanvas.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                ctx.drawImage(canvas, 0, 0);
                const link = document.createElement('a');
                link.download = `wordcloud_${Date.now()}.png`;
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
            },

            showToast(msg, type = 'info') {
                const toast = document.getElementById('toast');
                const toastMsg = document.getElementById('toast-msg');
                toastMsg.innerText = msg;
                toast.classList.remove('opacity-0', 'translate-y-10');
                if (type === 'error') {
                    toast.classList.remove('bg-gray-900'); toast.classList.add('bg-red-600');
                } else {
                    toast.classList.add('bg-gray-900'); toast.classList.remove('bg-red-600');
                }
                setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
            }
        };

        App.init();
    </script>
</body>
</html>
