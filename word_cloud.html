<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½æ–‡å­—é›² | Science Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud2@1.2.2/src/wordcloud2.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
                        secondary: { 50: '#fdf4ff', 500: '#d946ef' }
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* æ»¾å‹•æ¢ç¾åŒ– */
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-track { background: transparent; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .scroller::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

        /* è©æ€§æ¨™ç±¤æ¨£å¼ */
        .pos-chip { cursor: pointer; border: 1px solid #e2e8f0; transition: all 0.2s; user-select: none; }
        .pos-chip.active { background-color: #e0e7ff; color: #4338ca; border-color: #6366f1; font-weight: 700; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1); }
        
        /* è¼‰å…¥å‹•ç•« */
        .loader { width: 24px; height: 24px; border: 3px solid rgba(79, 70, 229, 0.2); border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* æ‹–æ‹‰æ‰‹æŸ„æ¨£å¼ */
        #resizer {
            width: 5px;
            cursor: col-resize;
            background-color: #e2e8f0;
            transition: background-color 0.2s;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #resizer:hover, #resizer.resizing { background-color: #6366f1; }
        /* æ‹–æ‹‰æ™‚åŠ ä¸Šä¸€å€‹å°åœ–ç¤ºæ„Ÿ */
        #resizer::after {
            content: "||";
            color: #94a3b8;
            font-size: 10px;
            letter-spacing: -1px;
        }
        #resizer:hover::after { color: white; }
    </style>
</head>
<body>

    <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 shrink-0 z-30 shadow-sm">
        <div class="flex items-center gap-4">
            <button onclick="window.location.href='researcher.html'" class="flex items-center gap-2 text-slate-500 hover:text-primary-600 transition font-bold text-sm bg-slate-50 hover:bg-primary-50 px-3 py-2 rounded-lg border border-transparent hover:border-primary-200">
                <i class="fa-solid fa-arrow-left"></i> è¿”å›ç ”ç©¶ä¸­å¿ƒ
            </button>
            <div class="h-6 w-px bg-slate-200"></div>
            <div class="flex items-center gap-2 text-slate-800">
                <i class="fa-solid fa-cloud text-primary-600 text-xl"></i>
                <h1 class="text-lg font-bold tracking-tight">AI æ™ºèƒ½æ–‡å­—é›²åˆ†æ</h1>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">Model: Gemini 2.5 Flash</span>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative" id="main-container">
        
        <aside id="sidebar" class="bg-white border-r border-slate-200 flex flex-col z-20 shadow-xl shrink-0 h-full relative" style="width: 400px; min-width: 320px; max-width: 600px;">
            
            <div class="flex-1 overflow-y-auto scroller p-6 space-y-6">
                
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-sm font-bold text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-pen-to-square text-primary-500"></i> åˆ†ææ–‡æœ¬
                        </label>
                        <div class="flex gap-2">
                            <button onclick="loadExample()" class="text-xs bg-slate-100 hover:bg-primary-50 text-slate-600 hover:text-primary-700 px-2 py-1 rounded transition border border-slate-200">è¼‰å…¥ç¯„ä¾‹</button>
                            <button onclick="clearInput()" class="text-xs bg-slate-100 hover:bg-red-50 text-slate-600 hover:text-red-600 px-2 py-1 rounded transition border border-slate-200">æ¸…ç©º</button>
                        </div>
                    </div>
                    <textarea id="text-input" class="w-full h-40 p-3 text-sm border border-slate-300 rounded-xl focus:ring-2 focus:ring-primary-500 outline-none transition resize-none leading-relaxed bg-slate-50 focus:bg-white" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ–‡ç« ..."></textarea>
                </div>

                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">è¦–è¦ºåŒ–è¨­å®š</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-semibold text-slate-500 mb-1 block">å½¢ç‹€</label>
                            <select id="shape-select" class="w-full p-2 text-sm border rounded-lg bg-white focus:border-primary-500 outline-none">
                                <option value="circle">åœ“å½¢ (Circle)</option>
                                <option value="cardioid">æ„›å¿ƒ (Heart)</option>
                                <option value="square">æ–¹å½¢ (Square)</option>
                                <option value="star">æ˜Ÿå½¢ (Star)</option>
                                <option value="diamond">è±å½¢ (Diamond)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-slate-500 mb-1 block">æ¬Šé‡æ¨¡å¼</label>
                            <select id="model-select" class="w-full p-2 text-sm border rounded-lg bg-white focus:border-primary-500 outline-none">
                                <option value="frequency">è©é » (Frequency)</option>
                                <option value="tfidf">TF-IDF (æ¨è–¦)</option>
                                <option value="textrank">TextRank (é—œéµæ€§)</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-semibold text-slate-500 mb-2 block">è©æ€§éæ¿¾</label>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="togglePos('n')" class="pos-chip active px-3 py-1.5 rounded-full text-xs" data-pos="n">åè©</button>
                            <button onclick="togglePos('v')" class="pos-chip active px-3 py-1.5 rounded-full text-xs" data-pos="v">å‹•è©</button>
                            <button onclick="togglePos('a')" class="pos-chip active px-3 py-1.5 rounded-full text-xs" data-pos="a">å½¢å®¹è©</button>
                            <button onclick="togglePos('d')" class="pos-chip active px-3 py-1.5 rounded-full text-xs" data-pos="d">å‰¯è©</button>
                            <button onclick="togglePos('o')" class="pos-chip px-3 py-1.5 rounded-full text-xs" data-pos="o">å…¶ä»–</button>
                        </div>
                    </div>
                </div>

                <button id="btn-analyze" onclick="runAnalysis()" class="w-full bg-gradient-to-r from-primary-600 to-indigo-600 hover:from-primary-700 hover:to-indigo-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-primary-200/50 transition transform active:scale-[0.98] flex items-center justify-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> é–‹å§‹ AI åˆ†æ
                </button>

                <div id="result-tabs" class="hidden pt-2">
                    <div class="flex border-b border-slate-200 mb-4">
                        <button onclick="switchTab('ai')" id="tab-ai" class="flex-1 pb-2 text-sm font-bold text-primary-600 border-b-2 border-primary-600">AI æ´å¯Ÿ</button>
                        <button onclick="switchTab('data')" id="tab-data" class="flex-1 pb-2 text-sm font-bold text-slate-400 hover:text-slate-600 border-b-2 border-transparent">æ•¸æ“šåˆ—è¡¨</button>
                    </div>

                    <div id="panel-ai" class="text-sm text-slate-600 leading-relaxed space-y-2 h-[200px] overflow-y-auto scroller">
                        </div>

                    <div id="panel-data" class="hidden h-[200px] overflow-y-auto scroller border border-slate-200 rounded-lg">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 sticky top-0">
                                <tr>
                                    <th class="p-2 border-b pl-4">#</th>
                                    <th class="p-2 border-b">è©å½™</th>
                                    <th class="p-2 border-b">è©æ€§</th>
                                    <th class="p-2 border-b text-right pr-4">æ¬Šé‡</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body" class="bg-white"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </aside>

        <div id="resizer"></div>

        <main class="flex-1 bg-slate-100 relative overflow-hidden flex items-center justify-center" id="main-content">
            
            <div class="absolute inset-0 opacity-5 pointer-events-none" style="background-image: radial-gradient(#6366f1 1px, transparent 1px); background-size: 24px 24px;"></div>

            <div id="canvas-wrapper" class="w-full h-full relative flex items-center justify-center p-4">
                
                <div id="empty-state" class="text-center">
                    <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm">
                        <i class="fa-solid fa-chart-pie text-3xl text-slate-300"></i>
                    </div>
                    <h3 class="text-lg font-bold text-slate-600">æº–å‚™å°±ç·’</h3>
                    <p class="text-slate-400 text-sm mt-1">è«‹åœ¨å·¦å´è¼¸å…¥æ–‡å­—ä¸¦é–‹å§‹åˆ†æ</p>
                </div>

                <div id="loading-state" class="hidden text-center">
                    <div class="loader mx-auto mb-4"></div>
                    <p class="text-primary-600 font-bold animate-pulse">AI æ­£åœ¨æ·±åº¦è§£è®€æ–‡æœ¬...</p>
                    <p class="text-slate-400 text-xs mt-2">æ­£åœ¨é€²è¡Œæ–·è©èˆ‡æ¬Šé‡è¨ˆç®—</p>
                </div>

                <canvas id="word-cloud-canvas" class="hidden shadow-2xl bg-white rounded-2xl"></canvas>
            </div>

            <button onclick="downloadImage()" id="btn-download" class="hidden absolute bottom-8 right-8 bg-white text-slate-700 hover:text-primary-600 hover:bg-primary-50 border border-slate-200 px-5 py-3 rounded-full shadow-lg font-bold transition flex items-center gap-2 z-30">
                <i class="fa-solid fa-download"></i> ä¸‹è¼‰åœ–ç‰‡
            </button>

        </main>
    </div>

    <script>
        // ğŸ”´ğŸ”´ğŸ”´ è«‹åœ¨æ­¤å¡«å…¥æ‚¨éƒ¨ç½²å¾Œçš„ GAS Web App ç¶²å€ ğŸ”´ğŸ”´ğŸ”´
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw3UqYr976wAd9aeEsLpTDSlGaUVdBpaErqZi-zHgNzh_Gd0SuggfdI7ldVzrqR1Ygd/exec"; 

        // å…¨åŸŸè®Šæ•¸
        let currentWords = [];
        let activePos = new Set(['n', 'v', 'a', 'd']); 
        const exampleText = "é›»æµç£æ•ˆæ‡‰æ˜¯æŒ‡é›»æµé€šéå°ç·šæ™‚ï¼Œæœƒåœ¨å°ç·šå‘¨åœç”¢ç”Ÿç£å ´çš„ç¾è±¡ã€‚1820å¹´ï¼Œä¸¹éº¥ç‰©ç†å­¸å®¶å¥§æ–¯ç‰¹ç™¼ç¾ï¼Œç•¶å°ç·šé€šé›»æ™‚ï¼Œæ—é‚Šçš„ç£é‡æœƒç™¼ç”Ÿåè½‰ï¼Œè­‰æ˜äº†é›»èˆ‡ç£ä¹‹é–“æœ‰å¯†åˆ‡çš„é—œä¿‚ã€‚ç£å ´çš„æ–¹å‘å¯ä»¥ç”¨å®‰åŸ¹å³æ‰‹å®šå‰‡ä¾†åˆ¤æ–·ï¼šç”¨å³æ‰‹æ¡ä½å°ç·šï¼Œå¤§æ‹‡æŒ‡æŒ‡å‘é›»æµæ–¹å‘ï¼Œå››æŒ‡å½æ›²çš„æ–¹å‘å°±æ˜¯ç£å ´æ–¹å‘ã€‚è‹¥å°‡å°ç·šç¹æˆèºç·šç®¡ï¼Œé€šé›»å¾Œå…§éƒ¨æœƒç”¢ç”Ÿå‡å‹»ç£å ´ï¼Œå…¶ç‰¹æ€§é¡ä¼¼æ–¼æ¢å½¢ç£éµã€‚";

        // === 1. æ‹–æ‹‰é‚Šç•Œé‚è¼¯ (Resizer) ===
        const resizer = document.getElementById('resizer');
        const sidebar = document.getElementById('sidebar');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            resizer.classList.add('resizing');
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const newWidth = e.clientX;
            if (newWidth > 320 && newWidth < 800) { // è¨­å®šæœ€å°æœ€å¤§å¯¬åº¦
                sidebar.style.width = `${newWidth}px`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = 'default';
                resizer.classList.remove('resizing');
                // æ‹–æ‹‰çµæŸå¾Œï¼Œå¦‚æœæ–‡å­—é›²å­˜åœ¨ï¼Œé‡æ–°ç¹ªè£½ä»¥é©æ‡‰æ–°å¯¬åº¦
                if(currentWords.length > 0) renderWordCloud();
            }
        });

        // === 2. UI æ“ä½œ ===
        function loadExample() { document.getElementById('text-input').value = exampleText; }

        function clearInput() {
            document.getElementById('text-input').value = '';
            document.getElementById('result-tabs').classList.add('hidden');
            document.getElementById('word-cloud-canvas').classList.add('hidden');
            document.getElementById('btn-download').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
        }

        function togglePos(pos) {
            const btn = document.querySelector(`button[data-pos="${pos}"]`);
            if (activePos.has(pos)) {
                activePos.delete(pos);
                btn.classList.remove('active');
            } else {
                activePos.add(pos);
                btn.classList.add('active');
            }
            if (currentWords.length > 0) renderWordCloud();
        }

        function switchTab(tab) {
            const tabAi = document.getElementById('tab-ai');
            const tabData = document.getElementById('tab-data');
            const panelAi = document.getElementById('panel-ai');
            const panelData = document.getElementById('panel-data');

            if (tab === 'ai') {
                tabAi.className = "flex-1 pb-2 text-sm font-bold text-primary-600 border-b-2 border-primary-600 transition";
                tabData.className = "flex-1 pb-2 text-sm font-bold text-slate-400 hover:text-slate-600 border-b-2 border-transparent transition";
                panelAi.classList.remove('hidden');
                panelData.classList.add('hidden');
            } else {
                tabAi.className = "flex-1 pb-2 text-sm font-bold text-slate-400 hover:text-slate-600 border-b-2 border-transparent transition";
                tabData.className = "flex-1 pb-2 text-sm font-bold text-primary-600 border-b-2 border-primary-600 transition";
                panelAi.classList.add('hidden');
                panelData.classList.remove('hidden');
            }
        }

        // === 3. åˆ†ææ ¸å¿ƒ (API å‘¼å«) ===
        function runAnalysis() {
            const text = document.getElementById('text-input').value.trim();
            const model = document.getElementById('model-select').value;
            const btn = document.getElementById('btn-analyze');

            if (!text) { alert("è«‹å…ˆè¼¸å…¥æ–‡æœ¬"); return; }
            if (GAS_URL.includes("åœ¨æ­¤å¡«å…¥")) { alert("è«‹å…ˆè¨­å®š GAS URL"); return; }

            const orgBtnHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="loader w-4 h-4 border-2 border-white/30 border-t-white mr-2"></div> åˆ†æä¸­...`;
            
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('word-cloud-canvas').classList.add('hidden');
            document.getElementById('btn-download').classList.add('hidden');
            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('result-tabs').classList.add('hidden');

            const payload = { text: text, mode: model };

            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: { "Content-Type": "text/plain;charset=utf-8" }
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    currentWords = data.data.wordList;
                    document.getElementById('panel-ai').innerHTML = data.data.aiAnalysis;
                    renderTable(data.data.wordList);
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('result-tabs').classList.remove('hidden');
                    renderWordCloud();
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(err => {
                console.error(err);
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('empty-state').innerHTML = `<div class="text-red-500 font-bold mb-2">ç™¼ç”ŸéŒ¯èª¤</div><p class="text-sm text-red-400">${err.message}</p>`;
                btn.disabled = false;
                btn.innerHTML = orgBtnHtml;
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = orgBtnHtml;
            });
        }

        // === 4. æ–‡å­—é›²ç¹ªè£½ (ä¿®å¾©ç‰ˆ) ===
        function renderWordCloud() {
            const canvas = document.getElementById('word-cloud-canvas');
            const wrapper = document.getElementById('canvas-wrapper');
            const shape = document.getElementById('shape-select').value;

            // éæ¿¾è³‡æ–™
            const filteredList = currentWords.filter(item => {
                const p = (item.pos || 'o').toLowerCase().charAt(0);
                const type = ['n','v','a','d'].includes(p) ? p : 'o';
                return activePos.has(type);
            });

            if (filteredList.length === 0) {
                alert("ç¯©é¸å¾Œç„¡è©å½™å¯é¡¯ç¤º");
                return;
            }

            canvas.classList.remove('hidden');
            document.getElementById('btn-download').classList.remove('hidden');
            
            // ğŸ”´ é—œéµä¿®å¾©ï¼šå–å¾—å¯¦éš›å¯ç”¨çš„å¯¬é«˜ (æ‰£é™¤ Padding)
            // è®“ Canvas å¡«æ»¿å®¹å™¨ï¼Œä½†ç•™ä¸€é»é‚Šè·
            const w = wrapper.clientWidth - 40; 
            const h = wrapper.clientHeight - 40;
            canvas.width = w;
            canvas.height = h;

            // è¨ˆç®—æ¬Šé‡ç¸®æ”¾
            const maxWeight = Math.max(...filteredList.map(i => i.weight)) || 1;
            // å­—é«”å¤§å°å…¬å¼ï¼š(ç›®å‰æ¬Šé‡ / æœ€å¤§æ¬Šé‡) * (ç•«å¸ƒåŸºæº–å°ºå¯¸) + æœ€å°å­—é«”
            // è®“å­—é«”éš¨ç•«å¸ƒå¤§å° RWD ç¸®æ”¾
            const baseSize = w / 15; 
            
            const list = filteredList.map(i => {
                // ç¢ºä¿å­—é«”å¤§å°åœ¨ 12px ~ baseSize*2 ä¹‹é–“
                const size = (i.weight / maxWeight) * baseSize + 12;
                return [i.word, size];
            });

            // ç¢ºä¿ DOM æ›´æ–°å¾Œå†ç¹ªåœ–
            setTimeout(() => {
                // å…ˆæ¸…é™¤èˆŠåœ–
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, w, h);

                WordCloud(canvas, {
                    list: list,
                    gridSize: 10,
                    weightFactor: 1, // æˆ‘å€‘å·²ç¶“æ‰‹å‹•è¨ˆç®— size äº†ï¼Œé€™è£¡è¨­ 1
                    fontFamily: '"Noto Sans TC", sans-serif',
                    fontWeight: 'bold',
                    color: function (word) {
                        const item = currentWords.find(i => i.word === word);
                        return getPosColor(item ? item.pos : 'o');
                    },
                    rotateRatio: 0.2,
                    rotationSteps: 2,
                    shape: shape,
                    backgroundColor: 'white', // è¨­ç‚ºç™½è‰²èƒŒæ™¯ï¼Œé¿å…ä¸‹è¼‰è®Šé»‘
                    drawOutOfBound: false,
                    shrinkToFit: true,
                    shuffle: false
                });
            }, 50);
        }

        function getPosColor(pos) {
            const p = String(pos).toLowerCase();
            if (p.startsWith('n')) return '#4f46e5'; // Indigo
            if (p.startsWith('v')) return '#059669'; // Emerald
            if (p.startsWith('a')) return '#d97706'; // Amber
            if (p.startsWith('d')) return '#9333ea'; // Purple
            return '#64748b'; // Slate
        }

        function renderTable(list) {
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = list.slice(0, 100).map((item, idx) => `
                <tr class="border-b border-slate-100 hover:bg-slate-50 transition">
                    <td class="p-2 pl-4 text-slate-400 text-xs">${idx + 1}</td>
                    <td class="p-2 font-medium text-slate-700">${item.word}</td>
                    <td class="p-2"><span class="px-2 py-0.5 rounded text-xs font-bold text-white" style="background-color: ${getPosColor(item.pos)}">${item.pos}</span></td>
                    <td class="p-2 pr-4 text-right font-mono text-slate-600">${item.weight.toFixed(1)}</td>
                </tr>
            `).join('');
        }

        function downloadImage() {
            const canvas = document.getElementById('word-cloud-canvas');
            const link = document.createElement('a');
            link.download = `wordcloud_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
        
        // ç›£è½å½¢ç‹€/æ¨¡å¼æ”¹è®Šè‡ªå‹•é‡ç¹ª
        document.getElementById('shape-select').addEventListener('change', () => {
            if(currentWords.length > 0) renderWordCloud();
        });
        
        // ç›£è½è¦–çª—å¤§å°æ”¹è®Šé‡ç¹ª (RWD)
        window.addEventListener('resize', () => {
             if(currentWords.length > 0) {
                 // é˜²æŠ–å‹• (Debounce)
                 clearTimeout(window.resizeTimer);
                 window.resizeTimer = setTimeout(renderWordCloud, 300);
             }
        });
    </script>
</body>
</html>
