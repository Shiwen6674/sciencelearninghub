<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½æ–‡å­—é›²åˆ†æ | Science Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud2.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        research: { 50: '#f5f3ff', 100: '#ede9fe', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9' },
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'Roboto', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .pos-tag.active { box-shadow: 0 2px 5px rgba(0,0,0,0.1); transform: translateY(-1px); border-color: currentColor; }
        .pos-tag.inactive { opacity: 0.5; background-color: #f1f5f9 !important; color: #94a3b8 !important; border-color: #e2e8f0; }
        .loader { border: 3px solid rgba(139, 92, 246, 0.3); border-radius: 50%; border-top: 3px solid #7c3aed; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <header class="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center z-20 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-research-100 p-2 rounded-lg text-research-700"><i class="fa-solid fa-cloud text-xl"></i></div>
            <h1 class="text-xl font-bold text-slate-800 tracking-tight" data-i18n="app_title">AI æ™ºèƒ½æ–‡å­—é›²åˆ†æ</h1>
        </div>
        <div class="flex items-center gap-3">
            <select id="language-selector" onchange="changeLanguage()" class="bg-slate-50 border border-slate-200 text-sm rounded-md p-1.5 focus:ring-research-500 outline-none">
                <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                <option value="en">English</option>
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
            </select>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-1/3 min-w-[350px] bg-white border-r border-slate-200 flex flex-col overflow-y-auto p-6 z-10 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
            <div class="mb-6">
                <label class="block text-sm font-bold text-slate-700 mb-2 flex justify-between items-center">
                    <span data-i18n="label_text">åˆ†ææ–‡æœ¬</span>
                    <div class="flex gap-2">
                        <button onclick="loadExample()" class="text-xs bg-research-50 text-research-600 px-2 py-1 rounded hover:bg-research-100 transition border border-research-200">
                            <i class="fa-solid fa-wand-magic-sparkles mr-1"></i><span data-i18n="btn_example">è¼‰å…¥ç¯„ä¾‹</span>
                        </button>
                        <button onclick="clearText()" class="text-xs text-slate-400 hover:text-red-500 transition">
                            <i class="fa-solid fa-trash-can mr-1"></i><span data-i18n="btn_clear">æ¸…ç©º</span>
                        </button>
                    </div>
                </label>
                <textarea id="text-input" class="w-full h-48 p-4 border border-slate-300 rounded-xl text-sm leading-relaxed resize-none focus:ring-2 focus:ring-research-500 outline-none transition bg-slate-50" placeholder="è«‹è²¼ä¸Šæ‚¨è¦åˆ†æçš„æ–‡ç« æˆ–æ®µè½..."></textarea>
            </div>

            <div class="mb-6 space-y-4">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider" data-i18n="label_settings">åˆ†æåƒæ•¸è¨­å®š</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1" data-i18n="label_model">æ¬Šé‡æ¨¡å‹</label>
                        <select id="model-select" class="w-full p-2 border border-slate-300 rounded-lg text-sm focus:ring-research-500 bg-white">
                            <option value="frequency" data-i18n="opt_freq">è©é » (Frequency)</option>
                            <option value="tfidf" data-i18n="opt_tfidf">TF-IDF (æ¨¡æ“¬)</option>
                            <option value="textrank" data-i18n="opt_textrank">TextRank</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1" data-i18n="label_shape">æ–‡å­—é›²å½¢ç‹€</label>
                        <select id="shape-select" class="w-full p-2 border border-slate-300 rounded-lg text-sm focus:ring-research-500 bg-white">
                            <option value="circle" data-i18n="shape_circle">åœ“å½¢</option>
                            <option value="square" data-i18n="shape_square">æ–¹å½¢</option>
                            <option value="cardioid" data-i18n="shape_heart">å¿ƒå½¢</option>
                            <option value="star" data-i18n="shape_star">æ˜Ÿå½¢</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-600 mb-2" data-i18n="label_pos_filter">è©æ€§éæ¿¾ & è‘—è‰²</label>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="togglePos('n')" class="pos-tag active px-3 py-1 rounded-full text-xs font-bold bg-blue-50 text-blue-600 border-blue-200" data-pos="n">åè© (N)</button>
                        <button onclick="togglePos('v')" class="pos-tag active px-3 py-1 rounded-full text-xs font-bold bg-green-50 text-green-600 border-green-200" data-pos="v">å‹•è© (V)</button>
                        <button onclick="togglePos('a')" class="pos-tag active px-3 py-1 rounded-full text-xs font-bold bg-amber-50 text-amber-600 border-amber-200" data-pos="a">å½¢å®¹è© (A)</button>
                        <button onclick="togglePos('d')" class="pos-tag active px-3 py-1 rounded-full text-xs font-bold bg-purple-50 text-purple-600 border-purple-200" data-pos="d">å‰¯è© (D)</button>
                    </div>
                </div>
            </div>

            <div class="mt-auto">
                <button id="btn-analyze" onclick="runAnalysis()" class="w-full bg-research-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-research-200 hover:bg-research-700 transition transform active:scale-[0.98] flex items-center justify-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> <span data-i18n="btn_analyze">é–‹å§‹ AI åˆ†æ</span>
                </button>
            </div>
        </aside>

        <main class="w-2/3 flex flex-col bg-slate-50 relative">
            <div class="h-3/5 p-6 relative">
                <div id="canvas-wrapper" class="w-full h-full bg-white rounded-3xl border border-slate-200 shadow-sm flex items-center justify-center overflow-hidden relative">
                    <div id="empty-state" class="text-center text-slate-400">
                        <i class="fa-solid fa-chart-simple text-4xl mb-3 opacity-50"></i>
                        <p data-i18n="msg_waiting">ç­‰å¾…åˆ†æ...</p>
                    </div>
                    <canvas id="word-cloud-canvas" class="hidden"></canvas>
                </div>
                <button onclick="downloadImage()" id="btn-download" class="hidden absolute top-10 right-10 bg-white/80 backdrop-blur p-2 rounded-lg border border-slate-200 shadow-sm text-slate-500 hover:text-research-600 transition" title="ä¸‹è¼‰åœ–ç‰‡"><i class="fa-solid fa-download"></i></button>
            </div>

            <div class="h-2/5 px-6 pb-6 flex flex-col">
                <div class="flex gap-4 mb-0 border-b border-slate-200 px-2">
                    <button onclick="switchTab('ai')" id="tab-ai" class="pb-3 px-4 text-sm font-bold text-research-700 border-b-2 border-research-600 transition">AI æ·±åº¦æ´å¯Ÿ</button>
                    <button onclick="switchTab('data')" id="tab-data" class="pb-3 px-4 text-sm font-bold text-slate-500 border-b-2 border-transparent hover:text-slate-700 transition">æ•¸æ“šåˆ—è¡¨</button>
                </div>

                <div class="bg-white flex-1 rounded-b-3xl rounded-tr-3xl border border-slate-200 border-t-0 p-6 overflow-y-auto shadow-sm scrollbar-thin">
                    <div id="panel-ai" class="animate-fade-in-up">
                        <div id="ai-content" class="text-slate-600 text-sm leading-relaxed space-y-4">
                            <p class="text-slate-400 italic" data-i18n="msg_ai_placeholder">AI åˆ†æå ±å‘Šå°‡åœ¨æ­¤è™•é¡¯ç¤º...</p>
                        </div>
                    </div>
                    <div id="panel-data" class="hidden animate-fade-in-up">
                        <table class="w-full text-left text-sm border-collapse">
                            <thead>
                                <tr class="text-slate-500 border-b border-slate-100">
                                    <th class="pb-2 pl-2">#</th>
                                    <th class="pb-2" data-i18n="col_word">è©å½™</th>
                                    <th class="pb-2" data-i18n="col_pos">è©æ€§</th>
                                    <th class="pb-2 text-right" data-i18n="col_weight">æ¬Šé‡</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body" class="text-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ğŸ”´ è«‹å‹™å¿…é‡æ–°éƒ¨ç½² GASï¼Œä¸¦å°‡æ–°çš„ç¶²å€è²¼åœ¨é€™è£¡ (çµå°¾æ˜¯ /exec)
        // ç¯„ä¾‹ï¼š "https://script.google.com/macros/s/AKfycb.../exec"
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw3UqYr976wAd9aeEsLpTDSlGaUVdBpaErqZi-zHgNzh_Gd0SuggfdI7ldVzrqR1Ygd/exec"; 
        
        // æ ¸å¿ƒè®Šæ•¸
        let currentWords = [];
        let activePos = new Set(['n', 'v', 'a', 'd', 'o']);
        let currentLang = 'zh-TW';

        const EXAMPLE_TEXTS = {
            "zh-TW": "é›»æµç£æ•ˆæ‡‰æ˜¯æŒ‡é›»æµé€šéå°ç·šæ™‚ï¼Œæœƒåœ¨å°ç·šå‘¨åœç”¢ç”Ÿç£å ´çš„ç¾è±¡ã€‚1820å¹´ï¼Œä¸¹éº¥ç‰©ç†å­¸å®¶å¥§æ–¯ç‰¹ç™¼ç¾ï¼Œç•¶å°ç·šé€šé›»æ™‚ï¼Œæ—é‚Šçš„ç£é‡æœƒç™¼ç”Ÿåè½‰ï¼Œè­‰æ˜äº†é›»èˆ‡ç£ä¹‹é–“æœ‰å¯†åˆ‡çš„é—œä¿‚ã€‚ç£å ´çš„æ–¹å‘å¯ä»¥ç”¨å®‰åŸ¹å³æ‰‹å®šå‰‡ä¾†åˆ¤æ–·ï¼šç”¨å³æ‰‹æ¡ä½å°ç·šï¼Œå¤§æ‹‡æŒ‡æŒ‡å‘é›»æµæ–¹å‘ï¼Œå››æŒ‡å½æ›²çš„æ–¹å‘å°±æ˜¯ç£å ´æ–¹å‘ã€‚è‹¥å°‡å°ç·šç¹æˆèºç·šç®¡ï¼Œé€šé›»å¾Œå…§éƒ¨æœƒç”¢ç”Ÿå‡å‹»ç£å ´ï¼Œå…¶ç‰¹æ€§é¡ä¼¼æ–¼æ¢å½¢ç£éµã€‚",
            "en": "Electromagnetism is a branch of physics involving the study of the electromagnetic force. In 1820, Danish physicist Hans Christian Ã˜rsted discovered that an electric current creates a magnetic field. This connection between electricity and magnetism is known as the magnetic effect of electric current.",
            "ja": "é›»æµã®ç£æ°—ä½œç”¨ã¨ã¯ã€å°ç·šã«é›»æµãŒæµã‚Œã‚‹ã¨ã€ãã®å‘¨å›²ã«ç£å ´ãŒç™ºç”Ÿã™ã‚‹ç¾è±¡ã®ã“ã¨ã§ã™ã€‚1820å¹´ã€ãƒ‡ãƒ³ãƒãƒ¼ã‚¯ã®ç‰©ç†å­¦è€…ã‚¨ãƒ«ã‚¹ãƒ†ãƒƒãƒ‰ã¯ã€å°ç·šã«é€šé›»ã™ã‚‹ã¨è¿‘ãã®æ–¹ä½ç£é‡ãŒæŒ¯ã‚Œã‚‹ã“ã¨ã‚’ç™ºè¦‹ã—ã€é›»æ°—ã¨ç£æ°—ã«ã¯å¯†æ¥ãªé–¢ä¿‚ãŒã‚ã‚‹ã“ã¨ã‚’è¨¼æ˜ã—ã¾ã—ãŸã€‚",
            "zh-CN": "ç”µæµç£æ•ˆåº”æ˜¯æŒ‡ç”µæµé€šè¿‡å¯¼çº¿æ—¶ï¼Œä¼šåœ¨å¯¼çº¿å‘¨å›´äº§ç”Ÿç£åœºçš„ç°è±¡ã€‚1820å¹´ï¼Œä¸¹éº¦ç‰©ç†å­¦å®¶å¥¥æ–¯ç‰¹å‘ç°ï¼Œå½“å¯¼çº¿é€šç”µæ—¶ï¼Œæ—è¾¹çš„ç£é’ˆä¼šå‘ç”Ÿåè½¬ï¼Œè¯æ˜äº†ç”µä¸ç£ä¹‹é—´æœ‰å¯†åˆ‡çš„å…³ç³»ã€‚"
        };

        const translations = {
            "zh-TW": { "app_title": "AI æ™ºèƒ½æ–‡å­—é›²åˆ†æ", "label_text": "åˆ†ææ–‡æœ¬", "label_settings": "åˆ†æåƒæ•¸è¨­å®š", "label_model": "æ¬Šé‡æ¨¡å‹", "opt_freq": "è©é » (Frequency)", "opt_tfidf": "TF-IDF (æ¨¡æ“¬)", "opt_textrank": "TextRank", "label_shape": "æ–‡å­—é›²å½¢ç‹€", "shape_circle": "åœ“å½¢", "shape_square": "æ–¹å½¢", "shape_heart": "å¿ƒå½¢", "shape_star": "æ˜Ÿå½¢", "label_pos_filter": "è©æ€§éæ¿¾ & è‘—è‰²", "btn_analyze": "é–‹å§‹ AI åˆ†æ", "btn_example": "è¼‰å…¥ç¯„ä¾‹", "btn_clear": "æ¸…ç©º", "msg_waiting": "ç­‰å¾…åˆ†æ...", "msg_ai_placeholder": "AI åˆ†æå ±å‘Šå°‡åœ¨æ­¤è™•é¡¯ç¤º...", "col_word": "è©å½™", "col_pos": "è©æ€§", "col_weight": "æ¬Šé‡", "status_analyzing": "AI æ­£åœ¨è§£è®€æ–‡æœ¬...", "err_input": "è«‹å…ˆè¼¸å…¥æ–‡æœ¬ï¼" },
            "en": { "app_title": "AI Word Cloud", "label_text": "Input Text", "label_settings": "Settings", "label_model": "Model", "opt_freq": "Frequency", "opt_tfidf": "TF-IDF", "opt_textrank": "TextRank", "label_shape": "Shape", "shape_circle": "Circle", "shape_square": "Square", "shape_heart": "Heart", "shape_star": "Star", "label_pos_filter": "POS Filter", "btn_analyze": "Analyze", "btn_example": "Example", "btn_clear": "Clear", "msg_waiting": "Waiting...", "msg_ai_placeholder": "AI report here...", "col_word": "Word", "col_pos": "POS", "col_weight": "Weight", "status_analyzing": "Analyzing...", "err_input": "Input text required!" },
            "ja": { "app_title": "AI ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰", "label_text": "ãƒ†ã‚­ã‚¹ãƒˆ", "label_settings": "è¨­å®š", "label_model": "ãƒ¢ãƒ‡ãƒ«", "opt_freq": "é »åº¦", "opt_tfidf": "TF-IDF", "opt_textrank": "TextRank", "label_shape": "å½¢çŠ¶", "shape_circle": "å††å½¢", "shape_square": "å››è§’", "shape_heart": "ãƒãƒ¼ãƒˆ", "shape_star": "æ˜Ÿ", "label_pos_filter": "å“è©", "btn_analyze": "åˆ†æé–‹å§‹", "btn_example": "ä¾‹æ–‡", "btn_clear": "ã‚¯ãƒªã‚¢", "msg_waiting": "å¾…æ©Ÿä¸­...", "msg_ai_placeholder": "AIãƒ¬ãƒãƒ¼ãƒˆ...", "col_word": "å˜èª", "col_pos": "å“è©", "col_weight": "é‡ã¿", "status_analyzing": "åˆ†æä¸­...", "err_input": "ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" },
            "zh-CN": { "app_title": "AI æ™ºèƒ½æ–‡å­—äº‘", "label_text": "åˆ†ææ–‡æœ¬", "label_settings": "å‚æ•°è®¾ç½®", "label_model": "æƒé‡æ¨¡å‹", "opt_freq": "è¯é¢‘", "opt_tfidf": "TF-IDF", "opt_textrank": "TextRank", "label_shape": "å½¢çŠ¶", "shape_circle": "åœ†å½¢", "shape_square": "æ–¹å½¢", "shape_heart": "å¿ƒå½¢", "shape_star": "æ˜Ÿå½¢", "label_pos_filter": "è¯æ€§è¿‡æ»¤", "btn_analyze": "å¼€å§‹åˆ†æ", "btn_example": "èŒƒä¾‹", "btn_clear": "æ¸…ç©º", "msg_waiting": "ç­‰å¾…åˆ†æ...", "msg_ai_placeholder": "AI æŠ¥å‘Š...", "col_word": "è¯æ±‡", "col_pos": "è¯æ€§", "col_weight": "æƒé‡", "status_analyzing": "è§£è¯»ä¸­...", "err_input": "è¯·è¾“å…¥æ–‡æœ¬ï¼" }
        };

        function changeLanguage() {
            currentLang = document.getElementById('language-selector').value;
            const t = translations[currentLang] || translations['zh-TW'];
            document.querySelectorAll('[data-i18n]').forEach(el => { el.innerText = t[el.getAttribute('data-i18n')]; });
        }

        function loadExample() { document.getElementById('text-input').value = EXAMPLE_TEXTS[currentLang] || EXAMPLE_TEXTS['zh-TW']; }
        function clearText() { document.getElementById('text-input').value = ''; }
        function togglePos(pos) {
            const btn = document.querySelector(`button[data-pos="${pos}"]`);
            if (activePos.has(pos)) { activePos.delete(pos); btn.classList.remove('active'); btn.classList.add('inactive'); }
            else { activePos.add(pos); btn.classList.add('active'); btn.classList.remove('inactive'); }
            if (currentWords.length > 0) renderWordCloud();
        }
        function switchTab(tab) {
            document.getElementById('tab-ai').className = tab === 'ai' ? "pb-3 px-4 text-sm font-bold text-research-700 border-b-2 border-research-600 transition" : "pb-3 px-4 text-sm font-bold text-slate-500 border-b-2 border-transparent hover:text-slate-700 transition";
            document.getElementById('tab-data').className = tab === 'data' ? "pb-3 px-4 text-sm font-bold text-research-700 border-b-2 border-research-600 transition" : "pb-3 px-4 text-sm font-bold text-slate-500 border-b-2 border-transparent hover:text-slate-700 transition";
            document.getElementById('panel-ai').classList.toggle('hidden', tab !== 'ai');
            document.getElementById('panel-data').classList.toggle('hidden', tab !== 'data');
        }

        function runAnalysis() {
            const text = document.getElementById('text-input').value.trim();
            const model = document.getElementById('model-select').value;
            const btn = document.getElementById('btn-analyze');
            const t = translations[currentLang];

            if (!text) { alert(t.err_input); return; }
            if (GAS_URL.includes("åœ¨æ­¤å¡«å…¥")) { alert("è«‹å…ˆè¨­å®š GAS API ç¶²å€ï¼"); return; }

            const originalBtnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="loader mr-2"></div> ${t.status_analyzing}`;
            
            document.getElementById('word-cloud-canvas').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('empty-state').innerHTML = `<div class="loader mx-auto mb-2"></div><p class="animate-pulse">${t.status_analyzing}</p>`;
            document.getElementById('ai-content').innerHTML = `<p class="text-slate-400 italic">${t.status_analyzing}</p>`;

            const payload = { text: text, mode: model };

            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: { "Content-Type": "text/plain;charset=utf-8" }
            })
            .then(response => response.json())
            .then(res => {
                if (res.status === 'success') {
                    currentWords = res.data.wordList;
                    document.getElementById('ai-content').innerHTML = res.data.aiAnalysis || "<p>ç„¡åˆ†æçµæœ</p>";
                    renderWordCloud();
                    renderTable();
                } else {
                    throw new Error(res.message || "æœªçŸ¥éŒ¯èª¤");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('empty-state').innerHTML = `<p class="text-red-500 text-sm p-4"><i class="fa-solid fa-triangle-exclamation"></i> åˆ†æå¤±æ•—: ${error.message}<br>è«‹æª¢æŸ¥ GAS éƒ¨ç½²æ¬Šé™æ˜¯å¦ç‚ºã€Œä»»ä½•äººã€</p>`;
                document.getElementById('ai-content').innerHTML = `<p class="text-red-500">é€£ç·šéŒ¯èª¤ã€‚</p>`;
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            });
        }

        function renderWordCloud() {
            const canvas = document.getElementById('word-cloud-canvas');
            const wrapper = document.getElementById('canvas-wrapper');
            const shape = document.getElementById('shape-select').value;
            
            const filteredList = currentWords.filter(item => {
                let cat = 'o';
                const p = String(item.pos).toLowerCase();
                if (p.startsWith('n')) cat = 'n';
                else if (p.startsWith('v')) cat = 'v';
                else if (p.startsWith('a')) cat = 'a';
                else if (p.startsWith('d')) cat = 'd';
                return activePos.has(cat);
            });

            if (filteredList.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('empty-state').innerHTML = "<p>ç„¡ç¬¦åˆæ¢ä»¶çš„è©å½™</p>";
                canvas.classList.add('hidden');
                return;
            }

            document.getElementById('empty-state').classList.add('hidden');
            canvas.classList.remove('hidden');
            document.getElementById('btn-download').classList.remove('hidden');

            const w = wrapper.clientWidth || 600;
            const h = wrapper.clientHeight || 400;
            canvas.width = w;
            canvas.height = h;

            const maxWeight = Math.max(...filteredList.map(i => i.weight)) || 1;
            const list = filteredList.map(i => [i.word, i.weight]);

            setTimeout(() => {
                WordCloud(canvas, {
                    list: list,
                    gridSize: 12,
                    weightFactor: function (size) { return (size / maxWeight) * (w / 10) + 12; },
                    fontFamily: 'Noto Sans TC, sans-serif',
                    color: function (word) {
                        const item = currentWords.find(w => w.word === word);
                        return item ? getPosColor(item.pos) : '#333';
                    },
                    rotateRatio: 0.2,
                    rotationSteps: 2,
                    shape: shape,
                    backgroundColor: 'transparent',
                    drawOutOfBound: false,
                    shrinkToFit: true
                });
            }, 100);
        }

        function getPosColor(pos) {
            const p = String(pos).toLowerCase();
            if (p.startsWith('n')) return '#3b82f6';
            if (p.startsWith('v')) return '#10b981';
            if (p.startsWith('a')) return '#f59e0b';
            if (p.startsWith('d')) return '#8b5cf6';
            return '#94a3b8';
        }

        function renderTable() {
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = currentWords.slice(0, 50).map((item, idx) => `
                <tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="py-2 pl-2 text-slate-400 text-xs">${idx + 1}</td>
                    <td class="py-2 font-medium text-slate-700">${item.word}</td>
                    <td class="py-2"><span class="px-2 py-0.5 rounded text-xs font-bold text-white" style="background-color: ${getPosColor(item.pos)}">${item.pos}</span></td>
                    <td class="py-2 text-right font-mono text-slate-600">${item.weight}</td>
                </tr>
            `).join('');
        }

        function downloadImage() {
            const canvas = document.getElementById('word-cloud-canvas');
            const link = document.createElement('a');
            link.download = 'ai-wordcloud.png';
            link.href = canvas.toDataURL();
            link.click();
        }
    </script>
</body>
</html>
