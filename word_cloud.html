<script>
    // ğŸ”´ è«‹é‡æ–°éƒ¨ç½² GAS å¾Œï¼Œå°‡æ–°çš„ç¶²å€è²¼åœ¨é€™è£¡
    const GAS_URL = "https://script.google.com/macros/s/AKfycbw3UqYr976wAd9aeEsLpTDSlGaUVdBpaErqZi-zHgNzh_Gd0SuggfdI7ldVzrqR1Ygd/exec"; 
    
    // ... (Tailwind Config é‚£äº›è¨­å®šä¿æŒä¸è®Š) ...

    // æ ¸å¿ƒè®Šæ•¸
    let currentWords = [];
    let activePos = new Set(['n', 'v', 'a', 'd', 'o']);
    let currentLang = 'zh-TW';

    // ... (translations, changeLanguage, loadExample, clearText, togglePos, switchTab å‡½å¼ä¿æŒä¸è®Š) ...

    // åŸ·è¡Œåˆ†æ
    function runAnalysis() {
        const text = document.getElementById('text-input').value.trim();
        const model = document.getElementById('model-select').value;
        const btn = document.getElementById('btn-analyze');
        
        if (!text) { alert("è«‹å…ˆè¼¸å…¥æ–‡æœ¬ï¼"); return; }
        if (GAS_URL.includes("ä½ çš„æ–°éƒ¨ç½²ç¶²å€")) { alert("è«‹å…ˆè¨­å®š GAS API ç¶²å€ï¼"); return; }

        // UI ç‹€æ…‹åˆ‡æ›
        const originalBtnText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<div class="loader mr-2"></div> AI æ­£åœ¨é‹ç®—...`;
        
        document.getElementById('word-cloud-canvas').classList.add('hidden');
        document.getElementById('empty-state').classList.remove('hidden');
        document.getElementById('empty-state').innerHTML = `<div class="loader mx-auto mb-2"></div><p class="animate-pulse">AI æ­£åœ¨åŠªåŠ›é–±è®€æ‚¨çš„æ–‡ç« ...</p>`;
        document.getElementById('ai-content').innerHTML = `<p class="text-slate-400 italic">åˆ†æä¸­...</p>`;

        const payload = { text: text, mode: model };

        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { "Content-Type": "text/plain;charset=utf-8" } // é¿å… CORS
        })
        .then(response => response.json())
        .then(res => {
            if (res.status === 'success') {
                currentWords = res.data.wordList;
                
                // é¡¯ç¤º AI åˆ†æ
                document.getElementById('ai-content').innerHTML = res.data.aiAnalysis;
                
                // æ¸²æŸ“
                renderWordCloud();
                renderTable();
            } else {
                throw new Error(res.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('empty-state').innerHTML = `<p class="text-red-500"><i class="fa-solid fa-triangle-exclamation"></i> éŒ¯èª¤: ${error.message}</p>`;
            document.getElementById('ai-content').innerHTML = `<p class="text-red-500">é€£ç·šéŒ¯èª¤ã€‚</p>`;
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalBtnText;
        });
    }

    // ğŸ”´ é—œéµä¿®æ­£ï¼šæ–‡å­—é›²æ¸²æŸ“é‚è¼¯
    function renderWordCloud() {
        const canvas = document.getElementById('word-cloud-canvas');
        const wrapper = document.getElementById('canvas-wrapper');
        const shape = document.getElementById('shape-select').value;
        
        // 1. éæ¿¾è©æ€§
        const filteredList = currentWords.filter(item => {
            let cat = 'o';
            const p = item.pos.toLowerCase();
            if (p.startsWith('n')) cat = 'n';
            else if (p.startsWith('v')) cat = 'v';
            else if (p.startsWith('a')) cat = 'a';
            else if (p.startsWith('d')) cat = 'd';
            return activePos.has(cat);
        });

        if (filteredList.length === 0) {
            document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('empty-state').innerHTML = "<p>ç„¡ç¬¦åˆæ¢ä»¶çš„è©å½™</p>";
            canvas.classList.add('hidden');
            return;
        }

        // 2. é¡¯ç¤º Canvas
        document.getElementById('empty-state').classList.add('hidden');
        canvas.classList.remove('hidden');
        document.getElementById('btn-download').classList.remove('hidden');

        // 3. è¨­å®š Canvas å¤§å° (RWD)
        canvas.width = wrapper.clientWidth;
        canvas.height = wrapper.clientHeight;

        // 4. æº–å‚™æ•¸æ“šçµ¦ wordcloud2.js
        // ç‚ºäº†é¿å…å­—é«”å¤ªå°ï¼Œæˆ‘å€‘æ‰¾å‡ºæœ€å¤§æ¬Šé‡ä¾†åšæ­£è¦åŒ–
        const maxWeight = Math.max(...filteredList.map(i => i.weight));
        const list = filteredList.map(i => [i.word, i.weight]);

        WordCloud(canvas, {
            list: list,
            gridSize: 16, // å­—è·åŠ å¤§ä¸€é»ï¼Œé¿å…é‡ç–Š
            weightFactor: function (size) { 
                // ğŸ”´ å‹•æ…‹è¨ˆç®—å­—é«”å¤§å°ï¼šæœ€å° 12pxï¼Œæœ€å¤§éš¨ç•«å¸ƒå¯¬åº¦èª¿æ•´
                return (size / maxWeight) * (canvas.width / 8) + 12; 
            },
            fontFamily: 'Noto Sans TC, sans-serif',
            color: function (word, weight) {
                const item = currentWords.find(w => w.word === word);
                return item ? getPosColor(item.pos) : '#333';
            },
            rotateRatio: 0.3, 
            rotationSteps: 2,
            shape: shape,
            backgroundColor: 'transparent',
            drawOutOfBound: false,
            shrinkToFit: true // å¦‚æœå­—å¤ªå¤šï¼Œè‡ªå‹•ç¸®å°
        });
    }

    // è¼”åŠ©ï¼šé¡è‰²å°ç…§
    function getPosColor(pos) {
        const p = pos.toLowerCase();
        if (p.startsWith('n')) return '#3b82f6'; // è—
        if (p.startsWith('v')) return '#10b981'; // ç¶ 
        if (p.startsWith('a')) return '#f59e0b'; // é»ƒ
        if (p.startsWith('d')) return '#8b5cf6'; // ç´«
        return '#94a3b8'; // ç°
    }

    // è¼”åŠ©ï¼šè¡¨æ ¼æ¸²æŸ“
    function renderTable() {
        const tbody = document.getElementById('data-table-body');
        tbody.innerHTML = currentWords.slice(0, 50).map((item, idx) => `
            <tr class="border-b border-slate-100 hover:bg-slate-50">
                <td class="py-2 pl-2 text-slate-400 text-xs">${idx + 1}</td>
                <td class="py-2 font-medium text-slate-700">${item.word}</td>
                <td class="py-2"><span class="px-2 py-0.5 rounded text-xs font-bold text-white" style="background-color: ${getPosColor(item.pos)}">${item.pos}</span></td>
                <td class="py-2 text-right font-mono text-slate-600">${item.weight}</td>
            </tr>
        `).join('');
    }

    function downloadImage() {
        const canvas = document.getElementById('word-cloud-canvas');
        const link = document.createElement('a');
        link.download = 'ai-wordcloud.png';
        link.href = canvas.toDataURL();
        link.click();
    }
</script>
