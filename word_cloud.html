<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Word Cloud | Science Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ğŸ”¥ ç§»é™¤å¤–éƒ¨ wordcloud2.jsï¼šæ”¹ç”¨å…§å»º Canvas ç•«åœ– -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/wordcloud2.js"></script> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Work Sans"', '"Noto Sans TC"', 'sans-serif'] },
                    colors: {
                        brand: { DEFAULT: '#BB50E0', hover: '#9a00cc', light: '#f3e5f5', bg: '#f8fafc' },
                        pos: { n: '#8b5cf6', v: '#10b981', a: '#f59e0b', d: '#3b82f6', c: '#ec4899', o: '#9ca3af' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #fff; color: #212121; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        .nav-link { cursor: pointer; position: relative; font-weight: 600; color: #757575; transition: color 0.3s; }
        .nav-link.active { color: #BB50E0; }
        .nav-link.active::after { content: ''; position: absolute; bottom: -8px; left: 0; width: 100%; height: 3px; background-color: #BB50E0; border-radius: 3px 3px 0 0; }
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-track { background: #f1f1f1; }
        .scroller::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .pos-badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; font-weight: 600; display: inline-block; min-width: 30px; text-align: center; }
        .pos-chip { display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; border: 1px solid #e5e7eb; background-color: #fff; color: #6b7280; cursor: pointer; transition: all 0.2s; }
        .pos-chip:hover { background-color: #f9fafb; }
        .pos-chip.active[data-pos="n"] { background-color: #f5f3ff; color: #8b5cf6; border-color: #8b5cf6; }
        .pos-chip.active[data-pos="v"] { background-color: #ecfdf5; color: #10b981; border-color: #10b981; }
        .pos-chip.active[data-pos="a"] { background-color: #fffbeb; color: #f59e0b; border-color: #f59e0b; }
        .pos-chip.active[data-pos="d"] { background-color: #eff6ff; color: #3b82f6; border-color: #3b82f6; }
        .pos-chip.active[data-pos="c"] { background-color: #fdf2f8; color: #ec4899; border-color: #ec4899; }
        .pos-chip.active[data-pos="o"] { background-color: #f3f4f6; color: #4b5563; border-color: #6b7280; }
        .pos-dot { width: 8px; height: 8px; border-radius: 50%; background-color: currentColor; }
        .loader { width: 24px; height: 24px; border: 3px solid rgba(187, 80, 224, 0.2); border-top-color: #BB50E0; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Range Slider Styling */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #BB50E0; cursor: pointer; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e5e7eb; border-radius: 2px; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="h-16 border-b border-gray-200 bg-white flex items-center justify-between px-6 shrink-0 z-30">
        <div class="flex items-center gap-6">
            <button onclick="window.location.href='researcher.html'" class="text-gray-500 hover:text-brand transition font-medium flex items-center gap-2 text-sm">
                <i class="fa-solid fa-arrow-left"></i> <span data-i18n="back">è¿”å›ç ”ç©¶ä¸­å¿ƒ</span>
            </button>
            <div class="h-6 w-px bg-gray-300"></div>
            <h1 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-cloud text-brand"></i>
                <span data-i18n="title">AI æ™ºèƒ½æ–‡å­—é›²</span>
            </h1>
        </div>
        <div class="flex items-center gap-4">
            <select id="language-selector" onchange="App.changeLanguage()" class="bg-gray-50 border border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-brand focus:border-brand block p-2 outline-none cursor-pointer">
                <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                <option value="en">English</option>
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
            </select>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-[45%] min-w-[420px] max-w-[800px] bg-white border-r border-gray-200 flex flex-col h-full shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-20">
            <div class="flex-1 overflow-y-auto scroller p-6">
                
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <div class="nav-link active px-0" data-i18n="tab_text">æ–‡å­—è¼¸å…¥</div>
                        <div class="flex gap-2">
                            <button onclick="App.loadExample()" class="text-xs font-bold text-brand hover:text-brand-hover px-3 py-1.5 rounded border border-brand-light hover:bg-brand-light transition flex items-center gap-1">
                                <i class="fa-solid fa-flask"></i> <span data-i18n="btn_example">ç¯„ä¾‹</span>
                            </button>
                            <button onclick="App.clearInput()" class="text-xs font-bold text-gray-500 hover:text-red-500 px-3 py-1.5 rounded border border-gray-200 hover:bg-red-50 transition flex items-center gap-1">
                                <i class="fa-solid fa-trash"></i> <span data-i18n="btn_clear">æ¸…ç©º</span>
                            </button>
                        </div>
                    </div>
                    <div class="bg-brand-bg rounded-xl border border-gray-300 p-4 focus-within:border-brand focus-within:ring-1 focus-within:ring-brand transition">
                        <textarea id="text-input" class="w-full h-32 bg-transparent border-0 outline-none text-gray-700 resize-none leading-relaxed placeholder-gray-400 text-sm" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ–‡ç« ..."></textarea>
                    </div>
                </div>

                <div class="mb-8 bg-gray-50 p-5 rounded-xl border border-gray-200">
                    <h5 class="text-sm font-bold mb-4 text-gray-700 flex items-center gap-2" data-i18n="sec_options">
                        <i class="fa-solid fa-sliders"></i> è¨­å®šé¸é …
                    </h5>

                    <div class="grid grid-cols-2 gap-4 mb-5">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1" data-i18n="label_model">æ¬Šé‡æ¨¡å‹</label>
                            <div class="relative">
                                <select id="model-select" class="w-full p-2.5 bg-white border border-gray-300 rounded-lg text-sm appearance-none focus:border-brand outline-none cursor-pointer font-medium shadow-sm">
                                    <option value="frequency">è©é » (Frequency)</option>
                                    <option value="tfidf">TF-IDF (Intra-text)</option>
                                    <option value="textrank">TextRank (Weighted)</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-3 top-3.5 text-gray-400 text-xs pointer-events-none"></i>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1" data-i18n="label_shape">å½¢ç‹€</label>
                            <div class="relative">
                                <select id="shape-select" class="w-full p-2.5 bg-white border border-gray-300 rounded-lg text-sm appearance-none focus:border-brand outline-none cursor-pointer font-medium shadow-sm">
                                    <option value="circle">åœ“å½¢</option>
                                    <option value="square">æ–¹å½¢</option>
                                    <option value="cardioid">æ„›å¿ƒ</option>
                                    <option value="star">æ˜Ÿå½¢</option>
                                    <option value="diamond">è±å½¢</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-3 top-3.5 text-gray-400 text-xs pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                    <div class="mb-5">
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase" data-i18n="label_max_words">é¡¯ç¤ºè©å½™æ•¸é‡</label>
                            <span id="max-words-val" class="text-xs font-bold text-brand bg-white px-2 py-0.5 rounded border border-gray-200">100</span>
                        </div>
                        <input type="range" id="max-words-slider" min="10" max="200" step="10" value="100">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2" data-i18n="label_pos_filter">è©æ€§éæ¿¾ (é»æ“Šåˆ‡æ›)</label>
                        <div class="flex flex-wrap gap-2" id="pos-container">
                            <button class="pos-chip active" data-pos="n"><span class="pos-dot"></span> åè© (N)</button>
                            <button class="pos-chip active" data-pos="v"><span class="pos-dot"></span> å‹•è© (V)</button>
                            <button class="pos-chip active" data-pos="a"><span class="pos-dot"></span> å½¢å®¹è© (A)</button>
                            <button class="pos-chip" data-pos="d"><span class="pos-dot"></span> å‰¯è© (D)</button>
                            <button class="pos-chip" data-pos="c"><span class="pos-dot"></span> é€£æ¥è© (C)</button>
                            <button class="pos-chip" data-pos="o"><span class="pos-dot"></span> å…¶ä»– (O)</button>
                        </div>
                    </div>
                </div>

                <button id="btn-analyze" onclick="App.runAnalysis()" class="w-full bg-brand hover:bg-brand-hover text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand/20 transition transform active:scale-[0.98] flex items-center justify-center gap-2 tracking-wide text-sm">
                    <span data-i18n="btn_visualize">ç”¢ç”Ÿæ–‡å­—é›²</span> <i class="fa-solid fa-wand-magic-sparkles"></i>
                </button>
            </div>

            <div id="results-container" class="hidden border-t border-gray-200 bg-gray-50 h-[35%] flex flex-col">
                <div class="flex border-b border-gray-200 bg-white px-6">
                    <button onclick="App.switchTab('ai')" id="tab-ai" class="py-3 px-4 text-sm font-bold text-brand border-b-2 border-brand transition" data-i18n="tab_ai">AI æ´å¯Ÿ</button>
                    <button onclick="App.switchTab('data')" id="tab-data" class="py-3 px-4 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition" data-i18n="tab_data">æ•¸æ“šåˆ—è¡¨</button>
                </div>
                <div id="panel-ai" class="flex-1 overflow-y-auto scroller p-6 text-sm text-gray-700 leading-relaxed space-y-3 bg-brand-bg"></div>
                <div id="panel-data" class="hidden flex-1 overflow-y-auto scroller p-0">
                    <table class="w-full text-sm text-left border-collapse">
                        <thead class="bg-gray-100 text-gray-500 sticky top-0 shadow-sm z-10">
                            <tr>
                                <th class="p-3 font-semibold pl-6" data-i18n="col_rank">#</th>
                                <th class="p-3 font-semibold" data-i18n="col_word">è©å½™</th>
                                <th class="p-3 font-semibold" data-i18n="col_pos">è©æ€§</th>
                                <th class="p-3 text-right font-semibold pr-6" data-i18n="col_weight">æ¬Šé‡</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="divide-y divide-gray-200 bg-white"></tbody>
                    </table>
                </div>
            </div>
        </aside>

        <div id="resizer" class="w-1 bg-gray-200 cursor-col-resize hover:bg-brand transition z-30"></div>

        <main class="flex-1 bg-gray-100 relative flex flex-col items-center justify-center p-8 overflow-hidden">
            
            <div id="canvas-wrapper" class="w-full h-full bg-white rounded-2xl shadow-sm border border-gray-200 relative flex items-center justify-center overflow-hidden">
                
                <div id="empty-state" class="text-center opacity-60">
                    <img src="https://cdn-icons-png.flaticon.com/512/4047/4047268.png" alt="Cloud" class="w-24 h-24 mx-auto mb-4 opacity-50 grayscale">
                    <h3 class="text-xl font-bold text-gray-700" data-i18n="state_ready">æº–å‚™å°±ç·’</h3>
                    <p class="text-gray-500 mt-2" data-i18n="state_ready_desc">è«‹åœ¨å·¦å´è¼¸å…¥æ–‡å­—ä¸¦ç”¢ç”Ÿæ–‡å­—é›²</p>
                </div>

                <div id="loading-state" class="hidden text-center">
                    <div class="loader mx-auto mb-4"></div>
                    <p class="text-brand font-bold text-lg animate-pulse" data-i18n="state_loading">AI æ­£åœ¨é‹ç®—ä¸­...</p>
                    <p class="text-gray-400 text-sm mt-1">æ–·è©ã€æ¬Šé‡è¨ˆç®—ã€AI è§£è®€</p>
                </div>

                <canvas id="word-cloud-canvas" class="hidden"></canvas>
            </div>

            <button onclick="App.downloadImage()" id="btn-download" class="hidden absolute bottom-12 right-12 bg-white text-gray-800 hover:text-brand border border-gray-300 px-6 py-3 rounded-full shadow-xl font-bold transition transform hover:-translate-y-1 flex items-center gap-2 z-30 group">
                <span class="group-hover:text-brand transition" data-i18n="btn_download">ä¸‹è¼‰åœ–ç‰‡</span> <i class="fa-solid fa-download group-hover:animate-bounce"></i>
            </button>

        </main>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 translate-y-10 transition-all duration-300 pointer-events-none z-50 font-medium text-sm flex items-center gap-3">
        <i class="fa-solid fa-info-circle"></i> <span id="toast-msg">Notification</span>
    </div>

    <script>
        // ğŸ”´ğŸ”´ğŸ”´ è«‹å‹™å¿…å¡«å…¥æ‚¨éƒ¨ç½²å¾Œçš„ GAS Web App URL (çµå°¾æ˜¯ /exec) ğŸ”´ğŸ”´ğŸ”´
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw3UqYr976wAd9aeEsLpTDSlGaUVdBpaErqZi-zHgNzh_Gd0SuggfdI7ldVzrqR1Ygd/exec"; 

        const App = {
            state: {
                words: [],
                resizeTimer: null,
                currentLang: 'zh-TW',
                activePos: new Set(['n', 'v', 'a']),
                maxWords: 100
            },

            translations: {
                "zh-TW": {
                    "back": "è¿”å›ç ”ç©¶ä¸­å¿ƒ", "title": "AI æ™ºèƒ½æ–‡å­—é›²", "tab_text": "æ–‡å­—è¼¸å…¥",
                    "btn_example": "è¼‰å…¥ç¯„ä¾‹", "btn_clear": "æ¸…ç©º", "sec_options": "è¨­å®šé¸é …",
                    "sec_options_desc": "è‡ªå®šç¾©æ‚¨çš„æ–‡å­—é›²åƒæ•¸", "label_model": "æ¬Šé‡æ¨¡å‹", "label_shape": "å½¢ç‹€", "label_pos_filter": "è©æ€§éæ¿¾ (é»æ“Šåˆ‡æ›)", "label_max_words": "é¡¯ç¤ºè©å½™æ•¸é‡",
                    "opt_freq": "è©é » (Frequency)", "opt_tfidf": "TF-IDF (Intra-text)", "opt_textrank": "TextRank (Weighted)",
                    "shape_circle": "åœ“å½¢", "shape_square": "æ–¹å½¢", "shape_heart": "æ„›å¿ƒ", "shape_star": "æ˜Ÿå½¢", "shape_diamond": "è±å½¢",
                    "btn_visualize": "ç”¢ç”Ÿæ–‡å­—é›²", "tab_ai": "AI æ´å¯Ÿ", "tab_data": "æ•¸æ“šåˆ—è¡¨",
                    "col_rank": "#", "col_word": "è©å½™", "col_pos": "è©æ€§", "col_weight": "æ¬Šé‡",
                    "state_ready": "æº–å‚™å°±ç·’", "state_ready_desc": "è«‹åœ¨å·¦å´è¼¸å…¥æ–‡å­—ä¸¦ç”¢ç”Ÿæ–‡å­—é›²",
                    "state_loading": "AI æ­£åœ¨é‹ç®—ä¸­...", "btn_download": "ä¸‹è¼‰åœ–ç‰‡",
                    "msg_input_empty": "è«‹è¼¸å…¥æ–‡å­—", "msg_processing": "è™•ç†ä¸­...", "msg_success": "åˆ†æå®Œæˆ", "msg_error": "ç™¼ç”ŸéŒ¯èª¤"
                },
                "en": {
                    "back": "Back", "title": "AI Word Cloud", "tab_text": "Text Input",
                    "btn_example": "Example", "btn_clear": "Clear", "sec_options": "Options",
                    "sec_options_desc": "Customize options", "label_model": "Model", "label_shape": "Shape", "label_pos_filter": "POS Filters", "label_max_words": "Max Words",
                    "opt_freq": "Frequency", "opt_tfidf": "TF-IDF", "opt_textrank": "TextRank",
                    "shape_circle": "Circle", "shape_square": "Square", "shape_heart": "Heart", "shape_star": "Star", "shape_diamond": "Diamond",
                    "btn_visualize": "VISUALIZE", "tab_ai": "AI Insight", "tab_data": "Data List",
                    "col_rank": "#", "col_word": "Word", "col_pos": "POS", "col_weight": "Weight",
                    "state_ready": "Ready", "state_ready_desc": "Input text to start",
                    "state_loading": "Processing...", "btn_download": "Download",
                    "msg_input_empty": "Input text required", "msg_processing": "Processing...", "msg_success": "Done", "msg_error": "Error"
                },
                "ja": { /* çœç•¥ */ }, "zh-CN": { /* çœç•¥ */ }
            },

            exampleText: "é›»æµç£æ•ˆæ‡‰æ˜¯æŒ‡é›»æµé€šéå°ç·šæ™‚ï¼Œæœƒåœ¨å°ç·šå‘¨åœç”¢ç”Ÿç£å ´çš„ç¾è±¡ã€‚1820å¹´ï¼Œä¸¹éº¥ç‰©ç†å­¸å®¶å¥§æ–¯ç‰¹ç™¼ç¾ï¼Œç•¶å°ç·šé€šé›»æ™‚ï¼Œæ—é‚Šçš„ç£é‡æœƒç™¼ç”Ÿåè½‰ï¼Œè­‰æ˜äº†é›»èˆ‡ç£ä¹‹é–“æœ‰å¯†åˆ‡çš„é—œä¿‚ã€‚ç£å ´çš„æ–¹å‘å¯ä»¥ç”¨å®‰åŸ¹å³æ‰‹å®šå‰‡ä¾†åˆ¤æ–·ï¼šç”¨å³æ‰‹æ¡ä½å°ç·šï¼Œå¤§æ‹‡æŒ‡æŒ‡å‘é›»æµæ–¹å‘ï¼Œå››æŒ‡å½æ›²çš„æ–¹å‘å°±æ˜¯ç£å ´æ–¹å‘ã€‚è‹¥å°‡å°ç·šç¹æˆèºç·šç®¡ï¼Œé€šé›»å¾Œå…§éƒ¨æœƒç”¢ç”Ÿå‡å‹»ç£å ´ï¼Œå…¶ç‰¹æ€§é¡ä¼¼æ–¼æ¢å½¢ç£éµã€‚",

            init() {
                this.bindEvents();
                this.initResizer();
                document.getElementById('text-input').placeholder = "è«‹åœ¨æ­¤è²¼ä¸Šæ–‡ç«  (å»ºè­° 100 å­—ä»¥ä¸Š)...";
            },

            bindEvents() {
                // è©æ€§æŒ‰éˆ•
                document.querySelectorAll('.pos-chip').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const target = e.currentTarget;
                        const pos = target.dataset.pos;
                        if (this.state.activePos.has(pos)) {
                            this.state.activePos.delete(pos);
                            target.classList.remove('active');
                        } else {
                            this.state.activePos.add(pos);
                            target.classList.add('active');
                        }
                        if (this.state.words.length > 0) this.renderWordCloud();
                    });
                });

                // Slider
                const slider = document.getElementById('max-words-slider');
                const valDisplay = document.getElementById('max-words-val');
                slider.addEventListener('input', (e) => {
                    this.state.maxWords = parseInt(e.target.value);
                    valDisplay.innerText = this.state.maxWords;
                });

                document.getElementById('shape-select').addEventListener('change', () => {
                    if (this.state.words.length > 0) this.renderWordCloud();
                });
                
                window.addEventListener('resize', () => {
                    if (this.state.words.length > 0) {
                        clearTimeout(this.state.resizeTimer);
                        this.state.resizeTimer = setTimeout(() => this.renderWordCloud(), 300);
                    }
                });
            },

            initResizer() {
                const resizer = document.getElementById('resizer');
                const sidebar = document.querySelector('aside');
                let isResizing = false;

                resizer.addEventListener('mousedown', () => {
                    isResizing = true;
                    document.body.style.cursor = 'col-resize';
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;
                    const w = e.clientX;
                    if (w > 350 && w < window.innerWidth * 0.6) {
                        sidebar.style.width = `${w}px`;
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isResizing) {
                        isResizing = false;
                        document.body.style.cursor = 'default';
                        if (this.state.words.length > 0) this.renderWordCloud();
                    }
                });
            },

            loadExample() { document.getElementById('text-input').value = this.exampleText; },
            clearInput() { document.getElementById('text-input').value = ''; this.state.words = []; },

            changeLanguage() {
                this.state.currentLang = document.getElementById('language-selector').value;
                const t = this.translations[this.state.currentLang] || this.translations['zh-TW'];
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    el.innerText = t[el.getAttribute('data-i18n')] || el.innerText;
                });
            },

            switchTab(tab) {
                const tabAi = document.getElementById('tab-ai');
                const tabData = document.getElementById('tab-data');
                const panelAi = document.getElementById('panel-ai');
                const panelData = document.getElementById('panel-data');

                if (tab === 'ai') {
                    tabAi.className = "py-3 px-4 text-sm font-bold text-brand border-b-2 border-brand transition";
                    tabData.className = "py-3 px-4 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition";
                    panelAi.classList.remove('hidden'); panelData.classList.add('hidden');
                } else {
                    tabAi.className = "py-3 px-4 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition";
                    tabData.className = "py-3 px-4 text-sm font-bold text-brand border-b-2 border-brand transition";
                    panelAi.classList.add('hidden'); panelData.classList.remove('hidden');
                }
            },

            async runAnalysis() {
                const text = document.getElementById('text-input').value.trim();
                const model = document.getElementById('model-select').value;
                const btn = document.getElementById('btn-analyze');
                const t = this.translations[this.state.currentLang] || this.translations['zh-TW'];

                if (!text) { this.showToast(t.msg_input_empty, 'error'); return; }
                if (GAS_URL.includes("åœ¨æ­¤å¡«å…¥")) { this.showToast("API URL not set", 'error'); return; }

                const orgBtnHtml = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<div class="loader w-4 h-4 border-2 border-white/30 border-t-white mr-2"></div> ${t.msg_processing}`;
                
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('word-cloud-canvas').classList.add('hidden');
                document.getElementById('btn-download').classList.add('hidden');
                document.getElementById('loading-state').classList.remove('hidden');
                document.getElementById('results-container').classList.add('hidden');

                const payload = { 
                    text: text, 
                    mode: model,
                    maxTerms: this.state.maxWords 
                };

                try {
                    const res = await fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload),
                        headers: { "Content-Type": "text/plain;charset=utf-8" }
                    });
                    const json = await res.json();

                    if (json.status === 'success') {
                        this.state.words = json.data.wordList;
                        document.getElementById('panel-ai').innerHTML = json.data.aiAnalysis;
                        this.renderTable(json.data.wordList);
                        
                        document.getElementById('loading-state').classList.add('hidden');
                        document.getElementById('results-container').classList.remove('hidden');
                        
                        setTimeout(() => this.renderWordCloud(), 100);
                        this.showToast(t.msg_success, "success");
                    } else {
                        throw new Error(json.message || "Unknown error");
                    }
                } catch (error) {
                    console.error(error);
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('empty-state').classList.remove('hidden');
                    this.showToast(t.msg_error + ": " + error.message, "error");
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = orgBtnHtml;
                }
            },

            // âœ… æ”¹æˆåŸç”Ÿ Canvas ç•«æ–‡å­—é›²ï¼Œä¸å†ä¾è³´å¤–éƒ¨å‡½å¼åº«
            renderWordCloud() {
                const canvas = document.getElementById('word-cloud-canvas');
                const wrapper = document.getElementById('canvas-wrapper');
                const shape = document.getElementById('shape-select').value;

                // 1. ç¯©é¸
                const filteredList = this.state.words.filter(item => {
                    const p = (item.pos || 'O').toLowerCase().charAt(0);
                    let type = 'o';
                    if (['n','v','a','d','c'].includes(p)) type = p;
                    return this.state.activePos.has(type);
                });

                if (filteredList.length === 0) {
                    this.showToast("ç¯©é¸å¾Œç„¡è©å½™", "error");
                    return;
                }

                canvas.classList.remove('hidden');
                document.getElementById('btn-download').classList.remove('hidden');
                
                const w = wrapper.clientWidth;
                const h = wrapper.clientHeight;
                canvas.width = w;
                canvas.height = h;

                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, w, h);
                ctx.textBaseline = 'middle';
                ctx.textAlign = 'center';

                // å­—é«”å¤§å°æ­£è¦åŒ–
                const maxWeight = Math.max(...filteredList.map(i => i.weight)) || 1;
                const minFont = 14;
                const maxFont = Math.max(24, w / 15); // éš¨ç•«å¸ƒå¯¬åº¦èª¿æ•´ä¸Šé™

                const placed = [];

                filteredList.forEach(item => {
                    const norm = item.weight / maxWeight; // 0~1
                    const fontSize = minFont + norm * (maxFont - minFont);
                    const color = this.getPosColor(item.pos);

                    const pos = this.findPositionForWord(ctx, item.word, fontSize, placed, w, h, shape);
                    if (!pos) return;

                    placed.push({
                        text: item.word,
                        x: pos.x,
                        y: pos.y,
                        fontSize,
                        color,
                        width: pos.width,
                        height: pos.height
                    });
                });

                // å¯¦éš›ç¹ªè£½
                placed.forEach(word => {
                    ctx.font = `${Math.round(word.fontSize)}px "Work Sans","Noto Sans TC",sans-serif`;
                    ctx.fillStyle = word.color;
                    ctx.fillText(word.text, word.x, word.y);
                });
            },

            // âœ… ç°¡å–®èºæ—‹æ’ç‰ˆï¼‹ç¢°æ’æª¢æŸ¥
            findPositionForWord(ctx, text, fontSize, placed, canvasW, canvasH, shape) {
                ctx.font = `${Math.round(fontSize)}px "Work Sans","Noto Sans TC",sans-serif`;
                const textWidth = ctx.measureText(text).width;
                const textHeight = fontSize; // ç²—ç•¥ä¼°è¨ˆ

                const centerX = canvasW / 2;
                const centerY = canvasH / 2;

                const maxRadius = Math.min(canvasW, canvasH) / 2;
                const stepAngle = 5 * (Math.PI / 180); // 5 åº¦
                const stepRadius = 3;

                for (let angle = 0, r = 0; r < maxRadius; angle += stepAngle, r += stepRadius / (2 * Math.PI)) {
                    const x = centerX + r * Math.cos(angle);
                    const y = centerY + r * Math.sin(angle);

                    const rect = {
                        x: x - textWidth / 2,
                        y: y - textHeight / 2,
                        width: textWidth,
                        height: textHeight
                    };

                    // è¶…å‡ºç•«å¸ƒé‚Šç•Œå°±è·³é
                    if (rect.x < 0 || rect.y < 0 || rect.x + rect.width > canvasW || rect.y + rect.height > canvasH) {
                        continue;
                    }

                    // å½¢ç‹€ç´„ç•¥æ§åˆ¶ï¼šcircle / square å…¶ä»–éƒ½æ¡ circle
                    if (shape === 'circle' || shape === 'cardioid' || shape === 'star' || shape === 'diamond') {
                        const dx = x - centerX;
                        const dy = y - centerY;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist > maxRadius) continue;
                    }
                    // squareï¼šä¸é¡å¤–é™åˆ¶ï¼ˆä¸Šé¢å·²ç”¨ç•«å¸ƒé‚Šç•Œæ§åˆ¶ï¼‰

                    // ç¢°æ’æª¢æŸ¥
                    let collide = false;
                    for (const p of placed) {
                        if (
                            rect.x < p.x + p.width &&
                            rect.x + rect.width > p.x &&
                            rect.y < p.y + p.height &&
                            rect.y + rect.height > p.y
                        ) {
                            collide = true;
                            break;
                        }
                    }

                    if (!collide) {
                        return {
                            x,
                            y,
                            width: textWidth,
                            height: textHeight
                        };
                    }
                }

                // æ‰¾ä¸åˆ°ä½ç½®å°±æ”¾æ£„é€™å€‹è©
                return null;
            },

            getPosColor(pos) {
                const p = String(pos).toLowerCase();
                if (p.startsWith('n')) return '#8b5cf6'; 
                if (p.startsWith('v')) return '#10b981'; 
                if (p.startsWith('a')) return '#f59e0b'; 
                if (p.startsWith('d')) return '#3b82f6'; 
                if (p.startsWith('c')) return '#ec4899'; 
                return '#9ca3af'; 
            },

            renderTable(list) {
                const tbody = document.getElementById('data-table-body');
                tbody.innerHTML = list.slice(0, 100).map((item, idx) => `
                    <tr class="hover:bg-gray-50 transition border-b border-gray-100">
                        <td class="p-3 text-gray-400 font-mono text-xs pl-6">${idx + 1}</td>
                        <td class="p-3 font-medium text-gray-800">${item.word}</td>
                        <td class="p-3"><span class="pos-badge text-white" style="background-color: ${this.getPosColor(item.pos)}">${item.pos}</span></td>
                        <td class="p-3 text-right font-mono text-gray-600 pr-6">${item.weight.toFixed(2)}</td>
                    </tr>
                `).join('');
            },

            downloadImage() {
                const canvas = document.getElementById('word-cloud-canvas');
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const ctx = tempCanvas.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                ctx.drawImage(canvas, 0, 0);
                const link = document.createElement('a');
                link.download = `wordcloud_${Date.now()}.png`;
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
            },

            showToast(msg, type = 'info') {
                const toast = document.getElementById('toast');
                const toastMsg = document.getElementById('toast-msg');
                toastMsg.innerText = msg;
                toast.classList.remove('opacity-0', 'translate-y-10');
                if (type === 'error') {
                    toast.classList.remove('bg-gray-900'); toast.classList.add('bg-red-600');
                } else {
                    toast.classList.add('bg-gray-900'); toast.classList.remove('bg-red-600');
                }
                setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
            }
        };

        App.init();
    </script>
</body>
</html>
