<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Word Cloud | Science Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud2@1.2.2/src/wordcloud2.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&family=Poppins:wght@400;500;600&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Work Sans"', '"Noto Sans TC"', 'sans-serif'],
                        heading: ['"Poppins"', '"Noto Sans TC"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            DEFAULT: '#BB50E0', // ÂèÉËÄÉÁ∂≤Á´ôÁöÑ‰∏ªÁ¥´Ëâ≤
                            hover: '#9a00cc',
                            light: '#f3e5f5',
                            bg: '#f8fafc'
                        },
                        gray: {
                            light: '#f5f5f5',
                            medium: '#e0e0e0',
                            dark: '#757575'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #fff; color: #212121; }
        
        /* Ê®°Êì¨ Material UI ÁöÑ Tabs */
        .nav-link {
            cursor: pointer; position: relative; font-weight: 500; color: #757575; transition: color 0.3s;
        }
        .nav-link.active { color: #BB50E0; }
        .nav-link.active::after {
            content: ''; position: absolute; bottom: -8px; left: 0; width: 100%; height: 3px; background-color: #BB50E0; border-radius: 3px 3px 0 0;
        }

        /* Ëá™ÂÆöÁæ©Êç≤Ëª∏ */
        .scroller::-webkit-scrollbar { width: 8px; height: 8px; }
        .scroller::-webkit-scrollbar-track { background: #f1f1f1; }
        .scroller::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .scroller::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        /* Loader */
        .loader { width: 24px; height: 24px; border: 3px solid rgba(187, 80, 224, 0.2); border-top-color: #BB50E0; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Ë©ûÊÄßÊ®ôÁ±§ */
        .pos-badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; font-weight: 600; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="h-16 border-b border-gray-200 bg-white flex items-center justify-between px-6 shrink-0 z-30">
        <div class="flex items-center gap-6">
            <button onclick="window.location.href='researcher.html'" class="text-gray-500 hover:text-brand transition font-medium flex items-center gap-2">
                <i class="fa-solid fa-arrow-left"></i> <span data-i18n="back">ËøîÂõûÁ†îÁ©∂‰∏≠ÂøÉ</span>
            </button>
            <div class="h-6 w-px bg-gray-300"></div>
            <h1 class="text-xl font-heading font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-cloud text-brand"></i>
                <span data-i18n="title">Generate Word Cloud</span>
            </h1>
        </div>
        <div class="flex items-center gap-4">
            <select id="language-selector" onchange="App.changeLanguage()" class="bg-gray-50 border border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-brand focus:border-brand block p-2 outline-none">
                <option value="zh-TW">ÁπÅÈ´î‰∏≠Êñá</option>
                <option value="en">English</option>
                <option value="ja">Êó•Êú¨Ë™û</option>
                <option value="zh-CN">ÁÆÄ‰Ωì‰∏≠Êñá</option>
            </select>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-[40%] min-w-[400px] max-w-[600px] bg-white border-r border-gray-200 flex flex-col h-full shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-20">
            <div class="flex-1 overflow-y-auto scroller p-6">
                
                <div class="flex border-b border-gray-200 mb-6">
                    <div class="nav-link active px-4 py-2" data-i18n="tab_text">Text Input</div>
                    </div>

                <div class="mb-6">
                    <div class="bg-gray-light rounded-xl border border-gray-medium p-4 focus-within:border-brand focus-within:ring-1 focus-within:ring-brand transition">
                        <textarea id="text-input" class="w-full h-48 bg-transparent border-0 outline-none text-gray-700 resize-none leading-relaxed placeholder-gray-400" placeholder="Paste or type your text to generate your word cloud..."></textarea>
                    </div>
                    <div class="flex justify-end gap-2 mt-2">
                        <button onclick="App.loadExample()" class="text-xs font-bold text-brand hover:text-brand-hover px-3 py-1 rounded border border-brand-light hover:bg-brand-light transition">
                            <i class="fa-solid fa-flask"></i> <span data-i18n="btn_example">ÁØÑ‰æã</span>
                        </button>
                        <button onclick="App.clearInput()" class="text-xs font-bold text-gray-500 hover:text-red-500 px-3 py-1 rounded border border-gray-200 hover:bg-red-50 transition">
                            <i class="fa-solid fa-trash"></i> <span data-i18n="btn_clear">Ê∏ÖÁ©∫</span>
                        </button>
                    </div>
                </div>

                <div class="mb-8">
                    <h5 class="text-lg font-heading font-bold mb-1" data-i18n="sec_options">Options</h5>
                    <p class="text-sm text-gray-500 mb-4" data-i18n="sec_options_desc">Customize your word cloud with the options below</p>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1" data-i18n="label_model">Model</label>
                            <div class="relative">
                                <select id="model-select" class="w-full p-3 bg-white border border-gray-300 rounded-lg text-sm appearance-none focus:border-brand outline-none cursor-pointer font-medium">
                                    <option value="frequency">Ë©ûÈ†ª (Frequency)</option>
                                    <option value="tfidf">TF-IDF (Êé®Ëñ¶)</option>
                                    <option value="textrank">TextRank (ÈóúËÅØÊÄß)</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-3 top-3.5 text-gray-400 text-xs pointer-events-none"></i>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1" data-i18n="label_shape">Shape</label>
                            <div class="relative">
                                <select id="shape-select" class="w-full p-3 bg-white border border-gray-300 rounded-lg text-sm appearance-none focus:border-brand outline-none cursor-pointer font-medium">
                                    <option value="circle">ÂúìÂΩ¢ (Circle)</option>
                                    <option value="square">ÊñπÂΩ¢ (Square)</option>
                                    <option value="cardioid">ÊÑõÂøÉ (Heart)</option>
                                    <option value="star">ÊòüÂΩ¢ (Star)</option>
                                    <option value="diamond">Ëè±ÂΩ¢ (Diamond)</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-3 top-3.5 text-gray-400 text-xs pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                    <button id="btn-analyze" onclick="App.runAnalysis()" class="w-full bg-brand hover:bg-brand-hover text-white font-bold py-3.5 rounded-full shadow-lg shadow-brand/20 transition transform active:scale-[0.98] flex items-center justify-center gap-2 tracking-wide text-sm">
                        <span data-i18n="btn_visualize">VISUALIZE</span> <i class="fa-solid fa-wand-magic-sparkles"></i>
                    </button>
                </div>

                <div id="results-container" class="hidden border-t border-gray-200 pt-6">
                    <div class="flex gap-4 mb-4">
                        <button onclick="App.switchTab('ai')" id="tab-ai" class="text-sm font-bold text-brand border-b-2 border-brand pb-1 transition">AI Insight</button>
                        <button onclick="App.switchTab('data')" id="tab-data" class="text-sm font-bold text-gray-400 border-b-2 border-transparent pb-1 hover:text-gray-600 transition">Data List</button>
                    </div>

                    <div id="panel-ai" class="bg-gray-50 p-4 rounded-xl border border-gray-100 text-sm text-gray-700 leading-relaxed space-y-3">
                        </div>

                    <div id="panel-data" class="hidden bg-white border border-gray-200 rounded-xl overflow-hidden">
                        <div class="max-h-[300px] overflow-y-auto scroller">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 text-gray-500 sticky top-0">
                                    <tr>
                                        <th class="p-3 font-semibold">Word</th>
                                        <th class="p-3 font-semibold">POS</th>
                                        <th class="p-3 text-right font-semibold">Weight</th>
                                    </tr>
                                </thead>
                                <tbody id="data-table-body" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </aside>

        <main class="flex-1 bg-gray-50 relative flex flex-col items-center justify-center p-8 overflow-hidden">
            
            <div id="canvas-wrapper" class="w-full h-full bg-white rounded-2xl shadow-sm border border-gray-200 relative flex items-center justify-center overflow-hidden">
                
                <div id="empty-state" class="text-center opacity-60">
                    <img src="https://cdn-icons-png.flaticon.com/512/4047/4047268.png" alt="Cloud" class="w-24 h-24 mx-auto mb-4 opacity-50 grayscale">
                    <h3 class="text-xl font-heading font-bold text-gray-700">Ready to Generate</h3>
                    <p class="text-gray-500 mt-2">Enter text on the left to create your word cloud.</p>
                </div>

                <div id="loading-state" class="hidden text-center">
                    <div class="loader mx-auto mb-4"></div>
                    <p class="text-brand font-bold text-lg animate-pulse">Processing...</p>
                    <p class="text-gray-400 text-sm mt-1">AI is analyzing text & calculating weights</p>
                </div>

                <canvas id="word-cloud-canvas" class="hidden"></canvas>
            </div>

            <button onclick="App.downloadImage()" id="btn-download" class="hidden absolute bottom-12 right-12 bg-white text-gray-800 hover:text-brand border border-gray-300 px-6 py-3 rounded-full shadow-xl font-bold transition transform hover:-translate-y-1 flex items-center gap-2 z-30 group">
                <span class="group-hover:text-brand transition">Download PNG</span> <i class="fa-solid fa-download group-hover:animate-bounce"></i>
            </button>

        </main>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 translate-y-10 transition-all duration-300 pointer-events-none z-50 font-medium text-sm flex items-center gap-3">
        <i class="fa-solid fa-info-circle"></i> <span id="toast-msg">Notification</span>
    </div>

    <script>
        // üî¥üî¥üî¥ Ë´ãÂãôÂøÖÂ°´ÂÖ•ÊÇ®ÈÉ®ÁΩ≤ÂæåÁöÑ GAS Web App URL (ÁµêÂ∞æÊòØ /exec) üî¥üî¥üî¥
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw3UqYr976wAd9aeEsLpTDSlGaUVdBpaErqZi-zHgNzh_Gd0SuggfdI7ldVzrqR1Ygd/exec"; 

        // ============================================================
        // üöÄ App Logic
        // ============================================================
        const App = {
            state: {
                words: [],
                resizeTimer: null,
                currentLang: 'zh-TW'
            },

            translations: {
                "zh-TW": {
                    "back": "ËøîÂõûÁ†îÁ©∂‰∏≠ÂøÉ", "title": "AI Êô∫ËÉΩÊñáÂ≠óÈõ≤", "tab_text": "ÊñáÂ≠óËº∏ÂÖ•",
                    "btn_example": "ÁØÑ‰æã", "btn_clear": "Ê∏ÖÁ©∫", "sec_options": "Ë®≠ÂÆöÈÅ∏È†Ö",
                    "sec_options_desc": "Ëá™ÂÆöÁæ©ÊÇ®ÁöÑÊñáÂ≠óÈõ≤ÂèÉÊï∏", "label_model": "Ê¨äÈáçÊ®°Âûã",
                    "label_shape": "ÂΩ¢ÁãÄ", "btn_visualize": "Áî¢ÁîüÊñáÂ≠óÈõ≤",
                    "msg_input_empty": "Ë´ãËº∏ÂÖ•ÊñáÂ≠ó", "msg_processing": "ËôïÁêÜ‰∏≠...",
                    "msg_success": "ÂàÜÊûêÂÆåÊàê", "msg_error": "ÁôºÁîüÈåØË™§"
                },
                "en": {
                    "back": "Back", "title": "Generate Word Cloud", "tab_text": "Text Input",
                    "btn_example": "Example", "btn_clear": "Clear", "sec_options": "Options",
                    "sec_options_desc": "Customize your word cloud options", "label_model": "Model",
                    "label_shape": "Shape", "btn_visualize": "VISUALIZE",
                    "msg_input_empty": "Please input text", "msg_processing": "Processing...",
                    "msg_success": "Done", "msg_error": "Error"
                },
                "ja": {
                    "back": "Êàª„Çã", "title": "AI „ÉØ„Éº„Éâ„ÇØ„É©„Ç¶„Éâ", "tab_text": "„ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ",
                    "btn_example": "‰æãÊñá", "btn_clear": "„ÇØ„É™„Ç¢", "sec_options": "„Ç™„Éó„Ç∑„Éß„É≥",
                    "sec_options_desc": "„ÉØ„Éº„Éâ„ÇØ„É©„Ç¶„Éâ„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫", "label_model": "„É¢„Éá„É´",
                    "label_shape": "ÂΩ¢Áä∂", "btn_visualize": "ÁîüÊàê„Åô„Çã",
                    "msg_input_empty": "„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", "msg_processing": "Âá¶ÁêÜ‰∏≠...",
                    "msg_success": "ÂÆå‰∫Ü", "msg_error": "„Ç®„É©„Éº"
                },
                "zh-CN": {
                    "back": "ËøîÂõû", "title": "AI Êô∫ËÉΩÊñáÂ≠ó‰∫ë", "tab_text": "ÊñáÂ≠óËæìÂÖ•",
                    "btn_example": "ËåÉ‰æã", "btn_clear": "Ê∏ÖÁ©∫", "sec_options": "ÈÄâÈ°π",
                    "sec_options_desc": "Ëá™ÂÆö‰πâÊÇ®ÁöÑÊñáÂ≠ó‰∫ëÂèÇÊï∞", "label_model": "ÊùÉÈáçÊ®°Âûã",
                    "label_shape": "ÂΩ¢Áä∂", "btn_visualize": "ÁîüÊàêÊñáÂ≠ó‰∫ë",
                    "msg_input_empty": "ËØ∑ËæìÂÖ•ÊñáÂ≠ó", "msg_processing": "Â§ÑÁêÜ‰∏≠...",
                    "msg_success": "ÂàÜÊûêÂÆåÊàê", "msg_error": "ÂèëÁîüÈîôËØØ"
                }
            },

            exampleText: "ÈõªÊµÅÁ£ÅÊïàÊáâÊòØÊåáÈõªÊµÅÈÄöÈÅéÂ∞éÁ∑öÊôÇÔºåÊúÉÂú®Â∞éÁ∑öÂë®ÂúçÁî¢ÁîüÁ£ÅÂ†¥ÁöÑÁèæË±°„ÄÇ1820Âπ¥Ôºå‰∏πÈ∫•Áâ©ÁêÜÂ≠∏ÂÆ∂Â•ßÊñØÁâπÁôºÁèæÔºåÁï∂Â∞éÁ∑öÈÄöÈõªÊôÇÔºåÊóÅÈÇäÁöÑÁ£ÅÈáùÊúÉÁôºÁîüÂÅèËΩâÔºåË≠âÊòé‰∫ÜÈõªËàáÁ£Å‰πãÈñìÊúâÂØÜÂàáÁöÑÈóú‰øÇ„ÄÇÁ£ÅÂ†¥ÁöÑÊñπÂêëÂèØ‰ª•Áî®ÂÆâÂüπÂè≥ÊâãÂÆöÂâá‰æÜÂà§Êñ∑ÔºöÁî®Âè≥ÊâãÊè°‰ΩèÂ∞éÁ∑öÔºåÂ§ßÊãáÊåáÊåáÂêëÈõªÊµÅÊñπÂêëÔºåÂõõÊåáÂΩéÊõ≤ÁöÑÊñπÂêëÂ∞±ÊòØÁ£ÅÂ†¥ÊñπÂêë„ÄÇËã•Â∞áÂ∞éÁ∑öÁπûÊàêËû∫Á∑öÁÆ°ÔºåÈÄöÈõªÂæåÂÖßÈÉ®ÊúÉÁî¢ÁîüÂùáÂãªÁ£ÅÂ†¥ÔºåÂÖ∂ÁâπÊÄßÈ°û‰ººÊñºÊ¢ùÂΩ¢Á£ÅÈêµ„ÄÇ",

            init() {
                this.bindEvents();
            },

            bindEvents() {
                document.getElementById('shape-select').addEventListener('change', () => {
                    if (this.state.words.length > 0) this.renderWordCloud();
                });
                window.addEventListener('resize', () => {
                    if (this.state.words.length > 0) {
                        clearTimeout(this.state.resizeTimer);
                        this.state.resizeTimer = setTimeout(() => this.renderWordCloud(), 300);
                    }
                });
            },

            changeLanguage() {
                this.state.currentLang = document.getElementById('language-selector').value;
                const t = this.translations[this.state.currentLang];
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    el.innerText = t[el.getAttribute('data-i18n')];
                });
            },

            loadExample() {
                document.getElementById('text-input').value = this.exampleText;
            },

            clearInput() {
                document.getElementById('text-input').value = '';
                document.getElementById('results-container').classList.add('hidden');
                document.getElementById('word-cloud-canvas').classList.add('hidden');
                document.getElementById('btn-download').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('loading-state').classList.add('hidden');
                this.state.words = [];
            },

            switchTab(tab) {
                const tabAi = document.getElementById('tab-ai');
                const tabData = document.getElementById('tab-data');
                const panelAi = document.getElementById('panel-ai');
                const panelData = document.getElementById('panel-data');

                if (tab === 'ai') {
                    tabAi.className = "text-sm font-bold text-brand border-b-2 border-brand pb-1 transition";
                    tabData.className = "text-sm font-bold text-gray-400 border-b-2 border-transparent pb-1 hover:text-gray-600 transition";
                    panelAi.classList.remove('hidden');
                    panelData.classList.add('hidden');
                } else {
                    tabAi.className = "text-sm font-bold text-gray-400 border-b-2 border-transparent pb-1 hover:text-gray-600 transition";
                    tabData.className = "text-sm font-bold text-brand border-b-2 border-brand pb-1 transition";
                    panelAi.classList.add('hidden');
                    panelData.classList.remove('hidden');
                }
            },

            async runAnalysis() {
                const text = document.getElementById('text-input').value.trim();
                const model = document.getElementById('model-select').value;
                const btn = document.getElementById('btn-analyze');
                const t = this.translations[this.state.currentLang];

                if (!text) { this.showToast(t.msg_input_empty, 'error'); return; }
                if (GAS_URL.includes("Âú®Ê≠§Â°´ÂÖ•")) { this.showToast("API URL not set", 'error'); return; }

                // UI Loading
                const orgBtnHtml = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<div class="loader w-4 h-4 border-2 border-white/30 border-t-white mr-2"></div> ${t.msg_processing}`;
                
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('word-cloud-canvas').classList.add('hidden');
                document.getElementById('btn-download').classList.add('hidden');
                document.getElementById('loading-state').classList.remove('hidden');
                document.getElementById('results-container').classList.add('hidden');

                try {
                    const res = await fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify({ text, mode: model }),
                        headers: { "Content-Type": "text/plain;charset=utf-8" }
                    });
                    const json = await res.json();

                    if (json.status === 'success') {
                        this.state.words = json.data.wordList;
                        // Ê∏≤Êüì AI ÂàÜÊûêËàáË°®Ê†º
                        document.getElementById('panel-ai').innerHTML = json.data.aiAnalysis;
                        this.renderTable(json.data.wordList);
                        
                        // È°ØÁ§∫ÁµêÊûú
                        document.getElementById('loading-state').classList.add('hidden');
                        document.getElementById('results-container').classList.remove('hidden');
                        
                        // Ê∏≤ÊüìÊñáÂ≠óÈõ≤
                        this.renderWordCloud();
                        this.showToast(t.msg_success, "success");
                    } else {
                        throw new Error(json.message);
                    }
                } catch (error) {
                    console.error(error);
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('empty-state').classList.remove('hidden');
                    this.showToast(t.msg_error + ": " + error.message, "error");
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = orgBtnHtml;
                }
            },

            renderWordCloud() {
                const canvas = document.getElementById('word-cloud-canvas');
                const wrapper = document.getElementById('canvas-wrapper');
                const shape = document.getElementById('shape-select').value;

                if (this.state.words.length === 0) return;

                canvas.classList.remove('hidden');
                document.getElementById('btn-download').classList.remove('hidden');

                // Âº∑Âà∂ÈáçË®≠ÂØ¨È´ò
                const w = wrapper.clientWidth;
                const h = wrapper.clientHeight;
                canvas.width = w;
                canvas.height = h;

                // Ê¨äÈáçÁ∏ÆÊîæ
                const maxWeight = Math.max(...this.state.words.map(i => i.weight)) || 1;
                const factor = (w / 12) / maxWeight;

                const list = this.state.words.map(i => [i.word, i.weight * factor + 12]);

                setTimeout(() => {
                    WordCloud(canvas, {
                        list: list,
                        gridSize: 12,
                        weightFactor: 1,
                        fontFamily: '"Work Sans", "Noto Sans TC", sans-serif',
                        fontWeight: 'bold',
                        color: (word) => {
                            const item = this.state.words.find(i => i.word === word);
                            return this.getPosColor(item ? item.pos : 'o');
                        },
                        rotateRatio: 0.3,
                        rotationSteps: 2,
                        shape: shape,
                        backgroundColor: 'transparent',
                        drawOutOfBound: false,
                        shrinkToFit: true
                    });
                }, 100);
            },

            getPosColor(pos) {
                const p = String(pos).toLowerCase();
                if (p.startsWith('n')) return '#BB50E0'; // Purple (Noun)
                if (p.startsWith('v')) return '#009688'; // Teal (Verb)
                if (p.startsWith('a')) return '#FF9800'; // Orange (Adj)
                if (p.startsWith('d')) return '#2196F3'; // Blue (Adv)
                return '#9E9E9E'; // Gray
            },

            renderTable(list) {
                const tbody = document.getElementById('data-table-body');
                tbody.innerHTML = list.slice(0, 50).map((item, idx) => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="p-3 text-gray-400 font-mono text-xs">${idx + 1}</td>
                        <td class="p-3 font-medium text-gray-800">${item.word}</td>
                        <td class="p-3"><span class="pos-badge text-white" style="background-color: ${this.getPosColor(item.pos)}">${item.pos}</span></td>
                        <td class="p-3 text-right font-mono text-gray-600">${item.weight.toFixed(1)}</td>
                    </tr>
                `).join('');
            },

            downloadImage() {
                const canvas = document.getElementById('word-cloud-canvas');
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const ctx = tempCanvas.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                ctx.drawImage(canvas, 0, 0);

                const link = document.createElement('a');
                link.download = `wordcloud_${Date.now()}.png`;
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
            },

            showToast(msg, type = 'info') {
                const toast = document.getElementById('toast');
                const toastMsg = document.getElementById('toast-msg');
                toastMsg.innerText = msg;
                toast.classList.remove('opacity-0', 'translate-y-10');
                
                if (type === 'error') {
                    toast.classList.remove('bg-gray-900');
                    toast.classList.add('bg-red-600');
                } else {
                    toast.classList.add('bg-gray-900');
                    toast.classList.remove('bg-red-600');
                }

                setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
            }
        };

        // Initialize
        App.init();
    </script>
</body>
</html>
