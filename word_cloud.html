<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½æ–‡å­—é›² | Science Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud2.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f5f3ff', 100: '#ede9fe', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9' },
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { background-color: #f8fafc; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* è‡ªå®šç¾©æ²è»¸ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }

        /* Pos Tag */
        .pos-btn { transition: all 0.2s; border: 1px solid #e2e8f0; }
        .pos-btn.active { background-color: #f3e8ff; color: #6b21a8; border-color: #d8b4fe; font-weight: 700; }
        .pos-btn:hover { background-color: #f8fafc; }

        .loader { border: 3px solid rgba(139, 92, 246, 0.3); border-radius: 50%; border-top: 3px solid #7c3aed; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <header class="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center h-16 shrink-0 z-20 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-brand-100 p-2 rounded-lg text-brand-700"><i class="fa-solid fa-cloud text-lg"></i></div>
            <h1 class="text-lg font-bold text-slate-800">AI æ™ºèƒ½æ–‡å­—é›²åˆ†æ</h1>
        </div>
        <div class="text-xs text-slate-400">Powered by Gemini 2.5 Flash</div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-[320px] md:w-[360px] lg:w-[400px] bg-white border-r border-slate-200 flex flex-col z-10 shadow-lg shrink-0">
            
            <div class="flex-1 overflow-y-auto custom-scroll p-6">
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-bold text-slate-700">åˆ†ææ–‡æœ¬</label>
                        <div class="flex gap-2">
                            <button onclick="loadExample()" class="text-xs text-brand-600 hover:text-brand-700 bg-brand-50 px-2 py-1 rounded transition">ç¯„ä¾‹</button>
                            <button onclick="document.getElementById('text-input').value=''" class="text-xs text-slate-400 hover:text-red-500 transition">æ¸…ç©º</button>
                        </div>
                    </div>
                    <textarea id="text-input" class="w-full h-32 p-3 border border-slate-300 rounded-xl text-sm resize-none focus:ring-2 focus:ring-brand-500 outline-none transition bg-slate-50" placeholder="è«‹è²¼ä¸Šæ–‡ç« ..."></textarea>
                </div>

                <div class="space-y-4 mb-6">
                    <h3 class="text-xs font-bold text-slate-400 uppercase">è¨­å®š</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <select id="model-select" class="w-full p-2 border rounded-lg text-sm bg-white">
                            <option value="frequency">è©é »å„ªå…ˆ</option>
                            <option value="textrank">TextRank (æ¬Šé‡)</option>
                        </select>
                        <select id="shape-select" class="w-full p-2 border rounded-lg text-sm bg-white">
                            <option value="circle">åœ“å½¢</option>
                            <option value="square">æ–¹å½¢</option>
                            <option value="cardioid">å¿ƒå½¢</option>
                            <option value="star">æ˜Ÿå½¢</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-xs font-semibold text-slate-500 mb-2 block">è©æ€§éæ¿¾</label>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="togglePos('n')" class="pos-btn active px-3 py-1 rounded-md text-xs" data-pos="n">åè©</button>
                            <button onclick="togglePos('v')" class="pos-btn active px-3 py-1 rounded-md text-xs" data-pos="v">å‹•è©</button>
                            <button onclick="togglePos('a')" class="pos-btn active px-3 py-1 rounded-md text-xs" data-pos="a">å½¢å®¹è©</button>
                            <button onclick="togglePos('d')" class="pos-btn active px-3 py-1 rounded-md text-xs" data-pos="d">å‰¯è©</button>
                            <button onclick="togglePos('o')" class="pos-btn px-3 py-1 rounded-md text-xs" data-pos="o">å…¶ä»–</button>
                        </div>
                    </div>
                </div>

                <button id="btn-analyze" onclick="runAnalysis()" class="w-full bg-brand-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-brand-700 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> é–‹å§‹åˆ†æ
                </button>
            </div>

            <div class="border-t border-slate-200 bg-slate-50 p-5 h-[250px] overflow-y-auto custom-scroll">
                <h3 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-robot text-brand-500"></i> AI æ·±åº¦æ´å¯Ÿ
                </h3>
                <div id="ai-content" class="text-sm text-slate-600 leading-relaxed">
                    <p class="text-slate-400 italic">åˆ†æå¾Œé¡¯ç¤º...</p>
                </div>
            </div>
        </aside>

        <main class="flex-1 bg-slate-100 relative flex items-center justify-center p-4">
            <div id="canvas-wrapper" class="w-full h-full bg-white rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden flex items-center justify-center">
                <div id="empty-state" class="text-center text-slate-400">
                    <i class="fa-solid fa-chart-simple text-5xl mb-4 opacity-30"></i>
                    <p>è«‹åœ¨å·¦å´è¼¸å…¥æ–‡å­—ä¸¦é–‹å§‹åˆ†æ</p>
                </div>
                <canvas id="word-cloud-canvas" class="hidden"></canvas>
            </div>

            <button onclick="downloadImage()" id="btn-download" class="hidden absolute bottom-8 right-8 bg-white text-slate-700 px-4 py-2 rounded-full shadow-lg border border-slate-200 hover:bg-brand-50 hover:text-brand-600 transition flex items-center gap-2 font-bold z-30">
                <i class="fa-solid fa-download"></i> ä¸‹è¼‰åœ–ç‰‡
            </button>
        </main>
    </div>

    <script>
        // ğŸ”´ğŸ”´ğŸ”´ è«‹å‹™å¿…å¡«å…¥æ‚¨éƒ¨ç½²å¾Œçš„ GAS Web App URL (çµå°¾æ˜¯ /exec) ğŸ”´ğŸ”´ğŸ”´
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw3UqYr976wAd9aeEsLpTDSlGaUVdBpaErqZi-zHgNzh_Gd0SuggfdI7ldVzrqR1Ygd/exec"; 

        // å…¨åŸŸè®Šæ•¸
        let currentWords = [];
        let activePos = new Set(['n', 'v', 'a', 'd']); // é è¨­å‹¾é¸å››å¤§è©é¡

        const EXAMPLE_TEXT = "é›»æµç£æ•ˆæ‡‰æ˜¯æŒ‡é›»æµé€šéå°ç·šæ™‚ï¼Œæœƒåœ¨å°ç·šå‘¨åœç”¢ç”Ÿç£å ´çš„ç¾è±¡ã€‚1820å¹´ï¼Œä¸¹éº¥ç‰©ç†å­¸å®¶å¥§æ–¯ç‰¹ç™¼ç¾ï¼Œç•¶å°ç·šé€šé›»æ™‚ï¼Œæ—é‚Šçš„ç£é‡æœƒç™¼ç”Ÿåè½‰ï¼Œè­‰æ˜äº†é›»èˆ‡ç£ä¹‹é–“æœ‰å¯†åˆ‡çš„é—œä¿‚ã€‚ç£å ´çš„æ–¹å‘å¯ä»¥ç”¨å®‰åŸ¹å³æ‰‹å®šå‰‡ä¾†åˆ¤æ–·ï¼šç”¨å³æ‰‹æ¡ä½å°ç·šï¼Œå¤§æ‹‡æŒ‡æŒ‡å‘é›»æµæ–¹å‘ï¼Œå››æŒ‡å½æ›²çš„æ–¹å‘å°±æ˜¯ç£å ´æ–¹å‘ã€‚è‹¥å°‡å°ç·šç¹æˆèºç·šç®¡ï¼Œé€šé›»å¾Œå…§éƒ¨æœƒç”¢ç”Ÿå‡å‹»ç£å ´ï¼Œå…¶ç‰¹æ€§é¡ä¼¼æ–¼æ¢å½¢ç£éµã€‚";

        function loadExample() {
            document.getElementById('text-input').value = EXAMPLE_TEXT;
        }

        // è©æ€§éæ¿¾é‚è¼¯
        function togglePos(pos) {
            const btn = document.querySelector(`button[data-pos="${pos}"]`);
            if (activePos.has(pos)) {
                activePos.delete(pos);
                btn.classList.remove('active');
            } else {
                activePos.add(pos);
                btn.classList.add('active');
            }
            // å³æ™‚é‡ç¹ª
            if (currentWords.length > 0) renderWordCloud();
        }

        // åŸ·è¡Œåˆ†æ
        function runAnalysis() {
            const text = document.getElementById('text-input').value.trim();
            const model = document.getElementById('model-select').value;
            const btn = document.getElementById('btn-analyze');

            if (!text) { alert("è«‹è¼¸å…¥æ–‡æœ¬"); return; }
            if (GAS_URL.includes("åœ¨æ­¤å¡«å…¥")) { alert("è«‹è¨­å®š GAS URL"); return; }

            // UI Loading
            const orgBtn = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="loader mr-2"></div> åˆ†æä¸­...`;
            
            document.getElementById('empty-state').innerHTML = `<div class="loader mx-auto mb-2"></div><p>AI æ­£åœ¨é–±è®€ä¸¦ç¹ªè£½...</p>`;
            document.getElementById('word-cloud-canvas').classList.add('hidden');
            document.getElementById('ai-content').innerHTML = `<p class="text-slate-400 italic animate-pulse">AI æ­£åœ¨æ€è€ƒ...</p>`;

            const payload = { text: text, mode: model };

            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: { "Content-Type": "text/plain;charset=utf-8" }
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    currentWords = data.data.wordList;
                    // æ›´æ–° AI åˆ†æå€
                    document.getElementById('ai-content').innerHTML = data.data.aiAnalysis;
                    // ç¹ªè£½
                    renderWordCloud();
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(err => {
                console.error(err);
                document.getElementById('empty-state').innerHTML = `<p class="text-red-500">éŒ¯èª¤: ${err.message}</p>`;
                document.getElementById('ai-content').innerHTML = `<p class="text-red-500">é€£ç·šå¤±æ•—</p>`;
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = orgBtn;
            });
        }

        // æ¸²æŸ“æ–‡å­—é›²
        function renderWordCloud() {
            const canvas = document.getElementById('word-cloud-canvas');
            const wrapper = document.getElementById('canvas-wrapper');
            const shape = document.getElementById('shape-select').value;

            // 1. éæ¿¾è³‡æ–™
            const list = currentWords
                .filter(w => {
                    const p = (w.pos || 'o').toLowerCase().charAt(0); // å–ç¬¬ä¸€å€‹å­—æ¯ n, v...
                    // ç°¡å–®å°æ‡‰ï¼šè‹¥ p åœ¨ activePos è£¡ï¼Œæˆ–æ˜¯ activePos åŒ…å« 'o' ä¸” p ä¸åœ¨ n,v,a,d è£¡
                    if (['n','v','a','d'].includes(p)) return activePos.has(p);
                    return activePos.has('o');
                })
                .map(w => [w.word, w.weight]);

            if (list.length === 0) {
                document.getElementById('empty-state').innerHTML = "<p>ç„¡ç¬¦åˆè©å½™</p>";
                document.getElementById('empty-state').classList.remove('hidden');
                canvas.classList.add('hidden');
                return;
            }

            // 2. æº–å‚™ç•«å¸ƒ
            document.getElementById('empty-state').classList.add('hidden');
            canvas.classList.remove('hidden');
            document.getElementById('btn-download').classList.remove('hidden');

            const w = wrapper.clientWidth;
            const h = wrapper.clientHeight;
            canvas.width = w;
            canvas.height = h;

            // 3. è¨ˆç®—å­—é«”ä¿‚æ•¸ (RWD)
            const maxWeight = Math.max(...list.map(i => i[1])) || 1;
            // è®“å­—é«”éš¨ç•«å¸ƒå¯¬åº¦ç¸®æ”¾ï¼Œä¾‹å¦‚å¯¬åº¦çš„ 1/8 åˆ° 1/20
            const factor = (w / 15) / maxWeight; 

            // 4. WordCloud2
            WordCloud(canvas, {
                list: list,
                gridSize: 10,
                weightFactor: function (size) { return size * factor + 10; }, // åŸºç¤å¤§å° + åŠ æ¬Š
                fontFamily: 'Noto Sans TC, sans-serif',
                color: function (word, weight) {
                    // æ ¹æ“šåŸå§‹è³‡æ–™æ‰¾è©æ€§é¡è‰²
                    const item = currentWords.find(i => i.word === word);
                    return getPosColor(item ? item.pos : 'o');
                },
                rotateRatio: 0.2,
                rotationSteps: 2,
                shape: shape,
                backgroundColor: 'transparent',
                drawOutOfBound: false,
                shrinkToFit: true
            });
        }

        function getPosColor(pos) {
            const p = String(pos).toUpperCase();
            if (p.startsWith('N')) return '#3b82f6'; // è—
            if (p.startsWith('V')) return '#10b981'; // ç¶ 
            if (p.startsWith('A')) return '#f59e0b'; // é»ƒ
            if (p.startsWith('D')) return '#8b5cf6'; // ç´«
            return '#64748b'; // ç°
        }

        function downloadImage() {
            const canvas = document.getElementById('word-cloud-canvas');
            // å»ºç«‹ä¸€å€‹ç™½è‰²èƒŒæ™¯çš„æš«æ™‚ canvasï¼Œé¿å…ä¸‹è¼‰é€æ˜åœ–
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const ctx = tempCanvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            ctx.drawImage(canvas, 0, 0);

            const link = document.createElement('a');
            link.download = 'wordcloud.png';
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html>
