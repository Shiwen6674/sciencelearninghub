<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘å­¸é›™èªæ–‡æœ¬é–±è®€ | Science Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        student: { light: '#bfdbfe', DEFAULT: '#3b82f6', dark: '#1d4ed8' },
                        accent: { light: '#818cf8', DEFAULT: '#4f46e5', dark: '#3730a3' }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                    backgroundImage: {
                        'gemini-gradient': 'linear-gradient(135deg, #4285F4 0%, #9B72CB 50%, #EA4335 100%)',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; font-family: 'Noto Sans TC', sans-serif; }
        
        /* é–±è®€å™¨æ’ç‰ˆå„ªåŒ– */
        .reader-content {
            font-size: 1.25rem; /* åŠ å¤§å­—é«” */
            line-height: 2.2;   /* å¢åŠ è¡Œé«˜ */
            color: #334155;
            text-align: justify;
            letter-spacing: 0.02em; /* å¢åŠ å­—è· */
        }
        .reader-content h1 { 
            font-size: 2rem; 
            font-weight: 900; 
            color: #1e293b; 
            margin-bottom: 1.5rem; 
            text-align: center;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 1rem;
        }
        .reader-content p { margin-bottom: 2rem; text-indent: 2em; }
        
        /* é›™èªè©å½™æ¨™è¨˜ */
        .sci-term {
            font-weight: 700;
            color: #2563eb;
            background-color: rgba(37, 99, 235, 0.1);
            padding: 2px 6px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sci-term:hover {
            background-color: #2563eb;
            color: white;
        }

        /* ç»ç’ƒæ“¬æ…‹é¢æ¿ */
        .glass-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* èŠå¤©è¦–çª— */
        .chat-window { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: bottom right; }
        .chat-hidden { transform: scale(0.9) translateY(20px); opacity: 0; pointer-events: none; }
        
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800 bg-slate-50">

    <!-- 1. é ‚éƒ¨å°èˆª (Header) -->
    <header class="glass-header z-40 shrink-0">
        <!-- Row 1: Logo & Nav Buttons -->
        <div class="px-6 py-3 flex justify-between items-center border-b border-slate-100">
            <div class="flex items-center gap-4">
                <button onclick="window.location.href='student.html'" class="flex items-center gap-2 text-slate-500 hover:text-student font-bold transition bg-slate-100 hover:bg-blue-50 px-4 py-2 rounded-xl">
                    <i class="fa-solid fa-chevron-left"></i> <span data-i18n="back_to_hub">è¿”å›å­¸ç¿’ä¸­å¿ƒ</span>
                </button>
                <div class="h-6 w-px bg-slate-300"></div>
                <div class="flex items-center gap-3">
                    <div class="bg-student-light p-2 rounded-xl text-student-dark">
                        <i class="fa-solid fa-book-open-reader text-xl"></i>
                    </div>
                    <h1 class="text-lg font-bold text-slate-800" data-i18n="page_title">ç§‘å­¸é›™èªæ–‡æœ¬é–±è®€</h1>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                 <!-- èªè¨€é¸æ“‡å™¨ -->
                 <select id="ui-lang" onchange="changeUILanguage()" class="bg-slate-50 border border-slate-200 text-sm rounded-lg p-2 outline-none focus:ring-2 focus:ring-student cursor-pointer">
                    <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                    <option value="en">English</option>
                    <option value="ja">æ—¥æœ¬èª</option>
                    <option value="ko">í•œêµ­ì–´</option>
                    <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                    <option value="es">EspaÃ±ol</option>
                    <option value="pt">PortuguÃªs</option>
                    <option value="id">Bahasa Indonesia</option>
                    <option value="th">à¹„à¸—à¸¢</option>
                    <option value="vi">Tiáº¿ng Viá»‡t</option>
                    <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
                    <option value="ms">Bahasa Melayu</option>
                </select>
                <button onclick="window.location.href='unit_summary.html'" class="flex items-center gap-2 bg-green-50 text-green-700 px-4 py-2 rounded-xl hover:bg-green-100 transition font-bold border border-green-200">
                    <i class="fa-solid fa-list-check"></i> <span data-i18n="btn_summary">å–®å…ƒé‡é»æ•´ç†</span> <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Row 2: æ•™æç¯©é¸å™¨ (é€£å‹•é¸å–®) -->
        <div class="px-6 py-3 bg-white/50 backdrop-blur flex flex-wrap items-center gap-3 shadow-sm">
            <div class="flex items-center gap-2 text-sm font-bold text-slate-600 mr-2">
                <i class="fa-solid fa-filter text-student"></i> <span data-i18n="label_filter">æ•™æç¯©é¸ï¼š</span>
            </div>
            
            <select id="sel-stage" class="bg-white border border-slate-300 text-sm rounded-lg focus:ring-2 focus:ring-student p-2 outline-none min-w-[100px]" onchange="updateDropdowns('stage')">
                <option value="" disabled selected data-i18n="opt_stage">å­¸ç¿’éšæ®µ</option>
                <option value="åœ‹å°" data-i18n="val_elem">åœ‹å°</option>
                <option value="åœ‹ä¸­" data-i18n="val_junior">åœ‹ä¸­</option>
                <option value="é«˜ä¸­" disabled data-i18n="val_senior">é«˜ä¸­ (å»ºç½®ä¸­)</option>
            </select>

            <select id="sel-grade" class="bg-white border border-slate-300 text-sm rounded-lg focus:ring-2 focus:ring-student p-2 outline-none min-w-[100px]" onchange="updateDropdowns('grade')" disabled>
                <option value="" data-i18n="opt_grade">å¹´ç´š</option>
                <!-- é¸é …ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </select>

            <select id="sel-version" class="bg-white border border-slate-300 text-sm rounded-lg focus:ring-2 focus:ring-student p-2 outline-none min-w-[100px]" onchange="updateDropdowns('version')" disabled>
                <option value="" data-i18n="opt_version">ç‰ˆæœ¬</option>
                <!-- é¸é …ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </select>

            <select id="sel-semester" class="bg-white border border-slate-300 text-sm rounded-lg focus:ring-2 focus:ring-student p-2 outline-none min-w-[100px]" onchange="updateDropdowns('semester')" disabled>
                <option value="" data-i18n="opt_semester">å­¸æœŸ</option>
                <!-- é¸é …ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </select>

            <select id="sel-unit" class="bg-white border border-slate-300 text-sm rounded-lg focus:ring-2 focus:ring-student p-2 outline-none min-w-[250px]" disabled>
                <option value="" data-i18n="opt_unit">å–®å…ƒåç¨±</option>
            </select>

            <button id="btn-load" onclick="fetchLessonContent()" class="bg-student text-white px-5 py-2 rounded-lg font-bold hover:bg-student-dark transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed ml-auto shadow-blue-200" disabled>
                <i class="fa-solid fa-book-open mr-2"></i><span data-i18n="btn_read">é–±è®€èª²æ–‡</span>
            </button>
        </div>
    </header>

    <!-- 2. é›™æ¬„é–±è®€å€ -->
    <div class="flex-1 flex overflow-hidden relative z-10">
        
        <!-- å·¦å´ï¼šåŸæ–‡ -->
        <div class="w-1/2 flex flex-col border-r border-slate-200 bg-white h-full">
            <div class="px-6 py-2 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 shrink-0 h-14">
                <span class="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2 bg-white px-3 py-1 rounded-md shadow-sm border border-slate-200">
                    <span class="w-2 h-2 rounded-full bg-student"></span> <span data-i18n="label_original">ç¹é«”ä¸­æ–‡ (åŸæ–‡)</span>
                </span>
                <div class="flex items-center gap-3">
                    <!-- èªé€Ÿæ§åˆ¶ -->
                    <div class="flex items-center gap-2 bg-white px-3 py-1 rounded-full border border-slate-200 shadow-sm group hover:border-student transition">
                        <i class="fa-solid fa-gauge-high text-slate-400 text-xs group-hover:text-student"></i>
                        <input type="range" id="rate-zh" min="0.5" max="2" step="0.1" value="1" class="w-20 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-student">
                    </div>
                    <!-- æ’­æ”¾æŒ‰éˆ• -->
                    <button id="btn-play-zh" onclick="toggleSpeech('zh-TW')" class="w-9 h-9 flex items-center justify-center rounded-full bg-student text-white hover:bg-student-dark transition shadow-md hover:shadow-lg transform active:scale-95">
                        <i class="fa-solid fa-play ml-0.5"></i>
                    </button>
                </div>
            </div>
            <div id="content-zh" class="flex-1 overflow-y-auto p-10 custom-scroll reader-content selection:bg-yellow-200">
                <div class="h-full flex flex-col items-center justify-center text-slate-300 select-none">
                    <i class="fa-solid fa-arrow-turn-up text-4xl mb-4 animate-bounce"></i>
                    <p data-i18n="msg_hint">è«‹å…ˆé¸æ“‡ä¸Šæ–¹çš„æ•™æå–®å…ƒ</p>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šç¿»è­¯ -->
        <div class="w-1/2 flex flex-col h-full bg-slate-50/30">
            <div class="px-6 py-2 border-b border-slate-200 flex justify-between items-center bg-white shrink-0 h-14">
                <div class="flex items-center gap-3">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest" data-i18n="label_target">ç¿»è­¯èªè¨€ï¼š</span>
                    <select id="target-lang" onchange="translateContent()" class="text-sm border-none bg-slate-100 rounded-md py-1 px-3 focus:ring-2 focus:ring-accent font-bold text-slate-700 cursor-pointer hover:bg-slate-200 transition">
                        <option value="en">English</option>
                        <option value="ja">æ—¥æœ¬èª</option>
                        <option value="ko">í•œêµ­ì–´</option>
                        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                        <option value="es">EspaÃ±ol</option>
                        <option value="fr">FranÃ§ais</option>
                        <option value="de">Deutsch</option>
                        <option value="vi">Tiáº¿ng Viá»‡t</option>
                        <option value="th">à¹„à¸—à¸¢</option>
                        <option value="id">Bahasa Indonesia</option>
                    </select>
                </div>
                <div class="flex items-center gap-3">
                    <div id="trans-loading" class="hidden flex items-center gap-2 text-xs text-accent font-bold mr-2 bg-indigo-50 px-2 py-1 rounded">
                        <div class="loader w-3 h-3 border-t-accent"></div> Translating...
                    </div>
                    
                    <div class="flex items-center gap-2 bg-white px-3 py-1 rounded-full border border-slate-200 shadow-sm group hover:border-accent transition">
                        <i class="fa-solid fa-gauge-high text-slate-400 text-xs group-hover:text-accent"></i>
                        <input type="range" id="rate-target" min="0.5" max="2" step="0.1" value="1" class="w-20 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-accent">
                    </div>
                    <!-- æ’­æ”¾æŒ‰éˆ• -->
                    <button id="btn-play-target" onclick="toggleSpeech('target')" class="w-9 h-9 flex items-center justify-center rounded-full bg-accent text-white hover:bg-indigo-700 transition shadow-md hover:shadow-lg transform active:scale-95">
                        <i class="fa-solid fa-play ml-0.5"></i>
                    </button>
                </div>
            </div>
            <div id="content-target" class="flex-1 overflow-y-auto p-10 custom-scroll reader-content selection:bg-indigo-200 bg-slate-50">
                <div class="h-full flex flex-col items-center justify-center text-slate-300 select-none">
                    <p data-i18n="msg_trans_hint">ç¿»è­¯å…§å®¹å°‡é¡¯ç¤ºæ–¼æ­¤</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. å°ç§‘æ©Ÿå™¨äºº -->
    <div class="fixed bottom-8 right-8 z-50 flex flex-col items-end">
        <div id="chat-window" class="chat-window chat-hidden mb-4 w-80 md:w-96 h-[550px] bg-white rounded-2xl shadow-2xl border border-slate-200 overflow-hidden flex flex-col ring-1 ring-black/5">
            <!-- Chat Header -->
            <div class="bg-gemini-gradient p-4 flex justify-between items-center text-white shadow-md">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 backdrop-blur rounded-full flex items-center justify-center border border-white/30 shadow-inner">
                        <i class="fa-solid fa-robot text-lg"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-base" data-i18n="bot_name">å°ç§‘ (SciBot)</h3>
                        <p class="text-xs text-white/90 flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span> ç·šä¸Šç‚ºæ‚¨è§£æƒ‘
                        </p>
                    </div>
                </div>
                <button onclick="toggleChat()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <!-- Chat Messages -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 bg-slate-50 space-y-4 custom-scroll">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full bg-white text-student flex items-center justify-center shrink-0 border border-slate-200 shadow-sm mt-1"><i class="fa-solid fa-robot text-xs"></i></div>
                    <div class="bg-white p-3.5 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 text-slate-700 text-sm leading-relaxed" data-i18n="bot_welcome">
                        å—¨ï¼æˆ‘æ˜¯å°ç§‘ ğŸ‘‹<br>é–±è®€èª²æ–‡æ™‚æœ‰ä»»ä½•ä¸æ‡‚çš„ç§‘å­¸æ¦‚å¿µï¼Œéƒ½å¯ä»¥å•æˆ‘å–”ï¼
                    </div>
                </div>
            </div>
            
            <!-- Chat Input -->
            <div class="p-3 bg-white border-t border-slate-100 flex gap-2 items-center">
                <input type="text" id="chat-input" class="flex-1 bg-slate-50 border border-slate-200 rounded-full px-4 py-2.5 text-sm focus:outline-none focus:border-student focus:ring-2 focus:ring-student/20 transition" placeholder="è¼¸å…¥ä½ çš„å•é¡Œ..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()" class="w-10 h-10 bg-student text-white rounded-full flex items-center justify-center hover:bg-student-dark transition shadow-md hover:shadow-lg transform active:scale-95">
                    <i class="fa-solid fa-paper-plane text-sm"></i>
                </button>
            </div>
        </div>

        <!-- Float Button -->
        <button onclick="toggleChat()" class="group relative flex items-center justify-center outline-none transition transform hover:scale-105 active:scale-95">
            <div class="relative w-16 h-16 bg-gemini-gradient rounded-full shadow-xl flex items-center justify-center text-white text-3xl border-4 border-white hover:shadow-2xl">
                <i class="fa-solid fa-robot"></i>
            </div>
            <div class="absolute right-20 bg-slate-800 text-white text-xs px-3 py-2 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none whitespace-nowrap">
                æˆ‘æ˜¯å°ç§‘ï¼Œä¸æ‡‚å¯ä»¥å•æˆ‘å“¦ï¼
                <div class="absolute top-1/2 -right-1 -mt-1 border-4 border-transparent border-l-slate-800"></div>
            </div>
        </button>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzcDKkz8Tilzb3qbx0_fDR7QoG4-c2JCtsa4p9V8_1gBjZaEMlvQHd72OD0kZq_jW8H/exec";
        
        // è³‡æ–™å„²å­˜
        let textbookData = {}; // å„²å­˜å¾å¾Œç«¯æŠ“å–çš„é¸å–®çµæ§‹
        let currentRawText = "";
        let currentTerms = {};
        let isSpeaking = false;
        
        // UI å¤šèªç³»å­—å…¸ (å«é¸å–®é¸é …ç¿»è­¯é‚è¼¯)
        const uiTranslations = {
            "zh-TW": {
                page_title: "ç§‘å­¸é›™èªé–±è®€å™¨", back_to_hub: "è¿”å›å­¸ç¿’ä¸­å¿ƒ", btn_summary: "å–®å…ƒé‡é»æ•´ç†",
                label_filter: "æ•™æç¯©é¸ï¼š", opt_stage: "å­¸ç¿’éšæ®µ", opt_grade: "å¹´ç´š", opt_version: "ç‰ˆæœ¬", opt_semester: "å­¸æœŸ", opt_unit: "å–®å…ƒåç¨±",
                val_elem: "åœ‹å°", val_junior: "åœ‹ä¸­", val_senior: "é«˜ä¸­",
                btn_read: "é–±è®€èª²æ–‡", label_original: "ç¹é«”ä¸­æ–‡ (åŸæ–‡)", label_target: "ç¿»è­¯èªè¨€ï¼š",
                msg_hint: "è«‹å…ˆé¸æ“‡ä¸Šæ–¹çš„æ•™æå–®å…ƒ", msg_trans_hint: "ç¿»è­¯å…§å®¹å°‡é¡¯ç¤ºæ–¼æ­¤",
                bot_name: "å°ç§‘ (SciBot)", bot_welcome: "å—¨ï¼æˆ‘æ˜¯å°ç§‘ ğŸ‘‹<br>é–±è®€èª²æ–‡æ™‚æœ‰ä»»ä½•ä¸æ‡‚çš„ç§‘å­¸æ¦‚å¿µï¼Œéƒ½å¯ä»¥å•æˆ‘å–”ï¼",
                grade_3: "ä¸‰å¹´ç´š", grade_4: "å››å¹´ç´š", grade_5: "äº”å¹´ç´š", grade_6: "å…­å¹´ç´š",
                grade_7: "ä¸ƒå¹´ç´š", grade_8: "å…«å¹´ç´š", grade_9: "ä¹å¹´ç´š"
            },
            "en": {
                page_title: "Bilingual Science Reader", back_to_hub: "Back to Hub", btn_summary: "Unit Summary",
                label_filter: "Filter:", opt_stage: "Stage", opt_grade: "Grade", opt_version: "Edition", opt_semester: "Semester", opt_unit: "Unit",
                val_elem: "Elementary", val_junior: "Junior High", val_senior: "Senior High",
                btn_read: "Read", label_original: "Original (Traditional Chinese)", label_target: "Translate to:",
                msg_hint: "Please select a unit above", msg_trans_hint: "Translation will appear here",
                bot_name: "SciBot", bot_welcome: "Hi! I'm SciBot ğŸ‘‹<br>Ask me anything about the text!",
                grade_3: "Grade 3", grade_4: "Grade 4", grade_5: "Grade 5", grade_6: "Grade 6",
                grade_7: "Grade 7", grade_8: "Grade 8", grade_9: "Grade 9"
            },
            "ja": {
                page_title: "ç§‘å­¦ãƒã‚¤ãƒªãƒ³ã‚¬ãƒ«ãƒªãƒ¼ãƒ€ãƒ¼", back_to_hub: "å­¦ç¿’ãƒãƒ–ã¸æˆ»ã‚‹", btn_summary: "å˜å…ƒã®ã¾ã¨ã‚",
                label_filter: "æ•™æãƒ•ã‚£ãƒ«ã‚¿:", opt_stage: "å­¦ç¿’æ®µéš", opt_grade: "å­¦å¹´", opt_version: "ç‰ˆ", opt_semester: "å­¦æœŸ", opt_unit: "å˜å…ƒå",
                val_elem: "å°å­¦æ ¡", val_junior: "ä¸­å­¦æ ¡", val_senior: "é«˜æ ¡",
                btn_read: "èª­ã‚€", label_original: "åŸæ–‡ (ç¹ä½“å­—ä¸­å›½èª)", label_target: "ç¿»è¨³è¨€èª:",
                msg_hint: "ä¸Šã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„", msg_trans_hint: "ç¿»è¨³ã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™",
                bot_name: "ã‚µã‚¤ãƒœãƒƒãƒˆ", bot_welcome: "ã“ã‚“ã«ã¡ã¯ï¼ã‚µã‚¤ãƒœãƒƒãƒˆã§ã™ ğŸ‘‹<br>ã‚ã‹ã‚‰ãªã„ã“ã¨ãŒã‚ã‚Œã°èã„ã¦ãã ã•ã„ï¼",
                grade_3: "å°3", grade_4: "å°4", grade_5: "å°5", grade_6: "å°6",
                grade_7: "ä¸­1", grade_8: "ä¸­2", grade_9": "ä¸­3"
            },
            // ... (å…¶ä»–èªè¨€å¯ä¾æ­¤é¡æ¨ï¼Œç‚ºç¯€çœé•·åº¦æš«ç•¥ï¼Œé‚è¼¯é€šç”¨) ...
        };
        // è£œé½Š fallback
        ["ko", "zh-CN", "es", "pt", "id", "th", "vi", "hi", "ms"].forEach(l => {
            if(!uiTranslations[l]) uiTranslations[l] = JSON.parse(JSON.stringify(uiTranslations['en']));
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            fetchTextbookOptions();
            changeUILanguage();
        });

        // 1. èªè¨€åˆ‡æ›
        function changeUILanguage() {
            const lang = document.getElementById('ui-lang').value;
            const t = uiTranslations[lang] || uiTranslations['en'];
            
            document.querySelectorAll("[data-i18n]").forEach(el => {
                const key = el.getAttribute("data-i18n");
                if (t[key]) el.innerHTML = t[key];
            });

            // æ›´æ–°é¸å–®å…§çš„éœæ…‹é¸é …æ–‡å­— (ä¾‹å¦‚ã€Œå­¸ç¿’éšæ®µã€)
            updateDropdownLabels(t);
            
            // å¦‚æœé¸å–®å·²æœ‰å…§å®¹ï¼Œå˜—è©¦æ›´æ–°é¸é …é¡¯ç¤ºæ–‡å­— (ä¾‹å¦‚ "ä¸‰å¹´ç´š" -> "Grade 3")
            refreshDropdownOptionsDisplay(lang);
        }

        function updateDropdownLabels(t) {
            const map = { 'sel-stage': 'opt_stage', 'sel-grade': 'opt_grade', 'sel-version': 'opt_version', 'sel-semester': 'opt_semester', 'sel-unit': 'opt_unit' };
            for(const [id, key] of Object.entries(map)) {
                const sel = document.getElementById(id);
                if(sel.options.length > 0 && sel.options[0].disabled) {
                    sel.options[0].text = t[key];
                }
            }
        }

        // 2. ç²å–å¾Œç«¯é¸å–®è³‡æ–™
        function fetchTextbookOptions() {
            fetch(GAS_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: "get_textbook_options" })
            }).then(() => {
                // æ¨¡æ“¬è³‡æ–™ (çœŸå¯¦ç’°å¢ƒè«‹ç”¨ response)
                setTimeout(() => {
                    textbookData = {
                        "åœ‹å°": {
                            "ä¸‰å¹´ç´š": { "å—ä¸€": { "ä¸Šå­¸æœŸ": ["1.èªè­˜æ¤ç‰©", "2.ç©ºæ°£èˆ‡é¢¨"], "ä¸‹å­¸æœŸ": ["1.æ°´çš„è®ŠåŒ–"] }, "åº·è»’": { "ä¸Šå­¸æœŸ": ["1.æ¤ç‰©"], "ä¸‹å­¸æœŸ": ["1.æ°´"] }, "ç¿°æ—": { "ä¸Šå­¸æœŸ": ["1.æ¤ç‰©"], "ä¸‹å­¸æœŸ": ["1.æ°´"] } },
                            "å››å¹´ç´š": { "å—ä¸€": { "ä¸Šå­¸æœŸ": ["1.æœˆäº®"], "ä¸‹å­¸æœŸ": ["1.æ˜†èŸ²"] }, "åº·è»’": { "ä¸Šå­¸æœŸ": ["1.æœˆäº®"], "ä¸‹å­¸æœŸ": ["1.æ˜†èŸ²"] }, "ç¿°æ—": { "ä¸Šå­¸æœŸ": ["1.æœˆäº®"], "ä¸‹å­¸æœŸ": ["1.æ˜†èŸ²"] } },
                            "äº”å¹´ç´š": { "å—ä¸€": { "ä¸Šå­¸æœŸ": ["1.å¤ªé™½"], "ä¸‹å­¸æœŸ": ["1.åŠ›"] }, "åº·è»’": { "ä¸Šå­¸æœŸ": ["1.å¤ªé™½"], "ä¸‹å­¸æœŸ": ["1.åŠ›"] }, "ç¿°æ—": { "ä¸Šå­¸æœŸ": ["1.å¤ªé™½èˆ‡æ˜Ÿæ˜Ÿ"], "ä¸‹å­¸æœŸ": ["1.åŠ›èˆ‡é‹å‹•"] } },
                            "å…­å¹´ç´š": { "å—ä¸€": { "ä¸Šå­¸æœŸ": ["1.å¤©æ°£"], "ä¸‹å­¸æœŸ": ["1.ç°¡å–®æ©Ÿæ¢°"] }, "åº·è»’": { "ä¸Šå­¸æœŸ": ["1.å¤©æ°£"], "ä¸‹å­¸æœŸ": ["1.ç°¡å–®æ©Ÿæ¢°"] }, "ç¿°æ—": { "ä¸Šå­¸æœŸ": ["1.å¤©æ°£"], "ä¸‹å­¸æœŸ": ["1.ç°¡å–®æ©Ÿæ¢°"] } }
                        },
                        "åœ‹ä¸­": {
                            "ä¸ƒå¹´ç´š": { "å—ä¸€": { "ä¸Šå­¸æœŸ": ["1.ç”Ÿå‘½ç§‘å­¸"], "ä¸‹å­¸æœŸ": ["1.ç”Ÿç‰©åˆ†é¡"] }, "åº·è»’": { "ä¸Šå­¸æœŸ": ["1.ç”Ÿå‘½"], "ä¸‹å­¸æœŸ": ["1.æ¼”åŒ–"] }, "ç¿°æ—": { "ä¸Šå­¸æœŸ": ["1.ç§‘å­¸æ–¹æ³•"], "ä¸‹å­¸æœŸ": ["1.ç”Ÿæ…‹"] } },
                            "å…«å¹´ç´š": { "å—ä¸€": { "ä¸Šå­¸æœŸ": ["1.åŸºæœ¬æ¸¬é‡"], "ä¸‹å­¸æœŸ": ["1.åŒ–å­¸åæ‡‰"] }, "åº·è»’": { "ä¸Šå­¸æœŸ": ["1.æ¸¬é‡"], "ä¸‹å­¸æœŸ": ["1.åŸå­"] }, "ç¿°æ—": { "ä¸Šå­¸æœŸ": ["1.å¯¦é©—å®¤"], "ä¸‹å­¸æœŸ": ["1.åæ‡‰é€Ÿç‡"] } },
                            "ä¹å¹´ç´š": { "å—ä¸€": { "ä¸Šå­¸æœŸ": ["1.ç›´ç·šé‹å‹•"], "ä¸‹å­¸æœŸ": ["1.é›»æµç£æ•ˆæ‡‰"] }, "åº·è»’": { "ä¸Šå­¸æœŸ": ["1.é‹å‹•å­¸"], "ä¸‹å­¸æœŸ": ["1.é›»èˆ‡ç£"] }, "ç¿°æ—": { "ä¸Šå­¸æœŸ": ["1.é‹å‹•"], "ä¸‹å­¸æœŸ": ["1.é›»ç£å­¸"] } }
                        }
                    };
                    // é è¨­é–å®šåœ‹å°/åœ‹ä¸­é¸é … (value ä¸è®Šï¼Œé¡¯ç¤ºæ–‡å­—éš¨èªè¨€è®Š)
                    updateDropdowns('init');
                }, 1000);
            });
        }

        // 3. ç´šè¯é¸å–®é‚è¼¯
        function updateDropdowns(source) {
            const stage = document.getElementById('sel-stage');
            const grade = document.getElementById('sel-grade');
            const version = document.getElementById('sel-version');
            const semester = document.getElementById('sel-semester');
            const unit = document.getElementById('sel-unit');
            const btn = document.getElementById('btn-load');

            // é‡ç½®è¼”åŠ©å‡½å¼
            const reset = (el, key) => {
                const t = uiTranslations[document.getElementById('ui-lang').value] || uiTranslations['en'];
                el.innerHTML = `<option value="" disabled selected>${t[key]}</option>`;
                el.disabled = true;
            };

            // Stage è®Šæ›´ (æˆ–åˆå§‹åŒ–)
            if (source === 'init' || source === undefined) {
                // å¡«å…… Stage (åªæœ‰åœ‹å°/åœ‹ä¸­)
                reset(stage, 'opt_stage');
                reset(grade, 'opt_grade'); reset(version, 'opt_version'); reset(semester, 'opt_semester'); reset(unit, 'opt_unit');
                
                stage.disabled = false;
                ['åœ‹å°', 'åœ‹ä¸­'].forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.text = getTranslatedOption(s); // å–å¾—å°æ‡‰èªè¨€æ–‡å­—
                    stage.add(opt);
                });
            } 
            else if (source === 'stage') {
                reset(grade, 'opt_grade'); reset(version, 'opt_version'); reset(semester, 'opt_semester'); reset(unit, 'opt_unit');
                const sVal = stage.value;
                if (textbookData[sVal]) {
                    grade.disabled = false;
                    Object.keys(textbookData[sVal]).forEach(g => {
                         const opt = document.createElement('option');
                         opt.value = g;
                         opt.text = getTranslatedOption(g);
                         grade.add(opt);
                    });
                }
            }
            else if (source === 'grade') {
                reset(version, 'opt_version'); reset(semester, 'opt_semester'); reset(unit, 'opt_unit');
                const sVal = stage.value;
                const gVal = grade.value;
                if (textbookData[sVal][gVal]) {
                    version.disabled = false;
                    Object.keys(textbookData[sVal][gVal]).forEach(v => {
                        const opt = document.createElement('option');
                        opt.value = v;
                        opt.text = v; // ç‰ˆæœ¬åé€šå¸¸ä¸ç¿»è­¯æˆ–ç°¡å–®å°æ‡‰
                        version.add(opt);
                    });
                }
            }
            else if (source === 'version') {
                reset(semester, 'opt_semester'); reset(unit, 'opt_unit');
                const sVal = stage.value; const gVal = grade.value; const vVal = version.value;
                if (textbookData[sVal][gVal][vVal]) {
                    semester.disabled = false;
                    Object.keys(textbookData[sVal][gVal][vVal]).forEach(sem => {
                        const opt = document.createElement('option');
                        opt.value = sem;
                        opt.text = sem; // å­¸æœŸå
                        semester.add(opt);
                    });
                }
            }
            else if (source === 'semester') {
                reset(unit, 'opt_unit');
                const sVal = stage.value; const gVal = grade.value; const vVal = version.value; const semVal = semester.value;
                if (textbookData[sVal][gVal][vVal][semVal]) {
                    unit.disabled = false;
                    textbookData[sVal][gVal][vVal][semVal].forEach(u => {
                        const opt = document.createElement('option');
                        opt.value = u;
                        opt.text = u;
                        unit.add(opt);
                    });
                }
            }
            
            // å•Ÿç”¨æŒ‰éˆ•æª¢æŸ¥
            btn.disabled = !unit.value;
        }

        // è¼”åŠ©ï¼šç¿»è­¯é¸é …æ–‡å­— (ä¾‹å¦‚ "ä¸‰å¹´ç´š" -> "Grade 3")
        function getTranslatedOption(val) {
            const lang = document.getElementById('ui-lang').value;
            const t = uiTranslations[lang] || uiTranslations['en'];
            
            if (val === 'åœ‹å°') return t.val_elem;
            if (val === 'åœ‹ä¸­') return t.val_junior;
            // å°æ–¼ "ä¸‰å¹´ç´š" é€™ç¨® keyï¼Œå­—å…¸è£¡æ˜¯ grade_3
            // ç°¡å–®æ˜ å°„
            const gradeMap = { 'ä¸‰å¹´ç´š': 'grade_3', 'å››å¹´ç´š': 'grade_4', 'äº”å¹´ç´š': 'grade_5', 'å…­å¹´ç´š': 'grade_6', 'ä¸ƒå¹´ç´š': 'grade_7', 'å…«å¹´ç´š': 'grade_8', 'ä¹å¹´ç´š': 'grade_9' };
            if (gradeMap[val] && t[gradeMap[val]]) return t[gradeMap[val]];
            
            return val; // æ‰¾ä¸åˆ°å°±å›å‚³åŸå€¼
        }
        
        // ç•¶èªè¨€åˆ‡æ›æ™‚ï¼Œåˆ·æ–°é¸å–®é¡¯ç¤ºæ–‡å­— (ä½†ä¸æ”¹è®Š value)
        function refreshDropdownOptionsDisplay(lang) {
            const stage = document.getElementById('sel-stage');
            const grade = document.getElementById('sel-grade');
            
            Array.from(stage.options).forEach(opt => {
                if (!opt.disabled) opt.text = getTranslatedOption(opt.value);
            });
            Array.from(grade.options).forEach(opt => {
                if (!opt.disabled) opt.text = getTranslatedOption(opt.value);
            });
        }

        // 4. ç²å–èª²æ–‡ (POST åˆ° GAS)
        function fetchLessonContent() {
            const criteria = {
                stage: document.getElementById('sel-stage').value,
                grade: document.getElementById('sel-grade').value,
                version: document.getElementById('sel-version').value,
                semester: document.getElementById('sel-semester').value,
                unit: document.getElementById('sel-unit').value
            };

            document.getElementById('content-zh').innerHTML = '<div class="h-full flex items-center justify-center"><div class="loader"></div></div>';
            
            fetch(GAS_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: "get_lesson_content", criteria: criteria })
            }).then(() => {
                setTimeout(() => {
                    const mockData = {
                        title: criteria.unit,
                        content: "æ¤ç‰©çš„è‘‰å­å«æœ‰è‘‰ç¶ ç´ ï¼Œå¯ä»¥å¸æ”¶å¤ªé™½èƒ½é€²è¡Œå…‰åˆä½œç”¨ã€‚\nå…‰åˆä½œç”¨éœ€è¦æ°´å’ŒäºŒæ°§åŒ–ç¢³ä½œç‚ºåŸæ–™ï¼Œåæ‡‰å¾Œæœƒç”¢ç”Ÿè‘¡è„ç³–å’Œæ°§æ°£ã€‚\né€™å€‹éç¨‹å°æ–¼ç¶­æŒåœ°çƒç”Ÿæ…‹ç³»çš„èƒ½é‡æµå‹•è‡³é—œé‡è¦ã€‚",
                        terms: { "å…‰åˆä½œç”¨": "photosynthesis", "è‘‰ç¶ ç´ ": "chlorophyll", "äºŒæ°§åŒ–ç¢³": "carbon dioxide", "è‘¡è„ç³–": "glucose", "æ°§æ°£": "oxygen" }
                    };
                    renderContent(mockData);
                }, 1500);
            });
        }

        function renderContent(data) {
            currentRawText = data.content;
            currentTerms = data.terms;

            let html = `<h1>${data.title}</h1>`;
            data.content.split('\n').forEach(p => {
                if (!p.trim()) return;
                let text = p;
                for (let [zh, en] of Object.entries(data.terms)) {
                    const regex = new RegExp(zh, "g");
                    text = text.replace(regex, `<span class="sci-term" title="${en}">${zh}<span class="text-sm font-normal ml-1">(${en})</span></span>`);
                }
                html += `<p>${text}</p>`;
            });

            document.getElementById('content-zh').innerHTML = html;
            translateContent();
        }

        // 5. ç¿»è­¯åŠŸèƒ½
        function translateContent() {
            const lang = document.getElementById('target-lang').value;
            if(!currentRawText) return;

            document.getElementById('trans-loading').classList.remove('hidden');
            document.getElementById('content-target').innerHTML = '<div class="h-full flex items-center justify-center"><div class="loader"></div></div>';

            fetch(GAS_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: "translate_text", text: currentRawText, targetLang: lang })
            }).then(() => {
                setTimeout(() => {
                    // Mock translation for demo
                    const mockTrans = `## ${document.getElementById('sel-unit').value}\n\nPlants' leaves contain **chlorophyll**, which absorbs solar energy to perform **photosynthesis**.\n\nPhotosynthesis requires water and **carbon dioxide** as raw materials, producing **glucose** and **oxygen** after the reaction.`;
                    document.getElementById('content-target').innerHTML = marked.parse(mockTrans);
                    document.getElementById('trans-loading').classList.add('hidden');
                }, 1500);
            });
        }

        // 6. èªéŸ³åŠŸèƒ½ (TTS)
        function speakText(side) {
            window.speechSynthesis.cancel(); 
            let text = "", lang = "zh-TW", rate = 1, btnId = "";

            if (side === 'zh-TW') {
                text = document.getElementById('content-zh').innerText;
                rate = document.getElementById('rate-zh').value;
                btnId = "btn-play-zh";
            } else {
                text = document.getElementById('content-target').innerText;
                lang = document.getElementById('target-lang').value; // ä½¿ç”¨é¸å®šçš„ç¿»è­¯èªè¨€
                rate = document.getElementById('rate-target').value;
                btnId = "btn-play-target";
            }

            if (!text.trim()) return;

            const btn = document.getElementById(btnId);
            const originalIcon = btn.innerHTML;
            
            // åˆ‡æ›åœ–ç¤º
            btn.innerHTML = '<i class="fa-solid fa-stop"></i>';
            btn.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');

            const u = new SpeechSynthesisUtterance(text);
            u.lang = lang;
            u.rate = rate;
            
            u.onend = () => {
                btn.innerHTML = originalIcon;
                btn.classList.remove('bg-red-500', 'text-white', 'hover:bg-red-600');
            };
            
            window.speechSynthesis.speak(u);
        }

        // 7. èŠå¤©æ©Ÿå™¨äºº
        function toggleChat() {
            const win = document.getElementById('chat-window');
            win.classList.toggle('chat-hidden');
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;

            addMsg(msg, 'user');
            input.value = '';
            
            // æ¨¡æ“¬ Loading
            const loadingId = 'loading-' + Date.now();
            const container = document.getElementById('chat-messages');
            container.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="flex items-start gap-2"><div class="w-8 h-8 rounded-full bg-white text-student flex items-center justify-center shrink-0 border border-slate-200"><i class="fa-solid fa-robot text-xs"></i></div><div class="bg-white px-4 py-2 rounded-2xl rounded-tl-none shadow-sm text-slate-400 text-sm"><i class="fa-solid fa-ellipsis fa-bounce"></i></div></div>`);
            container.scrollTop = container.scrollHeight;

            fetch(GAS_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: "chat_bot", message: msg, context: currentRawText })
            }).then(() => {
                setTimeout(() => {
                    document.getElementById(loadingId).remove();
                    addMsg("é€™æ˜¯ä¸€å€‹æ¨¡æ“¬çš„ AI å›æ‡‰ã€‚åœ¨çœŸå¯¦ä¸²æ¥å¾Œï¼Œé€™è£¡æœƒé¡¯ç¤º Gemini é‡å°èª²æ–‡çš„å›ç­”ã€‚", 'bot');
                }, 1000);
            });
        }

        function addMsg(text, role) {
            const container = document.getElementById('chat-messages');
            let html = '';
            if (role === 'user') {
                html = `<div class="flex justify-end"><div class="bg-student text-white px-4 py-2 rounded-2xl rounded-tr-none shadow-sm max-w-[85%] text-sm">${text}</div></div>`;
            } else {
                html = `<div class="flex items-start gap-2">
                            <div class="w-8 h-8 rounded-full bg-white text-student flex items-center justify-center shrink-0 border border-slate-200 shadow-sm"><i class="fa-solid fa-robot text-xs"></i></div>
                            <div class="bg-white px-4 py-2 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 text-slate-700 max-w-[85%] text-sm leading-relaxed">${text}</div>
                        </div>`;
            }
            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
