<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘å­¸é›™èªæ–‡æœ¬é–±è®€ | Science Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        student: { light: '#e0f2fe', DEFAULT: '#0ea5e9', dark: '#0284c7' }, // æ›´æŸ”å’Œçš„è—è‰²
                        paper: '#ffffff',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', '"Microsoft JhengHei"', 'sans-serif'], // å¼·åˆ¶å¾®è»Ÿæ­£é»‘æˆ– Noto
                    },
                    animation: {
                        "fade-in-up": "fadeInUp 0.6s ease-out forwards"
                    },
                    keyframes: {
                        "fadeInUp": { "0%": { opacity: "0", transform: "translateY(15px)" }, "100%": { opacity: "1", transform: "translateY(0)" } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; font-family: 'Noto Sans TC', sans-serif; }
        
        /* ç»ç’ƒæ“¬æ…‹ header */
        .glass-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* é–±è®€å€å¡Šå„ªåŒ–ï¼šä»¿æ›¸æœ¬æ’ç‰ˆ */
        .reader-container {
            font-size: 1.25rem; /* å¢å¤§å­—é«”é©åˆå­¸ç”Ÿ */
            line-height: 1.8;   /* èˆ’é©è¡Œé«˜ */
            color: #334155;
            text-align: justify;
        }
        
        /* å–®å…ƒæ¨™é¡Œæ¨£å¼ */
        .reader-container h1 {
            font-size: 1.8rem;
            font-weight: 800;
            color: #0f172a;
            margin-bottom: 1.5rem;
            padding-left: 1rem;
            border-left: 5px solid #0ea5e9; /* å·¦å´é£¾æ¢ */
            line-height: 1.4;
        }

        /* å…§æ–‡æ®µè½ */
        .reader-container p {
            margin-bottom: 1.5rem; /* æ®µè½é–“è·åŠ å¤§ */
            background-color: white;
            padding: 1.25rem;
            border-radius: 1rem;
            box-shadow: 0 2px 4px rgba(148, 163, 184, 0.1); /* è¼•å¾®å¡ç‰‡æ„Ÿ */
            border: 1px solid #f1f5f9;
        }

        /* ç§‘å­¸è©å½™æ¨™è¨» */
        .sci-term {
            font-weight: 700;
            color: #0284c7;
            background-color: #e0f2fe;
            padding: 2px 6px;
            border-radius: 6px;
            border-bottom: 2px solid #7dd3fc;
            cursor: help;
            transition: all 0.2s;
            display: inline-block;
        }
        .sci-term:hover { background-color: #0284c7; color: white; }

        /* ä¸‹æ‹‰é¸å–®ç¾åŒ– */
        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            appearance: none;
        }

        /* å·è»¸ç¾åŒ– */
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; border: 2px solid #f8fafc; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

        /* Google å°ç§‘æ¨£å¼ */
        .google-border {
            position: relative; z-index: 0; overflow: hidden;
        }
        .google-border::before {
            content: ""; position: absolute; z-index: -1; inset: 0; padding: 2px; border-radius: 50%;
            background: linear-gradient(135deg, #4285F4, #EA4335, #FBBC05, #34A853);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; mask-composite: exclude;
        }
        .google-text {
            background: linear-gradient(135deg, #4285F4, #EA4335, #34A853);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .chat-window { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: bottom right; }
        .chat-hidden { transform: scale(0.9) translateY(20px); opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800 bg-slate-50">

    <header class="glass-header z-40 flex flex-col shadow-sm relative">
        <div class="px-6 py-3 flex justify-between items-center border-b border-slate-100">
            <div class="flex items-center gap-4">
                <button onclick="window.location.href='student.html'" class="flex items-center gap-2 text-slate-500 hover:text-student font-bold transition bg-slate-50 px-4 py-2 rounded-full border border-slate-200 hover:border-student shadow-sm">
                    <i class="fa-solid fa-chevron-left"></i> <span data-i18n="back_student">è¿”å›å­¸ç¿’ä¸­å¿ƒ</span>
                </button>
                <div class="h-6 w-px bg-slate-300 hidden md:block"></div>
                <div class="flex items-center gap-3">
                    <div class="bg-blue-50 p-2 rounded-xl text-blue-600 hidden md:block">
                        <i class="fa-solid fa-book-open-reader text-xl"></i>
                    </div>
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight" data-i18n="page_title">ç§‘å­¸é›™èªæ–‡æœ¬é–±è®€</h1>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                 <div class="relative">
                    <i class="fa-solid fa-globe absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <select id="ui-lang" onchange="changeUILanguage()" class="custom-select pl-9 pr-10 py-2 bg-white border border-slate-200 text-sm rounded-full focus:ring-2 focus:ring-student outline-none cursor-pointer shadow-sm text-slate-600 font-bold hover:bg-slate-50 transition">
                        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                        <option value="en">English</option>
                        <option value="ja">æ—¥æœ¬èª</option>
                        <option value="ko">í•œêµ­ì–´</option>
                        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                        <option value="es">EspaÃ±ol</option>
                        <option value="pt">PortuguÃªs</option>
                        <option value="id">Bahasa Indonesia</option>
                        <option value="th">à¹„à¸—à¸¢</option>
                        <option value="vi">Tiáº¿ng Viá»‡t</option>
                        <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
                        <option value="ms">Bahasa Melayu</option>
                    </select>
                 </div>
                 <button onclick="window.location.href='unitkeyidea.html'" class="flex items-center gap-2 bg-emerald-50 text-emerald-700 px-5 py-2 rounded-full hover:bg-emerald-100 transition font-bold border border-emerald-200 shadow-sm">
                    <i class="fa-solid fa-list-check"></i> <span data-i18n="btn_summary">é‡é»æ•´ç†</span>
                </button>
            </div>
        </div>

        <div class="px-6 py-4 bg-white/80 backdrop-blur flex flex-wrap items-center gap-3 shadow-inner">
            <div class="flex items-center gap-2 text-sm font-bold text-slate-500 mr-2 uppercase tracking-wide">
                <i class="fa-solid fa-filter text-student"></i> <span data-i18n="label_filter">æ•™æç¯©é¸</span>
            </div>
            
            <select id="sel-stage" class="custom-select bg-white border border-slate-300 text-sm rounded-lg p-2.5 min-w-[120px] font-medium text-slate-700 shadow-sm focus:border-student focus:ring-1 focus:ring-student" onchange="updateDropdowns('stage')">
                <option value="" disabled selected data-i18n="opt_stage">è¼‰å…¥ä¸­...</option>
            </select>
            <select id="sel-grade" class="custom-select bg-white border border-slate-300 text-sm rounded-lg p-2.5 min-w-[100px] font-medium text-slate-700 shadow-sm" onchange="updateDropdowns('grade')" disabled>
                <option value="" data-i18n="opt_grade">å¹´ç´š</option>
            </select>
            <select id="sel-version" class="custom-select bg-white border border-slate-300 text-sm rounded-lg p-2.5 min-w-[100px] font-medium text-slate-700 shadow-sm" onchange="updateDropdowns('version')" disabled>
                <option value="" data-i18n="opt_version">ç‰ˆæœ¬</option>
            </select>
            <select id="sel-semester" class="custom-select bg-white border border-slate-300 text-sm rounded-lg p-2.5 min-w-[100px] font-medium text-slate-700 shadow-sm" onchange="updateDropdowns('semester')" disabled>
                <option value="" data-i18n="opt_semester">å­¸æœŸ</option>
            </select>
            <select id="sel-unit" class="custom-select bg-white border border-slate-300 text-sm rounded-lg p-2.5 min-w-[250px] flex-1 font-medium text-slate-700 shadow-sm" onchange="document.getElementById('btn-load').disabled = !this.value" disabled>
                <option value="" data-i18n="opt_unit">å–®å…ƒåç¨±</option>
            </select>

            <button id="btn-load" onclick="fetchLessonContent()" class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-6 py-2.5 rounded-xl font-bold shadow-md hover:shadow-lg hover:shadow-blue-500/30 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 ml-2 transform active:scale-95">
                <i class="fa-solid fa-book-open"></i> <span data-i18n="btn_read">é–±è®€èª²æ–‡</span>
            </button>
        </div>
    </header>

    <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative z-10">
        
        <div class="w-full md:w-1/2 flex flex-col border-r border-slate-200 bg-[#f8fafc] h-full shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10">
            <div class="px-6 py-3 border-b border-slate-200 flex justify-between items-center bg-white shrink-0 shadow-sm">
                <span class="text-xs font-extrabold text-slate-500 uppercase tracking-widest flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200">
                    <span class="w-2 h-2 rounded-full bg-blue-500"></span> <span data-i18n="label_original">ç¹é«”ä¸­æ–‡ (åŸæ–‡)</span>
                </span>
                <div class="flex items-center gap-3">
                    <div class="flex items-center bg-slate-50 rounded-lg border border-slate-200 px-2">
                        <i class="fa-solid fa-gauge-high text-slate-400 text-xs pl-2"></i>
                        <select id="rate-zh" class="bg-transparent text-xs font-bold text-slate-600 p-1.5 outline-none cursor-pointer">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1.0x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2.0x</option>
                        </select>
                    </div>
                    <button id="btn-play-zh" onclick="toggleSpeech('zh-TW')" class="w-10 h-10 flex items-center justify-center rounded-full bg-red-600 text-white hover:bg-red-700 transition shadow-md hover:shadow-lg transform active:scale-95" title="æ’­æ”¾ (è‡ªç„¶éŸ³)">
                        <i class="fa-brands fa-youtube text-lg"></i>
                    </button>
                </div>
            </div>
            <div id="content-zh" class="flex-1 overflow-y-auto p-8 custom-scroll reader-container selection:bg-blue-100">
                <div class="h-full flex flex-col items-center justify-center text-slate-300 select-none animate-fade-in-up">
                    <div class="bg-white p-8 rounded-full mb-6 border border-slate-100 shadow-sm">
                        <i class="fa-solid fa-arrow-up text-5xl text-blue-100 animate-bounce"></i>
                    </div>
                    <p data-i18n="msg_hint" class="text-xl font-bold text-slate-400">è«‹å…ˆé¸æ“‡ä¸Šæ–¹çš„æ•™æå–®å…ƒ</p>
                </div>
            </div>
        </div>

        <div class="w-full md:w-1/2 flex flex-col h-full bg-white">
            <div class="px-6 py-3 border-b border-slate-200 flex justify-between items-center bg-white shrink-0 shadow-sm">
                <div class="flex items-center gap-3">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-widest" data-i18n="label_target">ç¿»è­¯èªè¨€ï¼š</span>
                    <select id="target-lang" class="custom-select text-sm border border-slate-200 bg-slate-50 rounded-lg py-1.5 px-3 pr-8 focus:ring-2 focus:ring-indigo-500 font-bold text-slate-700 cursor-pointer hover:border-indigo-300 transition shadow-sm">
                        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                        <option value="en" selected>English</option>
                        <option value="ja">æ—¥æœ¬èª</option>
                        <option value="ko">í•œêµ­ì–´</option>
                        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                        <option value="es">EspaÃ±ol</option>
                        <option value="pt">PortuguÃªs</option>
                        <option value="id">Bahasa Indonesia</option>
                        <option value="th">à¹„à¸—à¸¢</option>
                        <option value="vi">Tiáº¿ng Viá»‡t</option>
                        <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
                        <option value="ms">Bahasa Melayu</option>
                    </select>
                    <button onclick="translateContent()" class="bg-indigo-600 text-white px-4 py-1.5 rounded-lg text-sm font-bold shadow hover:bg-indigo-700 transition flex items-center gap-1 active:scale-95">
                         <i class="fa-solid fa-language"></i> ç¿»è­¯
                    </button>
                </div>
                <div class="flex items-center gap-3">
                    <div id="trans-loading" class="hidden flex items-center gap-2 text-xs text-indigo-600 font-bold bg-indigo-50 px-3 py-1 rounded-full border border-indigo-100">
                        <div class="loader w-3 h-3 border-t-indigo-600"></div> <span data-i18n="msg_translating">ç¿»è­¯ä¸­...</span>
                    </div>
                    <div class="flex items-center bg-slate-50 rounded-lg border border-slate-200 px-2">
                        <i class="fa-solid fa-gauge-high text-slate-400 text-xs pl-2"></i>
                        <select id="rate-target" class="bg-transparent text-xs font-bold text-slate-600 p-1.5 outline-none cursor-pointer">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1.0x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2.0x</option>
                        </select>
                    </div>
                    <button id="btn-play-target" onclick="toggleSpeech('target')" class="w-10 h-10 flex items-center justify-center rounded-full bg-indigo-600 text-white hover:bg-indigo-700 transition shadow-md hover:shadow-lg transform active:scale-95" title="æ’­æ”¾ (è‡ªç„¶éŸ³)">
                        <i class="fa-brands fa-youtube text-lg"></i>
                    </button>
                </div>
            </div>
            <div id="content-target" class="flex-1 overflow-y-auto p-8 custom-scroll reader-container selection:bg-indigo-100 bg-white">
                <div class="h-full flex flex-col items-center justify-center text-slate-300 select-none">
                    <p data-i18n="msg_trans_hint" class="font-medium">è«‹é¸æ“‡èªè¨€ä¸¦é»æ“Šç¿»è­¯æŒ‰éˆ•</p>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-8 right-8 z-50 flex flex-col items-end">
        <div id="chat-window" class="chat-window chat-hidden mb-4 w-80 md:w-96 h-[500px] bg-white rounded-2xl shadow-2xl border border-slate-200 overflow-hidden flex flex-col ring-1 ring-black/5">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 flex justify-between items-center text-white shadow-md">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-md google-border">
                        <i class="fa-solid fa-robot text-lg google-text"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-base" data-i18n="bot_name">å°ç§‘ (SciBot)</h3>
                        <p class="text-xs text-white/90 flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span> ç·šä¸Šç‚ºæ‚¨è§£æƒ‘
                        </p>
                    </div>
                </div>
                <button onclick="toggleChat()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 bg-slate-50 space-y-4 custom-scroll">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shrink-0 shadow-sm mt-1 google-border">
                        <i class="fa-solid fa-robot text-xs google-text"></i>
                    </div>
                    <div class="bg-white p-3.5 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 text-slate-700 text-sm leading-relaxed" data-i18n="bot_welcome">
                        å—¨ï¼æˆ‘æ˜¯å°ç§‘ ğŸ‘‹<br>é–±è®€èª²æ–‡æ™‚æœ‰ä»»ä½•ä¸æ‡‚çš„ç§‘å­¸æ¦‚å¿µï¼Œéƒ½å¯ä»¥å•æˆ‘å–”ï¼
                    </div>
                </div>
            </div>
            <div class="p-3 bg-white border-t border-slate-100 flex gap-2 items-center">
                <input type="text" id="chat-input" class="flex-1 bg-slate-50 border border-slate-200 rounded-full px-4 py-2.5 text-sm focus:outline-none focus:border-student focus:ring-2 focus:ring-student/20 transition" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()" class="w-10 h-10 bg-student text-white rounded-full flex items-center justify-center hover:bg-student-dark transition shadow-md hover:shadow-lg transform active:scale-95">
                    <i class="fa-solid fa-paper-plane text-sm"></i>
                </button>
            </div>
        </div>

        <button onclick="toggleChat()" class="group relative flex items-center justify-center outline-none transition transform hover:scale-105 active:scale-95">
            <div class="relative w-16 h-16 bg-white rounded-full shadow-xl flex items-center justify-center text-3xl google-border hover:shadow-2xl">
                <i class="fa-solid fa-robot google-text"></i>
            </div>
        </button>
    </div>
    
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-xl transition-all duration-300 opacity-0 translate-y-10 z-50 flex items-center gap-3 pointer-events-none">
        <i id="toast-icon" class="fa-solid fa-circle-info text-yellow-400"></i>
        <span id="toast-msg">ç³»çµ±æç¤º</span>
    </div>

    <script>
        // *** è¨˜å¾—ç¢ºèªæ‚¨çš„ GAS URL ***
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx3MW-IOcU-38IqgawidSakL9nVwARmov4cuK0S6Jcqbv3SJFyHUbrvrI43Y6nskJAx/exec"; 
        
        let allOptions = {}; 
        let currentRawText = ""; 
        let currentTerms = {}; 
        let isSpeaking = false;
        let translationCache = {};

        // UI ç¿»è­¯è¨­å®š
        const uiTranslations = {
            "zh-TW": {
                page_title: "ç§‘å­¸é›™èªé–±è®€å™¨", back_student: "è¿”å›å­¸ç¿’ä¸­å¿ƒ", btn_summary: "é‡é»æ•´ç†",
                label_filter: "æ•™æç¯©é¸", opt_stage: "å­¸ç¿’éšæ®µ", opt_grade: "å¹´ç´š", opt_version: "ç‰ˆæœ¬", opt_semester: "å­¸æœŸ", opt_unit: "å–®å…ƒåç¨±",
                btn_read: "é–±è®€èª²æ–‡", label_original: "ç¹é«”ä¸­æ–‡ (åŸæ–‡)", label_target: "ç¿»è­¯èªè¨€ï¼š",
                msg_hint: "è«‹å…ˆé¸æ“‡ä¸Šæ–¹çš„æ•™æå–®å…ƒ", msg_trans_hint: "è«‹é¸æ“‡èªè¨€ä¸¦é»æ“Šç¿»è­¯æŒ‰éˆ•", msg_translating: "ç¿»è­¯ä¸­...",
                bot_name: "å°ç§‘ (SciBot)", bot_welcome: "å—¨ï¼æˆ‘æ˜¯å°ç§‘ ğŸ‘‹<br>é–±è®€èª²æ–‡æ™‚æœ‰ä»»ä½•ä¸æ‡‚çš„ç§‘å­¸æ¦‚å¿µï¼Œéƒ½å¯ä»¥å•æˆ‘å–”ï¼"
            },
            "en": {
                page_title: "Bilingual Science Reader", back_student: "Back to Hub", btn_summary: "Summary",
                label_filter: "Filter", opt_stage: "Stage", opt_grade: "Grade", opt_version: "Edition", opt_semester: "Semester", opt_unit: "Unit",
                btn_read: "Read", label_original: "Original (TC)", label_target: "Translate to:",
                msg_hint: "Select a unit above", msg_trans_hint: "Select language and click translate", msg_translating: "Translating...",
                bot_name: "SciBot", bot_welcome: "Hi! I'm SciBot ğŸ‘‹<br>Ask me anything about the text!"
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            fetchTextbookOptions(); 
            changeUILanguage();
            // é è¼‰èªéŸ³
            if(window.speechSynthesis) {
                window.speechSynthesis.getVoices();
            }
        });

        // æ ¸å¿ƒåŠŸèƒ½ 1: å°‹æ‰¾è‡ªç„¶èªéŸ³
        function getBestVoice(lang) {
            const voices = window.speechSynthesis.getVoices();
            // å„ªå…ˆå°‹æ‰¾ Google æˆ– Microsoft çš„è‡ªç„¶éŸ³
            let voice = voices.find(v => v.lang.includes(lang) && (v.name.includes("Google") || v.name.includes("Natural")));
            if (!voice) voice = voices.find(v => v.lang.includes(lang)); // æ¬¡é¸ï¼šç¬¦åˆèªè¨€å³å¯
            return voice;
        }

        // æ ¸å¿ƒåŠŸèƒ½ 2: æ’­æ”¾èªéŸ³ (ä½¿ç”¨å€é€Ÿ)
        function speakText(side) {
            window.speechSynthesis.cancel(); 
            let text = "", lang = "zh-TW", rate = 1, btnId = "";

            if (side === 'zh-TW') {
                text = document.getElementById('content-zh').innerText;
                rate = parseFloat(document.getElementById('rate-zh').value); // è®€å–ä¸‹æ‹‰é¸å–®å€é€Ÿ
                btnId = "btn-play-zh";
            } else {
                text = document.getElementById('content-target').innerText;
                lang = document.getElementById('target-lang').value;
                rate = parseFloat(document.getElementById('rate-target').value);
                btnId = "btn-play-target";
            }

            if (!text || text.includes("è«‹å…ˆé¸æ“‡") || text.includes("ç¿»è­¯ä¸­")) {
                showToast("æ²’æœ‰å¯æœ—è®€çš„æ–‡å­—", "error");
                return;
            }

            const btn = document.getElementById(btnId);
            btn.innerHTML = '<i class="fa-solid fa-stop"></i>'; // è®Šæ›´ç‚ºåœæ­¢åœ–ç¤º
            btn.classList.add('bg-slate-800', 'border-transparent'); // è¦–è¦ºå›é¥‹

            const u = new SpeechSynthesisUtterance(text);
            const voice = getBestVoice(lang === 'zh-TW' ? 'zh-TW' : lang);
            if (voice) u.voice = voice;
            
            u.lang = lang;
            u.rate = rate; // è¨­å®šå€é€Ÿ

            u.onend = () => {
                btn.innerHTML = '<i class="fa-brands fa-youtube text-lg"></i>'; // æ¢å¾© YT åœ–ç¤º
                btn.classList.remove('bg-slate-800', 'border-transparent');
                isSpeaking = false;
            };
            
            window.speechSynthesis.speak(u);
            isSpeaking = true;
        }

        function toggleSpeech(side) {
            if (isSpeaking) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                // é‡ç½®æ‰€æœ‰æ’­æ”¾æŒ‰éˆ•
                document.querySelectorAll('#btn-play-zh, #btn-play-target').forEach(btn => {
                    btn.innerHTML = '<i class="fa-brands fa-youtube text-lg"></i>';
                    btn.classList.remove('bg-slate-800', 'border-transparent');
                });
            } else {
                speakText(side);
            }
        }

        // --- ä¸‹æ–¹ç‚ºæ¨™æº–é‚è¼¯ (fetch, render, translate, chat) ---

        function showToast(msg, type="info") {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('opacity-0', 'translate-y-10');
            if(type === 'error') toast.classList.replace('bg-slate-800/90', 'bg-red-800/90');
            setTimeout(() => { 
                toast.classList.add('opacity-0', 'translate-y-10'); 
                toast.classList.replace('bg-red-800/90', 'bg-slate-800/90');
            }, 3000);
        }

        function changeUILanguage() {
            const lang = document.getElementById('ui-lang').value;
            const t = uiTranslations[lang] || uiTranslations['zh-TW'];
            if(t) {
                 document.querySelectorAll("[data-i18n]").forEach(el => {
                    const key = el.getAttribute("data-i18n");
                    if (t[key]) el.innerHTML = t[key];
                });
                updateDropdownLabels(t);
            }
        }

        function updateDropdownLabels(t) {
            const map = { 'sel-stage': 'opt_stage', 'sel-grade': 'opt_grade', 'sel-version': 'opt_version', 'sel-semester': 'opt_semester', 'sel-unit': 'opt_unit' };
            for(const [id, key] of Object.entries(map)) {
                const sel = document.getElementById(id);
                if(sel.options.length > 0 && sel.options[0].disabled) sel.options[0].text = t[key];
            }
        }

        function fetchTextbookOptions() {
            const stageSel = document.getElementById('sel-stage');
            stageSel.options[0].text = "è¼‰å…¥è³‡æ–™åº«ä¸­...";
            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: "get_textbook_options" })
            }).then(res => res.json()).then(response => {
                if(response.result === "success") {
                    allOptions = response.data || response; 
                    delete allOptions.result; delete allOptions.message;
                    initStageSelect();
                    showToast("è³‡æ–™åº«é€£çµæˆåŠŸ");
                } else { showToast("è³‡æ–™è¼‰å…¥å¤±æ•—", "error"); }
            }).catch(err => showToast("ç„¡æ³•é€£æ¥è³‡æ–™åº«", "error"));
        }

        function initStageSelect() {
            const sel = document.getElementById('sel-stage');
            sel.innerHTML = `<option value="" disabled selected>å­¸ç¿’éšæ®µ</option>`;
            Object.keys(allOptions).forEach(key => sel.add(new Option(key, key)));
            sel.disabled = false;
        }

        function updateDropdowns(source) {
            const stage = document.getElementById('sel-stage');
            const grade = document.getElementById('sel-grade');
            const version = document.getElementById('sel-version');
            const semester = document.getElementById('sel-semester');
            const unit = document.getElementById('sel-unit');
            const btn = document.getElementById('btn-load');

            const reset = (el, txt) => { el.innerHTML = `<option value="" disabled selected>${txt}</option>`; el.disabled = true; el.value = ""; };
            const fill = (el, items) => { items.forEach(i => el.add(new Option(i, i))); el.disabled = false; };

            if (source === 'stage') {
                reset(grade, 'å¹´ç´š'); reset(version, 'ç‰ˆæœ¬'); reset(semester, 'å­¸æœŸ'); reset(unit, 'å–®å…ƒåç¨±');
                if (stage.value && allOptions[stage.value]) fill(grade, Object.keys(allOptions[stage.value]));
            } else if (source === 'grade') {
                reset(version, 'ç‰ˆæœ¬'); reset(semester, 'å­¸æœŸ'); reset(unit, 'å–®å…ƒåç¨±');
                if (grade.value && allOptions[stage.value][grade.value]) fill(version, Object.keys(allOptions[stage.value][grade.value]));
            } else if (source === 'version') {
                reset(semester, 'å­¸æœŸ'); reset(unit, 'å–®å…ƒåç¨±');
                if (version.value && allOptions[stage.value][grade.value][version.value]) fill(semester, Object.keys(allOptions[stage.value][grade.value][version.value]));
            } else if (source === 'semester') {
                reset(unit, 'å–®å…ƒåç¨±');
                if (semester.value && allOptions[stage.value][grade.value][version.value][semester.value]) fill(unit, allOptions[stage.value][grade.value][version.value][semester.value]);
            }
            btn.disabled = !unit.value;
        }

        function fetchLessonContent() {
            translationCache = {};
            document.getElementById('content-zh').innerHTML = '<div class="h-full flex items-center justify-center"><div class="loader"></div></div>';
            document.getElementById('content-target').innerHTML = '<div class="h-full flex items-center justify-center text-slate-300">è«‹é¸æ“‡èªè¨€ä¸¦é»æ“Šç¿»è­¯æŒ‰éˆ•</div>';

            const criteria = {
                stage: document.getElementById('sel-stage').value,
                grade: document.getElementById('sel-grade').value,
                version: document.getElementById('sel-version').value,
                semester: document.getElementById('sel-semester').value,
                unit: document.getElementById('sel-unit').value
            };

            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: "get_lesson_content", criteria: criteria })
            }).then(res => res.json()).then(response => {
                if (response.result === "success") {
                    renderContent(response.data || response); 
                } else {
                    document.getElementById('content-zh').innerHTML = `<p class="text-red-500 text-center p-4">Error: ${response.message}</p>`;
                }
            }).catch(err => {
                document.getElementById('content-zh').innerHTML = `<p class="text-red-500 text-center p-4">è®€å–å¤±æ•—</p>`;
                showToast("è®€å–å¤±æ•—", "error");
            });
        }

        function renderContent(data) {
            currentRawText = data.content;
            currentTerms = data.terms || {};

            let html = `<h1>${data.title}</h1>`;
            if (data.content && data.content.trim() !== "") {
                 data.content.split('\n').forEach(p => {
                    if(!p.trim()) return;
                    let text = p;
                    // ç§‘å­¸è©å½™é«˜äº®
                    for (let [zh, en] of Object.entries(currentTerms)) {
                        const regex = new RegExp(zh, "g");
                        text = text.replace(regex, `<span class="sci-term" title="${en}">${zh}</span>`);
                    }
                    html += `<p>${text}</p>`;
                });
            } else {
                html += "<div class='text-center text-slate-400 py-10'><p>æœ¬å–®å…ƒç›®å‰æ²’æœ‰èª²æ–‡å…§å®¹ã€‚</p></div>";
            }
            document.getElementById('content-zh').innerHTML = html;
        }

        function translateContent() {
            const lang = document.getElementById('target-lang').value;
            if(!currentRawText) { showToast("è«‹å…ˆè¼‰å…¥èª²æ–‡", "error"); return; }
            if (lang === 'zh-TW') { document.getElementById('content-target').innerHTML = document.getElementById('content-zh').innerHTML; return; }
            if (translationCache[lang]) { document.getElementById('content-target').innerHTML = marked.parse(translationCache[lang]); return; }

            document.getElementById('trans-loading').classList.remove('hidden');
            document.getElementById('content-target').innerHTML = '<div class="h-full flex items-center justify-center"><div class="loader"></div></div>';

            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: "translate_text", text: currentRawText, targetLang: lang })
            }).then(res => res.json()).then(response => {
                if (response.result === "success") {
                    const mdText = response.translatedText;
                    translationCache[lang] = mdText;
                    document.getElementById('content-target').innerHTML = marked.parse(mdText);
                } else {
                    document.getElementById('content-target').innerHTML = `<p class="text-red-400 text-center">${response.message || 'ç¿»è­¯å¤±æ•—'}</p>`;
                }
                document.getElementById('trans-loading').classList.add('hidden');
            });
        }

        function toggleChat() {
            const win = document.getElementById('chat-window');
            win.classList.toggle('chat-hidden');
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;
            addMsg(msg, 'user');
            input.value = '';
            
            const loadingId = 'load-' + Date.now();
            document.getElementById('chat-messages').insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="flex items-start gap-2"><div class="w-8 h-8 rounded-full bg-white flex items-center justify-center border border-slate-200"><div class="loader w-4 h-4 border-t-student"></div></div></div>`);

            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: "chat_bot", message: msg, context: currentRawText.substring(0, 10000) })
            }).then(res => res.json()).then(response => {
                document.getElementById(loadingId).remove();
                if (response.result === "success") addMsg(response.reply, 'bot');
                else addMsg("æŠ±æ­‰ï¼Œå°ç§‘é€£ç·šä¸­æ–·ã€‚", 'bot');
            });
        }

        function addMsg(text, role) {
            const container = document.getElementById('chat-messages');
            let html = '';
            if (role === 'user') {
                html = `<div class="flex justify-end"><div class="bg-student text-white px-4 py-2 rounded-2xl rounded-tr-none shadow-sm max-w-[85%] text-sm leading-relaxed">${text}</div></div>`;
            } else {
                html = `<div class="flex items-start gap-2"><div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shrink-0 shadow-sm mt-1 google-border"><i class="fa-solid fa-robot text-xs google-text"></i></div><div class="bg-white px-4 py-2 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 text-slate-700 max-w-[85%] text-sm leading-relaxed prose prose-sm">${marked.parse(text)}</div></div>`;
            }
            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight;
        }

        (function() {
            const canvas = document.getElementById('network-canvas');
            const ctx = canvas.getContext('2d');
            let width, height, orbits = [], centerX, centerY, mouse = { x: null, y: null };
            window.addEventListener('mousemove', e => { mouse.x = e.x; mouse.y = e.y; });
            function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; centerX = width / 2; centerY = height / 2; initOrbits(); }
            class Orbit { constructor(rx, ry, a, c, s) { this.rx=rx; this.ry=ry; this.a=a; this.c=c; this.s=s; this.r=0; this.ea=Math.random()*Math.PI*2; } update(){ this.r+=this.s; this.ea+=0.002; } draw(){ ctx.save(); ctx.translate(centerX,centerY); ctx.rotate(this.a); ctx.beginPath(); ctx.ellipse(0,0,this.rx,this.ry,this.r,0,Math.PI*2); ctx.strokeStyle=this.c; ctx.lineWidth=1; ctx.stroke(); ctx.beginPath(); ctx.arc(this.rx*Math.cos(this.ea), this.ry*Math.sin(this.ea), 3, 0, Math.PI*2); ctx.fillStyle=this.c; ctx.fill(); ctx.restore(); } }
            function initOrbits() { orbits=[]; const br=width<height?width*0.2:height*0.25; orbits.push(new Orbit(br*2.2, br*2.2, 0, 'rgba(59,130,246,0.1)', 0.0005)); orbits.push(new Orbit(br*1.3, br*0.5, Math.PI/6, 'rgba(59,130,246,0.1)', 0.001)); }
            function animate() { ctx.clearRect(0,0,width,height); if(mouse.x){ centerX+=(width/2+(mouse.x-width/2)*0.03-centerX)*0.05; centerY+=(height/2+(mouse.y-height/2)*0.03-centerY)*0.05; } else { centerX+=(width/2-centerX)*0.05; centerY+=(height/2-centerY)*0.05; } orbits.forEach(o=>{o.update();o.draw()}); ctx.beginPath(); ctx.arc(centerX,centerY,5,0,Math.PI*2); ctx.fillStyle='rgba(59,130,246,0.2)'; ctx.fill(); requestAnimationFrame(animate); }
            window.addEventListener('resize', resize); resize(); animate();
        })();
    </script>
</body>
</html>
