<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>科學雙語文本閱讀 | Science Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        student: { light: '#e0f2fe', DEFAULT: '#0ea5e9', dark: '#0284c7' },
                    },
                    fontFamily: {
                        // 強制設定為微軟正黑體
                        sans: ['"Microsoft JhengHei"', '"Heiti TC"', 'sans-serif'],
                        serif: ['"Microsoft JhengHei"', 'sans-serif'], // 即使是書本模式也用正黑體
                    },
                    animation: {
                        "fade-in-up": "fadeInUp 0.5s ease-out forwards"
                    },
                    keyframes: {
                        "fadeInUp": { "0%": { opacity: "0", transform: "translateY(10px)" }, "100%": { opacity: "1", transform: "translateY(0)" } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; font-family: 'Microsoft JhengHei', sans-serif; }
        
        .glass-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* 閱讀區塊樣式修正 */
        .book-page {
            font-family: 'Microsoft JhengHei', sans-serif !important; /* 強制正黑體 */
            font-size: 1.25rem;
            line-height: 1.6; /* 修正：行距縮小 */
            color: #334155;
            background-color: white;
            padding: 2.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            min-height: 100%;
        }

        /* 標題樣式修正 */
        .book-page h1 {
            font-size: 2.25rem; /* 標題加大 */
            font-weight: 900;   /* 最粗體 */
            color: #0f172a;
            margin-bottom: 1.5rem;
            text-align: center;
            border-bottom: 3px solid #0ea5e9;
            padding-bottom: 1rem;
            line-height: 1.3;
        }

        .book-page p {
            margin-bottom: 1.2rem; /* 段落間距 */
            text-align: justify;
        }

        .sci-term {
            font-weight: 800; /* 詞彙加粗 */
            color: #0369a1;
            background-color: #e0f2fe;
            padding: 0 4px;
            border-radius: 4px;
            cursor: help;
        }

        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            appearance: none;
        }

        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .google-gradient-text { background: linear-gradient(135deg, #4285F4, #EA4335, #34A853); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .google-border::before { content: ""; position: absolute; z-index: -1; inset: 0; padding: 2px; border-radius: 50%; background: linear-gradient(135deg, #4285F4, #EA4335, #FBBC05, #34A853); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; }
        .google-border { position: relative; z-index: 0; overflow: hidden; }
        
        .chat-window { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: bottom right; }
        .chat-hidden { transform: scale(0.9) translateY(20px); opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <div id="canvas-container" class="fixed top-0 left-0 w-full h-full -z-10 bg-[#f7f6f3]"></div>

    <header class="glass-header z-40 flex flex-col shadow-sm relative">
        <div class="px-6 py-3 flex justify-between items-center border-b border-slate-100">
            <div class="flex items-center gap-4">
                <button onclick="window.location.href='student.html'" class="flex items-center gap-2 text-slate-500 hover:text-student font-bold transition bg-white px-4 py-2 rounded-full border border-slate-200 hover:border-student shadow-sm">
                    <i class="fa-solid fa-chevron-left"></i> <span data-i18n="back_student">返回</span>
                </button>
                <div class="h-6 w-px bg-slate-300 hidden md:block"></div>
                <h1 class="text-xl font-black text-slate-800 tracking-wide" data-i18n="page_title">科學雙語文本閱讀</h1>
            </div>
            
            <div class="flex items-center gap-3">
                 <div class="relative">
                    <i class="fa-solid fa-globe absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <select id="ui-lang" onchange="changeUILanguage()" class="custom-select pl-9 pr-10 py-1.5 bg-white border border-slate-200 text-sm rounded-full focus:ring-2 focus:ring-student outline-none cursor-pointer shadow-sm text-slate-600 font-bold">
                        <option value="zh-TW">繁體中文</option>
                        <option value="en">English</option>
                        <option value="ja">日本語</option>
                        <option value="ko">한국어</option>
                        <option value="zh-CN">简体中文</option>
                        <option value="es">Español</option>
                        <option value="pt">Português</option>
                        <option value="id">Bahasa Indonesia</option>
                        <option value="th">ไทย</option>
                        <option value="vi">Tiếng Việt</option>
                        <option value="hi">हिन्दी</option>
                        <option value="ms">Bahasa Melayu</option>
                    </select>
                 </div>
                 <button onclick="window.location.href='unitkeyidea.html'" class="flex items-center gap-2 bg-emerald-50 text-emerald-700 px-4 py-1.5 rounded-full hover:bg-emerald-100 transition font-bold border border-emerald-200 shadow-sm text-sm">
                    <i class="fa-solid fa-list-check"></i> <span data-i18n="btn_summary">重點整理</span>
                </button>
            </div>
        </div>

        <div class="px-6 py-3 bg-white/60 backdrop-blur flex flex-wrap items-center gap-3 shadow-sm">
            <div class="flex items-center gap-2 text-xs font-bold text-slate-500 mr-2 uppercase tracking-wide">
                <i class="fa-solid fa-filter text-student"></i> <span data-i18n="label_filter">教材篩選</span>
            </div>
            
            <select id="sel-stage" class="custom-select bg-white border border-slate-300 text-sm rounded-lg p-2 min-w-[100px] font-bold text-slate-700 shadow-sm" onchange="updateDropdowns('stage')">
                <option value="" disabled selected data-i18n="opt_stage">載入中...</option>
            </select>
            <select id="sel-grade" class="custom-select bg-white border border-slate-300 text-sm rounded-lg p-2 min-w-[80px] font-bold text-slate-700 shadow-sm" onchange="updateDropdowns('grade')" disabled>
                <option value="" data-i18n="opt_grade">年級</option>
            </select>
            <select id="sel-version" class="custom-select bg-white border border-slate-300 text-sm rounded-lg p-2 min-w-[80px] font-bold text-slate-700 shadow-sm" onchange="updateDropdowns('version')" disabled>
                <option value="" data-i18n="opt_version">版本</option>
            </select>
            <select id="sel-semester" class="custom-select bg-white border border-slate-300 text-sm rounded-lg p-2 min-w-[80px] font-bold text-slate-700 shadow-sm" onchange="updateDropdowns('semester')" disabled>
                <option value="" data-i18n="opt_semester">學期</option>
            </select>
            <select id="sel-unit" class="custom-select bg-white border border-slate-300 text-sm rounded-lg p-2 min-w-[200px] flex-1 font-bold text-slate-700 shadow-sm" onchange="document.getElementById('btn-load').disabled = !this.value" disabled>
                <option value="" data-i18n="opt_unit">單元名稱</option>
            </select>

            <button id="btn-load" onclick="fetchLessonContent()" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-bold shadow hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 transform active:scale-95 text-sm">
                <i class="fa-solid fa-book-open"></i> <span data-i18n="btn_read">閱讀</span>
            </button>
        </div>
    </header>

    <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative z-10">
        
        <div class="w-full md:w-1/2 flex flex-col border-r border-slate-200 h-full relative">
            <div class="absolute top-0 left-0 w-full px-6 py-2 flex justify-between items-center bg-white/90 backdrop-blur z-20 border-b border-slate-100">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span> <span data-i18n="label_original">原文</span>
                </span>
                <div class="flex items-center gap-3">
                    <div class="flex items-center bg-slate-100 rounded-full px-2 py-0.5">
                        <span class="text-[10px] font-bold text-slate-400 mr-1">SPEED</span>
                        <select id="rate-zh" class="bg-transparent text-xs font-bold text-slate-600 p-1 outline-none cursor-pointer">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1.0x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2.0x</option>
                        </select>
                    </div>
                    <button id="btn-play-zh" onclick="toggleSpeech('zh-TW')" class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-600 text-white hover:bg-blue-700 transition shadow-sm" title="播放">
                        <i class="fa-brands fa-youtube text-sm"></i>
                    </button>
                </div>
            </div>
            <div id="content-zh" class="flex-1 overflow-y-auto p-4 md:p-8 custom-scroll bg-[#f7f6f3]">
                <div class="h-full flex flex-col items-center justify-center text-slate-300 select-none">
                    <i class="fa-solid fa-book-open text-4xl mb-2 text-slate-200"></i>
                    <p data-i18n="msg_hint" class="font-bold">請選擇教材開始閱讀</p>
                </div>
            </div>
        </div>

        <div class="w-full md:w-1/2 flex flex-col h-full bg-white relative">
            <div class="absolute top-0 left-0 w-full px-6 py-2 flex justify-between items-center bg-white/90 backdrop-blur z-20 border-b border-slate-100">
                <div class="flex items-center gap-2">
                    <select id="target-lang" class="custom-select text-xs font-bold text-slate-600 border border-slate-200 bg-slate-50 rounded-full py-1 px-3 pr-6 focus:ring-1 focus:ring-blue-400 cursor-pointer hover:bg-white transition">
                        <option value="zh-TW">繁體中文</option>
                        <option value="en" selected>English</option>
                        <option value="ja">日本語</option>
                        <option value="ko">한국어</option>
                        <option value="zh-CN">简体中文</option>
                        <option value="es">Español</option>
                        <option value="pt">Português</option>
                        <option value="id">Bahasa Indonesia</option>
                        <option value="th">ไทย</option>
                        <option value="vi">Tiếng Việt</option>
                        <option value="hi">हिन्दी</option>
                        <option value="ms">Bahasa Melayu</option>
                    </select>
                    <button onclick="translateContent()" class="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-bold hover:bg-blue-100 transition border border-blue-100 flex items-center gap-1">
                         <i class="fa-solid fa-language"></i> 翻譯
                    </button>
                </div>
                <div class="flex items-center gap-3">
                    <div id="trans-loading" class="hidden flex items-center gap-2 text-xs text-blue-500 font-bold bg-blue-50 px-2 py-0.5 rounded-full">
                        <div class="loader w-3 h-3 border-t-blue-500"></div> 翻譯中...
                    </div>
                    <div class="flex items-center bg-slate-100 rounded-full px-2 py-0.5">
                        <span class="text-[10px] font-bold text-slate-400 mr-1">SPEED</span>
                        <select id="rate-target" class="bg-transparent text-xs font-bold text-slate-600 p-1 outline-none cursor-pointer">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1.0x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2.0x</option>
                        </select>
                    </div>
                    <button id="btn-play-target" onclick="toggleSpeech('target')" class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-600 text-white hover:bg-blue-700 transition shadow-sm" title="播放">
                        <i class="fa-brands fa-youtube text-sm"></i>
                    </button>
                </div>
            </div>
            <div id="content-target" class="flex-1 overflow-y-auto p-4 md:p-8 custom-scroll bg-white">
                <div class="h-full flex flex-col items-center justify-center text-slate-300 select-none">
                    <p data-i18n="msg_trans_hint" class="text-sm font-bold">點擊上方按鈕進行翻譯</p>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end">
        <div id="chat-window" class="chat-window chat-hidden mb-4 w-80 h-[450px] bg-white rounded-2xl shadow-2xl border border-slate-100 overflow-hidden flex flex-col ring-1 ring-black/5">
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-3 flex justify-between items-center text-white shadow-sm">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                        <i class="fa-solid fa-robot text-sm"></i>
                    </div>
                    <span class="font-bold text-sm">小科 (SciBot)</span>
                </div>
                <button onclick="toggleChat()" class="w-6 h-6 flex items-center justify-center rounded-full hover:bg-white/20 transition"><i class="fa-solid fa-xmark text-xs"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 bg-slate-50 space-y-3 custom-scroll">
                <div class="flex items-start gap-2">
                    <div class="w-6 h-6 rounded-full bg-white flex items-center justify-center shadow-sm text-blue-500 border border-blue-100"><i class="fa-solid fa-robot text-[10px]"></i></div>
                    <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 text-slate-600 text-xs leading-relaxed font-bold">
                        嗨！閱讀時有問題都可以問我喔！
                    </div>
                </div>
            </div>
            <div class="p-3 bg-white border-t border-slate-100 flex gap-2">
                <input type="text" id="chat-input" class="flex-1 bg-slate-50 border border-slate-200 rounded-full px-3 py-2 text-xs focus:outline-none focus:border-blue-400 transition" placeholder="輸入問題..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()" class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center hover:bg-blue-600 transition shadow-sm">
                    <i class="fa-solid fa-paper-plane text-xs"></i>
                </button>
            </div>
        </div>
        <button onclick="toggleChat()" class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-xl text-blue-600 hover:scale-105 transition duration-200 border border-slate-100">
            <i class="fa-solid fa-robot"></i>
        </button>
    </div>
    
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800/90 backdrop-blur text-white px-4 py-2 rounded-full shadow-xl transition-all duration-300 opacity-0 translate-y-10 z-50 flex items-center gap-2 pointer-events-none text-sm">
        <i id="toast-icon" class="fa-solid fa-circle-info text-yellow-400"></i>
        <span id="toast-msg">系統提示</span>
    </div>

    <script>
        // *** 您的 GAS URL (請確認是否為新部署的版本) ***
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx3MW-IOcU-38IqgawidSakL9nVwARmov4cuK0S6Jcqbv3SJFyHUbrvrI43Y6nskJAx/exec"; 
        
        let allOptions = {}; 
        let currentRawText = ""; 
        let currentTerms = {}; 
        let isSpeaking = false;
        let translationCache = {};

        const uiTranslations = {
            "zh-TW": { btn_read: "閱讀", label_original: "原文", label_target: "翻譯語言", msg_hint: "請選擇教材", msg_trans_hint: "點擊上方翻譯", msg_translating: "翻譯中..." },
            "en": { btn_read: "Read", label_original: "Original", label_target: "Translate to", msg_hint: "Select Unit", msg_trans_hint: "Click Translate", msg_translating: "Translating..." }
        };

        document.addEventListener('DOMContentLoaded', () => {
            fetchTextbookOptions(); 
            // 預載語音清單
            if(window.speechSynthesis) {
                window.speechSynthesis.getVoices();
                window.speechSynthesis.onvoiceschanged = () => {
                    window.speechSynthesis.getVoices();
                };
            }
        });

        // 核心修正：寬鬆的語音選擇策略，確保有聲音
        function getBestVoice(lang) {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) return null; // 瀏覽器還沒準備好

            // 1. 優先找完全符合且是 Google/Microsoft 的自然音
            let voice = voices.find(v => v.lang.includes(lang) && (v.name.includes("Google") || v.name.includes("Natural")));
            
            // 2. 次選：只要語言符合就好
            if (!voice) voice = voices.find(v => v.lang.includes(lang));
            
            // 3. (Fallback) 如果是中文但沒找到 zh-TW，試試 zh-CN
            if (!voice && lang === 'zh-TW') voice = voices.find(v => v.lang.includes('zh'));

            // 4. 真的沒辦法，就回傳 null，讓瀏覽器用預設
            return voice;
        }

        function speakText(side) {
            window.speechSynthesis.cancel(); 
            let text = "", lang = "zh-TW", rate = 1, btnId = "";

            if (side === 'zh-TW') {
                text = document.getElementById('content-zh').innerText;
                rate = parseFloat(document.getElementById('rate-zh').value);
                btnId = "btn-play-zh";
            } else {
                text = document.getElementById('content-target').innerText;
                lang = document.getElementById('target-lang').value;
                rate = parseFloat(document.getElementById('rate-target').value);
                btnId = "btn-play-target";
            }

            if (!text || text.includes("請選擇") || text.includes("翻譯中") || text.includes("Translation busy")) {
                showToast("沒有可朗讀的文字", "error");
                return;
            }

            const btn = document.getElementById(btnId);
            // 變更為紅色停止鍵
            btn.innerHTML = '<i class="fa-solid fa-stop"></i>';
            btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            btn.classList.add('bg-red-500', 'hover:bg-red-600');

            const u = new SpeechSynthesisUtterance(text);
            const voice = getBestVoice(lang === 'zh-TW' ? 'zh-TW' : lang);
            if (voice) u.voice = voice;
            
            u.lang = lang; // 設定語言代碼
            u.rate = rate; // 設定倍速

            u.onend = () => {
                // 恢復為藍色播放鍵
                btn.innerHTML = '<i class="fa-brands fa-youtube text-lg"></i>';
                btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                isSpeaking = false;
            };
            
            // 錯誤處理：如果播放失敗，也要恢復按鈕
            u.onerror = (e) => {
                console.error("Speech error:", e);
                btn.innerHTML = '<i class="fa-brands fa-youtube text-lg"></i>';
                btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                isSpeaking = false;
            };

            window.speechSynthesis.speak(u);
            isSpeaking = true;
        }
        
        function toggleSpeech(side) {
            if (isSpeaking) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                document.querySelectorAll('#btn-play-zh, #btn-play-target').forEach(btn => {
                    btn.innerHTML = '<i class="fa-brands fa-youtube text-lg"></i>';
                    btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                });
            } else {
                speakText(side);
            }
        }

        // 標準邏輯
        function showToast(msg, type="info") {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('opacity-0', 'translate-y-10');
            if(type === 'error') toast.classList.replace('bg-slate-800/90', 'bg-red-800/90');
            setTimeout(() => { 
                toast.classList.add('opacity-0', 'translate-y-10'); 
                toast.classList.replace('bg-red-800/90', 'bg-slate-800/90');
            }, 3000);
        }

        function changeUILanguage() {
            const lang = document.getElementById('ui-lang').value;
            const t = uiTranslations[lang] || uiTranslations['zh-TW'];
            if(t) {
                 document.querySelectorAll("[data-i18n]").forEach(el => {
                    const key = el.getAttribute("data-i18n");
                    if (t[key]) el.innerHTML = t[key];
                });
                updateDropdownLabels(t);
            }
        }

        function updateDropdownLabels(t) {
            const map = { 'sel-stage': 'opt_stage', 'sel-grade': 'opt_grade', 'sel-version': 'opt_version', 'sel-semester': 'opt_semester', 'sel-unit': 'opt_unit' };
            for(const [id, key] of Object.entries(map)) {
                const sel = document.getElementById(id);
                if(sel.options.length > 0 && sel.options[0].disabled) sel.options[0].text = t[key];
            }
        }

        function fetchTextbookOptions() {
            const stageSel = document.getElementById('sel-stage');
            stageSel.options[0].text = "載入資料庫中...";
            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: "get_textbook_options" })
            }).then(res => res.json()).then(response => {
                if(response.result === "success") {
                    allOptions = response.data || response; 
                    delete allOptions.result; delete allOptions.message;
                    initStageSelect();
                    showToast("已連結資料庫");
                } else { showToast("資料載入失敗", "error"); }
            }).catch(err => showToast("連線失敗", "error"));
        }

        function initStageSelect() {
            const sel = document.getElementById('sel-stage');
            sel.innerHTML = `<option value="" disabled selected>學習階段</option>`;
            Object.keys(allOptions).forEach(key => sel.add(new Option(key, key)));
            sel.disabled = false;
        }

        function updateDropdowns(source) {
            const stage = document.getElementById('sel-stage');
            const grade = document.getElementById('sel-grade');
            const version = document.getElementById('sel-version');
            const semester = document.getElementById('sel-semester');
            const unit = document.getElementById('sel-unit');
            const btn = document.getElementById('btn-load');

            const reset = (el, txt) => { el.innerHTML = `<option value="" disabled selected>${txt}</option>`; el.disabled = true; el.value = ""; };
            const fill = (el, items) => { items.forEach(i => el.add(new Option(i, i))); el.disabled = false; };

            if (source === 'stage') {
                reset(grade, '年級'); reset(version, '版本'); reset(semester, '學期'); reset(unit, '單元名稱');
                if (stage.value && allOptions[stage.value]) fill(grade, Object.keys(allOptions[stage.value]));
            } else if (source === 'grade') {
                reset(version, '版本'); reset(semester, '學期'); reset(unit, '單元名稱');
                if (grade.value && allOptions[stage.value][grade.value]) fill(version, Object.keys(allOptions[stage.value][grade.value]));
            } else if (source === 'version') {
                reset(semester, '學期'); reset(unit, '單元名稱');
                if (version.value && allOptions[stage.value][grade.value][version.value]) fill(semester, Object.keys(allOptions[stage.value][grade.value][version.value]));
            } else if (source === 'semester') {
                reset(unit, '單元名稱');
                if (semester.value && allOptions[stage.value][grade.value][version.value][semester.value]) fill(unit, allOptions[stage.value][grade.value][version.value][semester.value]);
            }
            btn.disabled = !unit.value;
        }

        function fetchLessonContent() {
            translationCache = {};
            document.getElementById('content-zh').innerHTML = '<div class="h-full flex items-center justify-center"><div class="loader"></div></div>';
            document.getElementById('content-target').innerHTML = '<div class="h-full flex items-center justify-center text-slate-300">點擊上方按鈕進行翻譯</div>';

            const criteria = {
                stage: document.getElementById('sel-stage').value,
                grade: document.getElementById('sel-grade').value,
                version: document.getElementById('sel-version').value,
                semester: document.getElementById('sel-semester').value,
                unit: document.getElementById('sel-unit').value
            };

            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: "get_lesson_content", criteria: criteria })
            }).then(res => res.json()).then(response => {
                if (response.result === "success") {
                    renderContent(response.data || response); 
                } else {
                    document.getElementById('content-zh').innerHTML = `<p class="text-red-500 text-center p-4">Error: ${response.message}</p>`;
                }
            }).catch(err => {
                document.getElementById('content-zh').innerHTML = `<p class="text-red-500 text-center p-4">讀取失敗</p>`;
                showToast("讀取失敗", "error");
            });
        }

        function renderContent(data) {
            currentRawText = data.content;
            currentTerms = data.terms || {};

            let html = `<div class="book-page"><h1>${data.title}</h1>`;
            if (data.content && data.content.trim() !== "") {
                 data.content.split('\n').forEach(p => {
                    if(!p.trim()) return;
                    let text = p;
                    for (let [zh, en] of Object.entries(currentTerms)) {
                        const regex = new RegExp(zh, "g");
                        text = text.replace(regex, `<span class="sci-term" title="${en}">${zh}</span>`);
                    }
                    html += `<p>${text}</p>`;
                });
            } else {
                html += "<p>無課文內容。</p>";
            }
            html += "</div>";
            document.getElementById('content-zh').innerHTML = html;
        }

        function translateContent() {
            const lang = document.getElementById('target-lang').value;
            if(!currentRawText) { showToast("請先載入課文", "error"); return; }
            if (lang === 'zh-TW') { document.getElementById('content-target').innerHTML = document.getElementById('content-zh').innerHTML; return; }
            
            if (translationCache[lang]) { 
                document.getElementById('content-target').innerHTML = `<div class="book-page">${marked.parse(translationCache[lang])}</div>`; 
                return; 
            }

            document.getElementById('trans-loading').classList.remove('hidden');
            document.getElementById('content-target').innerHTML = '<div class="h-full flex items-center justify-center"><div class="loader"></div></div>';

            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: "translate_text", text: currentRawText, targetLang: lang })
            }).then(res => res.json()).then(response => {
                if (response.result === "success") {
                    const mdText = response.translatedText;
                    translationCache[lang] = mdText;
                    document.getElementById('content-target').innerHTML = `<div class="book-page">${marked.parse(mdText)}</div>`;
                } else {
                    // 如果後端回傳錯誤 (包含 Translation busy)
                    document.getElementById('content-target').innerHTML = `<p class="text-red-400 text-center font-bold px-4">${response.message || '翻譯失敗'}</p>`;
                }
                document.getElementById('trans-loading').classList.add('hidden');
            });
        }

        function toggleChat() {
            const win = document.getElementById('chat-window');
            win.classList.toggle('chat-hidden');
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;
            addMsg(msg, 'user');
            input.value = '';
            
            const loadingId = 'load-' + Date.now();
            document.getElementById('chat-messages').insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="flex items-start gap-2"><div class="w-6 h-6 rounded-full bg-white flex items-center justify-center border border-slate-200"><div class="loader w-3 h-3 border-t-blue-500"></div></div></div>`);

            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: "chat_bot", message: msg, context: currentRawText.substring(0, 10000) })
            }).then(res => res.json()).then(response => {
                document.getElementById(loadingId).remove();
                if (response.result === "success") addMsg(response.reply, 'bot');
                else addMsg("抱歉，小科連線中斷。", 'bot');
            });
        }

        function addMsg(text, role) {
            const container = document.getElementById('chat-messages');
            let html = '';
            if (role === 'user') {
                html = `<div class="flex justify-end"><div class="bg-blue-50 text-blue-800 px-3 py-2 rounded-2xl rounded-tr-none shadow-sm max-w-[85%] text-xs leading-relaxed border border-blue-100 font-bold">${text}</div></div>`;
            } else {
                html = `<div class="flex items-start gap-2"><div class="w-6 h-6 rounded-full bg-white flex items-center justify-center shrink-0 shadow-sm mt-1 google-border"><i class="fa-solid fa-robot text-xs google-text"></i></div><div class="bg-white px-3 py-2 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 text-slate-600 max-w-[85%] text-xs leading-relaxed prose prose-sm font-bold">${marked.parse(text)}</div></div>`;
            }
            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
