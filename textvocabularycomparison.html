
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文本詞彙比較 | Science Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        researcher: { light: '#e9d5ff', DEFAULT: '#a855f7', dark: '#7e22ce' },
                        glass: {
                            100: 'rgba(255, 255, 255, 0.1)',
                            200: 'rgba(255, 255, 255, 0.2)',
                            700: 'rgba(255, 255, 255, 0.7)',
                            900: 'rgba(255, 255, 255, 0.9)',
                        }
                    },
                    fontFamily: {
                        sans: ['ui-sans-serif', 'system-ui', '-apple-system', "Segoe UI", 'Roboto', "Helvetica Neue", 'Arial', 'sans-serif'],
                    },
                    animation: {
                        "fade-in-up": "fadeInUp 0.6s ease-out forwards",
                        "pulse-slow": "pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite",
                    },
                    keyframes: {
                        "fadeInUp": {
                            "0%": { opacity: "0", transform: "translateY(20px)" },
                            "100%": { opacity: "1", transform: "translateY(0)" }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* 玻璃擬態與背景 */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(126, 34, 206, 0.08);
        }
        
        .input-area:focus {
            outline: none;
            border-color: #a855f7;
            box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.15);
        }

        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; overflow: hidden;
            background: linear-gradient(135deg, #fdfbff 0%, #f5f3ff 100%);
        }

        .title-3d {
            background: linear-gradient(135deg, #581c87 0%, #7e22ce 50%, #a855f7 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: drop-shadow(1px 1px 0px rgba(168, 85, 247, 0.4)) 
                    drop-shadow(3px 3px 0px rgba(88, 28, 135, 0.1));
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d8b4fe; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a855f7; }

        .result-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px -10px rgba(126, 34, 206, 0.15);
            border-color: rgba(168, 85, 247, 0.2);
        }
        
        /* 調整下拉選單樣式 */
        select { font-size: 0.95rem; }
    </style>
</head>
<body class="min-h-screen font-sans flex flex-col text-slate-700 relative overflow-x-hidden selection:bg-purple-200 selection:text-purple-900">

    <div id="canvas-container">
        <canvas id="network-canvas"></canvas>
    </div>

    <!-- 導航列 -->
    <nav class="glass-panel sticky top-0 z-50 border-b-0">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer group" onclick="window.location.href='researcher.html'">
                <div class="bg-purple-100 p-2 rounded-xl text-purple-600 shadow-sm transition group-hover:scale-105 group-hover:bg-purple-200">
                    <i class="fa-solid fa-arrow-left text-lg"></i>
                </div>
                <!-- ★ 新增 data-i18n 標籤，讓它能隨語言切換 -->
                <span class="text-xl font-bold tracking-tight text-slate-800 group-hover:text-purple-700 transition" data-i18n="back_researcher">返回研究中心</span>
            </div>
            
            <!-- 新增語言選單 -->
            <div class="flex items-center space-x-4">
                 <select id="language-selector" onchange="changeLanguage()" class="glass-panel rounded-xl py-2 px-4 text-sm font-medium outline-none focus:ring-2 focus:ring-purple-400/50 cursor-pointer text-slate-700 border border-purple-200 hover:bg-white/90 transition">
                    <option value="zh-TW">繁體中文</option>
                    <option value="en">English</option>
                    <option value="ja">日本語</option>
                    <option value="zh-CN">简体中文</option>
                </select>
                
                <span class="bg-purple-50 text-purple-700 px-4 py-1.5 rounded-full text-sm font-bold border border-purple-200 shadow-sm flex items-center gap-2">
                    <i class="fa-solid fa-scale-balanced"></i> 
                    <span data-i18n="tool_name">文本比較工具</span>
                </span>
            </div>
        </div>
    </nav>

    <!-- 主內容區 -->
    <main class="flex-1 p-6 md:p-10 relative z-10">
        <div class="max-w-[1800px] mx-auto animate-fade-in-up">
            
            <!-- 標題 -->
            <div class="text-center mb-10">
                <h1 class="text-4xl md:text-5xl font-black title-3d mb-3 tracking-tight" data-i18n="page_title">文本詞彙差異分析</h1>
                <p class="text-slate-500 text-lg font-medium" data-i18n="page_subtitle">Text Vocabulary Comparison & Set Analysis</p>
            </div>

            <!-- 輸入區塊 -->
            <div class="glass-panel p-8 rounded-[2.5rem] mb-8 border border-white/60 max-w-7xl mx-auto">
                
                <!-- 控制列 (極簡化：只保留載入範例) -->
                <div class="flex items-center justify-end mb-6">
                    <button onclick="loadDemo()" class="text-sm font-bold text-purple-600 hover:text-purple-800 hover:underline transition flex items-center gap-2 bg-purple-50 px-4 py-2 rounded-full border border-purple-100 hover:bg-purple-100">
                        <i class="fa-solid fa-flask"></i> <span data-i18n="btn_load_demo">載入範例</span>
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 relative">
                    <!-- 文本 A -->
                    <div class="relative group flex flex-col h-full">
                        <div class="flex justify-between items-center mb-3 px-1">
                            <label class="font-bold text-purple-900 text-lg flex items-center gap-2">
                                <div class="w-8 h-8 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center font-black">A</div>
                                <span data-i18n="label_text_a">文本 A</span>
                            </label>
                            <button onclick="clearText('textA')" class="text-slate-400 hover:text-red-500 text-sm transition font-medium px-2 py-1 rounded hover:bg-red-50">
                                <i class="fa-solid fa-trash-can mr-1"></i> <span data-i18n="btn_clear">清空</span>
                            </button>
                        </div>
                        <textarea id="textA" class="input-area w-full h-64 p-6 rounded-3xl border border-slate-200 bg-white/70 text-slate-700 leading-relaxed resize-none custom-scrollbar transition text-base shadow-inner font-mono" placeholder="在此貼上已斷詞的文本 A..."></textarea>
                        <div class="absolute bottom-4 right-4 bg-white/80 backdrop-blur px-3 py-1.5 rounded-xl text-xs font-bold text-purple-600 shadow-sm border border-purple-100 pointer-events-none">
                            <span data-i18n="label_count">詞彙數</span>: <span id="countA">0</span>
                        </div>
                    </div>

                    <!-- 中央操作按鈕 -->
                    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-20 hidden md:flex flex-col gap-4 pt-8">
                        <button onclick="compareTexts()" class="w-14 h-14 bg-white border-2 border-purple-100 rounded-full text-purple-600 shadow-xl hover:shadow-purple-500/20 hover:bg-purple-50 hover:scale-110 hover:border-purple-300 transition transform flex items-center justify-center group" title="Compare">
                            <i class="fa-solid fa-arrow-right-arrow-left text-xl group-hover:animate-pulse"></i>
                        </button>
                    </div>

                    <!-- 文本 B -->
                    <div class="relative group flex flex-col h-full">
                        <div class="flex justify-between items-center mb-3 px-1">
                            <label class="font-bold text-indigo-900 text-lg flex items-center gap-2">
                                <div class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center font-black">B</div>
                                <span data-i18n="label_text_b">文本 B</span>
                            </label>
                            <button onclick="clearText('textB')" class="text-slate-400 hover:text-red-500 text-sm transition font-medium px-2 py-1 rounded hover:bg-red-50">
                                <i class="fa-solid fa-trash-can mr-1"></i> <span data-i18n="btn_clear">清空</span>
                            </button>
                        </div>
                        <textarea id="textB" class="input-area w-full h-64 p-6 rounded-3xl border border-slate-200 bg-white/70 text-slate-700 leading-relaxed resize-none custom-scrollbar transition text-base shadow-inner font-mono" placeholder="在此貼上已斷詞的文本 B..."></textarea>
                        <div class="absolute bottom-4 right-4 bg-white/80 backdrop-blur px-3 py-1.5 rounded-xl text-xs font-bold text-indigo-600 shadow-sm border border-indigo-100 pointer-events-none">
                            <span data-i18n="label_count">詞彙數</span>: <span id="countB">0</span>
                        </div>
                    </div>
                </div>

                <!-- 行動版按鈕 -->
                <div class="md:hidden mt-8">
                    <button onclick="compareTexts()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-purple-500/30 active:scale-95 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-magnifying-glass-chart"></i> <span data-i18n="btn_start_compare">開始比較分析</span>
                    </button>
                </div>
            </div>

            <!-- 分析結果區 (預設隱藏) -->
            <div id="analysis-results" class="hidden mb-10 animate-fade-in-up">
                
                <!-- 4 欄位結果區 (A獨有, 聯集, 交集, B獨有) -->
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                    
                    <!-- 1. A 獨有 -->
                    <div class="result-card bg-white/80 backdrop-blur-md p-5 rounded-3xl shadow-sm border border-purple-100 flex flex-col h-[500px]">
                        <div class="flex items-center justify-between mb-4 pb-3 border-b border-purple-50">
                            <h3 class="font-bold text-purple-700 flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-purple-500 shadow-sm"></span> <span data-i18n="header_only_a">A 獨有</span>
                            </h3>
                            <span class="bg-purple-100 text-purple-700 text-xs px-2.5 py-1 rounded-lg font-black" id="countOnlyA">0</span>
                        </div>
                        <textarea id="onlyA" readonly class="flex-1 w-full bg-transparent resize-none outline-none text-slate-600 custom-scrollbar text-sm leading-relaxed font-mono" placeholder="A 文本獨有的詞彙..."></textarea>
                        <button onclick="copyToClipboard('onlyA')" class="mt-3 w-full py-2 rounded-xl border border-purple-200 text-purple-600 hover:bg-purple-50 transition text-xs font-bold flex items-center justify-center gap-2">
                            <i class="fa-regular fa-copy"></i> <span data-i18n="btn_copy">複製</span>
                        </button>
                    </div>

                    <!-- 2. 聯集 (Union) -->
                    <div class="result-card bg-white/80 backdrop-blur-md p-5 rounded-3xl shadow-sm border border-fuchsia-100 flex flex-col h-[500px]">
                        <div class="flex items-center justify-between mb-4 pb-3 border-b border-fuchsia-50">
                             <h3 class="font-bold text-fuchsia-700 flex items-center gap-2">
                                <i class="fa-solid fa-layer-group text-sm"></i> <span data-i18n="header_union">AB 聯集</span>
                            </h3>
                            <span class="bg-fuchsia-100 text-fuchsia-700 text-xs px-2.5 py-1 rounded-lg font-black" id="countUnion">0</span>
                        </div>
                        <textarea id="unionResult" readonly class="flex-1 w-full bg-transparent resize-none outline-none text-slate-600 custom-scrollbar text-sm leading-relaxed font-mono" placeholder="所有出現過的詞彙..."></textarea>
                        <button onclick="copyToClipboard('unionResult')" class="mt-3 w-full py-2 rounded-xl border border-fuchsia-200 text-fuchsia-600 hover:bg-fuchsia-50 transition text-xs font-bold flex items-center justify-center gap-2">
                            <i class="fa-regular fa-copy"></i> <span data-i18n="btn_copy">複製</span>
                        </button>
                    </div>

                    <!-- 3. 交集 (Common) - 改為 Teal/Cyan 風格 -->
                    <div class="result-card bg-white/80 backdrop-blur-md p-5 rounded-3xl shadow-sm border border-teal-100 flex flex-col h-[500px]">
                        <div class="flex items-center justify-between mb-4 pb-3 border-b border-teal-50">
                            <h3 class="font-bold text-teal-700 flex items-center gap-2">
                                <i class="fa-solid fa-link text-sm"></i> <span data-i18n="header_common">AB 交集</span>
                            </h3>
                            <span class="bg-teal-100 text-teal-700 text-xs px-2.5 py-1 rounded-lg font-black" id="countCommon">0</span>
                        </div>
                        <textarea id="common" readonly class="flex-1 w-full bg-transparent resize-none outline-none text-slate-600 custom-scrollbar text-sm leading-relaxed font-mono" placeholder="共同出現的詞彙..."></textarea>
                        <!-- 按鈕樣式統一 -->
                        <button onclick="copyToClipboard('common')" class="mt-3 w-full py-2 rounded-xl border border-teal-200 text-teal-600 hover:bg-teal-50 transition text-xs font-bold flex items-center justify-center gap-2">
                            <i class="fa-regular fa-copy"></i> <span data-i18n="btn_copy">複製</span>
                        </button>
                    </div>

                    <!-- 4. B 獨有 -->
                    <div class="result-card bg-white/80 backdrop-blur-md p-5 rounded-3xl shadow-sm border border-indigo-100 flex flex-col h-[500px]">
                        <div class="flex items-center justify-between mb-4 pb-3 border-b border-indigo-50">
                            <h3 class="font-bold text-indigo-700 flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-indigo-500 shadow-sm"></span> <span data-i18n="header_only_b">B 獨有</span>
                            </h3>
                            <span class="bg-indigo-100 text-indigo-700 text-xs px-2.5 py-1 rounded-lg font-black" id="countOnlyB">0</span>
                        </div>
                        <textarea id="onlyB" readonly class="flex-1 w-full bg-transparent resize-none outline-none text-slate-600 custom-scrollbar text-sm leading-relaxed font-mono" placeholder="B 文本獨有的詞彙..."></textarea>
                        <button onclick="copyToClipboard('onlyB')" class="mt-3 w-full py-2 rounded-xl border border-indigo-200 text-indigo-600 hover:bg-indigo-50 transition text-xs font-bold flex items-center justify-center gap-2">
                            <i class="fa-regular fa-copy"></i> <span data-i18n="btn_copy">複製</span>
                        </button>
                    </div>
                </div>
                
                <!-- 下載報告按鈕 -->
                <div class="mt-8 text-center">
                    <button onclick="downloadReport()" class="text-slate-400 hover:text-purple-600 transition text-sm font-bold flex items-center justify-center gap-2 mx-auto">
                        <i class="fa-solid fa-download"></i> <span data-i18n="btn_download_report">下載完整分析報告 (.txt)</span>
                    </button>
                </div>
            </div>

        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-2xl transition-all duration-300 opacity-0 translate-y-10 z-50 flex items-center gap-3 pointer-events-none border border-slate-700/50">
        <i class="fa-solid fa-check-circle text-green-400"></i>
        <span id="toast-msg" class="font-medium text-sm">操作成功</span>
    </div>

    <script>
        // *** 多語系字典 ***
        const translations = {
            "zh-TW": {
                "back_researcher": "返回研究中心",
                "tool_name": "文本比較工具", "page_title": "文本詞彙差異分析", "page_subtitle": "Text Vocabulary Comparison & Set Analysis",
                "btn_load_demo": "載入範例", "label_text_a": "文本 A", "label_text_b": "文本 B", "btn_clear": "清空", "label_count": "詞彙數",
                "btn_start_compare": "開始比較分析", "header_only_a": "A 獨有", "header_union": "AB 聯集", "header_common": "AB 交集", "header_only_b": "B 獨有",
                "btn_copy": "複製", "btn_download_report": "下載完整分析報告 (.txt)", "msg_input_empty": "請先輸入或貼上文本", "msg_analysis_done": "分析完成！", "msg_copied": "內容已複製", "msg_downloading": "報告下載中...", "msg_demo_loaded": "範例資料已載入",
                "demo_text_a": "光合作用 是 植物 利用 葉綠素 吸收 太陽能 ， 將 水 和 二氧化碳 轉化 為 葡萄糖 與 氧氣 的 過程 。 這 是 生態系 能量 的 基礎 。",
                "demo_text_b": "呼吸作用 是 生物 利用 氧氣 將 葡萄糖 分解 ， 產生 能量 、 水 和 二氧化碳 的 過程 。 這 是 維持 生命 現象 所 必需 的 。"
            },
            "en": {
                "back_researcher": "Back to Research Center",
                "tool_name": "Text Compare Tool", "page_title": "Vocabulary Gap Analysis", "page_subtitle": "Text Vocabulary Comparison & Set Analysis",
                "btn_load_demo": "Load Demo", "label_text_a": "Text A", "label_text_b": "Text B", "btn_clear": "Clear", "label_count": "Words",
                "btn_start_compare": "Compare", "header_only_a": "Unique to A", "header_union": "Union (A ∪ B)", "header_common": "Intersection (A ∩ B)", "header_only_b": "Unique to B",
                "btn_copy": "Copy", "btn_download_report": "Download Report (.txt)", "msg_input_empty": "Please enter text first", "msg_analysis_done": "Analysis Complete!", "msg_copied": "Copied!", "msg_downloading": "Downloading...", "msg_demo_loaded": "Demo Loaded",
                "demo_text_a": "Photosynthesis is the process used by plants to convert light energy into chemical energy that can later be released to fuel the organism's activities.",
                "demo_text_b": "Cellular respiration is a set of metabolic reactions and processes that take place in the cells of organisms to convert biochemical energy from nutrients into adenosine triphosphate."
            },
            "ja": {
                "back_researcher": "研究センターへ戻る",
                "tool_name": "テキスト比較", "page_title": "語彙差異分析", "page_subtitle": "Text Vocabulary Comparison & Set Analysis",
                "btn_load_demo": "デモをロード", "label_text_a": "テキスト A", "label_text_b": "テキスト B", "btn_clear": "クリア", "label_count": "語数",
                "btn_start_compare": "比較開始", "header_only_a": "A のみ", "header_union": "和集合 (A ∪ B)", "header_common": "共通 (A ∩ B)", "header_only_b": "B のみ",
                "btn_copy": "コピー", "btn_download_report": "レポートをダウンロード (.txt)", "msg_input_empty": "テキストを入力してください", "msg_analysis_done": "分析完了！", "msg_copied": "コピーしました", "msg_downloading": "ダウンロード中...", "msg_demo_loaded": "デモデータをロードしました",
                "demo_text_a": "光合成 は 植物 が 光エネルギー を 利用 して 水 と 二酸化炭素 から 酸素 と 炭水化物 を 合成 する 過程 です 。",
                "demo_text_b": "呼吸 は 生物 が 酸素 を 用いて 有機物 を 分解 し 、 エネルギー を 取り出す 過程 です 。"
            },
            "zh-CN": {
                "back_researcher": "返回研究中心",
                "tool_name": "文本比较工具", "page_title": "文本词汇差异分析", "page_subtitle": "Text Vocabulary Comparison & Set Analysis",
                "btn_load_demo": "载入范例", "label_text_a": "文本 A", "label_text_b": "文本 B", "btn_clear": "清空", "label_count": "词汇数",
                "btn_start_compare": "开始比较分析", "header_only_a": "A 独有", "header_union": "AB 并集", "header_common": "AB 交集", "header_only_b": "B 独有",
                "btn_copy": "复制", "btn_download_report": "下载完整分析报告 (.txt)", "msg_input_empty": "请先输入或贴上文本", "msg_analysis_done": "分析完成！", "msg_copied": "内容已复制", "msg_downloading": "报告下载中...", "msg_demo_loaded": "范例已载入",
                "demo_text_a": "光合作用 是 植物 利用 叶绿素 吸收 太阳能 ， 将 水 和 二氧化碳 转化 为 葡萄糖 与 氧气 的 过程 。 这 是 生态系 能量 的 基础 。",
                "demo_text_b": "呼吸作用 是 生物 利用 氧气 将 葡萄糖 分解 ， 产生 能量 、 水 和 二氧化碳 的 过程 。 这 是 维持 生命 现象 所 必需 的 。"
            }
        };

        function changeLanguage() {
            const lang = document.getElementById("language-selector").value;
            document.querySelectorAll("[data-i18n]").forEach(el => {
                const key = el.getAttribute("data-i18n");
                if (translations[lang][key]) el.innerText = translations[lang][key];
            });
            
            // 更新 placeholder
            const textA = document.getElementById('textA');
            const textB = document.getElementById('textB');
            if(lang === 'en') {
                textA.placeholder = "Paste tokenized text A here...";
                textB.placeholder = "Paste tokenized text B here...";
            } else {
                // 保持預設或根據需求增加更多翻譯
            }
        }

        // *** Canvas ***
        (function() {
            const canvas = document.getElementById('network-canvas');
            const ctx = canvas.getContext('2d');
            let width, height, particles = [];
            function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; initParticles(); }
            class Particle {
                constructor() {
                    this.x = Math.random() * width; this.y = Math.random() * height;
                    this.vx = (Math.random() - 0.5) * 0.5; this.vy = (Math.random() - 0.5) * 0.5;
                    this.size = Math.random() * 2 + 1;
                    this.color = `rgba(168, 85, 247, ${Math.random() * 0.4})`;
                }
                update() {
                    this.x += this.vx; this.y += this.vy;
                    if(this.x<0||this.x>width) this.vx*=-1; if(this.y<0||this.y>height) this.vy*=-1;
                }
                draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fillStyle=this.color; ctx.fill(); }
            }
            function initParticles() { particles=[]; for(let i=0;i<50;i++) particles.push(new Particle()); }
            function animate() {
                ctx.clearRect(0, 0, width, height);
                particles.forEach(p => { p.update(); p.draw(); });
                for(let i=0; i<particles.length; i++){
                    for(let j=i; j<particles.length; j++){
                        const dx = particles[i].x - particles[j].x;
                        const dy = particles[i].y - particles[j].y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        if(dist < 150){
                            ctx.beginPath();
                            ctx.strokeStyle = `rgba(168, 85, 247, ${0.08 - dist/2000})`;
                            ctx.lineWidth = 0.5;
                            ctx.moveTo(particles[i].x, particles[i].y);
                            ctx.lineTo(particles[j].x, particles[j].y);
                            ctx.stroke();
                        }
                    }
                }
                requestAnimationFrame(animate);
            }
            window.addEventListener('resize', resize); resize(); animate();
        })();

        // *** Logic ***
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { compareTexts(); }
        });

        function getMsg(key) {
            const lang = document.getElementById("language-selector").value;
            return translations[lang][key] || translations['zh-TW'][key];
        }

        function loadDemo() {
            const lang = document.getElementById("language-selector").value;
            const t = translations[lang] || translations['zh-TW'];

            document.getElementById('textA').value = t.demo_text_a;
            document.getElementById('textB').value = t.demo_text_b;
            
            // 觸發 input 事件以更新計數
            document.getElementById('textA').dispatchEvent(new Event('input'));
            document.getElementById('textB').dispatchEvent(new Event('input'));
            
            showToast(t.msg_demo_loaded); 
        }

        ['textA', 'textB'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                const count = this.value.trim() === '' ? 0 : splitText(this.value).length;
                document.getElementById('count' + id.slice(-1)).innerText = count;
            });
        });

        function clearText(id) {
            document.getElementById(id).value = '';
            document.getElementById('count' + id.slice(-1)).innerText = '0';
            document.getElementById('analysis-results').classList.add('hidden');
        }

        function splitText(rawText) {
            if (!rawText) return [];
            // 默認忽略大小寫與標點 (已移除UI開關，直接內建邏輯)
            const ignoreCase = true;
            if (ignoreCase) rawText = rawText.toLowerCase();
            
            // 只保留文字、中日文、數字 (排除標點)
            // \u4e00-\u9fa5: 中文
            // \u3040-\u309f: 平假名, \u30a0-\u30ff: 片假名 (for Japanese support)
            const cleanedText = rawText.replace(/[^\w\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff\s]/g, ' ');
            return cleanedText.split(/\s+/).filter(t => t.length > 0);
        }

        function compareTexts() {
            const textA = document.getElementById('textA').value;
            const textB = document.getElementById('textB').value;

            if (!textA.trim() && !textB.trim()) {
                showToast(getMsg('msg_input_empty'), 'error');
                return;
            }

            const tokensA = splitText(textA);
            const tokensB = splitText(textB);
            const setA = new Set(tokensA);
            const setB = new Set(tokensB);

            const lang = document.getElementById("language-selector").value;
            const locale = lang === 'en' ? 'en' : 'zh-Hant'; // 排序語系

            const onlyA = [...setA].filter(x => !setB.has(x)).sort((a, b) => a.localeCompare(b, locale));
            const common = [...setA].filter(x => setB.has(x)).sort((a, b) => a.localeCompare(b, locale));
            const onlyB = [...setB].filter(x => !setA.has(x)).sort((a, b) => a.localeCompare(b, locale));
            const union = [...new Set([...tokensA, ...tokensB])].sort((a, b) => a.localeCompare(b, locale));

            updateResult('onlyA', onlyA, 'countOnlyA');
            updateResult('common', common, 'countCommon');
            updateResult('onlyB', onlyB, 'countOnlyB');
            updateResult('unionResult', union, 'countUnion');
            
            const results = document.getElementById('analysis-results');
            results.classList.remove('hidden');
            setTimeout(() => { results.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
            showToast(getMsg('msg_analysis_done'));
        }

        function updateResult(elementId, dataArray, countId) {
            const el = document.getElementById(elementId);
            if (dataArray.length === 0) {
                el.value = "( None )"; // 統一用 None 或根據語系調整
                el.classList.add('text-slate-300', 'italic');
            } else {
                el.value = dataArray.join('\n');
                el.classList.remove('text-slate-300', 'italic');
            }
            document.getElementById(countId).innerText = dataArray.length;
        }

        function copyToClipboard(elementId) {
            const el = document.getElementById(elementId);
            if (!el || el.value === "( None )") return;
            el.select();
            el.setSelectionRange(0, 99999);
            document.execCommand("copy");
            window.getSelection().removeAllRanges();
            showToast(getMsg('msg_copied'));
        }
        
        function downloadReport() {
            const onlyA = document.getElementById('onlyA').value;
            const common = document.getElementById('common').value;
            const onlyB = document.getElementById('onlyB').value;
            const unionResult = document.getElementById('unionResult').value;
            const time = new Date().toLocaleString();
            
            const content = `Science Learning Hub - Text Analysis\nTime: ${time}\n\n` +
                            `=== Union ===\n${unionResult}\n\n` +
                            `=== Intersection ===\n${common}\n\n` +
                            `=== Unique A ===\n${onlyA}\n\n` +
                            `=== Unique B ===\n${onlyB}\n`;
                            
            const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `text_analysis_report_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(getMsg('msg_downloading'));
        }

        function showToast(message, type = 'normal') {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            const icon = toast.querySelector('i');
            msgEl.innerText = message;
            if (type === 'error') { icon.className = 'fa-solid fa-triangle-exclamation text-red-400'; } 
            else { icon.className = 'fa-solid fa-check-circle text-green-400'; }
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
        }
    </script>
</body>
</html>
