<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>命題用語檢核 | Science Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        teacher: { light: '#bbf7d0', DEFAULT: '#22c55e', dark: '#15803d' },
                    },
                    animation: { "fade-in-up": "fadeInUp 0.5s ease-out forwards" },
                    keyframes: { "fadeInUp": { "0%": { opacity: "0", transform: "translateY(10px)" }, "100%": { opacity: "1", transform: "translateY(0)" } } }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            min-height: 100vh;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 25px -5px rgba(22, 163, 74, 0.1), 0 8px 10px -6px rgba(22, 163, 74, 0.1);
        }
        .input-field { transition: all 0.2s; border: 1px solid #d1d5db; }
        .input-field:focus { box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3); border-color: #22c55e; outline: none; }
        .loader { border: 3px solid rgba(34, 197, 94, 0.2); border-radius: 50%; border-top: 3px solid #22c55e; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .bg-safe-deep { background-color: #166534; color: white; } 
        .bg-safe-light { background-color: #22c55e; color: white; } 
        .bg-warn { background-color: #f97316; color: white; } 
        .bg-danger { background-color: #dc2626; color: white; } 
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        
        /* Tooltip 樣式 */
        .tooltip-container { position: relative; display: inline-block; cursor: help; }
        .tooltip-content {
            visibility: hidden;
            width: 280px;
            background-color: #1e293b;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            line-height: 1.4;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            pointer-events: none;
        }
        .tooltip-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1e293b transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="p-4 md:p-8 relative overflow-x-hidden text-slate-800">

    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] rounded-full bg-green-200/30 blur-3xl animate-pulse"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] rounded-full bg-emerald-200/20 blur-3xl animate-pulse" style="animation-delay: 2s;"></div>
    </div>

    <nav class="glass-panel sticky top-2 z-50 rounded-2xl mb-8 p-4 flex justify-between items-center max-w-7xl mx-auto">
        <div class="flex items-center space-x-3 cursor-pointer group" onclick="window.location.href='teacher.html'">
            <div class="bg-green-100 p-2 rounded-xl text-green-600 group-hover:bg-green-600 group-hover:text-white transition">
                <i class="fa-solid fa-chevron-left"></i>
            </div>
            <span class="text-lg font-bold tracking-tight text-slate-700" data-i18n="back_btn">返回教學中心</span>
        </div>
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-globe text-slate-500"></i>
            <select id="language-selector" onchange="changeLanguage()" class="bg-white/50 border border-slate-200 text-slate-600 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block p-2 outline-none hover:bg-white transition cursor-pointer">
                <option value="zh-TW">繁體中文</option>
                <option value="en">English</option>
                <option value="ja">日本語</option>
                <option value="zh-CN">简体中文</option>
            </select>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto animate-fade-in-up">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-700 to-emerald-600 mb-3" data-i18n="page_title">
                中小學自然科命題用詞 AI 檢核
            </h1>
            <p class="text-slate-600 text-lg" data-i18n="page_subtitle">
                結合大數據資料庫與生成式 AI，精準診斷命題適切性
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-6">
                <div class="glass-panel p-6 rounded-3xl">
                    <h2 class="text-xl font-bold text-slate-700 mb-5 border-b border-green-100 pb-3 flex items-center">
                        <i class="fa-solid fa-sliders mr-3 text-green-600"></i> <span data-i18n="settings_title">參數設定</span>
                    </h2>
                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                <span data-i18n="label_stage">學習階段</span> <span class="text-red-500">*</span>
                            </label>
                            <select id="stage" class="w-full p-3 rounded-xl bg-white/70 input-field" onchange="updateGrades()">
                                <option value="" disabled selected data-i18n="opt_select">請選擇學習階段</option>
                                <option value="國小" data-i18n="opt_elem">國小</option>
                                <option value="國中" data-i18n="opt_junior">國中</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2" data-i18n="label_grade">目標年級</label>
                                <select id="grades" class="w-full p-3 rounded-xl bg-white/70 input-field">
                                    <option value="" selected data-i18n="opt_any">不限</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2" data-i18n="label_semester">目標學期</label>
                                <select id="semester" class="w-full p-3 rounded-xl bg-white/70 input-field">
                                    <option value="" selected data-i18n="opt_any">不限</option>
                                    <option value="上" data-i18n="opt_sem1">上學期</option>
                                    <option value="下" data-i18n="opt_sem2">下學期</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2" data-i18n="label_version">教科書版本</label>
                            <select id="version" class="w-full p-3 rounded-xl bg-white/70 input-field">
                                <option value="" selected data-i18n="opt_any">不限</option>
                                <option value="南一">南一</option>
                                <option value="康軒">康軒</option>
                                <option value="翰林">翰林</option>
                            </select>
                        </div>
                        <div class="pt-2">
                            <label class="block text-sm font-bold text-slate-700 mb-3" data-i18n="label_pos">檢測詞性 (多選)</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="bg-white/70 px-3 py-2 rounded-xl border border-green-100 flex items-center hover:bg-green-50 cursor-pointer transition shadow-sm text-sm"><input type="checkbox" name="pos" value="N" checked class="mr-2 accent-green-600 w-4 h-4"><span data-i18n="pos_n">名詞 (Na/Nb/Nc/Nf)</span></label>
                                <label class="bg-white/70 px-3 py-2 rounded-xl border border-green-100 flex items-center hover:bg-green-50 cursor-pointer transition shadow-sm text-sm"><input type="checkbox" name="pos" value="V" checked class="mr-2 accent-green-600 w-4 h-4"><span data-i18n="pos_v">動詞</span></label>
                                <label class="bg-white/70 px-3 py-2 rounded-xl border border-green-100 flex items-center hover:bg-green-50 cursor-pointer transition shadow-sm text-sm"><input type="checkbox" name="pos" value="A" class="mr-2 accent-green-600 w-4 h-4"><span data-i18n="pos_a">形容詞</span></label>
                                <label class="bg-white/70 px-3 py-2 rounded-xl border border-green-100 flex items-center hover:bg-green-50 cursor-pointer transition shadow-sm text-sm"><input type="checkbox" name="pos" value="D" class="mr-2 accent-green-600 w-4 h-4"><span data-i18n="pos_d">副詞</span></label>
                                <label class="bg-white/70 px-3 py-2 rounded-xl border border-green-100 flex items-center hover:bg-green-50 cursor-pointer transition shadow-sm text-sm"><input type="checkbox" name="pos" value="C" class="mr-2 accent-green-600 w-4 h-4"><span data-i18n="pos_c">連接詞</span></label>
                                <label class="bg-white/70 px-3 py-2 rounded-xl border border-green-100 flex items-center hover:bg-green-50 cursor-pointer transition shadow-sm text-sm"><input type="checkbox" name="pos" value="O" class="mr-2 accent-green-600 w-4 h-4"><span data-i18n="pos_o">其他</span></label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button id="runBtn" onclick="runAnalysis()" class="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white py-4 rounded-2xl hover:shadow-lg hover:shadow-green-500/30 transition-all font-bold text-xl tracking-wide transform active:scale-[0.98] flex items-center justify-center gap-3">
                    <i class="fa-solid fa-magnifying-glass-chart"></i> <span data-i18n="btn_start">開始 AI 檢測</span>
                </button>
            </div>

            <div class="lg:col-span-8 space-y-8">
                <div class="glass-panel p-6 rounded-3xl relative">
                    <div class="flex justify-between items-center mb-4">
                        <label class="block font-bold text-slate-700 text-xl">
                            <i class="fa-regular fa-file-lines mr-2 text-green-600"></i> <span data-i18n="label_text_input">試題文本</span>
                        </label>
                        <div class="flex gap-2">
                            <button onclick="loadExample()" class="text-sm bg-green-50 text-green-700 px-4 py-2 rounded-xl hover:bg-green-100 transition font-medium border border-green-200 flex items-center">
                                <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> <span data-i18n="btn_example">載入範例</span>
                            </button>
                            <button onclick="document.getElementById('text').value=''" class="text-sm bg-slate-50 text-slate-500 px-4 py-2 rounded-xl hover:bg-red-50 hover:text-red-500 transition border border-slate-200" title="清空">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </div>
                    <textarea id="text" class="w-full h-64 p-5 rounded-2xl bg-white/70 text-slate-700 text-base leading-relaxed resize-none input-field scrollbar-thin font-mono" placeholder="請在此貼上包含題幹與選項的完整試題內容..." data-i18n-placeholder="placeholder_text"></textarea>
                </div>

                <div id="result-area" class="hidden space-y-8 animate-fade-in-up">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="glass-panel p-5 rounded-2xl text-center border-b-4 border-green-500 tooltip-container group">
                            <div class="text-sm text-slate-500 mb-2 font-medium flex items-center justify-center gap-2">
                                <span data-i18n="kpi_score">適切性評分</span>
                                <i class="fa-regular fa-circle-question text-slate-400 group-hover:text-green-600 transition-colors"></i>
                            </div>
                            <div class="text-4xl font-black text-green-600" id="res-score">--</div>
                            <div class="tooltip-content">
                                <div class="font-bold text-green-400 mb-1 border-b border-slate-600 pb-1">計算公式</div>
                                <div class="mb-2">100 - Σ (學期差 × 2)</div>
                                <div class="font-bold text-green-400 mb-1 border-b border-slate-600 pb-1">本次算式</div>
                                <div id="res-score-detail" class="text-slate-300">請先進行分析...</div>
                            </div>
                        </div>

                        <div class="glass-panel p-5 rounded-2xl text-center">
                            <div class="text-sm text-slate-500 mb-2 font-medium" data-i18n="kpi_total">分析詞彙數</div>
                            <div class="text-3xl font-bold text-slate-700" id="res-total">0</div>
                        </div>
                        <div class="glass-panel p-5 rounded-2xl text-center">
                            <div class="text-sm text-slate-500 mb-2 font-medium" data-i18n="kpi_safe">符合目標年級</div>
                            <div class="text-3xl font-bold text-green-600" id="res-safe">0</div>
                        </div>
                        <div class="glass-panel p-5 rounded-2xl text-center border-b-4 border-red-400">
                            <div class="text-sm text-slate-500 mb-2 font-medium" data-i18n="kpi_risk">超前/未見</div>
                            <div class="text-3xl font-bold text-red-500" id="res-risk">0</div>
                        </div>
                    </div>

                    <div class="glass-panel p-6 rounded-3xl overflow-hidden">
                        <h3 class="font-bold text-slate-700 text-xl mb-5 flex items-center justify-between">
                            <span><i class="fa-solid fa-table-list mr-2 text-green-600"></i> <span data-i18n="table_title">詞彙年級分佈分析</span></span>
                        </h3>
                        <div class="overflow-x-auto max-h-[500px] scrollbar-thin rounded-xl border border-green-100">
                            <table class="w-full text-left border-collapse">
                                <thead class="sticky top-0 bg-green-50/90 backdrop-blur z-10">
                                    <tr class="text-slate-600 text-sm font-bold border-b border-green-200">
                                        <th class="pb-4 pt-4 pl-4" data-i18n="th_term">詞彙</th>
                                        <th class="pb-4 pt-4" data-i18n="th_pos">詞性</th>
                                        <th class="pb-4 pt-4" data-i18n="th_first">資料庫首次出現</th>
                                        <th class="pb-4 pt-4 text-center" data-i18n="th_diff">學期差</th>
                                        <th class="pb-4 pt-4 text-center" data-i18n="th_status">判定</th>
                                    </tr>
                                </thead>
                                <tbody id="result-table-body" class="text-slate-700 text-sm font-medium bg-white/50 divide-y divide-green-50">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="glass-panel p-8 rounded-3xl border-l-8 border-green-600 bg-white/80">
                        <h3 class="font-bold text-green-800 text-2xl mb-6 flex items-center">
                            <i class="fa-solid fa-robot fa-bounce mr-3 text-green-600" style="--fa-animation-duration: 3s;"></i> <span data-i18n="ai_feedback_title">AI 深度命題回饋</span>
                        </h3>
                        <div id="ai-feedback-loader" class="hidden flex items-center text-green-700">
                            <div class="loader mr-3"></div> <span data-i18n="status_analyzing">正在生成深度分析報告，請稍候...</span>
                        </div>
                        <div id="ai-feedback-content" class="text-slate-700 leading-relaxed space-y-6 text-base"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-xl transition-all duration-300 opacity-0 translate-y-10 z-50 flex items-center gap-3 pointer-events-none border border-slate-700">
        <i id="toast-icon" class="fa-solid fa-circle-info text-yellow-400"></i>
        <span id="toast-msg">提示訊息</span>
    </div>

    <script>
        // ★★★ 請務必確認這裡的 GAS_URL 是您後端部署後的正確網址 ★★★
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxbZPCCWFwFel6KjEzga-P_YJJccBevBMMCmgq_qVt1PfQEl2Som7z-DD2rU8kexrnGtA/exec";
        
        const translations = {
            "zh-TW": {
                "back_btn": "返回教學中心", "page_title": "中小學自然科命題用詞 AI 檢核", "page_subtitle": "結合大數據資料庫與生成式 AI，精準診斷命題適切性",
                "settings_title": "參數設定", "label_stage": "學習階段", "opt_select": "請選擇", "opt_elem": "國小", "opt_junior": "國中",
                "label_grade": "目標年級", "opt_any": "不限", "label_semester": "目標學期", "opt_sem1": "上學期", "opt_sem2": "下學期",
                "label_version": "教科書版本", "label_pos": "檢測詞性 (多選)", 
                "pos_n": "名詞 (Na/Nb/Nc/Nf)", "pos_v": "動詞", "pos_a": "形容詞", "pos_d": "副詞", "pos_c": "連接詞", "pos_o": "其他",
                "btn_start": "開始 AI 檢測", "label_text_input": "試題文本", "btn_example": "載入範例", "placeholder_text": "請在此貼上包含題幹與選項的完整試題內容...",
                "kpi_score": "適切性評分", "kpi_total": "分析詞彙數", "kpi_safe": "符合目標年級", "kpi_risk": "超前/未見",
                "table_title": "詞彙年級分佈分析", "th_term": "詞彙", "th_pos": "詞性", "th_first": "資料庫首次出現", "th_diff": "學期差", "th_status": "判定",
                "ai_feedback_title": "AI 深度命題回饋", "status_analyzing": "正在進行 AI 分析與資料比對...",
                "msg_select_stage": "請先選擇學習階段！", "msg_input_text": "請輸入試題文本！", "msg_analysis_done": "分析完成！", "msg_analysis_fail": "分析失敗：",
                "grade_3": "三年級", "grade_4": "四年級", "grade_5": "五年級", "grade_6": "六年級", "grade_7": "七年級", "grade_8": "八年級", "grade_9": "九年級"
            },
            "en": {
                "back_btn": "Back to Hub", "page_title": "Science Exam Vocabulary Checker", "page_subtitle": "AI-powered analysis for vocabulary suitability.",
                "settings_title": "Settings", "label_stage": "Stage", "opt_select": "Select...", "opt_elem": "Elementary", "opt_junior": "Junior High",
                "label_grade": "Target Grade", "opt_any": "Any", "label_semester": "Semester", "opt_sem1": "1st Sem", "opt_sem2": "2nd Sem",
                "label_version": "Textbook Edition", "label_pos": "Part of Speech", 
                "pos_n": "Noun (Na/Nb/Nc/Nf)", "pos_v": "Verb", "pos_a": "Adj", "pos_d": "Adv", "pos_c": "Conj", "pos_o": "Other",
                "btn_start": "Analyze", "label_text_input": "Exam Text", "btn_example": "Load Example", "placeholder_text": "Paste text here...",
                "kpi_score": "Suitability", "kpi_total": "Total Terms", "kpi_safe": "Safe", "kpi_risk": "Risk",
                "table_title": "Vocabulary Analysis", "th_term": "Term", "th_pos": "POS", "th_first": "First Seen", "th_diff": "Sem Gap", "th_status": "Status",
                "ai_feedback_title": "AI Feedback", "status_analyzing": "Analyzing...",
                "msg_select_stage": "Select stage first!", "msg_input_text": "Input text!", "msg_analysis_done": "Done!", "msg_analysis_fail": "Failed: ",
                "grade_3": "G3", "grade_4": "G4", "grade_5": "G5", "grade_6": "G6", "grade_7": "G7", "grade_8": "G8", "grade_9": "G9"
            },
            "ja": {
                "back_btn": "戻る", "page_title": "科学試験用語AIチェッカー", "page_subtitle": "ビッグデータとAIを活用した試験問題の適切性診断",
                "settings_title": "設定", "label_stage": "学習段階", "opt_select": "選択...", "opt_elem": "小学校", "opt_junior": "中学校",
                "label_grade": "目標学年", "opt_any": "指定なし", "label_semester": "学期", "opt_sem1": "前期", "opt_sem2": "後期",
                "label_version": "教科書版", "label_pos": "品詞 (複数選択)", 
                "pos_n": "名詞 (Na/Nb/Nc/Nf)", "pos_v": "動詞", "pos_a": "形容詞", "pos_d": "副詞", "pos_c": "接続詞", "pos_o": "その他",
                "btn_start": "分析開始", "label_text_input": "問題文", "btn_example": "例文をロード", "placeholder_text": "ここに貼り付けてください...",
                "kpi_score": "適合スコア", "kpi_total": "分析単語数", "kpi_safe": "学年適合", "kpi_risk": "未習リスク",
                "table_title": "単語分布分析", "th_term": "単語", "th_pos": "品詞", "th_first": "初出", "th_diff": "学期差", "th_status": "判定",
                "ai_feedback_title": "AI フィードバック", "status_analyzing": "分析中...",
                "msg_select_stage": "学習段階を選択してください！", "msg_input_text": "テキストを入力してください！", "msg_analysis_done": "完了！", "msg_analysis_fail": "失敗：",
                "grade_3": "小3", "grade_4": "小4", "grade_5": "小5", "grade_6": "小6", "grade_7": "中1", "grade_8": "中2", "grade_9": "中3"
            },
            "zh-CN": {
                "back_btn": "返回教学中心", "page_title": "中小学自然科命题用词 AI 检核", "page_subtitle": "结合大数据与生成式 AI，精准诊断命题适切性",
                "settings_title": "参数设置", "label_stage": "学习阶段", "opt_select": "请选择", "opt_elem": "国小", "opt_junior": "国中",
                "label_grade": "目标年级", "opt_any": "不限", "label_semester": "目标学期", "opt_sem1": "上学期", "opt_sem2": "下学期",
                "label_version": "教科书版本", "label_pos": "检测词性", 
                "pos_n": "名词 (Na/Nb/Nc/Nf)", "pos_v": "动词", "pos_a": "形容词", "pos_d": "副词", "pos_c": "连接词", "pos_o": "其他",
                "btn_start": "开始检测", "label_text_input": "试题文本", "btn_example": "载入范例", "placeholder_text": "请在此粘贴试题内容...",
                "kpi_score": "适切性评分", "kpi_total": "分析词汇数", "kpi_safe": "符合目标年级", "kpi_risk": "超前/未见",
                "table_title": "词汇年级分布分析", "th_term": "词汇", "th_pos": "词性", "th_first": "数据库首次出现", "th_diff": "学期差", "th_status": "判定",
                "ai_feedback_title": "AI 深度命题反馈", "status_analyzing": "正在进行 AI 分析与资料比对...",
                "msg_select_stage": "请先选择学习阶段！", "msg_input_text": "请输入试题文本！", "msg_analysis_done": "分析完成！", "msg_analysis_fail": "分析失败：",
                "grade_3": "三年级", "grade_4": "四年级", "grade_5": "五年级", "grade_6": "六年级", "grade_7": "七年级", "grade_8": "八年级", "grade_9": "九年级"
            }
        };

        let currentLang = 'zh-TW';

        document.addEventListener('DOMContentLoaded', () => { updateGrades(); });

        function changeLanguage() {
            currentLang = document.getElementById("language-selector").value;
            const t = translations[currentLang] || translations["zh-TW"];
            document.querySelectorAll("[data-i18n]").forEach(el => {
                const key = el.getAttribute("data-i18n");
                if (t[key]) el.innerText = t[key];
            });
            document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
                const key = el.getAttribute("data-i18n-placeholder");
                if (t[key]) el.placeholder = t[key];
            });
            updateGrades(true);
        }

        function updateGrades(isLangChange = false) {
            const stage = document.getElementById('stage').value;
            const gradeSelect = document.getElementById('grades');
            const t = translations[currentLang] || translations["zh-TW"];
            const currentVal = gradeSelect.value;

            gradeSelect.innerHTML = `<option value="" selected>${t.opt_any}</option>`;
            
            if (stage === '國小' || stage === 'opt_elem') {
                const grades = [{v:'三年級',l:t.grade_3},{v:'四年級',l:t.grade_4},{v:'五年級',l:t.grade_5},{v:'六年級',l:t.grade_6}];
                grades.forEach(g => { gradeSelect.add(new Option(g.l, g.v)); });
                gradeSelect.disabled = false;
            } else if (stage === '國中' || stage === 'opt_junior') {
                const grades = [{v:'七年級',l:t.grade_7},{v:'八年級',l:t.grade_8},{v:'九年級',l:t.grade_9}];
                grades.forEach(g => { gradeSelect.add(new Option(g.l, g.v)); });
                gradeSelect.disabled = false;
            } else {
                gradeSelect.disabled = true;
            }
            if(isLangChange && currentVal) gradeSelect.value = currentVal;
        }

        function loadExample() {
            document.getElementById('stage').value = "國中";
            updateGrades();
            document.getElementById('grades').value = "七年級";
            document.getElementById('semester').value = "上";
            document.getElementById('version').value = "";
            document.getElementById('text').value = 
`1. 使用複式顯微鏡觀察玻片標本時，如果想得到適當的光線，應調節下列哪些部位？
(A) 目鏡、物鏡
(B) 反光鏡、光圈
(C) 粗調節輪、細調節輪
(D) 載玻片、蓋玻片`;
            showToast("範例已載入，請按「開始 AI 檢測」", "success");
        }

        async function runAnalysis() {
            const stage = document.getElementById('stage').value;
            const text = document.getElementById('text').value.trim();
            const t = translations[currentLang] || translations["zh-TW"];
            
            if (!stage) { showToast(t.msg_select_stage, "warning"); return; }
            if (!text) { showToast(t.msg_input_text, "warning"); return; }

            const btn = document.getElementById('runBtn');
            const originalBtnContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="loader mr-3"></div> ${t.status_analyzing}`;
            
            document.getElementById('result-area').classList.remove('hidden');
            document.getElementById('ai-feedback-content').innerHTML = "";
            document.getElementById('ai-feedback-loader').classList.remove('hidden');
            document.getElementById('result-table-body').innerHTML = `<tr><td colspan="5" class="text-center py-8 text-slate-500 italic">${t.status_analyzing}</td></tr>`;
            document.getElementById('result-area').scrollIntoView({ behavior: 'smooth' });
            
            const requestBody = {
                action: "analyze",
                payload: {
                    text: text,
                    stage: stage,
                    grade: document.getElementById('grades').value,
                    semester: document.getElementById('semester').value,
                    version: document.getElementById('version').value,
                    posFilter: Array.from(document.querySelectorAll('input[name="pos"]:checked')).map(cb => cb.value)
                }
            };

            try {
                const response = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify(requestBody)
                });

                const jsonResponse = await response.json();

                if (jsonResponse.status === "success") {
                     renderResults(jsonResponse.data);
                     showToast(t.msg_analysis_done, "success");
                } else {
                     throw new Error(jsonResponse.message || "API 回傳錯誤");
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                showToast(t.msg_analysis_fail + error.message, "error");
                document.getElementById('ai-feedback-content').innerHTML = `<p class="text-red-500">連線失敗，請檢查網路或後端 URL。</p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnContent;
                document.getElementById('ai-feedback-loader').classList.add('hidden');
            }
        }

        function renderResults(data) {
            document.getElementById('res-score').innerText = data.summary.score;
            
            // ★★★ 關鍵：顯示算式 Tooltip ★★★
            document.getElementById('res-score-detail').innerText = data.summary.scoreFormula || "無扣分資料";
            
            document.getElementById('res-total').innerText = data.summary.total;
            document.getElementById('res-safe').innerText = data.summary.safe;
            document.getElementById('res-risk').innerText = data.summary.risk;
            document.getElementById('ai-feedback-content').innerHTML = data.aiFeedback;

            const tbody = document.getElementById('result-table-body');
            if (data.table.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-slate-500">沒有符合篩選條件的詞彙。</td></tr>';
                return;
            }

            tbody.innerHTML = data.table.map((item, index) => {
                let badgeClass = "bg-slate-400";
                let statusText = "未知";
                let diffText = "N/A";

                if (item.diff > -99) {
                    diffText = (item.diff > 0 ? "+" : "") + item.diff;

                    if (item.state === "fit") {
                        if (item.diff >= 4) { 
                            badgeClass = "bg-safe-deep"; statusText = "極易";
                        } else {
                            badgeClass = "bg-safe-light"; statusText = "符合";
                        }
                    } else if (item.state === "next_sem") {
                        badgeClass = "bg-warn"; statusText = "下學期";
                    } else if (item.state === "risk") {
                        badgeClass = "bg-danger"; statusText = "超前";
                    }
                } else {
                    badgeClass = "bg-danger"; statusText = "未見"; diffText = "-";
                }

                const rowClass = index % 2 === 0 ? 'bg-white/50' : 'bg-green-50/30';
                return `
                <tr class="${rowClass} hover:bg-green-100/50 transition duration-150">
                    <td class="py-3 pl-4 font-bold text-slate-700">${item.term}</td>
                    <td class="py-3 font-mono text-sm text-slate-500">${item.pos}</td>
                    <td class="py-3 text-slate-600 text-sm">${item.first}</td>
                    <td class="py-3 font-mono font-bold text-center text-slate-700" title="相差學期數">${diffText}</td>
                    <td class="py-3 text-center">
                        <span class="${badgeClass} text-white text-xs px-3 py-1 rounded-full shadow-sm font-bold inline-block min-w-[60px]">
                            ${statusText}
                        </span>
                    </td>
                </tr>`;
            }).join('');
        }

        function showToast(msg, type = "info") {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msgEl = document.getElementById('toast-msg');

            msgEl.innerText = msg;
            toast.className = toast.className.replace(/bg-\w+-800\/90/, '').replace(/border-\w+-700/, '');
            icon.className = icon.className.replace(/text-\w+-400/, '');

            if (type === "success") {
                toast.classList.add('bg-green-800/90', 'border-green-700');
                icon.classList.add('fa-circle-check', 'text-green-400');
            } else if (type === "warning") {
                toast.classList.add('bg-yellow-800/90', 'border-yellow-700');
                icon.classList.add('fa-triangle-exclamation', 'text-yellow-400');
            } else if (type === "error") {
                toast.classList.add('bg-red-800/90', 'border-red-700');
                icon.classList.add('fa-circle-xmark', 'text-red-400');
            } else {
                toast.classList.add('bg-slate-800/90', 'border-slate-700');
                icon.classList.add('fa-circle-info', 'text-blue-400');
            }
            
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
        }

        // Canvas Background
        window.addEventListener('load', function() {
            const canvas = document.getElementById('network-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let width, height, orbits = [], centerX, centerY;

            function resize() { 
                width = window.innerWidth; 
                height = window.innerHeight; 
                canvas.width = width; 
                canvas.height = height; 
                centerX = width / 2; 
                centerY = height / 2; 
                initOrbits(); 
            }

            class Orbit { 
                constructor(rx, ry, a, c, s) { 
                    this.rx = rx; this.ry = ry; this.a = a; this.c = c; this.s = s; this.r = 0; this.ea = Math.random() * Math.PI * 2; 
                } 
                update() { this.r += this.s; this.ea += 0.002; } 
                draw() { 
                    ctx.save(); ctx.translate(centerX, centerY); ctx.rotate(this.a); 
                    ctx.beginPath(); ctx.ellipse(0, 0, this.rx, this.ry, this.r, 0, Math.PI * 2); 
                    ctx.strokeStyle = this.c; ctx.lineWidth = 1; ctx.stroke(); 
                    ctx.beginPath(); ctx.arc(this.rx * Math.cos(this.ea), this.ry * Math.sin(this.ea), 3, 0, Math.PI * 2); 
                    ctx.fillStyle = this.c; ctx.fill(); ctx.restore(); 
                } 
            }

            function initOrbits() { 
                orbits = []; 
                const br = width < height ? width * 0.25 : height * 0.3; 
                orbits.push(new Orbit(br, br * 0.4, Math.PI / 4, 'rgba(34,197,94,0.3)', 0.001)); 
                orbits.push(new Orbit(br, br * 0.4, -Math.PI / 4, 'rgba(16,185,129,0.3)', -0.001)); 
                orbits.push(new Orbit(br * 1.2, br * 1.2, 0, 'rgba(6,95,70,0.1)', 0.0005)); 
            }

            function animate() { 
                ctx.clearRect(0, 0, width, height); 
                orbits.forEach(o => { o.update(); o.draw() }); 
                ctx.beginPath(); ctx.arc(centerX, centerY, 5, 0, Math.PI * 2); 
                ctx.fillStyle = 'rgba(34,197,94,0.8)'; ctx.shadowBlur = 15; ctx.shadowColor = '#22c55e'; ctx.fill(); 
                requestAnimationFrame(animate); 
            }

            window.addEventListener('resize', resize); 
            resize(); 
            animate();
        });
    </script>
</body>
</html>
