<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ä¸­å°å­¸è‡ªç„¶ç§‘å‘½é¡Œç”¨è©AIæª¢æ ¸ç³»çµ±</title>
<style>
/* ====== UI/UX é¢¨æ ¼å„ªåŒ–ï¼šæ·¡é›…æŸ”å’Œç¶ è‰²ä¸»é¡Œ (V9) ====== */
:root{
    --bg:#fcfcfc; /* æ¥è¿‘ç´”ç™½ï¼Œå¸¶å¾®ç´‹ç†æ„Ÿ */
    --fg:#212529; /* æ·±è‰²æ–‡å­— */
    --border:#e9ecef; /* æ›´æ·ºçš„é‚Šæ¡† */
    --card:#ffffff;
    --muted:#888;
    --accent:#5D9975; /* æ·¡é›…æŸ”å’Œçš„é¼ å°¾è‰ç¶  (ä¸»é¡Œè‰²) */
    --accent-hover: #477f60;
    --success:#61A54F; /* Fit æ¨™ç±¤ç¶  */
    --warning:#ffc107;
    --danger:#dc3545;
    --info:#5D9975; /* Tooltip é¡è‰²ä½¿ç”¨ä¸»é¡Œè‰² */
}
body{
    background:var(--bg);
    color:var(--fg);
    font-family:"Microsoft JhengHei", "Noto Sans TC", system-ui;
    font-size: 15px; 
    margin:0;
    padding:24px;
    position: relative;
    min-height: 100vh;
    opacity: 0; /* åˆå§‹éš±è—ï¼Œç”¨æ–¼æ·¡å…¥æ•ˆæœ */
    transition: opacity 0.8s ease-in;
}
.body-loaded {
    opacity: 1;
}
.wrap{max-width:1040px;margin:0 auto;}

/* ç³»çµ±åç¨±ç½®ä¸­èˆ‡è¦–è¦ºå¼·åŒ– */
h1{
    font-size:30px;
    letter-spacing:1.5px;
    color:var(--accent);
    margin:0 0 20px; 
    font-weight: 700;
    text-align: center;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
}

.card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
    margin:15px 0;
    box-shadow: 0 4px 8px rgba(0,0,0,.08);
    transition: box-shadow 0.3s ease-out;
}
.card:hover:not(.score-kpi) {
     box-shadow: 0 8px 16px rgba(0,0,0,.15);
}

.row{display:flex;gap:20px;flex-wrap:wrap;} 
.col{flex:1 1 0;min-width:180px;}

/* èª¿æ•´ Label å­—é«”å¤§å°èˆ‡é¡è‰²å±¤æ¬¡ */
label{display:block;margin:4px 0 6px 2px;font-size:13px;color:#495057;font-weight: 600;}

/* è¼¸å…¥æ¡†ç¾åŒ–èˆ‡èšç„¦æ•ˆæœ */
select,textarea,input,button{width:100%;font:inherit;border:1px solid var(--border);border-radius:8px;padding:12px;background:#fff;box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s;}
select:focus, textarea:focus { 
    border-color: var(--accent); 
    box-shadow: 0 0 0 3px rgba(93, 153, 117, 0.2); 
    outline: none;
}

select{appearance: none; background: #fff url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%2D%22292.4%22%3E%3Cpath%20fill%3D%22%236c757d%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.3-6.4H18.8a17.6%2017.6%200%200%200-13.3%206.4%2017.6%2017.6%200%200%200%200%2023.7l126.6%20126.6c6.4%206.4%2017.6%206.4%2024.1%200l126.6-126.6a17.6%2017.6%200%200%200%200-23.7z%22%2F%3E%3C%2Fsvg%3E") no-repeat right 10px center; background-size: 10px;}

textarea{min-height:120px;resize:vertical;}
button{background:var(--accent);color:#fff;border:none;cursor:pointer;transition: background 0.2s, transform 0.1s;font-weight: 600; padding: 12px;}
button:hover:not(:disabled){background: var(--accent-hover);}
button:active:not(:disabled){transform: scale(0.99); background: var(--accent-hover);} /* æŒ‰éˆ•æŒ‰ä¸‹æ•ˆæœ */
button:disabled{opacity:.6;cursor:not-allowed}

/* KPI å€å¡Š - æŠ¬å‡èˆ‡äº’å‹•åé¥‹ */
.kpi-box{
    flex:1 1 20%;min-width:120px;text-align:center; cursor: pointer; 
    transition: transform 0.2s, box-shadow 0.2s;
    user-select: none; /* é˜²æ­¢æ–‡æœ¬è¢«é¸ä¸­ */
}
.kpi-box:hover:not(.score-kpi) { 
    transform: translateY(-5px); 
    box-shadow: 0 10px 20px rgba(93, 153, 117, 0.15); /* ç¶ è‰²æŸ”å’Œé™°å½± */
}
.kpi{font-size:32px;font-weight:700;margin-top:4px;}
.small{color:var(--muted);font-size:12px;}
.score-kpi{background: #e6f3eb; border: 2px solid var(--accent); cursor: default !important;}
.score-kpi:hover { transform: none; }
.score-kpi .kpi{font-size: 40px; color: var(--accent);}

/* åˆ†æ•¸å‹•æ…‹æ•ˆæœ */
@keyframes scorePop {
    0% { transform: scale(0.8); opacity: 0; }
    80% { transform: scale(1.1); opacity: 1; }
    100% { transform: scale(1); }
}
.score-anim-pop {
    animation: scorePop 0.4s ease-out;
}

/* è¡¨æ ¼å€å¡Š */
.table{width:100%;border-collapse:separate;border-spacing:0 6px;font-size:14px;}
.table th{color:#495057;text-align:left;padding:10px 8px;border-bottom:2px solid var(--border);font-weight: 600; background: #f0f0f0;}
.table td{background:#ffffff;border:1px solid #e9ecef;padding:10px 8px;border-radius:6px;word-break: break-word; box-shadow: 0 1px 3px rgba(0,0,0,0.02);}
.table-filter-active { background-color: #e4eef6; } /* éæ¿¾å¾Œçš„è¡Œé«˜äº® */

/* Tag æ¨™ç±¤ */
.tag{border-radius:4px;padding:3px 8px;display:inline-block;font-size:12px;font-weight: 600;}
.tag.fit{background:#e5f6e8;color:var(--success);}
.tag.adv1{background:#ffedd9;color:#d97706;}
.tag.adv2{background:#fdd;color:var(--danger);}
.tag.unseen{background:#e9e9e9;color:var(--muted);}

/* AI Feedback å€å¡Š */
.feedback-box{background: #e6f3eb; border-color: var(--accent); margin-top: 15px;}
.feedback-box h3{color: var(--accent); margin: 0 0 10px; font-size: 18px; border-bottom: 2px solid var(--accent); padding-bottom: 4px;}

/* ç¢ºä¿èªè¨€é¸æ“‡å™¨åœ¨å³ä¸Šè§’ä¸¦ç·Šæ¹Š */
#lang-selector-wrap {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 10px;
}
#lang-selector {
    width: auto;
    max-width: 150px;
    padding: 6px 10px;
    font-size: 14px;
}

/* Loading ç‹€æ…‹ */
#loading-overlay{position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:100;}
.spinner{border:4px solid rgba(0,0,0,.1); border-left-color:var(--accent); border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite;}
#loading-text{margin-left:15px; font-weight:600; color:var(--accent);}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

/* Translated Text Section */
#translated-text-wrap h3 { font-size: 14px; color: #495057; margin-bottom: 5px; }
#analysis-text-content { color: var(--accent); }

/* è®“è¡¨æ ¼è¡Œè®Šè‰² */
.risk-row-adv2 { background-color: #fff8f8; }
.risk-row-adv1 { background-color: #fffcf8; }

</style>
</head>
<body class="body-loaded">

<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text"></div>
</div>

<div class="wrap">
    <!-- èªè¨€é¸æ“‡å™¨ - ç¢ºä¿åœ¨å³ä¸Šè§’ -->
    <div id="lang-selector-wrap">
        <select id="lang-selector" onchange="i18n.setLanguage(this.value)">
            <option value="zh-TW" selected>ç¹é«”ä¸­æ–‡</option>
            <option value="en">English</option>
            <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
            <option value="ja">æ—¥æœ¬èª</option>
        </select>
    </div>

    <h1 id="app-title">ä¸­å°å­¸è‡ªç„¶ç§‘å‘½é¡Œç”¨è©AIæª¢æ ¸ç³»çµ±</h1>

    <div class="card">
        <!-- å‘½é¡Œæ¢ä»¶è¼¸å…¥ -->
        <div class="row">
            <div class="col">
                <label id="label-stage">å­¸ç¿’éšæ®µ</label>
                <select id="stage">
                    <option value="" selected disabled data-i18n="select_stage_placeholder">è«‹é¸æ“‡</option>
                    <option value="é«˜ä¸­" data-i18n="stage_highschool" disabled>é«˜ä¸­ [å»ºç½®ä¸­]</option>
                    <option value="åœ‹ä¸­" data-i18n="stage_juniorhigh">åœ‹ä¸­</option>
                    <option value="åœ‹å°" data-i18n="stage_elementary">åœ‹å°</option>
                </select>
            </div>
            <div class="col">
                <label id="label-grades">å¹´ç´š</label>
                <select id="grades" disabled>
                    <option value="" selected data-i18n="select_grade_placeholder">è«‹å…ˆé¸æ“‡å­¸ç¿’éšæ®µ</option>
                </select>
            </div>
            <div class="col">
                <label id="label-semester">å­¸æœŸ</label>
                <select id="semester">
                    <option value="" selected data-i18n="semester_any">ä¸é™</option>
                    <option value="ä¸Š" data-i18n="semester_up">ä¸Š</option>
                    <option value="ä¸‹" data-i18n="semester_down">ä¸‹</option>
                </select>
            </div>
            <div class="col">
                <label id="label-version">ç‰ˆæœ¬</label>
                <select id="version">
                    <option value="" selected data-i18n="version_any">ä¸é™</option>
                </select>
            </div>
        </div>

        <!-- è©æ€§ç¯©é¸ -->
        <div class="row" style="margin-top: 20px;">
            <div class="col" style="flex: 1 1 100%;">
                <label id="label-posfilter">è¨ˆç®—é©åˆ‡æ€§è©æ€§ç¯„åœï¼ˆè«‹å‹¾é¸ï¼‰</label>
                <div style="display:flex; gap: 15px; flex-wrap: wrap;">
                    <label style="display:inline-flex; align-items:center;">
                        <input type="checkbox" name="pos" value="N" checked style="width: auto; margin-right: 5px;"> <span data-i18n="pos_n">åè© (N)</span>
                    </label>
                    <label style="display:inline-flex; align-items:center;">
                        <input type="checkbox" name="pos" value="V" checked style="width: auto; margin-right: 5px;"> <span data-i18n="pos_v">å‹•è© (V)</span>
                    </label>
                    <label style="display:inline-flex; align-items:center;">
                        <input type="checkbox" name="pos" value="A" style="width: auto; margin-right: 5px;"> <span data-i18n="pos_a">å½¢å®¹è© (A)</span>
                    </label>
                    <label style="display:inline-flex; align-items:center;">
                        <input type="checkbox" name="pos" value="D" style="width: auto; margin-right: 5px;"> <span data-i18n="pos_d">å‰¯è© (D)</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- æ–‡æœ¬è¼¸å…¥ -->
        <div class="row" style="margin-top: 20px;">
            <div class="col" style="flex:1 1 100%">
                <label id="label-text">è²¼ä¸Šå‘½é¡Œæ–‡æœ¬ï¼ˆé¡Œå¹¹ï¼‹é¸é …ï¼‰</label>
                <textarea id="text" data-i18n="text_placeholder" placeholder="è«‹å°‡é¡Œå¹¹èˆ‡æ‰€æœ‰é¸é …è²¼åœ¨æ­¤è™•"></textarea>
            </div>
        </div>

        <!-- åŸ·è¡ŒæŒ‰éˆ• -->
        <div class="row" style="margin-top: 15px;">
            <div class="col">
                <button id="runBtn" data-i18n="btn_run">é–‹å§‹æª¢æ¸¬</button>
            </div>
        </div>
    </div>

    <!-- ç‹€æ…‹/éŒ¯èª¤è¨Šæ¯ -->
    <div id="status-message" class="card" style="display:none; color: var(--danger);"></div>
    
    <!-- åŸå§‹æ–‡æœ¬èˆ‡ç¿»è­¯å°ç…§ - æ”¾åœ¨çµæœå€é ‚éƒ¨ä»¥æ–¹ä¾¿å°ç…§ -->
    <div id="translated-text-wrap" class="card" style="display:none;">
        <h3 id="original-text-title">åŸå§‹å‘½é¡Œæ–‡æœ¬</h3>
        <p id="original-text-content" style="white-space: pre-wrap; margin-bottom: 15px; font-size: 14px; color: var(--muted);"></p>
        <h3 id="translated-text-title">åˆ†ææ‰€ä½¿ç”¨çš„ç¿»è­¯æ–‡æœ¬ (ç¹é«”ä¸­æ–‡)</h3>
        <p id="analysis-text-content" style="white-space: pre-wrap; font-weight: 600; color: var(--accent-hover); font-size: 16px;"></p>
    </div>

    <!-- KPI æ‘˜è¦ -->
    <div id="summary" class="row"></div>
    
    <!-- AI å›é¥‹ -->
    <div id="geminiFeedbackWrap"></div>

    <!-- é¢¨éšªè©æ¸…å–® -->
    <div id="risks"></div>
    
    <!-- è©å½™æª¢æ¸¬è¡¨ -->
    <div id="tableWrap"></div>
    
</div>

<script>
// ====== 1. i18n èªè¨€ç¿»è­¯å­—å…¸ (å¾ code.gs loadInitialData è¼‰å…¥) ======
const i18n = {
    currentLang: 'zh-TW',
    dictionary: {}, 
    
    // è¨­ç½®èªè¨€ä¸¦æ›´æ–°ä»‹é¢
    setLanguage(lang) {
        this.currentLang = lang;
        localStorage.setItem('appLang', lang); 
        document.documentElement.lang = lang;

        const dict = this.dictionary[lang] || this.dictionary['zh-TW'];
        
        // 1. è™•ç†æ‰€æœ‰ data-i18n å±¬æ€§
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (dict[key]) {
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.placeholder = dict[key];
                } else if (el.tagName === 'OPTION') {
                    el.textContent = dict[key];
                } else {
                    el.textContent = dict[key];
                }
            }
        });

        // 2. è™•ç†æ‰€æœ‰ ID æ¨™ç±¤ (Label, Title, Button)
        const idMap = {
            'app-title': 'title', 'label-stage': 'stage', 'label-grades': 'grades', 
            'label-semester': 'semester', 'label-version': 'version', 'label-posfilter': 'posfilter',
            'label-text': 'text_input_label', 'runBtn': 'btn_run', 
            // Result Titles
            'original-text-title': 'original_text_title', 'translated-text-title': 'translated_text_title',
            'risks-title': 'risks_title', 'table-title': 'table_title', 
            'feedback-title': 'ai_feedback_title'
        };
        Object.entries(idMap).forEach(([id, key]) => {
            const el = document.getElementById(id);
            if (el && dict[key]) el.textContent = dict[key];
        });
        
        // 3. ç‰¹æ®Šè™•ç† (æ›´æ–°é é¢å…§å®¹)
        if (window.appRenderer) window.appRenderer.renderSummary(window.__lastSummary);
        if (window.appRenderer) window.appRenderer.renderRisks(window.__lastRisks);
        if (window.appRenderer) window.appRenderer.renderTable(window.__lastTable);
        if (window.appRenderer) window.appRenderer.renderGeminiFeedback(window.__lastFeedback);
    }
};

// ====== 2. æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒé‚è¼¯èˆ‡æ¸²æŸ“ ======
(function(){
    let OPTIONS_DATA = {}; 
    let currentFilter = null; // å„²å­˜ç•¶å‰è¡¨æ ¼éæ¿¾ç‹€æ…‹ (e.g., 'adv2')

    // Helper å‡½å¼ï¼šç”Ÿæˆ tag æ¨£å¼
    function tag(state){
        var m = {fit:'ç¬¦åˆ', adv1:'è¶…å‰1', adv2:'è¶…å‰â‰¥2', unseen:'æœªè¦‹'};
        const lang = i18n.currentLang;
        const D = i18n.dictionary[lang];
        if(D) {
            if (state === 'fit') m[state] = D.tag_fit;
            else if (state === 'adv1') m[state] = D.tag_adv1;
            else if (state === 'adv2') m[state] = D.tag_adv2;
            else if (state === 'unseen') m[state] = D.tag_unseen;
        }
        return `<span class="tag ${state}">${m[state]||state}</span>`;
    }
    
    // æ•¸æ“šéæ¿¾åŠŸèƒ½ (UX å„ªåŒ–ï¼šé»æ“Š KPI éæ¿¾è¡¨æ ¼)
    function applyTableFilter(filterState) {
        const tableBody = document.querySelector('#tableWrap tbody');
        if (!tableBody) return;

        // åˆ‡æ›éæ¿¾ç‹€æ…‹
        if (currentFilter === filterState) {
            currentFilter = null; // é—œé–‰éæ¿¾
        } else {
            currentFilter = filterState; // è¨­ç½®æ–°éæ¿¾
        }
        
        // æ›´æ–° KPI æ¨£å¼ (è§£é™¤æˆ–è¨­ç½®é«˜äº®)
        document.querySelectorAll('.kpi-box').forEach(box => {
            box.classList.remove('active-filter');
            if (box.dataset.filter === currentFilter) {
                box.classList.add('active-filter');
            }
        });

        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(row => {
            const rowState = row.dataset.state;
            if (currentFilter === null || rowState === currentFilter) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        // é‡æ–°æ¸²æŸ“å®Œæ•´è¡¨æ ¼ä»¥æ›´æ–°æ¨£å¼ï¼ˆå¦‚æœä¸ä½¿ç”¨æ­¤è¡Œï¼Œéœ€è¦åœ¨ applyTableFilter ä¸­æ‰‹å‹•ç®¡ç† row çš„æ¨£å¼ï¼‰
        // ç‚ºä¿æŒæ•ˆç‡ï¼Œæˆ‘å€‘åªæ›´æ–°é¡¯ç¤ºç‹€æ…‹ï¼Œä¸é‡æ–°æ¸²æŸ“ã€‚

    }

    // Renderer ç‰©ä»¶
    const Renderer = {
        tag: tag,
        dict: () => i18n.dictionary[i18n.currentLang] || i18n.dictionary['zh-TW'],
        applyTableFilter: applyTableFilter, // æš´éœ²çµ¦å¤–éƒ¨ä½¿ç”¨

        renderSummary(s){
            if (!s) return;
            window.__lastSummary = s;
            const D = this.dict();
            const el = document.getElementById('summary');
            
            // å®šç¾© KPI é †åºå’Œ Key
            const kpiItems = [
                { id: 'finalScore', labelKey: 'score_label', unit: '', className: 'score-kpi', filter: null },
                { id: 'coverage', labelKey: 'coverage_label', unit: '%', className: '', filter: null },
                { id: 'adv1', labelKey: 'adv1_label', unit: '', className: '', filter: 'adv1' },
                { id: 'adv2', labelKey: 'adv2_label', unit: '', className: '', filter: 'adv2' },
                { id: 'unseen', labelKey: 'unseen_label', unit: '', className: '', filter: 'unseen' },
            ];
            
            el.innerHTML = kpiItems.map(item => `
                <div class="col card kpi-box ${item.className}" data-filter="${item.filter}" 
                     onclick="${item.filter ? `window.appRenderer.applyTableFilter('${item.filter}')` : ''}">
                    <div class="small">${D[item.labelKey] || item.labelKey}</div>
                    <div class="kpi ${item.id === 'finalScore' ? 'score-anim-pop' : ''}">${s[item.id]??0}${item.unit}</div>
                </div>
            `).join('');
        },

        renderRisks(list){
            if(!list || !list.length){ document.getElementById('risks').innerHTML=''; return; }
            window.__lastRisks = list;
            const D = this.dict();
            const el = document.getElementById('risks');
            
            el.innerHTML = `<div class="card"><b id="risks-title">${D.risks_title || 'é«˜é¢¨éšªè©æ¸…å–®ï¼ˆå‰10ï¼‰'}</b><hr/>` +
                list.map(r => `
                    <div style="margin:6px 0">
                        <div><span class="feedback-term-note">${r.term}</span> ${this.tag(r.state)} (${D.frequency_unit || 'x'}${r.frequency})</div>
                        <div class="small">${D.first_introduced_label || 'æœ€æ—©å‡ºç¾'}ï¼š${r.first || D.unlabeled_sem}</div>
                        <div style="margin-top:4px;">${r.feedback||''}</div>
                    </div>
                `).join('') + '</div>';
        },

        renderTable(rows){
            if(!rows || !rows.length){ document.getElementById('tableWrap').innerHTML=''; return; }
            window.__lastTable = rows;
            const D = this.dict();
            const el = document.getElementById('tableWrap');

            const tableRows = rows.map(r => {
                const rowClass = r.state === 'adv2' ? 'risk-row-adv2' : r.state === 'adv1' ? 'risk-row-adv1' : '';
                return `
                    <tr class="${rowClass}" data-state="${r.state}">
                        <td>${r.term}</td>
                        <td>${r.posMajor}</td>
                        <td>${r.frequency}</td>
                        <td>${r.first || D.unlabeled_sem}</td>
                        <td>${this.tag(r.state)}</td>
                    </tr>
                `;
            }).join('');
            
            el.innerHTML = `
                <div class="card"><b id="table-title">${D.table_title || 'è©å½™æª¢æ¸¬è¡¨'} (${D.total_terms_label}: ${rows.length})</b>
                <table class="table">
                <thead><tr>
                    <th>${D.table_header_term || 'è©å½™'}</th>
                    <th>${D.table_header_pos || 'è©æ€§'}</th>
                    <th>${D.table_header_freq || 'é »ç‡ (x)'}</th>
                    <th>${D.table_header_first || 'æœ€æ—©å‡ºç¾'}</th>
                    <th>${D.table_header_state || 'ç‹€æ…‹'}</th>
                </tr></thead>
                <tbody>${tableRows}</tbody></table></div>`;

            // é‡æ–°æ‡‰ç”¨éæ¿¾ (å¦‚æœå­˜åœ¨)
            if (currentFilter) {
                this.applyTableFilter(currentFilter);
            }
        },
        
        renderGeminiFeedback(fb){
            const el = document.getElementById('geminiFeedbackWrap');
            el.innerHTML = '';
            if(!fb || !fb.overall){ return; }
            window.__lastFeedback = fb;
            const D = this.dict();

            let html = `<div class="card feedback-box"><h3 id="feedback-title">ğŸ’¡ ${D.ai_feedback_title || 'AI å‘½é¡Œå¯©æŸ¥å›é¥‹'}</h3>`;
            
            // åŸå§‹æ–‡æœ¬å’Œç¿»è­¯æ–‡æœ¬
            document.getElementById('original-text-content').textContent = window.__originalText;
            document.getElementById('analysis-text-content').textContent = fb.translatedText;
            document.getElementById('translated-text-wrap').style.display = (window.__originalText !== fb.translatedText) ? 'block' : 'none';

            // 1. æ•´é«”è©•èª
            html += `<p style="font-size: 16px;"><strong>${D.overall_comment_label || 'æ•´é«”è©•èª'}ï¼š</strong> ${fb.overall || D.no_comment_text}</p><hr>`;

            // 2. å„ªé»èˆ‡é¢¨éšª
            html += `<div class="row">`;
            html += `<div class="col" style="min-width: unset; flex: 1;"><strong>${D.strengths_label || 'å„ªé»'}ï¼š</strong><ul>`;
            (fb.strengths || []).forEach(s => { html += `<li>${s}</li>`; });
            html += '</ul></div>';
            
            html += `<div class="col" style="min-width: unset; flex: 1;"><strong>${D.risks_label || 'é¢¨éšª'}ï¼š</strong><ul>`;
            (fb.risks || []).forEach(r => { html += `<li>${r}</li>`; });
            html += '</ul></div>';
            html += '</div>';

            // 3. ä¿®æ­£ç­–ç•¥
            if (fb.suggestions && fb.suggestions.length) {
                html += `<hr><strong>${D.suggestions_label || 'ä¿®æ­£ç­–ç•¥å»ºè­°'}ï¼š</strong><ul>`;
                (fb.suggestions || []).forEach(s => { html += `<li>${s}</li>`; });
                html += '</ul>';
            }

            // 4. è©å½™è¨»é‡‹è¡¨
            if (fb.termNotes && fb.termNotes.length) {
                html += `<hr><strong>${D.term_notes_label || 'é«˜é¢¨éšªè©å½™ä¿®æ­£å»ºè­°'}ï¼š</strong>`;
                html += `<table class="term-note-table" style="width: 100%;"><thead><tr>
                    <th style="width: 25%;">${D.table_header_term || 'è©å½™'}</th>
                    <th style="width: 35%;">${D.issue_label || 'å•é¡Œé»'}</th>
                    <th style="width: 40%;">${D.fix_label || 'å¯æ¥å—æ”¹å¯«'}</th>
                </tr></thead><tbody>`;
                (fb.termNotes || []).forEach(n => {
                    html += `<tr><td>${n.term}</td><td>${n.issue || D.none_text}</td><td>${n.fix || D.none_text}</td></tr>`;
                });
                html += '</tbody></table>';
            }

            html += '</div>';
            el.innerHTML = html;
        }
    };
    window.appRenderer = Renderer;

    // ====== 3. äº‹ä»¶è™•ç†èˆ‡é€£å‹•é‚è¼¯ ======
    
    // ä¾å­¸ç¿’éšæ®µåˆ·æ–°å¹´ç´šå’Œç‰ˆæœ¬
    function refreshByStage(){
        const stage = document.getElementById('stage').value || '';
        const verSel = document.getElementById('version');
        const grdSel = document.getElementById('grades');
        const D = Renderer.dict();

        // åˆ·æ–°å¹´ç´š
        grdSel.innerHTML = '';
        const gs = OPTIONS_DATA[stage] ? OPTIONS_DATA[stage].grades : [];
        if (gs.length){
            const tip = document.createElement('option');
            tip.value = ''; tip.textContent = D.select_grade_placeholder || 'è«‹é¸æ“‡å¹´ç´š';
            grdSel.appendChild(tip);
            gs.forEach(g=>{
                const opt = document.createElement('option');
                opt.value = String(g.v); opt.textContent = g.t;
                grdSel.appendChild(opt);
            });
            grdSel.disabled = false;
        } else {
            const opt = document.createElement('option');
            opt.value = ''; opt.textContent = D.none_text || 'ä¸é™';
            grdSel.appendChild(opt);
            grdSel.disabled = true;
        }
        
        // åˆ·æ–°ç‰ˆæœ¬
        verSel.innerHTML = '';
        const vs = OPTIONS_DATA[stage] ? OPTIONS_DATA[stage].versions : [];
        vs.forEach(v=>{
            const opt = document.createElement('option');
            opt.value = v; 
            opt.textContent = (v === 'ä¸é™') ? (D.version_any || 'ä¸é™') : v;
            verSel.appendChild(opt);
        });
        verSel.disabled = false;
        verSel.value = 'ä¸é™'; 
    }
    
    function setLoading(on, messageKey='loading_analysis'){
        const btn = document.getElementById('runBtn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const D = Renderer.dict();
        
        btn.disabled = !!on;
        btn.textContent = on ? (D.loading_analysis || 'åˆ†æä¸­...') : (D.btn_run || 'é–‹å§‹æª¢æ¸¬');
        loadingOverlay.style.display = on ? 'flex' : 'none';
        loadingText.textContent = D[messageKey] || 'AI æ­£åœ¨åˆ†æå‘½é¡Œï¼Œè«‹ç¨å€™...';
    }

    function run(){
        const stage = document.getElementById('stage').value || '';
        const grades = document.getElementById('grades').value || ''; 
        const semester = document.getElementById('semester').value || '';
        const version = document.getElementById('version').value || '';
        const text = document.getElementById('text').value || '';
        const lang = i18n.currentLang;
        
        const D = Renderer.dict();
        
        if (!stage || !grades || !text) {
            document.getElementById('status-message').textContent = D.error_missing_fields || 'éŒ¯èª¤ï¼šè«‹é¸æ“‡å­¸ç¿’éšæ®µã€å¹´ç´šä¸¦è²¼ä¸Šå‘½é¡Œæ–‡æœ¬ã€‚';
            document.getElementById('status-message').style.display = 'block';
            return;
        }
        document.getElementById('status-message').style.display = 'none';

        window.__originalText = text;
        
        const posFilter = Array.from(document.querySelectorAll('input[name="pos"]:checked'))
                           .map(input => input.value);

        setLoading(true);
        // é‡ç½®éæ¿¾ç‹€æ…‹
        currentFilter = null;
        
        // æ¸…ç©ºèˆŠçµæœ
        document.getElementById('translated-text-wrap').style.display = 'none';
        document.getElementById('summary').innerHTML = '';
        document.getElementById('risks').innerHTML = '';
        document.getElementById('tableWrap').innerHTML = '';
        document.getElementById('geminiFeedbackWrap').innerHTML = '';
        
        google.script.run
            .withSuccessHandler(function(data){
                setLoading(false);
                if(data && data.error){ 
                    // éŒ¯èª¤ä»£ç¢¼æ˜ å°„
                    let errMsg = D[data.error] || data.error;
                    document.getElementById('status-message').textContent = D.error_server_failed + ': ' + errMsg;
                    document.getElementById('status-message').style.display = 'block';
                    return; 
                }
                
                Renderer.renderSummary(data.summary || {});
                Renderer.renderRisks(data.risks || []);
                Renderer.renderTable(data.table || []);
                Renderer.renderGeminiFeedback(data.gptFeedback);

                window.__lastSummary = data.summary;
                window.__lastRisks = data.risks;
                window.__lastTable = data.table;
                window.__lastFeedback = data.gptFeedback;
            })
            .withFailureHandler(function(err){
                setLoading(false);
                document.getElementById('status-message').textContent = D.error_server_call_failed + ': ' + err;
                document.getElementById('status-message').style.display = 'block';
            })
            .runCheck({ text, grades, semester, stage, version, posFilter, lang });
    }
    
    // ====== 4. åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š ======
    
    document.addEventListener('DOMContentLoaded', function(){
        google.script.run
            .withSuccessHandler(function(data){
                // è¼‰å…¥ i18n å­—å…¸
                i18n.dictionary = {
                    ...data.i18n, 
                    'zh-TW': {
                        ...data.i18n['zh-TW'],
                        coverage_label: 'ç”¨è©é©åˆ‡æ€§', adv1_label: 'è¶…å‰ 1 å­¸æœŸ', adv2_label: 'è¶…å‰ â‰¥ 2 å­¸æœŸ', unseen_label: 'æœªè¦‹æ–¼æ•™æ',
                        total_terms_label: 'å”¯ä¸€è©å½™æ•¸', first_introduced_label: 'æœ€æ—©å‡ºç¾', frequency_unit: 'x',
                        table_header_term: 'è©å½™', table_header_pos: 'è©æ€§', table_header_freq: 'é »ç‡', table_header_first: 'æœ€æ—©å‡ºç¾', table_header_state: 'ç‹€æ…‹',
                        unlabeled_sem: 'ï¼ˆæœªæ¨™ï¼‰', none_text: 'ç„¡',
                        error_missing_fields: 'éŒ¯èª¤ï¼šè«‹é¸æ“‡å­¸ç¿’éšæ®µã€å¹´ç´šä¸¦è²¼ä¸Šå‘½é¡Œæ–‡æœ¬ã€‚',
                        error_server_failed: 'ä¼ºæœç«¯è™•ç†å¤±æ•—', error_server_call_failed: 'å‘¼å«ä¼ºæœç«¯å¤±æ•—',
                        loading_analysis: 'AI æ­£åœ¨åˆ†æå‘½é¡Œï¼Œè«‹ç¨å€™...', ai_feedback_title: 'AI å‘½é¡Œå¯©æŸ¥å›é¥‹',
                        overall_comment_label: 'æ•´é«”è©•èª', strengths_label: 'å„ªé»', risks_label: 'é¢¨éšª', suggestions_label: 'ä¿®æ­£ç­–ç•¥å»ºè­°',
                        term_notes_label: 'é«˜é¢¨éšªè©å½™ä¿®æ­£å»ºè­°', issue_label: 'å•é¡Œé»', fix_label: 'å¯æ¥å—æ”¹å¯«',
                        tag_fit: 'ç¬¦åˆ', tag_adv1: 'è¶…å‰1', tag_adv2: 'è¶…å‰â‰¥2', tag_unseen: 'æœªè¦‹',
                        original_text_title: 'åŸå§‹å‘½é¡Œæ–‡æœ¬', translated_text_title: 'åˆ†ææ‰€ä½¿ç”¨çš„ç¿»è­¯æ–‡æœ¬ (ç¹é«”ä¸­æ–‡)',
                        risks_title: 'é«˜é¢¨éšªè©æ¸…å–®ï¼ˆå‰10ï¼‰', table_title: 'è©å½™æª¢æ¸¬è¡¨',
                        pos_help_title: 'è©æ€§ç¯©é¸èªªæ˜ï¼š', pos_help_trigger: '[?]',
                    },
                };

                OPTIONS_DATA = data.options;
                
                const storedLang = localStorage.getItem('appLang') || 'zh-TW';
                document.getElementById('lang-selector').value = storedLang;
                i18n.setLanguage(storedLang);
                
                refreshByStage(); 
                
                // è¨­ç½® body é¡ï¼Œè§¸ç™¼æ·¡å…¥æ•ˆæœ
                document.body.classList.add('body-loaded');

            }).loadInitialData();
            
        // ç¶å®šäº‹ä»¶
        document.getElementById('stage').addEventListener('change', refreshByStage);
        document.getElementById('runBtn').addEventListener('click', run);
        
    });
})();
</script>
</body>
</html>
