<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘å­¸æ–‡æœ¬æŸ¥è©¢ | Science Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        researcher: { light: '#e9d5ff', DEFAULT: '#a855f7', dark: '#7e22ce' },
                        glass: { 100: 'rgba(255, 255, 255, 0.1)', 200: 'rgba(255, 255, 255, 0.2)', 700: 'rgba(255, 255, 255, 0.7)', 900: 'rgba(255, 255, 255, 0.9)' }
                    },
                    fontFamily: { sans: ['ui-sans-serif', 'system-ui', '-apple-system', "Segoe UI", 'Roboto', "Helvetica Neue", 'Arial', 'sans-serif'] },
                    animation: { "fade-in-up": "fadeInUp 0.6s ease-out forwards", "pulse-slow": "pulse 3s infinite" },
                    keyframes: { fadeInUp: { "0%": { opacity: "0", transform: "translateY(20px)" }, "100%": { opacity: "1", transform: "translateY(0)" } } }
                }
            }
        }
    </script>
    <style>
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px 0 rgba(126, 34, 206, 0.08); }
        .input-area:focus { outline: none; border-color: #a855f7; box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.15); }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; overflow: hidden; background: linear-gradient(135deg, #fdfbff 0%, #f5f3ff 100%); }
        .title-3d { background: linear-gradient(135deg, #581c87 0%, #7e22ce 50%, #a855f7 100%); -webkit-background-clip: text; background-clip: text; color: transparent; filter: drop-shadow(1px 1px 0px rgba(168, 85, 247, 0.4)) drop-shadow(3px 3px 0px rgba(88, 28, 135, 0.1)); }
        
        /* è¡¨æ ¼æ¨£å¼å„ªåŒ– */
        .table-container { overflow-x: auto; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th { background-color: #f3e8ff; color: #6b21a8; font-weight: 700; padding: 12px 16px; text-align: left; font-size: 0.875rem; border-bottom: 2px solid #e9d5ff; }
        td { padding: 12px 16px; border-bottom: 1px solid #f3f4f6; color: #374151; font-size: 0.9rem; }
        tr:hover td { background-color: #faf5ff; }
        .td-content { white-space: normal; min-width: 300px; max-width: 500px; line-height: 1.6; }
        
        /* èªéŸ³æŒ‰éˆ•å‹•ç•« */
        .mic-active { animation: pulse-red 1.5s infinite; color: #ef4444 !important; border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* è¼‰å…¥ä¸­é®ç½© */
        .loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.7); backdrop-filter: blur(2px); display: flex; align-items: center; justify-content: center; z-index: 50; border-radius: 1.5rem; }
    </style>
</head>
<body class="min-h-screen font-sans flex flex-col text-slate-700 relative overflow-x-hidden selection:bg-purple-200 selection:text-purple-900">

    <div id="canvas-container"><canvas id="network-canvas"></canvas></div>

    <nav class="glass-panel sticky top-0 z-50 border-b-0">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer group" onclick="window.location.href='researcher.html'">
                <div class="bg-purple-100 p-2 rounded-xl text-purple-600 shadow-sm transition group-hover:scale-105 group-hover:bg-purple-200">
                    <i class="fa-solid fa-arrow-left text-lg"></i>
                </div>
                <span class="text-xl font-bold tracking-tight text-slate-800 group-hover:text-purple-700 transition" data-i18n="back_researcher">è¿”å›ç ”ç©¶ä¸­å¿ƒ</span>
            </div>
            <div class="flex items-center space-x-4">
                 <select id="language-selector" onchange="changeLanguage()" class="glass-panel rounded-xl py-2 px-4 text-sm font-medium outline-none focus:ring-2 focus:ring-purple-400/50 cursor-pointer text-slate-700 border border-purple-200 hover:bg-white/90 transition">
                    <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                    <option value="en">English</option>
                    <option value="ja">æ—¥æœ¬èª</option>
                    <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                </select>
                <span class="bg-purple-50 text-purple-700 px-4 py-1.5 rounded-full text-sm font-bold border border-purple-200 shadow-sm flex items-center gap-2">
                    <i class="fa-solid fa-magnifying-glass"></i> <span data-i18n="tool_name">ç§‘å­¸æ–‡æœ¬æŸ¥è©¢</span>
                </span>
            </div>
        </div>
    </nav>

    <main class="flex-1 p-6 md:p-10 relative z-10">
        <div class="max-w-7xl mx-auto animate-fade-in-up">
            
            <div class="text-center mb-10">
                <h1 class="text-4xl md:text-5xl font-black title-3d mb-3 tracking-tight" data-i18n="page_title">ç§‘å­¸æ–‡æœ¬èªæ–™åº«æŸ¥è©¢</h1>
                <p class="text-slate-500 text-lg font-medium" data-i18n="page_subtitle">Search Scientific Text Corpus & Analysis</p>
            </div>

            <div class="glass-panel p-8 rounded-[2rem] mb-8 border border-white/60 relative">
                <div id="search-loading" class="loading-overlay hidden"><div class="text-purple-600 font-bold text-lg"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i> <span data-i18n="msg_searching">æŸ¥è©¢ä¸­...</span></div></div>

                <div class="mb-8">
                    <label class="block text-sm font-bold text-slate-600 mb-2 ml-1" data-i18n="label_search_term">è«‹è¼¸å…¥æŸ¥è©¢è©å½™æˆ–å¥å­</label>
                    <div class="relative group">
                        <textarea id="inputText" class="input-area w-full h-24 p-5 pr-14 rounded-2xl border border-slate-200 bg-white/80 text-slate-700 text-lg leading-relaxed resize-none shadow-inner transition" placeholder="ä¾‹ï¼šæ‘©æ“¦åŠ›ã€å…‰åˆä½œç”¨ã€å…¨çƒæš–åŒ–..."></textarea>
                        
                        <button id="voiceBtn" class="absolute bottom-3 right-3 w-10 h-10 rounded-xl bg-slate-100 text-slate-500 hover:bg-purple-100 hover:text-purple-600 transition flex items-center justify-center shadow-sm border border-slate-200" title="èªéŸ³è¼¸å…¥">
                            <i class="fa-solid fa-microphone"></i>
                        </button>
                    </div>
                    <p id="voiceHint" class="text-xs text-slate-400 mt-2 text-right h-4 transition-all"></p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 bg-purple-50/50 p-5 rounded-2xl border border-purple-100">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1 uppercase" data-i18n="label_stage">å­¸ç¿’éšæ®µ</label>
                        <select id="stageFilter" class="w-full p-2.5 rounded-xl border border-slate-200 bg-white text-slate-700 focus:ring-2 focus:ring-purple-400 outline-none">
                            <option value="å…¨éƒ¨" data-i18n="opt_all" selected>å…¨éƒ¨</option>
                            <option value="åœ‹å°" data-i18n="opt_elem">åœ‹å°</option>
                            <option value="åœ‹ä¸­" data-i18n="opt_junior">åœ‹ä¸­</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1 uppercase" data-i18n="label_page_size">æ¯é é¡¯ç¤º</label>
                        <select id="pageSizeSelect" class="w-full p-2.5 rounded-xl border border-slate-200 bg-white text-slate-700 focus:ring-2 focus:ring-purple-400 outline-none">
                            <option value="20">20 ç­†</option>
                            <option value="50">50 ç­†</option>
                            <option value="100">100 ç­†</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1 uppercase" data-i18n="label_context">ä¸Šä¸‹æ–‡ç¯„åœ</label>
                        <select id="contextRangeSelect" class="w-full p-2.5 rounded-xl border border-slate-200 bg-white text-slate-700 focus:ring-2 focus:ring-purple-400 outline-none">
                            <option value="0" data-i18n="opt_ctx_0">æœ¬å¥</option>
                            <option value="1" data-i18n="opt_ctx_1">å‰å¾Œ 1 å¥</option>
                            <option value="2" data-i18n="opt_ctx_2">å‰å¾Œ 2 å¥</option>
                            <option value="3" data-i18n="opt_ctx_3">å‰å¾Œ 3 å¥</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="searchBtn" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-2.5 rounded-xl font-bold shadow-md hover:shadow-lg hover:shadow-purple-500/30 active:scale-95 transition">
                            <i class="fa-solid fa-magnifying-glass mr-2"></i> <span data-i18n="btn_search">æŸ¥è©¢</span>
                        </button>
                    </div>
                </div>

                <div id="statusMsg" class="text-center text-sm font-medium min-h-[20px]"></div>
            </div>

            <div id="result-panel" class="hidden">
                
                <div id="earliestInfo" class="glass-panel p-6 rounded-2xl border-l-8 border-purple-500 mb-6 flex items-start gap-4 hidden">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center flex-shrink-0 text-purple-600 text-xl">
                        <i class="fa-solid fa-lightbulb"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-purple-800 mb-1" data-i18n="title_earliest">è©å½™æœ€æ—©å‡ºç¾ä½ç½®</h3>
                        <div id="earliestInfoContent" class="text-slate-600 leading-relaxed text-sm"></div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-3xl mb-8 border border-white/60">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-chart-line text-purple-500"></i> <span data-i18n="title_chart">å„ç‰ˆæœ¬å¹´ç´šåˆ†ä½ˆ</span>
                    </h3>
                    <div class="h-[300px] w-full relative">
                        <canvas id="gradeChart"></canvas>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-3xl border border-white/60 overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-list-ul text-purple-500"></i> <span data-i18n="title_list">æª¢ç´¢çµæœåˆ—è¡¨</span>
                        </h3>
                        <div id="pagerInfo" class="text-xs text-slate-500 font-bold bg-slate-100 px-3 py-1 rounded-full">0 / 0</div>
                    </div>
                    
                    <div class="table-container">
                        <table id="resultTable">
                            <thead>
                                <tr>
                                    <th data-i18n="th_no">#</th>
                                    <th data-i18n="th_term">æŸ¥è©¢è©</th>
                                    <th data-i18n="th_stage">éšæ®µ</th>
                                    <th data-i18n="th_pub">å‡ºç‰ˆç¤¾</th>
                                    <th data-i18n="th_grade">å¹´ç´š</th>
                                    <th data-i18n="th_sem">å­¸æœŸ</th>
                                    <th data-i18n="th_vol">å†Šåˆ¥</th>
                                    <th data-i18n="th_unit">èª²åˆ¥</th>
                                    <th data-i18n="th_content">å…§å®¹</th>
                                </tr>
                            </thead>
                            <tbody id="resultBody" class="bg-white"></tbody>
                        </table>
                    </div>

                    <div class="flex justify-center items-center gap-4 mt-6">
                        <button id="prevPageBtn" class="w-10 h-10 rounded-full bg-white border border-slate-200 text-slate-600 hover:bg-purple-50 hover:text-purple-600 hover:border-purple-200 transition shadow-sm disabled:opacity-40 disabled:cursor-not-allowed">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <div class="flex items-center gap-2 bg-slate-50 px-4 py-2 rounded-xl border border-slate-200">
                            <span class="text-sm text-slate-500" data-i18n="label_goto">è·³è‡³</span>
                            <input type="number" id="gotoPageInput" min="1" value="1" class="w-12 text-center bg-white border border-slate-200 rounded-md py-1 text-sm outline-none focus:border-purple-400">
                            <span class="text-sm text-slate-500" data-i18n="label_page">é </span>
                            <button id="gotoPageBtn" class="text-xs bg-purple-600 text-white px-2 py-1 rounded hover:bg-purple-700 transition">GO</button>
                        </div>
                        <button id="nextPageBtn" class="w-10 h-10 rounded-full bg-white border border-slate-200 text-slate-600 hover:bg-purple-50 hover:text-purple-600 hover:border-purple-200 transition shadow-sm disabled:opacity-40 disabled:cursor-not-allowed">
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-2xl transition-all duration-300 opacity-0 translate-y-10 z-50 flex items-center gap-3 pointer-events-none border border-slate-700/50">
        <i class="fa-solid fa-circle-info text-purple-400"></i>
        <span id="toast-msg" class="font-medium text-sm"></span>
    </div>

    <script>
        // ğŸ”´ è«‹åœ¨æ­¤å¡«å…¥å‰›å‰›éƒ¨ç½² GAS å¾Œå–å¾—çš„ç¶²å€ (çµå°¾æ˜¯ /exec)
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyswFkjh-wlWpgZMD02eyO4vBhLX2-HdkYY4AAaonG-LxJuL5Ioi02MyZukgj73q82b_A/exec"; 

        // *** å¤šèªç³»è¨­å®š (å®Œæ•´4åœ‹èªè¨€) ***
        const translations = {
            "zh-TW": {
                "back_researcher": "è¿”å›ç ”ç©¶ä¸­å¿ƒ", "tool_name": "ç§‘å­¸æ–‡æœ¬æŸ¥è©¢",
                "page_title": "ç§‘å­¸æ–‡æœ¬èªæ–™åº«æŸ¥è©¢", "page_subtitle": "Search Scientific Text Corpus & Analysis",
                "msg_searching": "æŸ¥è©¢ä¸­...", "label_search_term": "è«‹è¼¸å…¥æŸ¥è©¢è©å½™æˆ–å¥å­",
                "label_stage": "å­¸ç¿’éšæ®µ", "opt_all": "å…¨éƒ¨", "opt_elem": "åœ‹å°", "opt_junior": "åœ‹ä¸­",
                "label_page_size": "æ¯é é¡¯ç¤º", "label_context": "ä¸Šä¸‹æ–‡ç¯„åœ",
                "opt_ctx_0": "æœ¬å¥", "opt_ctx_1": "å‰å¾Œ 1 å¥", "opt_ctx_2": "å‰å¾Œ 2 å¥", "opt_ctx_3": "å‰å¾Œ 3 å¥",
                "btn_search": "æŸ¥è©¢", "title_earliest": "è©å½™æœ€æ—©å‡ºç¾ä½ç½®", "msg_no_earliest": "å°šæœªåœ¨æ•™æä¸­å‡ºç¾",
                "title_chart": "å„ç‰ˆæœ¬å¹´ç´šåˆ†ä½ˆ", "title_list": "æª¢ç´¢çµæœåˆ—è¡¨",
                "th_no": "#", "th_term": "æŸ¥è©¢è©", "th_stage": "éšæ®µ", "th_pub": "å‡ºç‰ˆç¤¾",
                "th_grade": "å¹´ç´š", "th_sem": "å­¸æœŸ", "th_vol": "å†Šåˆ¥", "th_unit": "èª²åˆ¥", "th_content": "å…§å®¹",
                "label_goto": "è·³è‡³", "label_page": "é ",
                "msg_no_data": "æ²’æœ‰æ‰¾åˆ°ç›¸ç¬¦è³‡æ–™ã€‚", "msg_total_prefix": "ç¸½å…±", "msg_total_suffix": "ç­†è³‡æ–™",
                "mic_listening": "æ­£åœ¨è†è½...", "mic_error": "ç„¡æ³•é–‹å•Ÿéº¥å…‹é¢¨", "mic_not_support": "æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥",
                "msg_input_empty": "è«‹è¼¸å…¥æŸ¥è©¢å…§å®¹",
                "msg_api_url_error": "è«‹å…ˆè¨­å®š GAS API ç¶²å€",
                "placeholder_text": "ä¾‹ï¼šæ‘©æ“¦åŠ›ã€å…‰åˆä½œç”¨ã€å…¨çƒæš–åŒ–...",
                "grade_suffix": "å¹´ç´š"
            },
            "en": {
                "back_researcher": "Back to Research Center", "tool_name": "Corpus Search",
                "page_title": "Scientific Corpus Query", "page_subtitle": "Search Scientific Text Corpus & Analysis",
                "msg_searching": "Searching...", "label_search_term": "Enter keyword or sentence",
                "label_stage": "Stage", "opt_all": "All", "opt_elem": "Elementary", "opt_junior": "Junior High",
                "label_page_size": "Page Size", "label_context": "Context Range",
                "opt_ctx_0": "Current", "opt_ctx_1": "+/- 1 Sentence", "opt_ctx_2": "+/- 2 Sentences", "opt_ctx_3": "+/- 3 Sentences",
                "btn_search": "Search", "title_earliest": "Earliest Appearance", "msg_no_earliest": "Not found in corpus",
                "title_chart": "Distribution by Grade/Version", "title_list": "Search Results",
                "th_no": "#", "th_term": "Term", "th_stage": "Stage", "th_pub": "Publisher",
                "th_grade": "Grade", "th_sem": "Sem.", "th_vol": "Vol.", "th_unit": "Unit", "th_content": "Content",
                "label_goto": "Go to", "label_page": "",
                "msg_no_data": "No results found.", "msg_total_prefix": "Total", "msg_total_suffix": "records",
                "mic_listening": "Listening...", "mic_error": "Mic Error", "mic_not_support": "Voice input not supported",
                "msg_input_empty": "Please enter search text",
                "msg_api_url_error": "Please configure GAS API URL",
                "placeholder_text": "E.g., Photosynthesis, Friction...",
                "grade_suffix": " Grade"
            },
            "ja": { 
                "back_researcher": "ç ”ç©¶ã‚»ãƒ³ã‚¿ãƒ¼ã¸æˆ»ã‚‹", "tool_name": "ç§‘å­¦ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢",
                "page_title": "ç§‘å­¦ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ¼ãƒ‘ã‚¹æ¤œç´¢", "page_subtitle": "Search Scientific Text Corpus & Analysis",
                "msg_searching": "æ¤œç´¢ä¸­...", "label_search_term": "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¾ãŸã¯æ–‡ã‚’å…¥åŠ›",
                "label_stage": "å­¦ç¿’æ®µéš", "opt_all": "ã™ã¹ã¦", "opt_elem": "å°å­¦æ ¡", "opt_junior": "ä¸­å­¦æ ¡",
                "label_page_size": "è¡¨ç¤ºä»¶æ•°", "label_context": "æ–‡è„ˆç¯„å›²",
                "opt_ctx_0": "ã“ã®æ–‡ã®ã¿", "opt_ctx_1": "å‰å¾Œ 1 æ–‡", "opt_ctx_2": "å‰å¾Œ 2 æ–‡", "opt_ctx_3": "å‰å¾Œ 3 æ–‡",
                "btn_search": "æ¤œç´¢", "title_earliest": "åˆå‡ºç®‡æ‰€", "msg_no_earliest": "ã‚³ãƒ¼ãƒ‘ã‚¹ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“",
                "title_chart": "å­¦å¹´ãƒ»å‡ºç‰ˆç¤¾åˆ¥åˆ†å¸ƒ", "title_list": "æ¤œç´¢çµæœä¸€è¦§",
                "th_no": "#", "th_term": "æ¤œç´¢èª", "th_stage": "æ®µéš", "th_pub": "å‡ºç‰ˆç¤¾",
                "th_grade": "å­¦å¹´", "th_sem": "å­¦æœŸ", "th_vol": "å·»", "th_unit": "å˜å…ƒ", "th_content": "å†…å®¹",
                "label_goto": "ç§»å‹•", "label_page": "ãƒšãƒ¼ã‚¸",
                "msg_no_data": "ä¸€è‡´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚", "msg_total_prefix": "åˆè¨ˆ", "msg_total_suffix": "ä»¶",
                "mic_listening": "èãå–ã‚Šä¸­...", "mic_error": "ãƒã‚¤ã‚¯ã‚¨ãƒ©ãƒ¼", "mic_not_support": "éŸ³å£°å…¥åŠ›ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“",
                "msg_input_empty": "æ¤œç´¢å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
                "msg_api_url_error": "GAS API URLã‚’è¨­å®šã—ã¦ãã ã•ã„",
                "placeholder_text": "ä¾‹ï¼šå…‰åˆæˆã€æ‘©æ“¦åŠ›ã€æ¸©æš–åŒ–...",
                "grade_suffix": "å¹´ç”Ÿ"
            },
            "zh-CN": { 
                "back_researcher": "è¿”å›ç ”ç©¶ä¸­å¿ƒ", "tool_name": "ç§‘å­¦æ–‡æœ¬æŸ¥è¯¢",
                "page_title": "ç§‘å­¦æ–‡æœ¬è¯­æ–™åº“æŸ¥è¯¢", "page_subtitle": "Search Scientific Text Corpus & Analysis",
                "msg_searching": "æŸ¥è¯¢ä¸­...", "label_search_term": "è¯·è¾“å…¥æŸ¥è¯¢è¯æ±‡æˆ–å¥å­",
                "label_stage": "å­¦ä¹ é˜¶æ®µ", "opt_all": "å…¨éƒ¨", "opt_elem": "å›½å°", "opt_junior": "å›½ä¸­",
                "label_page_size": "æ¯é¡µæ˜¾ç¤º", "label_context": "ä¸Šä¸‹æ–‡èŒƒå›´",
                "opt_ctx_0": "æœ¬å¥", "opt_ctx_1": "å‰å 1 å¥", "opt_ctx_2": "å‰å 2 å¥", "opt_ctx_3": "å‰å 3 å¥",
                "btn_search": "æŸ¥è¯¢", "title_earliest": "è¯æ±‡æœ€æ—©å‡ºç°ä½ç½®", "msg_no_earliest": "å°šæœªåœ¨æ•™æä¸­å‡ºç°",
                "title_chart": "å„ç‰ˆæœ¬å¹´çº§åˆ†å¸ƒ", "title_list": "æ£€ç´¢ç»“æœåˆ—è¡¨",
                "th_no": "#", "th_term": "æŸ¥è¯¢è¯", "th_stage": "é˜¶æ®µ", "th_pub": "å‡ºç‰ˆç¤¾",
                "th_grade": "å¹´çº§", "th_sem": "å­¦æœŸ", "th_vol": "å†Œåˆ«", "th_unit": "è¯¾åˆ«", "th_content": "å†…å®¹",
                "label_goto": "è·³è‡³", "label_page": "é¡µ",
                "msg_no_data": "æ²¡æœ‰æ‰¾åˆ°ç›¸ç¬¦èµ„æ–™ã€‚", "msg_total_prefix": "æ€»å…±", "msg_total_suffix": "ç¬”èµ„æ–™",
                "mic_listening": "æ­£åœ¨è†å¬...", "mic_error": "æ— æ³•å¼€å¯éº¦å…‹é£", "mic_not_support": "æ­¤æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥",
                "msg_input_empty": "è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹",
                "msg_api_url_error": "è¯·å…ˆè®¾å®š GAS API ç½‘å€",
                "placeholder_text": "ä¾‹ï¼šæ‘©æ“¦åŠ›ã€å…‰åˆä½œç”¨ã€å…¨çƒæš–åŒ–...",
                "grade_suffix": "å¹´çº§"
            }
        };

        function getMsg(key) {
            const lang = document.getElementById("language-selector").value;
            const dict = translations[lang] || translations['zh-TW'];
            return dict[key] || translations['zh-TW'][key] || key;
        }

        function changeLanguage() {
            const lang = document.getElementById("language-selector").value;
            
            // 1. æ›´æ–°æ‰€æœ‰å¸¶æœ‰ data-i18n çš„å…ƒç´ 
            document.querySelectorAll("[data-i18n]").forEach(el => {
                const key = el.getAttribute("data-i18n");
                el.innerText = getMsg(key);
            });

            // 2. æ›´æ–° Placeholder
            document.getElementById('inputText').placeholder = getMsg('placeholder_text');

            // 3. æ›´æ–° Chart æ¨™ç±¤ (è‹¥åœ–è¡¨å­˜åœ¨)
            if (gradeChartInstance) {
                const suffix = getMsg('grade_suffix');
                const grades = ['3','4','5','6','7','8','9'];
                // è‹±æ–‡ç‰ˆè¦æŠŠæ•¸å­—æ”¾å¾Œé¢? é€™è£¡ç°¡å–®è™•ç†çµ±ä¸€æ ¼å¼ï¼Œè‹¥è¦ç²¾ç´°å¯å†åˆ¤æ–·
                // ç›®å‰è¨­å®š: zh/ja: "3å¹´ç´š", en: "3 Grade" (å¯æ¥å—)
                gradeChartInstance.data.labels = grades.map(g => g + suffix);
                gradeChartInstance.update();
            }
        }

        // *** Canvas èƒŒæ™¯ ***
        (function() {
            const canvas = document.getElementById('network-canvas');
            const ctx = canvas.getContext('2d');
            let width, height, particles = [];
            function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; initParticles(); }
            class Particle {
                constructor() {
                    this.x = Math.random() * width; this.y = Math.random() * height;
                    this.vx = (Math.random() - 0.5) * 0.5; this.vy = (Math.random() - 0.5) * 0.5;
                    this.size = Math.random() * 2 + 1;
                    this.color = `rgba(168, 85, 247, ${Math.random() * 0.4})`;
                }
                update() { this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>width)this.vx*=-1; if(this.y<0||this.y>height)this.vy*=-1; }
                draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fillStyle=this.color; ctx.fill(); }
            }
            function initParticles() { particles=[]; for(let i=0;i<40;i++) particles.push(new Particle()); }
            function animate() {
                ctx.clearRect(0, 0, width, height);
                particles.forEach(p => { p.update(); p.draw(); });
                for(let i=0;i<particles.length;i++){
                    for(let j=i;j<particles.length;j++){
                        const dx = particles[i].x - particles[j].x; const dy = particles[i].y - particles[j].y;
                        const dist = Math.sqrt(dx*dx+dy*dy);
                        if(dist<150){ ctx.beginPath(); ctx.strokeStyle=`rgba(168,85,247,${0.1-dist/1500})`; ctx.lineWidth=0.5; ctx.moveTo(particles[i].x,particles[i].y); ctx.lineTo(particles[j].x,particles[j].y); ctx.stroke(); }
                    }
                }
                requestAnimationFrame(animate);
            }
            window.addEventListener('resize', resize); resize(); animate();
        })();

        // *** æ ¸å¿ƒé‚è¼¯ ***
        const $ = id => document.getElementById(id);
        // ğŸŸ¡ ä¿®æ”¹é è¨­å€¼ç‚º 'å…¨éƒ¨'
        let currentQueryText = '', currentStageFilter = 'å…¨éƒ¨', currentPageSize = 20, currentPage = 1, currentContextRange = 0, totalPagesCache = 1;
        let gradeChartInstance = null;

        // Enter éµæŸ¥è©¢
        $('inputText').addEventListener('keydown', (e) => {
            if (e.isComposing || e.keyCode === 229) return;
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); $('searchBtn').click(); }
        });

        // èªéŸ³è¼¸å…¥
        (function(){
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const voiceBtn = $('voiceBtn'), voiceHint = $('voiceHint'), inputEl = $('inputText');
            if (!SpeechRecognition) { voiceBtn.style.display='none'; return; }
            
            const rec = new SpeechRecognition();
            rec.lang = 'zh-TW'; rec.continuous = false; rec.interimResults = true;
            let listening = false;

            voiceBtn.addEventListener('click', () => {
                if(!listening) { rec.start(); listening = true; voiceBtn.classList.add('mic-active'); voiceHint.innerText = getMsg('mic_listening'); }
                else { rec.stop(); listening = false; voiceBtn.classList.remove('mic-active'); voiceHint.innerText = ''; }
            });
            rec.onresult = (e) => {
                const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
                inputEl.value = transcript;
            };
            rec.onend = () => { listening = false; voiceBtn.classList.remove('mic-active'); voiceHint.innerText = ''; };
        })();

        $('searchBtn').addEventListener('click', () => {
            currentQueryText = $('inputText').value;
            currentStageFilter = $('stageFilter').value;
            currentPageSize = Number($('pageSizeSelect').value);
            currentContextRange = Number($('contextRangeSelect').value);
            currentPage = 1;
            runSearch();
        });

        $('gotoPageBtn').addEventListener('click', () => {
            const wantPage = Number($('gotoPageInput').value);
            if (wantPage >= 1 && wantPage <= totalPagesCache) { currentPage = wantPage; runSearch(); }
        });
        $('prevPageBtn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; runSearch(); } });
        $('nextPageBtn').addEventListener('click', () => { if (currentPage < totalPagesCache) { currentPage++; runSearch(); } });

        // ğŸ”µ ä¿®æ­£ï¼šæ”¹ç”¨ fetch å‘¼å« GAS API
        async function runSearch(){
            if(!currentQueryText.trim()) { showToast(getMsg('msg_input_empty'), 'error'); return; }
            
            if (!GAS_API_URL || GAS_API_URL.includes("åœ¨æ­¤å¡«å…¥")) {
                showToast(getMsg('msg_api_url_error'), 'error');
                return;
            }

            const loading = $('search-loading');
            const statusMsg = $('statusMsg');
            loading.classList.remove('hidden');
            statusMsg.innerText = '';
            $('result-panel').classList.add('hidden'); // Hide old results

            // æº–å‚™è³‡æ–™
            const payload = {
                text: currentQueryText,
                stage: currentStageFilter,
                pageSize: currentPageSize,
                page: currentPage,
                context: currentContextRange
            };

            try {
                // ç™¼é€ POST è«‹æ±‚
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // é¿å… CORS é æª¢
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);

                showResults(data);

            } catch (err) {
                console.error(err);
                loading.classList.add('hidden');
                statusMsg.innerHTML = `<span class="text-red-500">Error: ${err.message}</span>`;
            }
        }

        function showResults(payload){
            $('search-loading').classList.add('hidden');
            
            if (!payload || !payload.rows || payload.rows.length === 0) {
                $('statusMsg').innerText = getMsg('msg_no_data');
                return;
            }

            $('result-panel').classList.remove('hidden');
            setTimeout(() => { $('result-panel').scrollIntoView({behavior:'smooth', block:'start'}); }, 100);

            const { rows, total, page, totalPages } = payload;
            totalPagesCache = totalPages;
            
            $('statusMsg').innerHTML = `<span class="text-purple-600 font-bold">${getMsg('msg_total_prefix')} ${total} ${getMsg('msg_total_suffix')}</span>`;
            $('pagerInfo').innerText = `${page} / ${totalPages}`;
            $('gotoPageInput').max = totalPages; $('gotoPageInput').value = page;
            $('prevPageBtn').disabled = page <= 1;
            $('nextPageBtn').disabled = page >= totalPages;

            // Insight Card
            const infoBox = $('earliestInfo');
            const contentBox = $('earliestInfoContent');
            if(payload.earliest && payload.earliest.results && payload.earliest.results.length > 0) {
                infoBox.classList.remove('hidden');
                // å‹•æ…‹ç¿»è­¯æ¨™é¡Œ (é›–ç„¶ä¸Šé¢æœ‰éœæ…‹ç¿»è­¯ï¼Œä½†é€™è£¡é‡æ–°è³¦å€¼ç¢ºä¿æ­£ç¢º)
                let html = `<p class="mb-1"><strong class="text-purple-600">ã€Œ${currentQueryText}ã€</strong> ${getMsg('title_earliest')}:</p>`;
                payload.earliest.results.forEach(section => {
                   const items = [...new Set((section.items||[]).map(x => `${x.publisher}${x.grade}${x.semester}ç¬¬${x.unit}å–®å…ƒ`))].join('ã€');
                   html += `<div class="ml-2 mb-1"><span class="font-bold text-slate-700">${section.stage}:</span> ${items}</div>`;
                });
                contentBox.innerHTML = html;
            } else {
                infoBox.classList.add('hidden');
            }

            // Table
            const tbody = $('resultBody');
            tbody.innerHTML = rows.map((r, i) => `
                <tr class="hover:bg-purple-50/50 transition">
                    <td class="font-mono text-slate-400">${(page-1)*currentPageSize + i + 1}</td>
                    <td class="font-bold text-purple-700">${r.term}</td>
                    <td>${r.stage}</td>
                    <td><span class="px-2 py-0.5 bg-slate-100 rounded text-xs">${r.publisher}</span></td>
                    <td>${r.grade}</td>
                    <td>${r.semester}</td>
                    <td>${r.volume}</td>
                    <td>${r.unit}</td>
                    <td class="td-content">${r.sentenceHtml}</td>
                </tr>
            `).join('');

            renderGradeChart(payload.counts);
        }

        function renderGradeChart(counts){
            const canvas = $('gradeChart');
            if (gradeChartInstance) { gradeChartInstance.destroy(); }
            if (!counts) return;

            const grades = ['3','4','5','6','7','8','9'];
            // å–å¾—ç›®å‰çš„å¹´ç´šå¾Œç¶´ç¿»è­¯
            const suffix = getMsg('grade_suffix');
            
            const pubs = ['å—ä¸€','åº·è»’','ç¿°æ—'];
            const colors = { 'å—ä¸€': '#3b82f6', 'åº·è»’': '#f97316', 'ç¿°æ—': '#22c55e' }; 
            
            const datasets = pubs.map(p => ({
                label: p,
                data: grades.map(g => (counts[p]||{})[g] || 0),
                borderColor: colors[p],
                backgroundColor: colors[p]+'20', 
                borderWidth: 3,
                tension: 0.3,
                pointRadius: 4,
                pointBackgroundColor: '#fff',
                pointBorderWidth: 2
            }));

            const ctx = canvas.getContext('2d');
            gradeChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: grades.map(g => g + suffix), datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function showToast(msg, type='normal') {
            const toast = $('toast');
            $('toast-msg').innerText = msg;
            toast.querySelector('i').className = type === 'error' ? 'fa-solid fa-triangle-exclamation text-red-400' : 'fa-solid fa-check-circle text-green-400';
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
        }
    </script>
</body>
</html>
