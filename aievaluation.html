<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>CAT 自適性測驗 | AI 出題與作答</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { student: '#3b82f6' },
          animation: { "fade-in-up": "fadeInUp 0.5s ease-out forwards" },
          keyframes: { fadeInUp: { "0%": { opacity: "0", transform: "translateY(20px)" }, "100%": { opacity: "1", transform: "translateY(0)" } } }
        }
      }
    };
  </script>

  <style>
    body {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      font-family: "Microsoft JhengHei", sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    .glass-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.7);
      box-shadow: 0 4px 6px rgba(0,0,0,0.08);
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    .option-btn { transition: all 0.18s ease; }
  </style>
</head>

<body class="text-slate-800 min-h-screen flex flex-col">

  <nav class="glass-panel sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
    <div class="flex items-center gap-4">
      <a href="student.html" class="group flex items-center gap-2 text-slate-500 hover:text-blue-600 transition decoration-0">
        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow group-hover:shadow-md transition">
          <i class="fa-solid fa-arrow-left"></i>
        </div>
        <span class="font-bold hidden md:block">返回學習中心</span>
      </a>
      <div class="h-8 w-px bg-slate-300 mx-2 hidden sm:block"></div>
      <div class="hidden sm:block">
        <h1 class="font-bold text-lg">CAT 自適性測驗</h1>
        <p class="text-xs text-slate-500">教材參數設定 → AI 出題 → 作答 → 自適應下一題</p>
      </div>
    </div>
    <div class="flex items-center gap-2 pl-2 border-l border-slate-300">
      <div id="user-info" class="text-sm font-bold text-blue-600">訪客</div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-8 flex-1 w-full pb-24">

    <!-- 教材參數設定 -->
    <div id="selection-panel" class="glass-panel rounded-2xl p-6 mb-8 no-print">
      <div class="flex justify-between items-center mb-4">
        <h2 class="font-bold text-lg flex items-center gap-2">
          <i class="fa-solid fa-database"></i>
          <span>教材參數設定</span>
        </h2>
        <span id="db-status" class="text-xs font-bold text-orange-500">
          <i class="fa-solid fa-circle-notch fa-spin"></i> Loading...
        </span>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
        <div>
          <label class="text-xs font-bold text-slate-500 ml-1">學習階段</label>
          <select id="sel-stage" class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500">
            <option value="" disabled selected>Loading...</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 ml-1">版本</label>
          <select id="sel-publisher" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50">
            <option value="" disabled selected>Select...</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 ml-1">年級</label>
          <select id="sel-grade" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50">
            <option value="" disabled selected>Select...</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 ml-1">學期</label>
          <select id="sel-semester" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50">
            <option value="" disabled selected>Select...</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 ml-1">單元名稱</label>
          <select id="sel-unit" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50">
            <option value="" disabled selected>Select...</option>
          </select>
        </div>
      </div>

      <!-- 框架偏好：PISA / TIMSS / TOEFL -->
      <div class="mt-5 grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div class="font-bold text-slate-700">PISA 優點</div>
            <label class="inline-flex items-center cursor-pointer">
              <input id="fw-pisa" type="checkbox" class="sr-only peer" checked>
              <div class="w-11 h-6 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-600 relative after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:h-5 after:w-5 after:rounded-full after:transition-all peer-checked:after:translate-x-5"></div>
            </label>
          </div>
          <div class="text-xs text-slate-500 mt-2">強調情境化題幹、真實問題脈絡與素養導向題組。</div>
        </div>

        <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div class="font-bold text-slate-700">TIMSS 優點</div>
            <label class="inline-flex items-center cursor-pointer">
              <input id="fw-timss" type="checkbox" class="sr-only peer" checked>
              <div class="w-11 h-6 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-600 relative after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:h-5 after:w-5 after:rounded-full after:transition-all peer-checked:after:translate-x-5"></div>
            </label>
          </div>
          <div class="text-xs text-slate-500 mt-2">強調知識向度×認知歷程（知道/應用/推理）的題目結構。</div>
        </div>

        <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div class="font-bold text-slate-700">TOEFL 優點</div>
            <label class="inline-flex items-center cursor-pointer">
              <input id="fw-toefl" type="checkbox" class="sr-only peer" checked>
              <div class="w-11 h-6 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:bg-blue-600 relative after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:h-5 after:w-5 after:rounded-full after:transition-all peer-checked:after:translate-x-5"></div>
            </label>
          </div>
          <div class="text-xs text-slate-500 mt-2">強調計時、穩定的自適應測驗流程與一致的作答體驗。</div>
        </div>
      </div>

      <!-- CAT 參數（最小必要：題數、是否計時） -->
      <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="text-xs font-bold text-slate-500 ml-1">目標題數</label>
          <input id="cat-target-n" type="number" min="5" max="30" value="10"
            class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500 bg-white">
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 ml-1">最多題數（上限）</label>
          <input id="cat-max-n" type="number" min="5" max="50" value="15"
            class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500 bg-white">
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 ml-1">是否計時</label>
          <select id="cat-timer-on" class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500 bg-white">
            <option value="1" selected>是</option>
            <option value="0">否</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 ml-1">每題秒數（計時用）</label>
          <input id="cat-seconds-per-item" type="number" min="10" max="300" value="45"
            class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500 bg-white">
        </div>
      </div>

      <div class="mt-6 flex justify-end gap-3">
        <button id="btn-reload" type="button"
          class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-6 py-3 rounded-xl font-bold transition cursor-pointer border border-slate-200 shadow-sm flex items-center active:scale-95"
          onclick="reloadMetadata()">
          <i class="fa-solid fa-rotate mr-2"></i> 重新載入資料庫
        </button>

        <button id="btn-start-cat" type="button" disabled
          class="bg-emerald-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2 active:scale-95"
          onclick="startCAT()">
          <i class="fa-solid fa-play"></i> 開始出題（CAT）
        </button>
      </div>

      <div class="mt-4 text-xs text-slate-500">
        提示：這頁只要 GAS 的 <code>action=get_metadata</code> 回傳成功，即可正常帶出下拉選單。開始出題後，會呼叫後端 <code>generate_exam</code>（可在程式最上方改 action 名稱）。
      </div>
    </div>

    <!-- Loading -->
    <div id="loading-view" class="hidden flex-col items-center justify-center py-20">
      <div class="loader mb-4"></div>
      <h3 class="text-xl font-bold text-slate-700">CAT 出題中...</h3>
      <p class="text-sm text-slate-500 mt-2">正在向後端取得第一題（或題組）</p>
    </div>

    <!-- CAT 測驗區 -->
    <div id="cat-view" class="hidden animate-fade-in-up">
      <div class="glass-panel rounded-2xl p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <div id="cat-tag" class="text-xs font-bold bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full inline-block">CAT</div>
            <div id="cat-title" class="text-2xl font-black text-slate-800 mt-2">—</div>
          </div>
          <div class="flex items-center gap-2">
            <div id="cat-progress" class="text-xs font-bold text-emerald-700 bg-emerald-100 px-3 py-1 rounded-full">第 0 題／共 0 題</div>
            <div id="cat-timer" class="text-xs font-bold text-slate-600 bg-slate-100 px-3 py-1 rounded-full hidden">
              <i class="fa-solid fa-clock mr-1"></i><span id="cat-timer-text">—</span>
            </div>
            <button type="button"
              class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-xl font-bold border border-slate-200"
              onclick="backToSelection()">
              返回設定
            </button>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
          <div class="lg:col-span-2">
            <!-- 刺激材料 / 情境（PISA 常用） -->
            <div id="cat-stimulus-box" class="hidden bg-slate-50 border border-slate-200 rounded-2xl p-4 mb-4">
              <div class="text-xs font-bold text-slate-500 mb-2">閱讀材料 / 情境</div>
              <div id="cat-stimulus" class="text-sm text-slate-700 leading-relaxed whitespace-pre-line"></div>
            </div>

            <div class="bg-white border border-slate-200 rounded-2xl p-5">
              <div id="cat-question-meta" class="text-xs text-slate-500 mb-2">—</div>
              <div id="cat-question" class="text-base md:text-lg font-bold text-slate-800 leading-relaxed">—</div>
              <div id="cat-options" class="mt-4 space-y-2"></div>

              <div id="cat-feedback" class="mt-4 hidden text-sm rounded-xl px-3 py-2"></div>

              <div class="mt-5 flex justify-end gap-2">
                <button id="btn-next" type="button" disabled
                  class="text-sm px-5 py-2.5 rounded-xl bg-emerald-600 text-white font-bold shadow hover:bg-emerald-700 disabled:opacity-40 disabled:cursor-not-allowed"
                  onclick="goNext()">
                  下一題
                </button>
              </div>
            </div>
          </div>

          <!-- 右側：作答狀態 -->
          <div class="bg-white border border-slate-200 rounded-2xl p-5">
            <div class="font-bold text-slate-700 mb-2">測驗狀態</div>
            <div class="text-sm text-slate-600 leading-relaxed space-y-2">
              <div>測驗編號：<span id="cat-test-id" class="font-semibold">—</span></div>
              <div>目前能力值 θ：<span id="cat-theta" class="font-semibold">—</span></div>
              <div>停止規則：<span id="cat-stop-rule" class="font-semibold">目標題數 / 最大題數</span></div>
            </div>

            <div class="mt-4 border-t border-slate-100 pt-4">
              <div class="text-xs font-bold text-slate-500 mb-2">框架偏好（已送後端）</div>
              <div id="cat-fw-badges" class="flex flex-wrap gap-2"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 結果區 -->
      <div id="cat-result" class="hidden glass-panel rounded-2xl p-6 mt-6">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs font-bold text-slate-500">測驗完成</div>
            <div id="cat-result-title" class="text-2xl font-black text-slate-800 mt-1">—</div>
          </div>
          <button type="button"
            class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-6 py-3 rounded-xl font-bold border border-slate-200"
            onclick="reloadPageHard()">
            重新開始
          </button>
        </div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-white border border-slate-200 rounded-2xl p-4">
            <div class="text-xs font-bold text-slate-500">得分</div>
            <div id="cat-score" class="text-3xl font-black text-emerald-700 mt-1">—</div>
          </div>
          <div class="bg-white border border-slate-200 rounded-2xl p-4">
            <div class="text-xs font-bold text-slate-500">能力值 θ（若後端提供）</div>
            <div id="cat-score-theta" class="text-3xl font-black text-slate-800 mt-1">—</div>
          </div>
          <div class="bg-white border border-slate-200 rounded-2xl p-4">
            <div class="text-xs font-bold text-slate-500">作答題數</div>
            <div id="cat-score-n" class="text-3xl font-black text-slate-800 mt-1">—</div>
          </div>
        </div>

        <div class="mt-5 bg-white border border-slate-200 rounded-2xl p-4">
          <div class="text-sm font-bold text-slate-700 mb-2">後端回饋 / 診斷（原樣顯示）</div>
          <pre id="cat-result-raw" class="text-xs bg-slate-50 border border-slate-200 rounded-xl p-3 overflow-auto max-h-[40vh] whitespace-pre-wrap">—</pre>
        </div>
      </div>
    </div>

  </main>

  <script>
    // ========= 你只需要檢查這三個常數 =========
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxBWrZCp-xLckDGZnhe64K0IUa_8CJZRzqZbrgL8lQdNn3S1WgaEzbdOtpo4mGwN6_H/exec";

    // 後端出題/作答 action（若你的後端名稱不同，只改這兩行）
    const ACTION_START  = "generate_exam"; // 開始出題（CAT）
    const ACTION_SUBMIT = "submit_exam";   // 送出作答 / 取下一題（CAT）
    // ========================================

    let allData = [];
    let filters = {};

    // CAT session state
    let catSession = {
      test_id: "",
      current_item: null,
      current_index: 0,
      target_n: 10,
      max_n: 15,
      timer_on: true,
      seconds_per_item: 45,
      frameworks: { pisa: true, timss: true, toefl: true },
      theta: null,
      answers: [],
      items_cache: null,   // 若後端一次回傳 items array，也能跑
      finished: false
    };

    let timerHandle = null;
    let timerRemain = 0;

    // ---------- 工具 ----------
    function safeJsonParse(text) {
      try { return JSON.parse(text); } catch(e) { return null; }
    }

    function getCurrentUser() {
      return JSON.parse(sessionStorage.getItem("currentUser") || localStorage.getItem("currentUser") || '{"name":"訪客"}');
    }

    function setDBStatusSuccess(n) {
      const dbStatus = document.getElementById("db-status");
      if (!dbStatus) return;
      dbStatus.innerHTML = `<i class="fa-solid fa-check"></i> 資料庫連線成功（${n}筆）`;
      dbStatus.className = "text-xs font-bold text-green-600";
    }

    function setDBStatusFail() {
      const dbStatus = document.getElementById("db-status");
      if (!dbStatus) return;
      dbStatus.innerText = "連線失敗";
      dbStatus.className = "text-xs font-bold text-red-500";
    }

    function setDBStatusLoading() {
      const dbStatus = document.getElementById("db-status");
      if (!dbStatus) return;
      dbStatus.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Loading...`;
      dbStatus.className = "text-xs font-bold text-orange-500";
    }

    function normalizeItem(raw) {
      if (!raw || typeof raw !== "object") return null;

      const stem =
        raw.stem || raw.question || raw.text || raw.item_stem || raw.prompt || "";

      const stimulus =
        raw.stimulus || raw.passage || raw.context || raw.reading || "";

      // 你的 CATItemBank 欄位是 option_A~D
      const A = raw.option_A ?? raw.A ?? raw.choiceA ?? raw.optionA ?? "";
      const B = raw.option_B ?? raw.B ?? raw.choiceB ?? raw.optionB ?? "";
      const C = raw.option_C ?? raw.C ?? raw.choiceC ?? raw.optionC ?? "";
      const D = raw.option_D ?? raw.D ?? raw.choiceD ?? raw.optionD ?? "";

      const options = [A, B, C, D].map(x => (x === null || typeof x === "undefined") ? "" : String(x));

      return {
        item_id: raw.item_id || raw.id || raw.itemId || raw.itemID || "",
        concept_tag: raw.concept_tag || raw.concept || raw.topic || "",
        cognitive_level: raw.cogntive_level || raw.cognitive_level || raw.level || "",
        difficulty: raw.IRT_b ?? raw.b ?? raw.difficulty ?? "",
        stem: String(stem || "").trim(),
        stimulus: String(stimulus || "").trim(),
        options: options,
      };
    }

    function renderFrameworkBadges() {
      const box = document.getElementById("cat-fw-badges");
      if (!box) return;
      box.innerHTML = "";

      const mk = (label) => {
        const span = document.createElement("span");
        span.className = "text-xs font-bold px-2.5 py-1 rounded-full bg-slate-100 text-slate-700 border border-slate-200";
        span.textContent = label;
        return span;
      };

      if (catSession.frameworks.pisa)  box.appendChild(mk("PISA"));
      if (catSession.frameworks.timss) box.appendChild(mk("TIMSS"));
      if (catSession.frameworks.toefl) box.appendChild(mk("TOEFL"));

      if (!catSession.frameworks.pisa && !catSession.frameworks.timss && !catSession.frameworks.toefl) {
        box.appendChild(mk("未指定框架（一般題型）"));
      }
    }

    function setTitleFromFilters() {
      const sem = (filters.semester === "上") ? "上學期" : (filters.semester === "下") ? "下學期" : (filters.semester || "");
      const title = `${filters.stage || ""}｜${filters.publisher || ""}｜${filters.grade || ""}年級｜${sem}｜${filters.unitName || ""}`;
      const el = document.getElementById("cat-title");
      if (el) el.textContent = title;
    }

    function updateProgress() {
      const el = document.getElementById("cat-progress");
      if (!el) return;
      el.textContent = `第 ${catSession.current_index} 題／目標 ${catSession.target_n} 題（上限 ${catSession.max_n} 題）`;
    }

    function stopTimer() {
      if (timerHandle) {
        clearInterval(timerHandle);
        timerHandle = null;
      }
    }

    function startTimer(seconds) {
      stopTimer();
      timerRemain = seconds;

      const box = document.getElementById("cat-timer");
      const txt = document.getElementById("cat-timer-text");
      if (box && txt) {
        box.classList.remove("hidden");
        txt.textContent = `${timerRemain}s`;
      }

      timerHandle = setInterval(() => {
        timerRemain -= 1;
        if (txt) txt.textContent = `${timerRemain}s`;

        if (timerRemain <= 0) {
          stopTimer();
          // 超時：自動送出空白（由後端決定怎麼處理，例如視為未作答/錯）
          autoTimeoutSubmit();
        }
      }, 1000);
    }

    async function autoTimeoutSubmit() {
      // 若已經作答過，就不動
      const btnNext = document.getElementById("btn-next");
      if (btnNext && !btnNext.disabled) return;

      // 視為未作答：送 response_option = ""
      try {
        await submitAnswer("");
      } catch (e) {
        alert("計時到，但送出作答失敗：" + e.message);
      }
    }

    // ---------- 這段是你「成功載入資料庫」那份 HTML 的核心（完整保留） ----------
    window.onload = async () => {
      const user = getCurrentUser();
      const userInfo = document.getElementById("user-info");
      if (userInfo) userInfo.innerText = user.name;

      setDBStatusLoading();

      try {
        const res = await fetch(GAS_API_URL + "?action=get_metadata&ts=" + Date.now());
        if (!res.ok) throw new Error(`伺服器 HTTP 錯誤: ${res.status}`);

        const text = await res.text();
        const json = safeJsonParse(text);
        if (!json) {
          console.error("JSON 解析失敗的原始文本:", text);
          throw new Error("API 回應格式錯誤（非 JSON）。");
        }

        if (json.status === "success") {
          allData = json.data || [];
          setDBStatusSuccess(allData.length);
          initSelectors();
        } else {
          throw new Error(json.message || "API 回應狀態非成功");
        }
      } catch (e) {
        console.error("載入元數據失敗:", e);
        setDBStatusFail();
        const selStageAgain = document.getElementById("sel-stage");
        if (selStageAgain) {
          selStageAgain.innerHTML = '<option value="" disabled selected>連線失敗，請重試...</option>';
          selStageAgain.disabled = true;
        }
        alert(`無法載入資料庫！\n錯誤訊息: ${e.message}`);
      }
    };

    function reloadMetadata() {
      location.reload();
    }

    function initSelectors() {
      const stages = [...new Set(allData.map(d => d.stage))];
      populate("sel-stage", stages);

      const selStage = document.getElementById("sel-stage");
      const selPublisher = document.getElementById("sel-publisher");
      const selGrade = document.getElementById("sel-grade");
      const selSemester = document.getElementById("sel-semester");
      const selUnit = document.getElementById("sel-unit");

      if (selStage) selStage.onchange = (e) => updateLevel(1, e.target.value);
      if (selPublisher) selPublisher.onchange = (e) => updateLevel(2, e.target.value);
      if (selGrade) selGrade.onchange = (e) => updateLevel(3, e.target.value);
      if (selSemester) selSemester.onchange = (e) => updateLevel(4, e.target.value);
      if (selUnit) selUnit.onchange = (e) => {
        filters.unitName = e.target.value;
        const btn = document.getElementById("btn-start-cat");
        if (btn) btn.disabled = false;
      };
    }

    function updateLevel(level, value) {
      if (level === 1) filters = { stage: value };
      if (level === 2) { filters.publisher = value; delete filters.grade; delete filters.semester; delete filters.unitName; }
      if (level === 3) { filters.grade = value; delete filters.semester; delete filters.unitName; }
      if (level === 4) { filters.semester = value; delete filters.unitName; }

      const ids = ["sel-publisher", "sel-grade", "sel-semester", "sel-unit"];
      for (let i = level; i < 4; i++) {
        const el = document.getElementById(ids[i]);
        if (el) {
          el.innerHTML = '<option disabled selected>Select...</option>';
          el.disabled = true;
        }
      }

      const btn = document.getElementById("btn-start-cat");
      if (btn) btn.disabled = true;

      const relevantData = allData.filter(d => {
        const safeMatch = (dVal, fVal) => !fVal || String(dVal).trim() == String(fVal).trim();
        return safeMatch(d.stage, filters.stage) &&
               safeMatch(d.publisher, filters.publisher) &&
               safeMatch(d.grade, filters.grade) &&
               safeMatch(d.semester, filters.semester);
      });

      if (level === 1) populate("sel-publisher", [...new Set(relevantData.map(d => d.publisher))]);
      if (level === 2) populate("sel-grade", [...new Set(relevantData.map(d => d.grade))].sort((a, b) => a - b), "grade");
      if (level === 3) populate("sel-semester", [...new Set(relevantData.map(d => d.semester))], "semester");

      if (level === 4) {
        const unitSelect = document.getElementById("sel-unit");
        if (!unitSelect) return;
        unitSelect.innerHTML = '<option disabled selected>Select...</option>';
        if (relevantData.length > 0) {
          relevantData.forEach(d => {
            const opt = document.createElement("option");
            opt.value = d.unitName;
            opt.text = (d.unitType && !isNaN(d.unitType)) ? `第${d.unitType}課 ${d.unitName}` : d.unitName;
            unitSelect.add(opt);
          });
          unitSelect.disabled = false;
        }
      }
    }

    function populate(id, list, type) {
      const el = document.getElementById(id);
      if (!el) return;
      el.innerHTML = '<option disabled selected>Select...</option>';
      list.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o;
        if (type === "grade") opt.text = o + "年級";
        else if (type === "semester") opt.text = (o === "上" ? "上學期" : (o === "下" ? "下學期" : o));
        else opt.text = o;
        el.add(opt);
      });
      el.disabled = false;
    }
    // ----------（以上：資料庫載入與五層連動 完整保留）----------


    // ========== CAT：開始出題 ==========
    async function startCAT() {
      const selPanel = document.getElementById("selection-panel");
      const loading = document.getElementById("loading-view");
      const catView = document.getElementById("cat-view");

      if (selPanel) selPanel.classList.add("hidden");
      if (loading) { loading.classList.remove("hidden"); loading.classList.add("flex"); }
      if (catView) catView.classList.add("hidden");

      // 讀取框架偏好與 CAT 參數
      catSession.frameworks = {
        pisa:  !!document.getElementById("fw-pisa")?.checked,
        timss: !!document.getElementById("fw-timss")?.checked,
        toefl: !!document.getElementById("fw-toefl")?.checked
      };
      catSession.target_n = Math.max(5, Math.min(30, Number(document.getElementById("cat-target-n")?.value || 10)));
      catSession.max_n = Math.max(catSession.target_n, Math.min(50, Number(document.getElementById("cat-max-n")?.value || 15)));
      catSession.timer_on = (document.getElementById("cat-timer-on")?.value || "1") === "1";
      catSession.seconds_per_item = Math.max(10, Math.min(300, Number(document.getElementById("cat-seconds-per-item")?.value || 45)));

      // reset session
      catSession.test_id = "";
      catSession.current_item = null;
      catSession.current_index = 0;
      catSession.theta = null;
      catSession.answers = [];
      catSession.items_cache = null;
      catSession.finished = false;
      stopTimer();

      // UI init
      setTitleFromFilters();
      renderFrameworkBadges();
      const testIdEl = document.getElementById("cat-test-id");
      if (testIdEl) testIdEl.textContent = "—";
      const thetaEl = document.getElementById("cat-theta");
      if (thetaEl) thetaEl.textContent = "—";

      try {
        const user = getCurrentUser();

        const payload = {
          action: ACTION_START,
          mode: "CAT",
          filters: filters,
          cat: {
            target_n: catSession.target_n,
            max_n: catSession.max_n,
            timer_on: catSession.timer_on ? 1 : 0,
            seconds_per_item: catSession.seconds_per_item,
            frameworks: catSession.frameworks
          },
          user: {
            name: user.name || "訪客",
            student_id: user.student_id || user.StudentID || user.id || ""
          }
        };

        const res = await fetch(GAS_API_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(`HTTP 錯誤! 狀態碼: ${res.status}`);

        const text = await res.text();
        const json = safeJsonParse(text);

        if (!json) {
          console.error("非 JSON 回應：", text);
          throw new Error("後端回傳非 JSON（請檢查 Apps Script ContentService 回傳）。");
        }

        if (json.status !== "success") {
          throw new Error(json.message || "後端回應失敗");
        }

        // 相容多種後端格式：data.items（一次回題組）或 data.item（一次回一題）
        const data = json.data || {};
        catSession.test_id = data.test_id || data.testId || data.testID || "";

        const testId2 = document.getElementById("cat-test-id");
        if (testId2) testId2.textContent = catSession.test_id || "（未提供）";

        catSession.theta = (typeof data.theta !== "undefined") ? data.theta : null;
        const theta2 = document.getElementById("cat-theta");
        if (theta2) theta2.textContent = (catSession.theta === null || typeof catSession.theta === "undefined") ? "—" : String(catSession.theta);

        if (Array.isArray(data.items) && data.items.length > 0) {
          catSession.items_cache = data.items.map(normalizeItem).filter(Boolean);
          catSession.current_index = 1;
          catSession.current_item = catSession.items_cache[0];
        } else {
          const itemRaw = data.item || data.current_item || data.currentItem || data.question || null;
          const item = normalizeItem(itemRaw);
          if (!item) throw new Error("後端未提供第一題（item/items）。");
          catSession.current_index = 1;
          catSession.current_item = item;
        }

        // show cat view
        if (loading) { loading.classList.add("hidden"); loading.classList.remove("flex"); }
        if (catView) catView.classList.remove("hidden");

        updateProgress();
        renderCurrentItem();

      } catch (e) {
        console.error(e);
        if (loading) { loading.classList.add("hidden"); loading.classList.remove("flex"); }
        if (selPanel) selPanel.classList.remove("hidden");
        alert("開始出題失敗：\n" + e.message);
      }
    }

    function renderCurrentItem() {
      const item = catSession.current_item;
      if (!item) return;

      // meta
      const meta = [];
      if (item.item_id) meta.push(`題號：${item.item_id}`);
      if (item.concept_tag) meta.push(`概念：${item.concept_tag}`);
      if (item.cognitive_level) meta.push(`認知層次：${item.cognitive_level}`);
      if (item.difficulty !== "" && item.difficulty !== null && typeof item.difficulty !== "undefined") meta.push(`難度(b)：${item.difficulty}`);

      const metaEl = document.getElementById("cat-question-meta");
      if (metaEl) metaEl.textContent = meta.length ? meta.join("｜") : "—";

      // stimulus
      const stimBox = document.getElementById("cat-stimulus-box");
      const stimEl = document.getElementById("cat-stimulus");
      if (item.stimulus) {
        if (stimEl) stimEl.textContent = item.stimulus;
        if (stimBox) stimBox.classList.remove("hidden");
      } else {
        if (stimEl) stimEl.textContent = "";
        if (stimBox) stimBox.classList.add("hidden");
      }

      // question
      const qEl = document.getElementById("cat-question");
      if (qEl) qEl.textContent = item.stem || "（題幹空白）";

      // options
      const optEl = document.getElementById("cat-options");
      if (optEl) optEl.innerHTML = "";

      const feedback = document.getElementById("cat-feedback");
      if (feedback) {
        feedback.classList.add("hidden");
        feedback.textContent = "";
        feedback.className = "mt-4 hidden text-sm rounded-xl px-3 py-2";
      }

      const btnNext = document.getElementById("btn-next");
      if (btnNext) btnNext.disabled = true;

      const letters = ["A", "B", "C", "D"];
      item.options.forEach((optText, idx) => {
        if (!optText) return;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "option-btn w-full text-left px-4 py-3 rounded-xl border border-slate-200 bg-white hover:bg-emerald-50 hover:border-emerald-300 text-slate-800";
        btn.innerHTML = `<span class="inline-flex items-center justify-center w-7 h-7 mr-2 rounded-full bg-emerald-50 text-emerald-700 text-xs font-bold">${letters[idx]}</span>${optText}`;
        btn.onclick = () => chooseOption(letters[idx], idx);
        optEl.appendChild(btn);
      });

      updateProgress();

      // timer
      if (catSession.timer_on) {
        startTimer(catSession.seconds_per_item);
      } else {
        stopTimer();
        const t = document.getElementById("cat-timer");
        if (t) t.classList.add("hidden");
      }
    }

    async function chooseOption(letter, index) {
      stopTimer();

      const optEl = document.getElementById("cat-options");
      const btns = optEl ? Array.from(optEl.querySelectorAll("button")) : [];
      btns.forEach(b => b.disabled = true);

      const item = catSession.current_item;
      const answer = {
        ts: new Date().toISOString(),
        test_id: catSession.test_id || "",
        item_id: item?.item_id || "",
        response_option: letter,
        response_index: index
      };
      catSession.answers.push(answer);

      // 立即送後端（CAT 要靠後端更新 θ、抽下一題）
      try {
        await submitAnswer(letter);
      } catch (e) {
        alert("送出作答失敗：\n" + e.message);
        // 允許使用者仍可按下一題（避免卡死）
        const btnNext = document.getElementById("btn-next");
        if (btnNext) btnNext.disabled = false;
      }
    }

    async function submitAnswer(letter) {
      const item = catSession.current_item;
      if (!item) throw new Error("目前沒有題目可送出");

      const user = getCurrentUser();

      const payload = {
        action: ACTION_SUBMIT,
        mode: "CAT",
        filters: filters,
        test_id: catSession.test_id || "",
        item_id: item.item_id || "",
        response_option: letter, // "A"/"B"/"C"/"D" 或 ""（超時未作答）
        user: {
          name: user.name || "訪客",
          student_id: user.student_id || user.StudentID || user.id || ""
        },
        cat: {
          target_n: catSession.target_n,
          max_n: catSession.max_n,
          frameworks: catSession.frameworks
        }
      };

      const res = await fetch(GAS_API_URL, {
        method: "POST",
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error(`HTTP 錯誤! 狀態碼: ${res.status}`);

      const text = await res.text();
      const json = safeJsonParse(text);
      if (!json) {
        console.error("非 JSON 回應：", text);
        throw new Error("後端回傳非 JSON。");
      }
      if (json.status !== "success") {
        throw new Error(json.message || "後端回應失敗");
      }

      const data = json.data || {};

      // 更新 theta（若後端有給）
      if (typeof data.theta !== "undefined") {
        catSession.theta = data.theta;
        const thetaEl = document.getElementById("cat-theta");
        if (thetaEl) thetaEl.textContent = String(catSession.theta);
      }

      // 後端可回 correctness / feedback（若你有做）
      const fb = document.getElementById("cat-feedback");
      if (fb && (data.feedback || data.correctness || typeof data.is_correct !== "undefined")) {
        const isCorrect = (data.is_correct === 1 || data.is_correct === "1" || data.isCorrect === true);
        fb.classList.remove("hidden");
        if (isCorrect) {
          fb.className = "mt-4 text-sm rounded-xl px-3 py-2 bg-emerald-50 border border-emerald-200 text-emerald-800";
          fb.innerHTML = `<div class="font-semibold text-emerald-700 mb-1">答對</div><div class="text-slate-700">${data.feedback || ""}</div>`;
        } else {
          fb.className = "mt-4 text-sm rounded-xl px-3 py-2 bg-orange-50 border border-orange-200 text-orange-800";
          fb.innerHTML = `<div class="font-semibold text-orange-600 mb-1">答錯</div><div class="text-slate-700">${data.feedback || ""}</div>`;
        }
      }

      // 決定下一題 / 結束
      if (data.finished === true || data.done === true || data.is_finished === 1 || data.next_item === null) {
        catSession.finished = true;
        showResult(json);
        return;
      }

      let nextItemRaw = data.next_item || data.item || data.current_item || data.currentItem || null;

      // 如果後端一次回 items，我們也能本地走（但仍建議後端回 next_item）
      if (!nextItemRaw && Array.isArray(data.items)) {
        catSession.items_cache = data.items.map(normalizeItem).filter(Boolean);
        nextItemRaw = catSession.items_cache[catSession.current_index]; // 下一題（index 從 0）
      }

      const nextItem = normalizeItem(nextItemRaw);
      if (!nextItem) {
        // 後端沒有給 next，允許使用者手動按「下一題」但會卡住；直接當作結束更安全
        showResult(json);
        return;
      }

      // 下一題準備好：開放按鈕「下一題」
      catSession._next_item_buffer = nextItem;

      const btnNext = document.getElementById("btn-next");
      if (btnNext) btnNext.disabled = false;
    }

    function goNext() {
      const next = catSession._next_item_buffer || null;
      if (!next) return;

      catSession.current_item = next;
      catSession.current_index += 1;
      catSession._next_item_buffer = null;

      renderCurrentItem();
    }

    function showResult(rawJson) {
      stopTimer();

      const catResult = document.getElementById("cat-result");
      if (catResult) catResult.classList.remove("hidden");

      const titleEl = document.getElementById("cat-result-title");
      if (titleEl) titleEl.textContent = (filters.unitName || "測驗") + "｜CAT 測驗完成";

      const nEl = document.getElementById("cat-score-n");
      if (nEl) nEl.textContent = String(catSession.answers.length);

      const thetaEl = document.getElementById("cat-score-theta");
      if (thetaEl) thetaEl.textContent = (catSession.theta === null || typeof catSession.theta === "undefined") ? "—" : String(catSession.theta);

      // score：若後端有給就用；沒有就顯示 —
      const scoreEl = document.getElementById("cat-score");
      const data = (rawJson && rawJson.data) ? rawJson.data : {};
      const scoreVal = data.score ?? data.total_score ?? data.percent ?? data.percentile ?? null;
      if (scoreEl) scoreEl.textContent = (scoreVal === null || typeof scoreVal === "undefined") ? "—" : String(scoreVal);

      const rawEl = document.getElementById("cat-result-raw");
      if (rawEl) rawEl.textContent = JSON.stringify(rawJson, null, 2);

      // 隱藏題目區（避免繼續作答）
      const btnNext = document.getElementById("btn-next");
      if (btnNext) btnNext.disabled = true;
    }

    function backToSelection() {
      stopTimer();
      const selPanel = document.getElementById("selection-panel");
      const catView = document.getElementById("cat-view");
      const loading = document.getElementById("loading-view");

      if (loading) { loading.classList.add("hidden"); loading.classList.remove("flex"); }
      if (catView) catView.classList.add("hidden");
      if (selPanel) selPanel.classList.remove("hidden");
    }

    function reloadPageHard() {
      location.reload();
    }
  </script>
</body>
</html>
