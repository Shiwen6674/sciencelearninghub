<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Science Learning Hub | CAT 評量</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

  <!-- Chart.js (for PISA-style chart stimulus) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg: #0b1220;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --muted2: rgba(255,255,255,.55);
      --good: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --brand: #10b981;
      --brand2:#34d399;
    }
    html,body{height:100%;}
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(16,185,129,.25), transparent 55%),
        radial-gradient(900px 600px at 90% 15%, rgba(59,130,246,.18), transparent 55%),
        radial-gradient(1100px 700px at 35% 95%, rgba(244,63,94,.12), transparent 60%),
        linear-gradient(180deg, #050914 0%, var(--bg) 60%, #070c18 100%);
      color: var(--text);
    }
    .serif{ font-family: "Noto Serif TC", serif; }
    .glass{
      background: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: 0 18px 45px rgba(0,0,0,.35);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .glass2{
      background: var(--card2);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .soft-ring:focus{
      outline: none;
      box-shadow: 0 0 0 4px rgba(16,185,129,.25);
      border-color: rgba(16,185,129,.55);
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:.55rem; border-radius: 14px;
      padding:.75rem 1rem;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.22); }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{
      background: linear-gradient(135deg, rgba(16,185,129,.95), rgba(52,211,153,.85));
      border-color: rgba(16,185,129,.55);
      color: #062019;
    }
    .btn-primary:hover{ filter: brightness(1.03); }
    .btn-danger{
      background: rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.35);
    }
    .badge{
      display:inline-flex; align-items:center; gap:.4rem;
      padding:.2rem .55rem; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
      font-size: .78rem;
    }
    .label{ color: var(--muted2); font-size:.85rem; }
    .input, select{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding: .70rem .85rem;
      color: rgba(255,255,255,.92);
    }
    select option{ color:#111827; }
    .divider{
      height:1px; background: rgba(255,255,255,.10);
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .skeleton{
      background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06));
      background-size: 200% 100%;
      animation: sk 1.2s infinite;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
    }
    @keyframes sk{ 0%{background-position: 200% 0;} 100%{background-position: -200% 0;} }
    .toast{
      position: fixed; right: 18px; bottom: 18px; z-index: 50;
      width: min(420px, calc(100vw - 36px));
      display:none;
    }
    .toast.show{ display:block; }
    .modal{
      position: fixed; inset:0; z-index: 60;
      display:none; align-items:center; justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,.55);
    }
    .modal.show{ display:flex; }
    .kbd{
      font-size:.75rem; padding:.10rem .35rem; border-radius:8px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.80);
    }
    .opt{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding: .85rem .95rem;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      cursor:pointer;
    }
    .opt:hover{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.22); }
    .opt.selected{
      border-color: rgba(16,185,129,.60);
      background: rgba(16,185,129,.12);
      box-shadow: 0 0 0 4px rgba(16,185,129,.12);
    }
    .opt.disabled{ opacity:.55; cursor:not-allowed; }
    .prose-stem{
      white-space: pre-wrap;
      line-height: 1.75;
      color: rgba(255,255,255,.90);
    }
    .prose-muted{
      white-space: pre-wrap;
      line-height: 1.7;
      color: rgba(255,255,255,.78);
    }
    .table-stim th,.table-stim td{
      border: 1px solid rgba(255,255,255,.12);
      padding: .55rem .6rem;
      font-size: .92rem;
    }
    .table-stim th{
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      font-weight:600;
    }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            serif: ['"Noto Serif TC"', 'serif']
          }
        }
      }
    };
  </script>
</head>

<body>
  <div class="max-w-[1280px] mx-auto px-4 py-6">
    <!-- Top Bar -->
    <div class="glass rounded-3xl px-5 py-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-2xl glass2 flex items-center justify-center">
          <i class="fa-solid fa-compass-drafting text-white/90"></i>
        </div>
        <div>
          <div class="text-lg md:text-xl font-semibold">Science Learning Hub <span class="text-white/60">|</span> CAT 評量</div>
          <div class="text-sm text-white/65">
            整合 CAT（IRT）自適應出題 + PISA 題組/資料表圖表呈現 + TIMSS 概念標籤 + TOEFL 式進度/快捷鍵 UX
          </div>
        </div>
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <span id="badge-conn" class="badge"><i class="fa-solid fa-circle-notch fa-spin"></i> 連線中…</span>
        <span id="badge-db" class="badge"><i class="fa-solid fa-database"></i> 未載入</span>
        <button id="btn-reload" class="btn">
          <i class="fa-solid fa-rotate"></i> 重新載入
        </button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-5 mt-5">
      <!-- Left Panel -->
      <aside class="lg:col-span-4 space-y-5">
        <section class="glass rounded-3xl p-5">
          <div class="flex items-center justify-between gap-2">
            <div class="font-semibold text-white/90"><i class="fa-solid fa-sliders mr-2"></i>教材參數設定</div>
            <span class="badge"><i class="fa-solid fa-keyboard"></i> 快捷鍵 <span class="kbd">A</span><span class="kbd">B</span><span class="kbd">C</span><span class="kbd">D</span></span>
          </div>
          <div class="divider my-4"></div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <div class="label mb-1">學習階段</div>
              <select id="sel-stage" class="soft-ring">
                <option value="國小">國小</option>
                <option value="國中">國中</option>
              </select>
            </div>
            <div>
              <div class="label mb-1">科目</div>
              <select id="sel-subject" class="soft-ring">
                <option value="自然科學">自然科學</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mt-3">
            <div>
              <div class="label mb-1">年級</div>
              <select id="sel-grade" class="soft-ring"></select>
            </div>
            <div>
              <div class="label mb-1">學期</div>
              <select id="sel-semester" class="soft-ring">
                <option value="上學期">上學期</option>
                <option value="下學期">下學期</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 gap-3 mt-3">
            <div>
              <div class="label mb-1">版本（出版社）</div>
              <select id="sel-publisher" class="soft-ring">
                <option value="">載入後選擇…</option>
              </select>
            </div>
            <div>
              <div class="label mb-1">單元名稱</div>
              <select id="sel-unit" class="soft-ring">
                <option value="">載入後選擇…</option>
              </select>
            </div>
          </div>

          <div class="divider my-4"></div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <div class="label mb-1">學生代碼（CAT 需要）</div>
              <input id="inp-student" class="input soft-ring" placeholder="例如：S401_01（可留空，系統自動產生）" />
            </div>
            <div>
              <div class="label mb-1">CAT 上限題數</div>
              <input id="inp-maxitems" type="number" min="5" max="40" step="1" class="input soft-ring" value="15" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mt-3">
            <div>
              <div class="label mb-1">CAT 最少題數</div>
              <input id="inp-minitems" type="number" min="3" max="40" step="1" class="input soft-ring" value="8" />
            </div>
            <div>
              <div class="label mb-1">停止門檻（SE）</div>
              <input id="inp-stopse" type="number" min="0.10" max="1.00" step="0.01" class="input soft-ring" value="0.35" />
            </div>
          </div>

          <div class="mt-4 flex gap-3">
            <button id="btn-start" class="btn btn-primary w-full">
              <i class="fa-solid fa-play"></i> 開始 CAT 出題
            </button>
            <button id="btn-reset" class="btn w-full">
              <i class="fa-solid fa-arrow-rotate-left"></i> 重設
            </button>
          </div>

          <div class="mt-3 text-xs text-white/55 leading-relaxed">
            註：此頁以你的後台 action 規格呼叫（<span class="mono">getUnitOptions / startCAT / submitAndNext / finishCAT</span>），不需要改動後端程式。
          </div>
        </section>

        <!-- AI Item Generation / Bank Booster -->
        <section class="glass rounded-3xl p-5">
          <div class="flex items-center justify-between">
            <div class="font-semibold text-white/90"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>題庫補強（AI 生成並入庫）</div>
            <span class="badge"><i class="fa-solid fa-table-cells-large"></i> PISA 題組支援</span>
          </div>
          <div class="divider my-4"></div>

          <div class="grid grid-cols-3 gap-3">
            <div>
              <div class="label mb-1">總題數</div>
              <input id="ai-N" type="number" min="6" max="30" step="1" class="input soft-ring" value="12">
            </div>
            <div>
              <div class="label mb-1">單題數</div>
              <input id="ai-single" type="number" min="2" max="30" step="1" class="input soft-ring" value="8">
            </div>
            <div>
              <div class="label mb-1">題組數</div>
              <input id="ai-group" type="number" min="0" max="10" step="1" class="input soft-ring" value="2">
            </div>
          </div>

          <div class="grid grid-cols-3 gap-3 mt-3">
            <div>
              <div class="label mb-1">容易%</div>
              <input id="ai-easy" type="number" min="0" max="100" step="1" class="input soft-ring" value="30">
            </div>
            <div>
              <div class="label mb-1">中等%</div>
              <input id="ai-medium" type="number" min="0" max="100" step="1" class="input soft-ring" value="50">
            </div>
            <div>
              <div class="label mb-1">偏難%</div>
              <input id="ai-hard" type="number" min="0" max="100" step="1" class="input soft-ring" value="20">
            </div>
          </div>

          <div class="mt-4 flex gap-3">
            <button id="btn-ai-save" class="btn w-full">
              <i class="fa-solid fa-cloud-arrow-up"></i> AI 生成並寫入題庫
            </button>
          </div>

          <div class="mt-3 text-xs text-white/60 leading-relaxed">
            用途：若某單元 CAT 題庫不足（後台回 <span class="mono">no active items</span>），可先用此功能「生成+入庫」，再開始 CAT。
          </div>
        </section>

        <!-- Design Principles -->
        <section class="glass rounded-3xl p-5">
          <div class="font-semibold text-white/90"><i class="fa-solid fa-award mr-2"></i>保留的測驗優點（設計落地）</div>
          <div class="divider my-4"></div>

          <div class="space-y-3 text-sm text-white/80">
            <div class="flex items-start gap-3">
              <div class="w-9 h-9 rounded-2xl glass2 flex items-center justify-center mt-0.5"><i class="fa-solid fa-chart-line"></i></div>
              <div>
                <div class="font-medium">PISA：情境化 + 資料判讀</div>
                <div class="text-white/60">支援題組、表格/圖表/簡易 SVG 刺激；題幹可分離 stimulus 渲染。</div>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <div class="w-9 h-9 rounded-2xl glass2 flex items-center justify-center mt-0.5"><i class="fa-solid fa-tags"></i></div>
              <div>
                <div class="font-medium">TIMSS：概念/技能對齊</div>
                <div class="text-white/60">顯示 concept_tag、textbook_source；結束後以概念層級彙整弱點/優勢。</div>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <div class="w-9 h-9 rounded-2xl glass2 flex items-center justify-center mt-0.5"><i class="fa-solid fa-stopwatch"></i></div>
              <div>
                <div class="font-medium">TOEFL：流暢作答 UX</div>
                <div class="text-white/60">清楚進度條、鍵盤快捷鍵、送出前確認、錯誤提示清晰且可復原。</div>
              </div>
            </div>
          </div>
        </section>
      </aside>

      <!-- Right Panel -->
      <main class="lg:col-span-8 space-y-5">
        <!-- Live status / progress -->
        <section class="glass rounded-3xl p-5">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="badge"><i class="fa-solid fa-bolt"></i> CAT 狀態：<span id="live-state" class="font-semibold">待命</span></span>
              <span class="badge"><i class="fa-solid fa-signal"></i> θ：<span id="live-theta" class="font-semibold">—</span></span>
              <span class="badge"><i class="fa-solid fa-crosshairs"></i> SE：<span id="live-se" class="font-semibold">—</span></span>
              <span class="badge"><i class="fa-solid fa-list-check"></i> 進度：<span id="live-progress" class="font-semibold">0/—</span></span>
            </div>

            <div class="w-full md:w-[320px]">
              <div class="h-2 rounded-full bg-white/10 overflow-hidden border border-white/10">
                <div id="bar-progress" class="h-full rounded-full" style="width:0%; background: linear-gradient(90deg, rgba(16,185,129,.95), rgba(59,130,246,.60));"></div>
              </div>
              <div class="mt-1 text-xs text-white/55 flex justify-between">
                <span>自適應出題中</span>
                <span id="bar-hint">—</span>
              </div>
            </div>
          </div>

          <div class="divider my-4"></div>

          <div id="panel-placeholder" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="glass2 rounded-2xl p-4">
              <div class="text-sm font-semibold text-white/90">你現在可以做什麼</div>
              <div class="mt-2 text-sm text-white/70 leading-relaxed">
                1) 先選年級、學期、出版社、單元<br>
                2) 直接按「開始 CAT 出題」：若題庫足夠，立即出第一題<br>
                3) 若題庫不足，可先用「AI 生成並寫入題庫」補強後再開始
              </div>
            </div>
            <div class="glass2 rounded-2xl p-4">
              <div class="text-sm font-semibold text-white/90">操作效率（建議）</div>
              <div class="mt-2 text-sm text-white/70 leading-relaxed">
                作答可按鍵盤 <span class="kbd">A</span>/<span class="kbd">B</span>/<span class="kbd">C</span>/<span class="kbd">D</span> 選擇選項。<br>
                送出後才會寫入資料庫（避免誤觸）。
              </div>
            </div>
          </div>
        </section>

        <!-- Question card -->
        <section class="glass rounded-3xl p-5">
          <div class="flex items-center justify-between gap-3">
            <div class="font-semibold text-white/90"><i class="fa-solid fa-pen-to-square mr-2"></i>作答區</div>
            <div class="flex items-center gap-2">
              <button id="btn-finish" class="btn" disabled>
                <i class="fa-solid fa-flag-checkered"></i> 結束並產生診斷
              </button>
            </div>
          </div>

          <div class="divider my-4"></div>

          <!-- Stimulus Render Area -->
          <div id="stimulus-wrap" class="hidden mb-4">
            <div class="text-xs text-white/55 mb-2">共同材料 / 刺激（PISA 題組呈現）</div>
            <div class="glass2 rounded-2xl p-4">
              <div id="stimulus-content"></div>
            </div>
          </div>

          <div id="q-skel" class="space-y-3">
            <div class="skeleton h-5 w-2/3"></div>
            <div class="skeleton h-4 w-full"></div>
            <div class="skeleton h-4 w-full"></div>
            <div class="skeleton h-4 w-5/6"></div>
          </div>

          <div id="q-wrap" class="hidden">
            <div class="flex items-start justify-between gap-3 flex-wrap">
              <div>
                <div class="text-xs text-white/55">題目 ID</div>
                <div id="q-id" class="mono text-sm text-white/80">—</div>
              </div>
              <div class="flex items-center gap-2 flex-wrap justify-end">
                <span id="tag-concept" class="badge"><i class="fa-solid fa-tag"></i> concept_tag：—</span>
                <span id="tag-source" class="badge"><i class="fa-solid fa-book"></i> source：—</span>
              </div>
            </div>

            <div class="mt-3 prose-stem serif text-[1.02rem]" id="q-stem"></div>

            <div class="grid grid-cols-1 gap-3 mt-5" id="q-options"></div>

            <div class="mt-5 flex flex-col md:flex-row gap-3">
              <button id="btn-submit" class="btn btn-primary md:w-[240px]" disabled>
                <i class="fa-solid fa-paper-plane"></i> 送出答案
              </button>
              <button id="btn-next" class="btn md:w-[240px]" disabled>
                <i class="fa-solid fa-forward"></i> 下一題
              </button>
              <div class="flex-1 text-sm text-white/65 flex items-center">
                <span id="hint-area">選擇 A/B/C/D 後再送出。</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Report -->
        <section id="report" class="glass rounded-3xl p-5 hidden">
          <div class="flex items-center justify-between gap-3">
            <div class="font-semibold text-white/90"><i class="fa-solid fa-clipboard-check mr-2"></i>診斷報告</div>
            <div class="flex gap-2">
              <button id="btn-copy-report" class="btn">
                <i class="fa-solid fa-copy"></i> 複製摘要
              </button>
              <button id="btn-restart" class="btn">
                <i class="fa-solid fa-rotate-left"></i> 重新測驗
              </button>
            </div>
          </div>
          <div class="divider my-4"></div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="glass2 rounded-2xl p-4">
              <div class="text-xs text-white/55">得分</div>
              <div id="rep-score" class="text-2xl font-bold mt-1">—</div>
              <div class="text-xs text-white/55 mt-2">test_id</div>
              <div id="rep-testid" class="mono text-sm text-white/75 mt-1 break-all">—</div>
            </div>
            <div class="glass2 rounded-2xl p-4">
              <div class="text-xs text-white/55">能力估計 θ</div>
              <div id="rep-theta" class="text-2xl font-bold mt-1">—</div>
              <div class="text-xs text-white/55 mt-2">測量精度 SE</div>
              <div id="rep-se" class="text-xl font-semibold mt-1 text-white/85">—</div>
            </div>
            <div class="glass2 rounded-2xl p-4">
              <div class="text-xs text-white/55">學習建議（非 AI）</div>
              <div id="rep-feedback" class="prose-muted text-sm mt-2"></div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div class="glass2 rounded-2xl p-4">
              <div class="font-semibold text-white/90 text-sm"><i class="fa-solid fa-triangle-exclamation mr-2"></i>優先補強概念</div>
              <div id="rep-weak" class="mt-2 text-sm text-white/75"></div>
            </div>
            <div class="glass2 rounded-2xl p-4">
              <div class="font-semibold text-white/90 text-sm"><i class="fa-solid fa-star mr-2"></i>相對優勢概念</div>
              <div id="rep-strong" class="mt-2 text-sm text-white/75"></div>
            </div>
          </div>

          <div class="glass2 rounded-2xl p-4 mt-4">
            <div class="font-semibold text-white/90 text-sm"><i class="fa-solid fa-xmark mr-2"></i>錯題（回看線索：概念｜教材來源）</div>
            <div id="rep-wrong" class="mt-2 text-sm text-white/75"></div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">
    <div class="glass rounded-2xl p-4">
      <div class="flex items-start gap-3">
        <div id="toast-icon" class="w-10 h-10 rounded-2xl glass2 flex items-center justify-center">
          <i class="fa-solid fa-circle-info"></i>
        </div>
        <div class="flex-1">
          <div id="toast-title" class="font-semibold">提示</div>
          <div id="toast-msg" class="text-sm text-white/75 mt-1 leading-relaxed">—</div>
          <div class="mt-3 flex justify-end">
            <button class="btn" onclick="UI.hideToast()"><i class="fa-solid fa-xmark"></i> 關閉</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="glass rounded-3xl w-full max-w-[720px] p-5">
      <div class="flex items-center justify-between gap-3">
        <div class="font-semibold text-white/90" id="modal-title">—</div>
        <button class="btn" onclick="UI.hideModal()"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="divider my-4"></div>
      <div id="modal-body" class="text-sm text-white/75 leading-relaxed"></div>
      <div class="mt-5 flex flex-col md:flex-row gap-3 justify-end" id="modal-actions"></div>
    </div>
  </div>

  <script>
    /************************************************************
     * 1) 只要改這裡：換成你的 GAS /exec
     ************************************************************/
    const GAS_API_URL = "https://script.google.com/macros/s/PASTE_YOUR_DEPLOYMENT_ID/exec";

    /************************************************************
     * 2) 後台 action（對齊你貼的 code.gs，避免 Unknown action）
     ************************************************************/
    const ACTION = {
      GET_UNIT_OPTIONS: "getUnitOptions",
      START_CAT: "startCAT",
      SUBMIT_NEXT: "submitAndNext",
      FINISH_CAT: "finishCAT",
      GEN_SAVE_EXAM: "generateAndSaveExam"
    };

    /************************************************************
     * State
     ************************************************************/
    const State = {
      meta: {
        unitsByPublisher: {},
        publishers: []
      },
      cat: {
        started: false,
        test_id: "",
        student_id: "",
        current_item: null,
        selected: "",
        next_item_buffer: null,
        n_admin: 0,
        max_items: 15,
        min_items: 8,
        stop_se: 0.35,
        theta: null,
        se: null
      }
    };

    /************************************************************
     * UI helpers
     ************************************************************/
    const UI = {
      setConn(ok, msg){
        const el = document.getElementById("badge-conn");
        if(ok){
          el.innerHTML = `<i class="fa-solid fa-circle-check"></i> 連線成功`;
          el.style.borderColor = "rgba(34,197,94,.35)";
          el.style.background = "rgba(34,197,94,.10)";
        }else{
          el.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> 連線異常`;
          el.style.borderColor = "rgba(245,158,11,.35)";
          el.style.background = "rgba(245,158,11,.10)";
          if(msg) UI.toast("連線異常", msg, "warn");
        }
      },
      setDB(text){
        const el = document.getElementById("badge-db");
        el.innerHTML = `<i class="fa-solid fa-database"></i> ${escapeHtml(text)}`;
      },
      toast(title, msg, type="info"){
        const t = document.getElementById("toast");
        const ic = document.getElementById("toast-icon");
        const tt = document.getElementById("toast-title");
        const tm = document.getElementById("toast-msg");

        let icon = "fa-circle-info";
        if(type==="good") icon="fa-circle-check";
        if(type==="warn") icon="fa-triangle-exclamation";
        if(type==="bad") icon="fa-circle-xmark";

        ic.innerHTML = `<i class="fa-solid ${icon}"></i>`;
        tt.textContent = title || "提示";
        tm.textContent = msg || "";

        t.classList.add("show");
        clearTimeout(UI._toastTimer);
        UI._toastTimer = setTimeout(()=>UI.hideToast(), 5200);
      },
      hideToast(){
        document.getElementById("toast").classList.remove("show");
      },
      modal(title, bodyHtml, actions=[]){
        document.getElementById("modal-title").textContent = title || "提示";
        document.getElementById("modal-body").innerHTML = bodyHtml || "";
        const act = document.getElementById("modal-actions");
        act.innerHTML = "";
        actions.forEach(a=>{
          const btn = document.createElement("button");
          btn.className = a.className || "btn";
          btn.innerHTML = a.html || "OK";
          btn.onclick = a.onClick || (()=>UI.hideModal());
          act.appendChild(btn);
        });
        document.getElementById("modal").classList.add("show");
      },
      hideModal(){
        document.getElementById("modal").classList.remove("show");
      },
      setLive(){
        const s = State.cat;
        document.getElementById("live-state").textContent = s.started ? "測驗中" : "待命";
        document.getElementById("live-theta").textContent = (s.theta==null) ? "—" : String(round(s.theta, 4));
        document.getElementById("live-se").textContent = (s.se==null) ? "—" : String(round(s.se, 4));
        document.getElementById("live-progress").textContent = `${s.n_admin}/${s.max_items || "—"}`;

        const pct = (s.max_items ? Math.min(100, Math.round((s.n_admin / s.max_items)*100)) : 0);
        document.getElementById("bar-progress").style.width = pct + "%";
        document.getElementById("bar-hint").textContent = s.max_items ? (pct + "%") : "—";
      },
      showQuestionSkeleton(show){
        document.getElementById("q-skel").classList.toggle("hidden", !show);
        document.getElementById("q-wrap").classList.toggle("hidden", show);
      },
      showReport(show){
        document.getElementById("report").classList.toggle("hidden", !show);
      },
      showStimulus(stim){
        const wrap = document.getElementById("stimulus-wrap");
        const box = document.getElementById("stimulus-content");
        box.innerHTML = "";
        if(!stim){
          wrap.classList.add("hidden");
          return;
        }
        wrap.classList.remove("hidden");

        try{
          const kind = String(stim.kind||"").trim();
          if(kind === "table" && stim.table){
            const cols = Array.isArray(stim.table.columns)? stim.table.columns : [];
            const rows = Array.isArray(stim.table.rows)? stim.table.rows : [];
            const table = document.createElement("table");
            table.className = "table-stim w-full border-collapse rounded-xl overflow-hidden";
            const thead = document.createElement("thead");
            const trh = document.createElement("tr");
            cols.forEach(c=>{
              const th = document.createElement("th");
              th.textContent = String(c);
              trh.appendChild(th);
            });
            thead.appendChild(trh);
            table.appendChild(thead);

            const tbody = document.createElement("tbody");
            rows.forEach(r=>{
              const tr = document.createElement("tr");
              (Array.isArray(r)? r : [r]).forEach(cell=>{
                const td = document.createElement("td");
                td.textContent = String(cell);
                tr.appendChild(td);
              });
              tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            box.appendChild(table);
            return;
          }

          if(kind === "chart" && stim.chart){
            const canvas = document.createElement("canvas");
            canvas.height = 160;
            box.appendChild(canvas);

            const chart_type = stim.chart.chart_type || "bar";
            const labels = Array.isArray(stim.chart.labels)? stim.chart.labels : [];
            const datasets = Array.isArray(stim.chart.datasets)? stim.chart.datasets : [];

            // Let Chart.js use its default palette; keep it simple
            new Chart(canvas.getContext("2d"),{
              type: chart_type,
              data:{
                labels,
                datasets: datasets.map((d,i)=>({
                  label: d.label || ("dataset"+(i+1)),
                  data: Array.isArray(d.data)? d.data : []
                }))
              },
              options:{
                responsive:true,
                plugins:{
                  legend:{ labels:{ color:"rgba(255,255,255,.85)" } }
                },
                scales:{
                  x:{ ticks:{ color:"rgba(255,255,255,.75)" }, grid:{ color:"rgba(255,255,255,.10)" } },
                  y:{ ticks:{ color:"rgba(255,255,255,.75)" }, grid:{ color:"rgba(255,255,255,.10)" } }
                }
              }
            });
            return;
          }

          if(kind === "svg" && stim.svg && stim.svg.svg_text){
            const div = document.createElement("div");
            div.className = "w-full overflow-auto";
            div.innerHTML = stim.svg.svg_text;
            box.appendChild(div);
            return;
          }

          const pre = document.createElement("pre");
          pre.className = "text-xs text-white/70 whitespace-pre-wrap";
          pre.textContent = JSON.stringify(stim, null, 2);
          box.appendChild(pre);
        }catch(e){
          const pre = document.createElement("pre");
          pre.className = "text-xs text-white/70 whitespace-pre-wrap";
          pre.textContent = "stimulus 解析失敗：" + String(e?.message || e);
          box.appendChild(pre);
        }
      }
    };

    /************************************************************
     * API
     ************************************************************/
    async function apiCall(payload){
      const res = await fetch(GAS_API_URL, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload),
        redirect: "follow"
      });
      const text = await res.text();
      let json = null;
      try{ json = JSON.parse(text); }catch(_){}
      if(!json){
        throw new Error("後端未回傳 JSON。請確認 GAS 是 Web App /exec，並且 doPost 回傳 JSON。");
      }
      if(json.ok !== true){
        throw new Error(json.error || "後端回傳失敗（ok=false）");
      }
      return json;
    }

    async function ping(){
      try{
        const res = await fetch(GAS_API_URL, { method:"GET", redirect:"follow" });
        const txt = await res.text();
        let j = null;
        try{ j = JSON.parse(txt); }catch(_){}
        if(j && j.ok === true){
          UI.setConn(true);
          return true;
        }
        UI.setConn(true); // GET 不一定回 JSON，但能通就當 ok
        return true;
      }catch(e){
        UI.setConn(false, String(e?.message||e));
        return false;
      }
    }

    /************************************************************
     * Metadata: grade options + getUnitOptions from ItemBank
     ************************************************************/
    function buildGradeOptions(stage){
      const sel = document.getElementById("sel-grade");
      sel.innerHTML = "";
      const grades = (stage === "國中") ? [7,8,9] : [3,4,5,6];
      grades.forEach(g=>{
        const op = document.createElement("option");
        op.value = String(g);
        op.textContent = String(g) + "年級";
        sel.appendChild(op);
      });
      // default 4 if exists
      if(stage !== "國中") sel.value = "4";
    }

    function getSelectedUnitMeta(){
      const subject = document.getElementById("sel-subject").value.trim() || "自然科學";
      const grade = Number(document.getElementById("sel-grade").value);
      const semester = document.getElementById("sel-semester").value.trim();
      const publisher = document.getElementById("sel-publisher").value.trim();
      const unit = document.getElementById("sel-unit").value.trim();

      return {
        subject,
        grade,
        semester,
        textbook_version: publisher,
        unit_name: unit
      };
    }

    async function loadUnitOptions(){
      const subject = document.getElementById("sel-subject").value.trim() || "自然科學";
      const grade = Number(document.getElementById("sel-grade").value);
      const semester = document.getElementById("sel-semester").value.trim();

      UI.setDB("載入單元選單中…");
      const json = await apiCall({
        action: ACTION.GET_UNIT_OPTIONS,
        subject, grade, semester
      });

      State.meta.publishers = Array.isArray(json.publishers) ? json.publishers : [];
      State.meta.unitsByPublisher = json.unitsByPublisher || {};

      // publisher dropdown
      const selPub = document.getElementById("sel-publisher");
      selPub.innerHTML = "";
      if(State.meta.publishers.length === 0){
        const op = document.createElement("option");
        op.value = "";
        op.textContent = "（此年級/學期尚無題庫）";
        selPub.appendChild(op);
      }else{
        State.meta.publishers.forEach(p=>{
          const op = document.createElement("option");
          op.value = p;
          op.textContent = p;
          selPub.appendChild(op);
        });
      }

      // unit dropdown depends on publisher
      refreshUnitDropdown();

      UI.setDB(`單元選單已載入（出版社 ${State.meta.publishers.length}）`);
      UI.toast("資料載入完成", "已取得該年級/學期之題庫版本與單元清單。", "good");
    }

    function refreshUnitDropdown(){
      const pub = document.getElementById("sel-publisher").value.trim();
      const units = (State.meta.unitsByPublisher && State.meta.unitsByPublisher[pub]) ? State.meta.unitsByPublisher[pub] : [];
      const selUnit = document.getElementById("sel-unit");
      selUnit.innerHTML = "";
      if(!units || units.length === 0){
        const op = document.createElement("option");
        op.value = "";
        op.textContent = "（此版本尚無單元）";
        selUnit.appendChild(op);
      }else{
        units.forEach(u=>{
          const op = document.createElement("option");
          op.value = u;
          op.textContent = u;
          selUnit.appendChild(op);
        });
      }
    }

    /************************************************************
     * CAT flow
     ************************************************************/
    function ensureStudentId(){
      const inp = document.getElementById("inp-student");
      let sid = (inp.value || "").trim();
      if(!sid){
        sid = "guest_" + Date.now();
        inp.value = sid;
      }
      localStorage.setItem("slh_student_id", sid);
      return sid;
    }

    function resetCATUI(){
      State.cat.started = false;
      State.cat.test_id = "";
      State.cat.current_item = null;
      State.cat.selected = "";
      State.cat.next_item_buffer = null;
      State.cat.n_admin = 0;
      State.cat.theta = null;
      State.cat.se = null;

      UI.setLive();
      UI.showQuestionSkeleton(true);
      UI.showStimulus(null);
      UI.showReport(false);

      document.getElementById("btn-finish").disabled = true;
      document.getElementById("btn-submit").disabled = true;
      document.getElementById("btn-next").disabled = true;

      // placeholder visible
      document.getElementById("panel-placeholder").classList.remove("hidden");
    }

    function parseStimulusFromStem(stem){
      // detect marker [STIMULUS_JSON]
      const marker = "[STIMULUS_JSON]";
      const idx = stem.indexOf(marker);
      if(idx < 0) return { cleanStem: stem, stimulus: null };
      const before = stem.slice(0, idx).trim();
      const after = stem.slice(idx + marker.length).trim();
      // after may include JSON
      const firstBrace = after.indexOf("{");
      const lastBrace = after.lastIndexOf("}");
      if(firstBrace < 0 || lastBrace <= firstBrace){
        return { cleanStem: before, stimulus: null };
      }
      const jsonText = after.slice(firstBrace, lastBrace+1);
      try{
        const stim = JSON.parse(jsonText);
        return { cleanStem: before, stimulus: stim };
      }catch(_){
        return { cleanStem: before, stimulus: null };
      }
    }

    function normalizeItem(raw){
      if(!raw) return null;
      const item_id = String(raw.item_id || "").trim();
      let stem = String(raw.stem || "").trim();

      const parsed = parseStimulusFromStem(stem);
      stem = parsed.cleanStem;

      const optObj = raw.options || {};
      const A = (raw.option_A ?? optObj.A ?? raw.A ?? "").toString();
      const B = (raw.option_B ?? optObj.B ?? raw.B ?? "").toString();
      const C = (raw.option_C ?? optObj.C ?? raw.C ?? "").toString();
      const D = (raw.option_D ?? optObj.D ?? raw.D ?? "").toString();

      const options = { A, B, C, D };
      const concept_tag = String(raw.concept_tag || "").trim();
      const textbook_source = String(raw.textbook_source || "").trim();

      return { item_id, stem, options, concept_tag, textbook_source, stimulus: parsed.stimulus };
    }

    function renderItem(item){
      UI.showQuestionSkeleton(false);

      document.getElementById("panel-placeholder").classList.add("hidden");

      document.getElementById("q-id").textContent = item.item_id || "—";
      document.getElementById("q-stem").textContent = item.stem || "";

      document.getElementById("tag-concept").innerHTML = `<i class="fa-solid fa-tag"></i> concept_tag：${escapeHtml(item.concept_tag || "—")}`;
      document.getElementById("tag-source").innerHTML = `<i class="fa-solid fa-book"></i> source：${escapeHtml(item.textbook_source || "—")}`;

      UI.showStimulus(item.stimulus);

      const optWrap = document.getElementById("q-options");
      optWrap.innerHTML = "";

      State.cat.selected = "";
      document.getElementById("btn-submit").disabled = true;
      document.getElementById("btn-next").disabled = true;
      document.getElementById("hint-area").textContent = "選擇 A/B/C/D 後再送出。";

      ["A","B","C","D"].forEach(letter=>{
        const text = (item.options && item.options[letter] != null) ? String(item.options[letter]) : "";
        const card = document.createElement("div");
        card.className = "opt";
        card.setAttribute("data-letter", letter);
        card.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="w-9 h-9 rounded-2xl glass2 flex items-center justify-center font-bold">${letter}</div>
            <div class="flex-1 text-white/85 leading-relaxed">${escapeHtml(text)}</div>
            <div class="text-xs text-white/55 mt-1"><span class="kbd">${letter}</span></div>
          </div>
        `;
        card.onclick = ()=>selectOption(letter);
        optWrap.appendChild(card);
      });
    }

    function selectOption(letter){
      if(!State.cat.started) return;
      State.cat.selected = letter;
      document.querySelectorAll(".opt").forEach(el=>{
        const l = el.getAttribute("data-letter");
        el.classList.toggle("selected", l===letter);
      });
      document.getElementById("btn-submit").disabled = false;
      document.getElementById("hint-area").textContent = `已選擇 ${letter}。按「送出答案」寫入並取得下一題。`;
    }

    async function startCAT(){
      const unit = getSelectedUnitMeta();
      if(!unit.textbook_version || !unit.unit_name){
        UI.toast("資料不足", "請先選擇「出版社」與「單元名稱」。", "warn");
        return;
      }

      const sid = ensureStudentId();
      State.cat.student_id = sid;

      State.cat.max_items = clampNum(Number(document.getElementById("inp-maxitems").value), 5, 40, 15);
      State.cat.min_items = clampNum(Number(document.getElementById("inp-minitems").value), 3, 40, 8);
      State.cat.stop_se = clampNum(Number(document.getElementById("inp-stopse").value), 0.10, 1.00, 0.35);

      UI.showReport(false);
      UI.showQuestionSkeleton(true);
      UI.showStimulus(null);

      document.getElementById("btn-start").disabled = true;
      document.getElementById("btn-finish").disabled = true;

      try{
        const json = await apiCall({
          action: ACTION.START_CAT,
          student: { student_id: sid },
          unit,
          settings: { max_items: State.cat.max_items }
        });

        State.cat.started = true;
        State.cat.test_id = json.test_id || "";
        State.cat.theta = (typeof json.theta !== "undefined") ? json.theta : null;
        State.cat.se = (typeof json.se !== "undefined") ? json.se : null;
        State.cat.n_admin = 0; // backend returns n_admin=0 at start

        const item = normalizeItem(json.item);
        if(!item) throw new Error("後端未提供第一題 item");

        State.cat.current_item = item;
        UI.setLive();
        renderItem(item);

        document.getElementById("btn-finish").disabled = false;
        UI.toast("CAT 已開始", "已取得第一題。", "good");
      }catch(e){
        // If no active items, give best UX: offer AI generate+save then start again
        const msg = String(e?.message || e);

        if(msg.includes("no active items")){
          UI.modal(
            "此單元 CAT 題庫不足",
            `後端回覆：<span class="mono">${escapeHtml(msg)}</span><br><br>
             你可以直接「AI 生成並入庫」補題庫，完成後立即開始 CAT。`,
            [
              {
                className:"btn btn-primary",
                html:`<i class="fa-solid fa-wand-magic-sparkles"></i> 立即 AI 生成並入庫後開始`,
                onClick: async ()=>{
                  UI.hideModal();
                  await aiGenerateAndSave(true);
                }
              },
              {
                className:"btn",
                html:`<i class="fa-solid fa-xmark"></i> 取消`,
                onClick: ()=>UI.hideModal()
              }
            ]
          );
        }else{
          UI.toast("開始 CAT 失敗", msg, "bad");
        }
      }finally{
        document.getElementById("btn-start").disabled = false;
      }
    }

    async function submitAnswer(){
      if(!State.cat.started || !State.cat.current_item) return;
      const letter = State.cat.selected;
      if(!letter){
        UI.toast("尚未選擇答案", "請先選擇 A/B/C/D。", "warn");
        return;
      }

      // lock UI
      document.getElementById("btn-submit").disabled = true;
      document.getElementById("btn-next").disabled = true;
      document.getElementById("hint-area").textContent = "送出中…";

      const unit = getSelectedUnitMeta();
      const item = State.cat.current_item;

      try{
        const json = await apiCall({
          action: ACTION.SUBMIT_NEXT,
          test_id: State.cat.test_id,
          student_id: State.cat.student_id,
          item_id: item.item_id,
          response_option: letter,
          max_items: State.cat.max_items,
          min_items: State.cat.min_items,
          stop_se: State.cat.stop_se,
          // optional (record fields)
          grade: String(unit.grade || ""),
          class: "",
          school: ""
        });

        State.cat.theta = (typeof json.theta !== "undefined") ? json.theta : State.cat.theta;
        State.cat.se = (typeof json.se !== "undefined") ? json.se : State.cat.se;

        const prog = json.progress || {};
        State.cat.n_admin = Number(prog.n_admin || (State.cat.n_admin + 1));
        UI.setLive();

        if(json.done === true){
          document.getElementById("hint-area").textContent = "測驗已達停止條件，正在產生診斷…";
          await finishCAT();
          return;
        }

        const next = normalizeItem(json.item);
        if(!next) throw new Error("後端未提供下一題 item");

        State.cat.next_item_buffer = next;
        document.getElementById("btn-next").disabled = false;
        document.getElementById("hint-area").textContent = "已取得下一題，按「下一題」繼續。";
      }catch(e){
        UI.toast("送出失敗", String(e?.message||e), "bad");
        document.getElementById("btn-submit").disabled = false;
        document.getElementById("hint-area").textContent = "送出失敗，請重試。";
      }
    }

    function goNext(){
      const next = State.cat.next_item_buffer;
      if(!next) return;
      State.cat.current_item = next;
      State.cat.next_item_buffer = null;
      renderItem(next);
      document.getElementById("hint-area").textContent = "選擇 A/B/C/D 後再送出。";
    }

    async function finishCAT(){
      if(!State.cat.started) return;

      document.getElementById("btn-finish").disabled = true;
      document.getElementById("btn-submit").disabled = true;
      document.getElementById("btn-next").disabled = true;

      try{
        const json = await apiCall({
          action: ACTION.FINISH_CAT,
          test_id: State.cat.test_id,
          student_id: State.cat.student_id
        });

        // Show report
        UI.showReport(true);

        document.getElementById("rep-score").textContent = json.score || "—";
        document.getElementById("rep-testid").textContent = json.test_id || "—";
        document.getElementById("rep-theta").textContent = (json.theta!=null) ? String(json.theta) : "—";
        document.getElementById("rep-se").textContent = (json.se!=null) ? String(json.se) : "—";
        document.getElementById("rep-feedback").textContent = json.feedback_student || "";

        document.getElementById("rep-weak").innerHTML = renderListBadges(json.weak_concepts || [], "bad");
        document.getElementById("rep-strong").innerHTML = renderListBadges(json.strong_concepts || [], "good");
        document.getElementById("rep-wrong").innerHTML = renderWrongItems(json.wrong_items || []);

        UI.toast("診斷完成", "已產生測驗摘要與概念層級診斷。", "good");

        // mark ended
        State.cat.started = false;
        UI.setLive();
      }catch(e){
        UI.toast("產生診斷失敗", String(e?.message||e), "bad");
      }finally{
        document.getElementById("btn-finish").disabled = false;
      }
    }

    /************************************************************
     * AI generate + save to itembank
     ************************************************************/
    async function aiGenerateAndSave(thenStart=false){
      const unit = getSelectedUnitMeta();
      if(!unit.textbook_version || !unit.unit_name){
        UI.toast("資料不足", "請先選擇「出版社」與「單元名稱」。", "warn");
        return;
      }

      const spec = {
        N: Number(document.getElementById("ai-N").value),
        N_single: Number(document.getElementById("ai-single").value),
        N_group: Number(document.getElementById("ai-group").value),
        easy: Number(document.getElementById("ai-easy").value),
        medium: Number(document.getElementById("ai-medium").value),
        hard: Number(document.getElementById("ai-hard").value)
      };

      document.getElementById("btn-ai-save").disabled = true;
      UI.toast("AI 生成中", "正在生成題目並寫入 CATItemBank…", "info");

      try{
        const json = await apiCall({
          action: ACTION.GEN_SAVE_EXAM,
          unit,
          spec,
          save_options_columns: true
        });

        UI.toast("入庫完成", `已寫入 ${json.saved_count} 題。`, "good");
        await loadUnitOptions(); // refresh dropdowns from itembank

        if(thenStart){
          await startCAT();
        }
      }catch(e){
        UI.toast("AI 入庫失敗", String(e?.message||e), "bad");
      }finally{
        document.getElementById("btn-ai-save").disabled = false;
      }
    }

    /************************************************************
     * Event wiring
     ************************************************************/
    document.addEventListener("DOMContentLoaded", async ()=>{
      // restore student id
      const sid = localStorage.getItem("slh_student_id");
      if(sid) document.getElementById("inp-student").value = sid;

      buildGradeOptions(document.getElementById("sel-stage").value);
      resetCATUI();

      document.getElementById("sel-stage").addEventListener("change", async ()=>{
        buildGradeOptions(document.getElementById("sel-stage").value);
        await loadUnitOptions().catch(err=>UI.toast("載入失敗", String(err?.message||err), "bad"));
      });

      document.getElementById("sel-grade").addEventListener("change", ()=>loadUnitOptions().catch(err=>UI.toast("載入失敗", String(err?.message||err), "bad")));
      document.getElementById("sel-semester").addEventListener("change", ()=>loadUnitOptions().catch(err=>UI.toast("載入失敗", String(err?.message||err), "bad")));
      document.getElementById("sel-publisher").addEventListener("change", refreshUnitDropdown);

      document.getElementById("btn-reload").addEventListener("click", async ()=>{
        await ping();
        await loadUnitOptions().catch(err=>UI.toast("載入失敗", String(err?.message||err), "bad"));
      });

      document.getElementById("btn-start").addEventListener("click", startCAT);
      document.getElementById("btn-submit").addEventListener("click", submitAnswer);
      document.getElementById("btn-next").addEventListener("click", goNext);
      document.getElementById("btn-finish").addEventListener("click", finishCAT);

      document.getElementById("btn-reset").addEventListener("click", ()=>{
        resetCATUI();
        UI.toast("已重設", "狀態已回到待命。", "info");
      });

      document.getElementById("btn-restart").addEventListener("click", ()=>{
        resetCATUI();
        UI.toast("已重設", "可重新開始測驗。", "info");
        window.scrollTo({ top:0, behavior:"smooth" });
      });

      document.getElementById("btn-ai-save").addEventListener("click", ()=>aiGenerateAndSave(false));

      document.getElementById("btn-copy-report").addEventListener("click", async ()=>{
        const text =
`score: ${document.getElementById("rep-score").textContent}
test_id: ${document.getElementById("rep-testid").textContent}
theta: ${document.getElementById("rep-theta").textContent}
se: ${document.getElementById("rep-se").textContent}

feedback:
${document.getElementById("rep-feedback").textContent}`;
        try{
          await navigator.clipboard.writeText(text);
          UI.toast("已複製", "診斷摘要已複製到剪貼簿。", "good");
        }catch(e){
          UI.toast("複製失敗", "瀏覽器未授權剪貼簿，請手動複製。", "warn");
        }
      });

      // keyboard shortcuts A/B/C/D
      document.addEventListener("keydown", (ev)=>{
        if(!State.cat.started) return;
        const k = String(ev.key || "").toUpperCase();
        if(["A","B","C","D"].includes(k)){
          selectOption(k);
          ev.preventDefault();
        }
        if(k === "ENTER"){
          if(!document.getElementById("btn-submit").disabled) submitAnswer();
          ev.preventDefault();
        }
      });

      // initial load
      const ok = await ping();
      if(ok){
        await loadUnitOptions().catch(err=>UI.toast("載入失敗", String(err?.message||err), "bad"));
      }
    });

    /************************************************************
     * Small utilities
     ************************************************************/
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[m]));
    }
    function round(x,d){ const p=Math.pow(10,d); return Math.round(x*p)/p; }
    function clampNum(x, lo, hi, fallback){
      const n = Number(x);
      if(!Number.isFinite(n)) return fallback;
      return Math.max(lo, Math.min(hi, n));
    }
    function renderListBadges(arr, type){
      const xs = Array.isArray(arr) ? arr : [];
      if(xs.length===0) return `<div class="text-white/55">（無）</div>`;
      return xs.map(x=>{
        const t = escapeHtml(String(x));
        const icon = (type==="good") ? "fa-star" : "fa-triangle-exclamation";
        const bg = (type==="good") ? "rgba(34,197,94,.10)" : "rgba(245,158,11,.10)";
        const bd = (type==="good") ? "rgba(34,197,94,.35)" : "rgba(245,158,11,.35)";
        return `<span class="badge mr-2 mb-2" style="background:${bg}; border-color:${bd};"><i class="fa-solid ${icon}"></i> ${t}</span>`;
      }).join("");
    }
    function renderWrongItems(arr){
      const xs = Array.isArray(arr) ? arr : [];
      if(xs.length===0) return `<div class="text-white/55">（無）</div>`;
      return xs.map(w=>{
        const id = escapeHtml(w.item_id || "");
        const ct = escapeHtml(w.concept_tag || "");
        const src = escapeHtml(w.textbook_source || "");
        const meta = [ct, src].filter(Boolean).join(" ｜ ");
        return `<div class="py-2 border-b border-white/10 last:border-b-0">
          <div class="mono text-white/85">${id}</div>
          <div class="text-xs text-white/60 mt-1">${meta || "—"}</div>
        </div>`;
      }).join("");
    }
  </script>
</body>
</html>
