<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AI 評分診斷 | aievaluation</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      font-family: "Microsoft JhengHei", sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    .glass-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.7);
      box-shadow: 0 4px 6px rgba(0,0,0,0.08);
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="text-slate-800 min-h-screen flex flex-col">

  <!-- Top bar -->
  <nav class="glass-panel sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <a href="student.html" class="group flex items-center gap-2 text-slate-500 hover:text-blue-600 transition decoration-0">
        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow group-hover:shadow-md transition">
          <i class="fa-solid fa-arrow-left"></i>
        </div>
        <span class="font-bold hidden md:block">返回學習中心</span>
      </a>
      <div class="h-8 w-px bg-slate-300 mx-2 hidden sm:block"></div>
      <div class="hidden sm:block">
        <h1 class="font-bold text-lg">AI 評分診斷</h1>
        <p class="text-xs text-slate-500">教材參數設定 → 連線載入資料庫</p>
      </div>
    </div>

    <div class="flex items-center gap-2 pl-2 border-l border-slate-300">
      <div id="user-info" class="text-sm font-bold text-blue-600">訪客</div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-8 flex-1 w-full pb-24">

    <!-- Selection Panel -->
    <div id="selection-panel" class="glass-panel rounded-2xl p-6 mb-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="font-bold text-lg flex items-center gap-2">
          <i class="fa-solid fa-database"></i>
          <span>教材參數設定</span>
        </h2>
        <span id="db-status" class="text-xs font-bold text-orange-500">
          <i class="fa-solid fa-circle-notch fa-spin"></i> Loading...
        </span>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
        <div>
          <label class="text-xs font-bold text-slate-500 ml-1">學習階段</label>
          <select id="sel-stage" class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500">
            <option value="" disabled selected>Loading...</option>
          </select>
        </div>

        <div>
          <label class="text-xs font-bold text-slate-500 ml-1">版本</label>
          <select id="sel-publisher" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50">
            <option value="" disabled selected>Select...</option>
          </select>
        </div>

        <div>
          <label class="text-xs font-bold text-slate-500 ml-1">年級</label>
          <select id="sel-grade" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50">
            <option value="" disabled selected>Select...</option>
          </select>
        </div>

        <div>
          <label class="text-xs font-bold text-slate-500 ml-1">學期</label>
          <select id="sel-semester" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50">
            <option value="" disabled selected>Select...</option>
          </select>
        </div>

        <div>
          <label class="text-xs font-bold text-slate-500 ml-1">單元名稱</label>
          <select id="sel-unit" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50">
            <option value="" disabled selected>Select...</option>
          </select>
        </div>
      </div>

      <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-end">
        <button id="btn-reload" type="button"
          class="bg-slate-100 text-slate-700 px-6 py-2.5 rounded-xl font-bold border border-slate-200 hover:bg-slate-200 transition flex items-center gap-2"
          onclick="reloadMetadata()">
          <i class="fa-solid fa-rotate"></i> 重新載入資料庫
        </button>

        <button id="btn-evaluate" type="button" disabled
          class="bg-emerald-600 text-white px-8 py-2.5 rounded-xl font-bold shadow-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2"
          onclick="startEvaluation()">
          <i class="fa-solid fa-clipboard-check"></i> 開始評分診斷
        </button>
      </div>

      <div class="mt-4 text-xs text-slate-500">
        <span class="font-semibold">提示：</span>這頁只要 GAS 的 <code>action=get_metadata</code> 回傳成功，即可正常帶出下拉選單。
      </div>
    </div>

    <!-- Loading -->
    <div id="loading-view" class="hidden flex-col items-center justify-center py-20">
      <div class="loader mb-4"></div>
      <h3 class="text-xl font-bold text-slate-700">載入評分診斷中...</h3>
      <p class="text-sm text-slate-500 mt-2">（若你的後端尚未實作對應 action，這一步會提示錯誤，但資料庫載入仍可正常運作。）</p>
    </div>

    <!-- Result -->
    <div id="result-view" class="hidden">
      <div class="glass-panel rounded-2xl p-6">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-xs font-bold text-slate-500">目前選擇</div>
            <div id="result-title" class="text-xl font-black text-slate-800 mt-1">—</div>
          </div>
          <button type="button"
            class="bg-slate-100 text-slate-700 px-6 py-2.5 rounded-xl font-bold border border-slate-200 hover:bg-slate-200 transition"
            onclick="backToSelection()">
            返回參數設定
          </button>
        </div>

        <div class="mt-5">
          <div class="text-sm font-bold text-slate-700 mb-2">系統回傳</div>
          <pre id="result-json" class="text-xs bg-slate-50 border border-slate-200 rounded-xl p-3 overflow-auto max-h-[50vh] whitespace-pre-wrap">—</pre>
        </div>
      </div>
    </div>

  </main>

  <script>
    // === 1) 這裡改成你的 GAS Web App URL（你貼的成功版本就是這條）===
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxBWrZCp-xLckDGZnhe64K0IUa_8CJZRzqZbrgL8lQdNn3S1WgaEzbdOtpo4mGwN6_H/exec";

    // === 2) 這一段就是你「成功載入資料庫」那份 HTML 的核心（完整搬過來）===
    let allData = [];
    let filters = {};

    window.onload = async () => {
      // 顯示登入者（同時支援 sessionStorage / localStorage）
      const user = JSON.parse(sessionStorage.getItem("currentUser") || localStorage.getItem("currentUser") || '{"name":"訪客"}');
      const userInfo = document.getElementById("user-info");
      if (userInfo) userInfo.innerText = user.name;

      await loadMetadataAndInit();
    };

    async function reloadMetadata() {
      // 重置 UI
      allData = [];
      filters = {};
      setDBStatusLoading();
      resetAllSelectors();
      await loadMetadataAndInit();
    }

    async function loadMetadataAndInit() {
      const selStage = document.getElementById("sel-stage");
      if (selStage) {
        selStage.innerHTML = '<option value="" disabled selected>Loading...</option>';
        selStage.disabled = true;
      }

      try {
        // 加上 ts 避免快取造成「舊資料／無更新」問題（iOS Safari 特別常見）
        const res = await fetch(GAS_API_URL + "?action=get_metadata&ts=" + Date.now());
        if (!res.ok) throw new Error(`伺服器 HTTP 錯誤: ${res.status}`);

        const text = await res.text();
        let json;
        try {
          json = JSON.parse(text);
        } catch (parseError) {
          console.error("JSON 解析失敗的原始文本:", text);
          throw new Error(`API 回應格式錯誤，原始內容開頭: ${text.substring(0, 50)}...`);
        }

        if (json.status === "success") {
          allData = json.data || [];

          setDBStatusSuccess(allData.length);

          // 初始化五層下拉
          initSelectors();
        } else {
          throw new Error(json.message || "API 回應狀態非成功");
        }
      } catch (e) {
        console.error("載入元數據失敗:", e);
        setDBStatusFail(e.message);

        if (selStage) {
          selStage.innerHTML = '<option value="" disabled selected>連線失敗，請重試...</option>';
          selStage.disabled = true;
        }

        alert(`無法載入資料庫！\n錯誤訊息: ${e.message}`);
      }
    }

    function setDBStatusLoading() {
      const dbStatus = document.getElementById("db-status");
      if (!dbStatus) return;
      dbStatus.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Loading...`;
      dbStatus.className = "text-xs font-bold text-orange-500";
    }

    function setDBStatusSuccess(n) {
      const dbStatus = document.getElementById("db-status");
      if (!dbStatus) return;
      dbStatus.innerHTML = `<i class="fa-solid fa-check"></i> 資料庫連線成功（${n}筆）`;
      dbStatus.className = "text-xs font-bold text-green-600";
    }

    function setDBStatusFail(msg) {
      const dbStatus = document.getElementById("db-status");
      if (!dbStatus) return;
      dbStatus.innerText = "連線失敗";
      dbStatus.className = "text-xs font-bold text-red-500";
      console.log("DB fail reason:", msg);
    }

    function resetAllSelectors() {
      const ids = ["sel-stage", "sel-publisher", "sel-grade", "sel-semester", "sel-unit"];
      ids.forEach((id, idx) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML = `<option value="" disabled selected>${idx === 0 ? "Loading..." : "Select..."}</option>`;
        el.disabled = (idx !== 0);
      });
      const btn = document.getElementById("btn-evaluate");
      if (btn) btn.disabled = true;
    }

    function initSelectors() {
      // 注意：這裡依賴你後端 get_metadata 回傳的欄位名稱：
      // stage, publisher, grade, semester, unitName, unitType（與你成功頁一致）
      const stages = [...new Set((allData || []).map(d => d.stage))].filter(Boolean);
      populate("sel-stage", stages);

      const selStage = document.getElementById("sel-stage");
      const selPublisher = document.getElementById("sel-publisher");
      const selGrade = document.getElementById("sel-grade");
      const selSemester = document.getElementById("sel-semester");
      const selUnit = document.getElementById("sel-unit");

      if (selStage) selStage.onchange = (e) => updateLevel(1, e.target.value);
      if (selPublisher) selPublisher.onchange = (e) => updateLevel(2, e.target.value);
      if (selGrade) selGrade.onchange = (e) => updateLevel(3, e.target.value);
      if (selSemester) selSemester.onchange = (e) => updateLevel(4, e.target.value);

      if (selUnit) {
        selUnit.onchange = (e) => {
          filters.unitName = e.target.value;
          const btn = document.getElementById("btn-evaluate");
          if (btn) btn.disabled = false;
        };
      }
    }

    function updateLevel(level, value) {
      if (level === 1) filters = { stage: value };
      if (level === 2) { filters.publisher = value; delete filters.grade; delete filters.semester; delete filters.unitName; }
      if (level === 3) { filters.grade = value; delete filters.semester; delete filters.unitName; }
      if (level === 4) { filters.semester = value; delete filters.unitName; }

      // 依你的成功版本：只清除後續層級
      const ids = ["sel-publisher", "sel-grade", "sel-semester", "sel-unit"];
      for (let i = level; i < 4; i++) {
        const el = document.getElementById(ids[i]);
        if (!el) continue;
        el.innerHTML = '<option disabled selected>Select...</option>';
        el.disabled = true;
      }

      const btn = document.getElementById("btn-evaluate");
      if (btn) btn.disabled = true;

      const relevantData = (allData || []).filter(d => {
        const safeMatch = (dVal, fVal) => !fVal || String(dVal ?? "").trim() == String(fVal ?? "").trim();
        return safeMatch(d.stage, filters.stage) &&
               safeMatch(d.publisher, filters.publisher) &&
               safeMatch(d.grade, filters.grade) &&
               safeMatch(d.semester, filters.semester);
      });

      if (level === 1) {
        populate("sel-publisher", [...new Set(relevantData.map(d => d.publisher))].filter(Boolean));
      }

      if (level === 2) {
        populate("sel-grade", [...new Set(relevantData.map(d => d.grade))].filter(Boolean).sort((a,b)=>a-b), "grade");
      }

      if (level === 3) {
        populate("sel-semester", [...new Set(relevantData.map(d => d.semester))].filter(Boolean), "semester");
      }

      if (level === 4) {
        const unitSelect = document.getElementById("sel-unit");
        if (!unitSelect) return;

        unitSelect.innerHTML = '<option disabled selected>Select...</option>';

        if (relevantData.length > 0) {
          relevantData.forEach(d => {
            const opt = document.createElement("option");
            opt.value = d.unitName;
            opt.text = (d.unitType && !isNaN(d.unitType)) ? `第${d.unitType}課 ${d.unitName}` : d.unitName;
            unitSelect.add(opt);
          });
          unitSelect.disabled = false;
        }
      }
    }

    function populate(id, list, type) {
      const el = document.getElementById(id);
      if (!el) return;

      el.innerHTML = '<option disabled selected>Select...</option>';

      (list || []).forEach(o => {
        const opt = document.createElement("option");
        opt.value = o;

        if (type === "grade") opt.text = o + "年級";
        else if (type === "semester") opt.text = (o === "上" ? "上學期" : (o === "下" ? "下學期" : o));
        else opt.text = o;

        el.add(opt);
      });

      el.disabled = false;
    }

    // === 3) 評分診斷（先做成可執行的「示範流程」：把 filters 送到後端，後端若未實作會提示）===
    async function startEvaluation() {
      const selPanel = document.getElementById("selection-panel");
      const loading = document.getElementById("loading-view");
      const resultView = document.getElementById("result-view");

      if (selPanel) selPanel.classList.add("hidden");
      if (loading) { loading.classList.remove("hidden"); loading.classList.add("flex"); }
      if (resultView) resultView.classList.add("hidden");

      const titleEl = document.getElementById("result-title");
      if (titleEl) {
        const sem = (filters.semester === "上") ? "上學期" : (filters.semester === "下" ? "下學期" : (filters.semester || ""));
        titleEl.innerText = `${filters.publisher || ""} ${filters.grade || ""}年級 ${sem}｜${filters.unitName || ""}`;
      }

      try {
        // 你可以把 action 改成你後端真正有的（例如 generate_exam / submit_exam / get_evaluation...）
        const payload = { action: "aievaluation_init", filters: filters };

        const res = await fetch(GAS_API_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(`HTTP 錯誤! 狀態碼: ${res.status}`);

        const text = await res.text();
        let json;
        try {
          json = JSON.parse(text);
        } catch (e) {
          // 若後端回純文字，也直接顯示
          json = { status: "raw", data: text };
        }

        const out = document.getElementById("result-json");
        if (out) out.textContent = JSON.stringify(json, null, 2);

        if (loading) { loading.classList.add("hidden"); loading.classList.remove("flex"); }
        if (resultView) resultView.classList.remove("hidden");

      } catch (e) {
        if (loading) { loading.classList.add("hidden"); loading.classList.remove("flex"); }
        if (selPanel) selPanel.classList.remove("hidden");

        alert("評分診斷初始化失敗（但教材參數/資料庫載入功能仍正常）。\n錯誤訊息: " + e.message);
      }
    }

    function backToSelection() {
      const selPanel = document.getElementById("selection-panel");
      const resultView = document.getElementById("result-view");
      const loading = document.getElementById("loading-view");

      if (loading) { loading.classList.add("hidden"); loading.classList.remove("flex"); }
      if (resultView) resultView.classList.add("hidden");
      if (selPanel) selPanel.classList.remove("hidden");
    }
  </script>

</body>
</html>
