<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Science Learning Hub | 學生測驗</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            student: { DEFAULT: "#3b82f6", dark: "#1d4ed8" }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Arial', 'sans-serif'],
            serif: ['"Noto Serif TC"', 'serif']
          }
        }
      }
    };
  </script>

  <style>
    body { font-family: Inter, system-ui, sans-serif; }
    .serif { font-family: "Noto Serif TC", serif; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <!-- Top bar (簡潔、學生風格) -->
  <header class="sticky top-0 z-40 bg-white/85 backdrop-blur border-b border-slate-200">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-student/10 text-student flex items-center justify-center">
          <i class="fa-solid fa-pen-to-square"></i>
        </div>
        <div>
          <div class="font-bold leading-tight">學生測驗</div>
          <div class="text-xs text-slate-500">選擇教材後開始作答</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <a href="./student.html" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50">
          <i class="fa-solid fa-arrow-left"></i>
          <span class="text-sm font-semibold">返回</span>
        </a>
        <span id="connBadge" class="text-xs px-3 py-2 rounded-xl border border-slate-200 bg-white text-slate-600">
          <i class="fa-solid fa-circle-notch fa-spin mr-1"></i>連線中
        </span>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-5">
    <!-- Step 1: 選教材 -->
    <section class="bg-white border border-slate-200 rounded-2xl p-4 md:p-5 shadow-sm">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="font-bold">
          1. 選擇教材
          <span class="ml-2 text-xs font-semibold text-slate-500">（先選年級與學期，再載入版本與單元）</span>
        </div>
        <button id="btnReload" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold">
          <i class="fa-solid fa-rotate mr-2"></i>重新載入
        </button>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">年級</label>
          <select id="selGrade" class="w-full px-3 py-3 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-4 focus:ring-student/15">
            <!-- 由 JS 填入 -->
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">學期</label>
          <select id="selSemester" class="w-full px-3 py-3 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-4 focus:ring-student/15">
            <option value="上學期">上學期</option>
            <option value="下學期">下學期</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">版本（出版社）</label>
          <select id="selPublisher" class="w-full px-3 py-3 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-4 focus:ring-student/15">
            <option value="">請先載入…</option>
          </select>
          <div class="text-xs text-slate-500 mt-1" id="publisherHint"></div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">單元</label>
          <select id="selUnit" class="w-full px-3 py-3 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-4 focus:ring-student/15">
            <option value="">請先載入…</option>
          </select>
          <div class="text-xs text-slate-500 mt-1" id="unitHint"></div>
        </div>
      </div>

      <div class="mt-4 flex items-center gap-3 flex-wrap">
        <div class="flex items-center gap-2">
          <span class="text-sm font-semibold text-slate-700">題數</span>
          <input id="inpN" type="number" min="5" max="40" step="1"
                 class="w-28 px-3 py-2 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-4 focus:ring-student/15"
                 value="15" />
          <span class="text-xs text-slate-500">（固定做完這個題數）</span>
        </div>

        <button id="btnStart"
                class="ml-auto inline-flex items-center gap-2 px-4 py-3 rounded-xl bg-student text-white font-bold hover:bg-student-dark disabled:opacity-60 disabled:cursor-not-allowed">
          <i class="fa-solid fa-play"></i>開始測驗
        </button>
      </div>

      <div class="mt-3 text-xs text-slate-500">
        若你是從 student.html 正常進來，系統會自動抓你的帳號做作答紀錄。
      </div>
    </section>

    <!-- Step 2: 作答 -->
    <section class="bg-white border border-slate-200 rounded-2xl p-4 md:p-5 shadow-sm">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="font-bold">2. 作答</div>
        <div class="flex items-center gap-2">
          <span class="text-xs px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-slate-700">
            進度：<span id="progText" class="font-bold">0/0</span>
          </span>
          <button id="btnFinish"
                  class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold disabled:opacity-60 disabled:cursor-not-allowed"
                  disabled>
            <i class="fa-solid fa-flag-checkered"></i>結束
          </button>
        </div>
      </div>

      <div class="mt-3 h-2 rounded-full bg-slate-100 overflow-hidden">
        <div id="progBar" class="h-full bg-student rounded-full" style="width:0%"></div>
      </div>

      <!-- Question -->
      <div class="mt-5" id="qArea">
        <div id="qEmpty" class="text-slate-500 text-sm">
          尚未開始測驗。請先在上方選擇教材後按「開始測驗」。
        </div>

        <div id="qWrap" class="hidden">
          <div class="text-xs text-slate-500">題目</div>
          <div id="qStem" class="serif text-[1.05rem] leading-relaxed mt-2 whitespace-pre-wrap"></div>

          <div class="mt-4 grid grid-cols-1 gap-3" id="optWrap"></div>

          <div class="mt-5 flex flex-col md:flex-row gap-3">
            <button id="btnSubmit"
                    class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-student text-white font-bold hover:bg-student-dark disabled:opacity-60 disabled:cursor-not-allowed"
                    disabled>
              <i class="fa-solid fa-paper-plane"></i>送出答案
            </button>
            <button id="btnNext"
                    class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 font-bold disabled:opacity-60 disabled:cursor-not-allowed"
                    disabled>
              <i class="fa-solid fa-forward"></i>下一題
            </button>
            <div class="flex-1 text-sm text-slate-500 flex items-center" id="hint">
              選擇一個選項後再送出。
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Result -->
    <section id="resultSec" class="hidden bg-white border border-slate-200 rounded-2xl p-4 md:p-5 shadow-sm">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="font-bold">測驗結果</div>
        <div class="flex items-center gap-2">
          <button id="btnCopy"
                  class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold">
            <i class="fa-solid fa-copy"></i>複製結果
          </button>
          <button id="btnRestart"
                  class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-student text-white font-bold hover:bg-student-dark">
            <i class="fa-solid fa-rotate-left"></i>再做一次
          </button>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
          <div class="text-xs text-slate-500">分數</div>
          <div id="resScore" class="text-3xl font-extrabold mt-1">—</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
          <div class="text-xs text-slate-500">測驗代碼</div>
          <div id="resTestId" class="mt-2 text-sm font-bold text-slate-800 break-all">—</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
          <div class="text-xs text-slate-500">回饋</div>
          <div id="resFeedback" class="mt-2 text-sm text-slate-700 whitespace-pre-wrap">—</div>
        </div>
      </div>

      <div class="mt-4 rounded-2xl border border-slate-200 bg-white p-4">
        <div class="text-sm font-bold text-slate-800">錯題清單</div>
        <div id="resWrong" class="mt-2 text-sm text-slate-700"></div>
      </div>
    </section>

    <!-- Simple toast -->
    <div id="toast" class="fixed bottom-4 right-4 hidden">
      <div class="max-w-sm bg-slate-900 text-white rounded-2xl px-4 py-3 shadow-lg">
        <div class="flex items-start gap-3">
          <div id="toastIcon" class="mt-0.5"><i class="fa-solid fa-circle-info"></i></div>
          <div class="flex-1">
            <div id="toastTitle" class="font-bold">提示</div>
            <div id="toastMsg" class="text-sm text-white/80 mt-1">—</div>
          </div>
        </div>
      </div>
    </div>
  </main>

<script>
/* ===========================
   0) 只要改這個：你的 GAS /exec
=========================== */
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxvAOgRDBE6T-2R37UeTzo0RSQukgGOlEYyBrTw8zUSOlIKNIzLdJXozjNx4Hn6brc2/exec";

/* 你的後端 action（不改後端就必須對齊） */
const ACTION = {
  GET_UNIT_OPTIONS: "getUnitOptions",
  START_CAT: "startCAT",
  SUBMIT_NEXT: "submitAndNext",
  FINISH_CAT: "finishCAT"
};

/* ===========================
   1) 全域狀態（精簡）
=========================== */
const Meta = {
  publishers: [],
  unitsByPublisher: {}
};

const CAT = {
  started: false,
  test_id: "",
  student_id: "",
  current: null,
  next: null,
  selected: "",
  n: 15,
  step: 0
};

/* ===========================
   2) UI 小工具（學生版）
=========================== */
const UI = {
  setConn(ok, msg){
    const b = document.getElementById("connBadge");
    if(ok){
      b.innerHTML = `<i class="fa-solid fa-circle-check mr-1"></i>已連線`;
      b.className = "text-xs px-3 py-2 rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-700";
    }else{
      b.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-1"></i>連線失敗`;
      b.className = "text-xs px-3 py-2 rounded-xl border border-amber-200 bg-amber-50 text-amber-800";
      if(msg) UI.toast("連線失敗", msg, "warn");
    }
  },
  toast(title, msg, type="info"){
    const t = document.getElementById("toast");
    const ic = document.getElementById("toastIcon");
    const tt = document.getElementById("toastTitle");
    const tm = document.getElementById("toastMsg");

    let icon = "fa-circle-info";
    if(type==="good") icon="fa-circle-check";
    if(type==="warn") icon="fa-triangle-exclamation";
    if(type==="bad") icon="fa-circle-xmark";
    ic.innerHTML = `<i class="fa-solid ${icon}"></i>`;

    tt.textContent = title || "提示";
    tm.textContent = msg || "";

    t.classList.remove("hidden");
    clearTimeout(UI._timer);
    UI._timer = setTimeout(()=>t.classList.add("hidden"), 4200);
  },
  setProgress(step, total){
    const txt = document.getElementById("progText");
    const bar = document.getElementById("progBar");
    txt.textContent = `${step}/${total}`;
    const pct = total ? Math.min(100, Math.round((step/total)*100)) : 0;
    bar.style.width = pct + "%";
  },
  showQuestion(show){
    document.getElementById("qEmpty").classList.toggle("hidden", show);
    document.getElementById("qWrap").classList.toggle("hidden", !show);
  },
  showResult(show){
    document.getElementById("resultSec").classList.toggle("hidden", !show);
  }
};

/* ===========================
   3) 取得 student_id（沿用 student.html）
   - 你 student.html 用哪個 key 存都可能不同
   - 這裡做「多 key 嘗試」：不改 student.html 也能吃到
=========================== */
function getStudentIdFromLogin(){
  // 常見 key（你可以在這裡加上你 student.html 實際使用的 key）
  const keys = [
    "student_id",
    "StudentID",
    "SLH_student_id",
    "slh_student_id",
    "user_student_id",
    "login_student_id",
    "current_student_id",
    "slh_user" // 可能是 JSON
  ];

  for(const k of keys){
    const v = localStorage.getItem(k);
    if(!v) continue;
    if(k === "slh_user"){
      try{
        const obj = JSON.parse(v);
        const sid = obj?.student_id || obj?.StudentID || obj?.id;
        if(sid) return String(sid);
      }catch(_){}
    }
    const s = String(v).trim();
    if(s) return s;
  }
  return "";
}

/* ===========================
   4) API 呼叫（重點：避免 CORS preflight）
   - 不送 Content-Type: application/json
   - 直接 body 放 JSON 字串，GAS 仍可 JSON.parse(e.postData.contents)
=========================== */
async function api(payload){
  const res = await fetch(GAS_API_URL, {
    method: "POST",
    body: JSON.stringify(payload),
    redirect: "follow"
  });

  const text = await res.text();
  let json = null;
  try{ json = JSON.parse(text); }catch(_){}
  if(!json) throw new Error("後端未回傳 JSON（請確認使用 /exec，且 doPost 回 JSON）。");
  if(json.ok !== true) throw new Error(json.error || "後端回傳失敗（ok=false）");
  return json;
}

async function ping(){
  try{
    const r = await fetch(GAS_API_URL, { method:"GET", redirect:"follow" });
    if(r.ok) UI.setConn(true);
    else UI.setConn(false, "HTTP " + r.status);
  }catch(e){
    UI.setConn(false, String(e?.message||e));
  }
}

/* ===========================
   5) 載入教材選單（確保不失敗）
=========================== */
function buildGradeOptions(){
  // 你也可以依 student.html 的年級來源自動帶入
  const sel = document.getElementById("selGrade");
  sel.innerHTML = "";
  // 這裡預設國小3-6、國中7-9，全列出比較不會「載不到」
  const grades = [3,4,5,6,7,8,9];
  for(const g of grades){
    const op = document.createElement("option");
    op.value = String(g);
    op.textContent = `${g}年級`;
    sel.appendChild(op);
  }
  sel.value = "4";
}

async function loadUnitOptions(){
  const grade = Number(document.getElementById("selGrade").value);
  const semester = document.getElementById("selSemester").value;

  document.getElementById("publisherHint").textContent = "載入中…";
  document.getElementById("unitHint").textContent = "";

  const json = await api({
    action: ACTION.GET_UNIT_OPTIONS,
    subject: "自然科學",
    grade,
    semester
  });

  Meta.publishers = Array.isArray(json.publishers) ? json.publishers : [];
  Meta.unitsByPublisher = json.unitsByPublisher || {};

  const selPub = document.getElementById("selPublisher");
  selPub.innerHTML = "";
  if(Meta.publishers.length === 0){
    selPub.innerHTML = `<option value="">（此年級/學期尚無題庫）</option>`;
    document.getElementById("publisherHint").textContent = "目前沒有可用的版本。";
  }else{
    for(const p of Meta.publishers){
      const op = document.createElement("option");
      op.value = p;
      op.textContent = p;
      selPub.appendChild(op);
    }
    document.getElementById("publisherHint").textContent = "已載入版本，請選擇。";
  }

  refreshUnitDropdown();
}

function refreshUnitDropdown(){
  const pub = document.getElementById("selPublisher").value.trim();
  const units = (Meta.unitsByPublisher && Meta.unitsByPublisher[pub]) ? Meta.unitsByPublisher[pub] : [];
  const selUnit = document.getElementById("selUnit");
  selUnit.innerHTML = "";

  if(!units || units.length === 0){
    selUnit.innerHTML = `<option value="">（此版本尚無單元）</option>`;
    document.getElementById("unitHint").textContent = "請先確認此版本是否已建立題庫。";
    return;
  }

  for(const u of units){
    const op = document.createElement("option");
    op.value = u;
    op.textContent = u;
    selUnit.appendChild(op);
  }
  document.getElementById("unitHint").textContent = "已載入單元，請選擇。";
}

/* ===========================
   6) 測驗流程（固定題數 N）
   - 不顯示 min/max/SE
   - 但送給後端：min_items=N、max_items=N、stop_se=0（通常可確保做滿 N 題）
=========================== */
function getUnit(){
  return {
    subject: "自然科學",
    grade: Number(document.getElementById("selGrade").value),
    semester: document.getElementById("selSemester").value,
    textbook_version: document.getElementById("selPublisher").value.trim(),
    unit_name: document.getElementById("selUnit").value.trim()
  };
}

function normalizeItem(raw){
  if(!raw) return null;
  const optObj = raw.options || {};
  return {
    item_id: String(raw.item_id || "").trim(),
    stem: String(raw.stem || "").trim(),
    options: {
      A: String(raw.option_A ?? optObj.A ?? ""),
      B: String(raw.option_B ?? optObj.B ?? ""),
      C: String(raw.option_C ?? optObj.C ?? ""),
      D: String(raw.option_D ?? optObj.D ?? "")
    }
  };
}

function renderItem(item){
  UI.showQuestion(true);

  document.getElementById("qStem").textContent = item.stem || "";
  const wrap = document.getElementById("optWrap");
  wrap.innerHTML = "";

  CAT.selected = "";
  document.getElementById("btnSubmit").disabled = true;
  document.getElementById("btnNext").disabled = true;
  document.getElementById("hint").textContent = "選擇一個選項後再送出。";

  const letters = ["A","B","C","D"];
  for(const L of letters){
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className =
      "text-left w-full px-4 py-4 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 " +
      "focus:outline-none focus:ring-4 focus:ring-student/15";

    btn.setAttribute("data-letter", L);
    btn.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="w-10 h-10 rounded-xl bg-student/10 text-student flex items-center justify-center font-extrabold">${L}</div>
        <div class="flex-1 text-slate-800 leading-relaxed">${escapeHtml(item.options[L] || "")}</div>
      </div>
    `;

    btn.onclick = () => selectOption(L);
    wrap.appendChild(btn);
  }
}

function selectOption(letter){
  CAT.selected = letter;
  document.querySelectorAll("#optWrap button").forEach(b=>{
    const isSel = b.getAttribute("data-letter") === letter;
    b.classList.toggle("border-student", isSel);
    b.classList.toggle("bg-student/5", isSel);
  });
  document.getElementById("btnSubmit").disabled = false;
  document.getElementById("hint").textContent = `已選擇 ${letter}，請按「送出答案」。`;
}

async function startTest(){
  const unit = getUnit();
  if(!unit.textbook_version || !unit.unit_name){
    UI.toast("資料不足", "請先選擇版本與單元。", "warn");
    return;
  }

  const sid = getStudentIdFromLogin();
  if(!sid){
    UI.toast("未登入", "找不到你的登入資訊。請從 student.html 登入後再進入測驗。", "warn");
    return;
  }

  const n = clampNum(Number(document.getElementById("inpN").value), 5, 40, 15);
  CAT.n = n;

  document.getElementById("btnStart").disabled = true;

  try{
    const json = await api({
      action: ACTION.START_CAT,
      student: { student_id: sid },
      unit,
      settings: { max_items: n }
    });

    CAT.started = true;
    CAT.student_id = sid;
    CAT.test_id = json.test_id || "";
    CAT.step = 0;

    const first = normalizeItem(json.item);
    if(!first) throw new Error("後端未提供第一題。");

    CAT.current = first;
    CAT.next = null;

    UI.setProgress(0, CAT.n);
    document.getElementById("btnFinish").disabled = false;

    renderItem(first);
    UI.toast("開始作答", "測驗已開始。", "good");
  }catch(e){
    const msg = String(e?.message || e);
    UI.toast("開始失敗", msg, "bad");
  }finally{
    document.getElementById("btnStart").disabled = false;
  }
}

async function submitAnswer(){
  if(!CAT.started || !CAT.current) return;
  if(!CAT.selected){
    UI.toast("尚未選擇", "請先選擇一個選項。", "warn");
    return;
  }

  document.getElementById("btnSubmit").disabled = true;
  document.getElementById("btnNext").disabled = true;
  document.getElementById("hint").textContent = "送出中…";

  const unit = getUnit();

  try{
    const json = await api({
      action: ACTION.SUBMIT_NEXT,
      test_id: CAT.test_id,
      student_id: CAT.student_id,
      item_id: CAT.current.item_id,
      response_option: CAT.selected,

      // 固定題數：min=max=N，stop_se=0（不提前停）
      max_items: CAT.n,
      min_items: CAT.n,
      stop_se: 0,

      // 記錄欄位（若後端有用）
      grade: String(unit.grade || "")
    });

    // 進度
    const prog = json.progress || {};
    CAT.step = Number(prog.n_admin || (CAT.step + 1));
    UI.setProgress(CAT.step, CAT.n);

    if(json.done === true || CAT.step >= CAT.n){
      await finishTest();
      return;
    }

    const next = normalizeItem(json.item);
    if(!next) throw new Error("後端未提供下一題。");

    CAT.next = next;
    document.getElementById("btnNext").disabled = false;
    document.getElementById("hint").textContent = "已取得下一題，按「下一題」繼續。";
  }catch(e){
    UI.toast("送出失敗", String(e?.message||e), "bad");
    document.getElementById("btnSubmit").disabled = false;
    document.getElementById("hint").textContent = "送出失敗，請重試。";
  }
}

function goNext(){
  if(!CAT.next) return;
  CAT.current = CAT.next;
  CAT.next = null;
  renderItem(CAT.current);
}

async function finishTest(){
  document.getElementById("btnFinish").disabled = true;
  document.getElementById("btnSubmit").disabled = true;
  document.getElementById("btnNext").disabled = true;

  try{
    const json = await api({
      action: ACTION.FINISH_CAT,
      test_id: CAT.test_id,
      student_id: CAT.student_id
    });

    UI.showResult(true);
    document.getElementById("resScore").textContent = json.score ?? "—";
    document.getElementById("resTestId").textContent = json.test_id ?? "—";
    document.getElementById("resFeedback").textContent = json.feedback_student ?? "—";
    document.getElementById("resWrong").innerHTML = renderWrong(json.wrong_items || []);

    UI.toast("完成", "已產生結果。", "good");

    CAT.started = false;
    document.getElementById("btnFinish").disabled = true;
  }catch(e){
    UI.toast("結束失敗", String(e?.message||e), "bad");
    document.getElementById("btnFinish").disabled = false;
  }
}

function resetAll(){
  CAT.started = false;
  CAT.test_id = "";
  CAT.current = null;
  CAT.next = null;
  CAT.selected = "";
  CAT.step = 0;

  UI.setProgress(0, Number(document.getElementById("inpN").value) || 0);
  UI.showQuestion(false);
  UI.showResult(false);

  document.getElementById("btnFinish").disabled = true;
  document.getElementById("btnSubmit").disabled = true;
  document.getElementById("btnNext").disabled = true;
}

/* ===========================
   7) 輔助
=========================== */
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}
function clampNum(x, lo, hi, fallback){
  const n = Number(x);
  if(!Number.isFinite(n)) return fallback;
  return Math.max(lo, Math.min(hi, n));
}
function renderWrong(arr){
  const xs = Array.isArray(arr) ? arr : [];
  if(xs.length === 0) return `<div class="text-slate-500">沒有錯題</div>`;
  return xs.map(w=>{
    const id = escapeHtml(w.item_id || "");
    const ct = escapeHtml(w.concept_tag || "");
    const src = escapeHtml(w.textbook_source || "");
    const meta = [ct, src].filter(Boolean).join("｜");
    return `
      <div class="py-2 border-b border-slate-200 last:border-b-0">
        <div class="font-bold text-slate-800">${id}</div>
        <div class="text-xs text-slate-500 mt-1">${meta || "—"}</div>
      </div>
    `;
  }).join("");
}

/* ===========================
   8) 初始化與事件
=========================== */
document.addEventListener("DOMContentLoaded", async ()=>{
  buildGradeOptions();
  resetAll();

  // 預設進度顯示
  UI.setProgress(0, clampNum(Number(document.getElementById("inpN").value),5,40,15));

  // 連線與載入
  await ping();
  try{
    await loadUnitOptions();
    UI.toast("載入完成", "教材選單已載入。", "good");
  }catch(e){
    UI.toast("載入失敗", String(e?.message||e), "bad");
  }

  // 事件
  document.getElementById("btnReload").addEventListener("click", async ()=>{
    try{
      await loadUnitOptions();
      UI.toast("已更新", "教材選單已重新載入。", "good");
    }catch(e){
      UI.toast("載入失敗", String(e?.message||e), "bad");
    }
  });

  document.getElementById("selGrade").addEventListener("change", async ()=>{
    try{ await loadUnitOptions(); }catch(e){ UI.toast("載入失敗", String(e?.message||e), "bad"); }
  });

  document.getElementById("selSemester").addEventListener("change", async ()=>{
    try{ await loadUnitOptions(); }catch(e){ UI.toast("載入失敗", String(e?.message||e), "bad"); }
  });

  document.getElementById("selPublisher").addEventListener("change", refreshUnitDropdown);

  document.getElementById("inpN").addEventListener("change", ()=>{
    const n = clampNum(Number(document.getElementById("inpN").value),5,40,15);
    document.getElementById("inpN").value = n;
    if(!CAT.started) UI.setProgress(0, n);
  });

  document.getElementById("btnStart").addEventListener("click", startTest);
  document.getElementById("btnSubmit").addEventListener("click", submitAnswer);
  document.getElementById("btnNext").addEventListener("click", goNext);
  document.getElementById("btnFinish").addEventListener("click", finishTest);

  document.getElementById("btnRestart").addEventListener("click", ()=>{
    resetAll();
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  document.getElementById("btnCopy").addEventListener("click", async ()=>{
    const text =
`score: ${document.getElementById("resScore").textContent}
test_id: ${document.getElementById("resTestId").textContent}

feedback:
${document.getElementById("resFeedback").textContent}`;
    try{
      await navigator.clipboard.writeText(text);
      UI.toast("已複製", "結果已複製到剪貼簿。", "good");
    }catch(_){
      UI.toast("複製失敗", "瀏覽器未授權剪貼簿。", "warn");
    }
  });

  // 學生版：鍵盤 A/B/C/D 直接選，Enter 送出
  document.addEventListener("keydown", (ev)=>{
    if(!CAT.started) return;
    const k = String(ev.key||"").toUpperCase();
    if(["A","B","C","D"].includes(k)){
      selectOption(k);
      ev.preventDefault();
    }
    if(k === "ENTER"){
      if(!document.getElementById("btnSubmit").disabled) submitAnswer();
      ev.preventDefault();
    }
  });
});
</script>
</body>
</html>
