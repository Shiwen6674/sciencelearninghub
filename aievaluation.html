<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Science Learning Hub | AI測驗與診斷</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            student: { DEFAULT: "#3b82f6", dark: "#1d4ed8" }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Arial', 'sans-serif'],
            serif: ['"Noto Serif TC"', 'serif']
          }
        }
      }
    };
  </script>

  <style>
    body { font-family: Inter, system-ui, sans-serif; }
    .serif { font-family: "Noto Serif TC", serif; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <!-- Top bar -->
  <header class="sticky top-0 z-40 bg-white/85 backdrop-blur border-b border-slate-200">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <!-- Left: Back + Title -->
      <div class="flex items-center gap-3 min-w-0">
        <a href="./student.html" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50">
          <i class="fa-solid fa-arrow-left"></i>
          <span class="text-sm font-semibold">返回學習中心</span>
        </a>

        <div class="hidden sm:flex items-center gap-3 min-w-0">
          <div class="w-10 h-10 rounded-xl bg-student/10 text-student flex items-center justify-center shrink-0">
            <i class="fa-solid fa-pen-to-square"></i>
          </div>
          <div class="min-w-0">
            <div class="font-bold leading-tight truncate">AI測驗與診斷</div>
            <div class="text-xs text-slate-500 truncate">選擇教材後開始作答</div>
          </div>
        </div>
      </div>

      <!-- Right: Connection -->
      <span id="connBadge" class="text-xs px-3 py-2 rounded-xl border border-slate-200 bg-white text-slate-600 shrink-0">
        <i class="fa-solid fa-circle-notch fa-spin mr-1"></i>連線中
      </span>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-5">
    <!-- Step 1: 選教材 -->
    <section class="bg-white border border-slate-200 rounded-2xl p-4 md:p-5 shadow-sm">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="font-bold">
          1. 選擇教材
          <span class="ml-2 text-xs font-semibold text-slate-500">（選擇學習階段、年級、學期、版本、單元）</span>
        </div>
        <button id="btnReload" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold">
          <i class="fa-solid fa-rotate mr-2"></i>重新載入
        </button>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">學習階段</label>
          <select id="selStage" class="w-full px-3 py-3 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-4 focus:ring-student/15">
            <option value="">載入中…</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">年級</label>
          <select id="selGrade" class="w-full px-3 py-3 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-4 focus:ring-student/15">
            <option value="">請先選擇學習階段…</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">學期</label>
          <select id="selSemester" class="w-full px-3 py-3 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-4 focus:ring-student/15">
            <option value="">請先選擇年級…</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-1">版本</label>
          <select id="selPublisher" class="w-full px-3 py-3 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-4 focus:ring-student/15">
            <option value="">請先載入…</option>
          </select>
          <div class="text-xs text-slate-500 mt-1" id="publisherHint"></div>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-semibold text-slate-700 mb-1">單元</label>
          <select id="selUnit" class="w-full px-3 py-3 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-4 focus:ring-student/15">
            <option value="">請先載入…</option>
          </select>
          <div class="text-xs text-slate-500 mt-1" id="unitHint"></div>
        </div>
      </div>

      <div class="mt-4 flex items-center gap-3 flex-wrap">
        <div class="flex items-center gap-2">
          <span class="text-sm font-semibold text-slate-700">題數</span>
          <input id="inpN" type="number" min="5" max="40" step="1"
                 class="w-28 px-3 py-2 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-4 focus:ring-student/15"
                 value="15" />
        </div>

        <button id="btnStart"
                class="ml-auto inline-flex items-center gap-2 px-4 py-3 rounded-xl bg-student text-white font-bold hover:bg-student-dark disabled:opacity-60 disabled:cursor-not-allowed">
          <i class="fa-solid fa-play"></i>開始測驗
        </button>
      </div>
    </section>

    <!-- Step 2: 作答 -->
    <section class="bg-white border border-slate-200 rounded-2xl p-4 md:p-5 shadow-sm">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="font-bold">2. 作答</div>
        <div class="flex items-center gap-2">
          <span class="text-xs px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-slate-700">
            進度：<span id="progText" class="font-bold">0/0</span>
          </span>
          <button id="btnFinish"
                  class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold disabled:opacity-60 disabled:cursor-not-allowed"
                  disabled>
            <i class="fa-solid fa-flag-checkered"></i>結束
          </button>
        </div>
      </div>

      <div class="mt-3 h-2 rounded-full bg-slate-100 overflow-hidden">
        <div id="progBar" class="h-full bg-student rounded-full" style="width:0%"></div>
      </div>

      <!-- Question -->
      <div class="mt-5" id="qArea">
        <div id="qEmpty" class="text-slate-500 text-sm">
          尚未開始測驗。請先在上方選擇教材後按「開始測驗」。
        </div>

        <div id="qWrap" class="hidden">
          <div class="text-xs text-slate-500">題目</div>
          <div id="qStem" class="serif text-[1.05rem] leading-relaxed mt-2 whitespace-pre-wrap"></div>

          <div class="mt-4 grid grid-cols-1 gap-3" id="optWrap"></div>

          <div class="mt-5 flex flex-col md:flex-row gap-3">
            <button id="btnSubmit"
                    class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-student text-white font-bold hover:bg-student-dark disabled:opacity-60 disabled:cursor-not-allowed"
                    disabled>
              <i class="fa-solid fa-paper-plane"></i>送出答案
            </button>
            <button id="btnNext"
                    class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 font-bold disabled:opacity-60 disabled:cursor-not-allowed"
                    disabled>
              <i class="fa-solid fa-forward"></i>下一題
            </button>
            <div class="flex-1 text-sm text-slate-500 flex items-center" id="hint">
              選擇一個選項後再送出。
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Result -->
    <section id="resultSec" class="hidden bg-white border border-slate-200 rounded-2xl p-4 md:p-5 shadow-sm">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="font-bold">測驗結果</div>
        <div class="flex items-center gap-2">
          <button id="btnCopy"
                  class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold">
            <i class="fa-solid fa-copy"></i>複製結果
          </button>
          <button id="btnRestart"
                  class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-student text-white font-bold hover:bg-student-dark">
            <i class="fa-solid fa-rotate-left"></i>再做一次
          </button>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
          <div class="text-xs text-slate-500">分數</div>
          <div id="resScore" class="text-3xl font-extrabold mt-1">—</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
          <div class="text-xs text-slate-500">測驗代碼</div>
          <div id="resTestId" class="mt-2 text-sm font-bold text-slate-800 break-all">—</div>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
          <div class="text-xs text-slate-500">回饋</div>
          <div id="resFeedback" class="mt-2 text-sm text-slate-700 whitespace-pre-wrap">—</div>
        </div>
      </div>

      <div class="mt-4 rounded-2xl border border-slate-200 bg-white p-4">
        <div class="text-sm font-bold text-slate-800">錯題清單</div>
        <div id="resWrong" class="mt-2 text-sm text-slate-700"></div>
      </div>
    </section>

    <!-- Simple toast -->
    <div id="toast" class="fixed bottom-4 right-4 hidden">
      <div class="max-w-sm bg-slate-900 text-white rounded-2xl px-4 py-3 shadow-lg">
        <div class="flex items-start gap-3">
          <div id="toastIcon" class="mt-0.5"><i class="fa-solid fa-circle-info"></i></div>
          <div class="flex-1">
            <div id="toastTitle" class="font-bold">提示</div>
            <div id="toastMsg" class="text-sm text-white/80 mt-1">—</div>
          </div>
        </div>
      </div>
    </div>
  </main>

<script>
/* ===========================
   0) 只要改這個：你的 GAS /exec
=========================== */
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxvAOgRDBE6T-2R37UeTzo0RSQukgGOlEYyBrTw8zUSOlIKNIzLdJXozjNx4Hn6brc2/exec";

/* 你要抓的內容試算表（提供給後端用；後端若已內建可忽略） */
const CONTENT_DB_ID = "1cEfMEy3bvDa1tET3xmh7ShGeJy8KLUMa_JuULGBD-mk";
const CONTENT_SHEET_NAME = "Sheet1";

/* 你的後端 action（不改後端就必須對齊） */
const ACTION = {
  /* 既有：題庫選單/測驗流程 */
  GET_UNIT_OPTIONS: "getUnitOptions",
  START_CAT: "startCAT",
  SUBMIT_NEXT: "submitAndNext",
  FINISH_CAT: "finishCAT"
};

/* 可能存在於「單元重點整理」後端的教材選單 action（前端自動嘗試，不需要你改 UI） */
const META_ACTION_CANDIDATES = [
  "get_metadata",          // ★ 這個是你上面成功載入的 action
  "getMaterialTree",
  "getTextbookMeta",
  "getContentMeta",
  "getContentOptions",
  "getTextbookOptions",
  "getLessonOptions",
  ACTION.GET_UNIT_OPTIONS
];
/* ===========================
   1) 全域狀態（精簡）
=========================== */
const Meta = {
  mode: "tree",     // tree | legacy
  tree: {},         // stage -> grade -> semester -> version -> units[]
  unitIndex: {},    // key -> {lesson_no, lesson_name, unit_name, ...}
  publishers: [],   // legacy
  unitsByPublisher: {} // legacy
};

const CAT = {
  started: false,
  test_id: "",
  student_id: "",
  current: null,
  next: null,
  selected: "",
  n: 15,
  step: 0
};

/* ===========================
   2) UI 小工具
=========================== */
const UI = {
  setConn(ok, msg){
    const b = document.getElementById("connBadge");
    if(ok){
      b.innerHTML = `<i class="fa-solid fa-circle-check mr-1"></i>已連線`;
      b.className = "text-xs px-3 py-2 rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-700 shrink-0";
    }else{
      b.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-1"></i>連線失敗`;
      b.className = "text-xs px-3 py-2 rounded-xl border border-amber-200 bg-amber-50 text-amber-800 shrink-0";
      if(msg) UI.toast("連線失敗", msg, "warn");
    }
  },
  toast(title, msg, type="info"){
    const t = document.getElementById("toast");
    const ic = document.getElementById("toastIcon");
    const tt = document.getElementById("toastTitle");
    const tm = document.getElementById("toastMsg");

    let icon = "fa-circle-info";
    if(type==="good") icon="fa-circle-check";
    if(type==="warn") icon="fa-triangle-exclamation";
    if(type==="bad") icon="fa-circle-xmark";
    ic.innerHTML = `<i class="fa-solid ${icon}"></i>`;

    tt.textContent = title || "提示";
    tm.textContent = msg || "";

    t.classList.remove("hidden");
    clearTimeout(UI._timer);
    UI._timer = setTimeout(()=>t.classList.add("hidden"), 4200);
  },
  setProgress(step, total){
    const txt = document.getElementById("progText");
    const bar = document.getElementById("progBar");
    txt.textContent = `${step}/${total}`;
    const pct = total ? Math.min(100, Math.round((step/total)*100)) : 0;
    bar.style.width = pct + "%";
  },
  showQuestion(show){
    document.getElementById("qEmpty").classList.toggle("hidden", show);
    document.getElementById("qWrap").classList.toggle("hidden", !show);
  },
  showResult(show){
    document.getElementById("resultSec").classList.toggle("hidden", !show);
  }
};

/* ===========================
   3) 取得 student_id（沿用 student.html）
=========================== */
function getStudentIdFromLogin(){
  const keys = [
    "student_id",
    "StudentID",
    "SLH_student_id",
    "slh_student_id",
    "user_student_id",
    "login_student_id",
    "current_student_id",
    "slh_user"
  ];

  for(const k of keys){
    const v = localStorage.getItem(k);
    if(!v) continue;
    if(k === "slh_user"){
      try{
        const obj = JSON.parse(v);
        const sid = obj?.student_id || obj?.StudentID || obj?.id;
        if(sid) return String(sid);
      }catch(_){}
    }
    const s = String(v).trim();
    if(s) return s;
  }
  return "";
}

/* ===========================
   4) API 呼叫（GET → form POST → JSON POST 三段式）
=========================== */
function buildFormBody(payload){
  const p = new URLSearchParams();
  const action = payload?.action ?? "";
  if(action) p.set("action", action);

  // 讓後端能知道你要抓哪份試算表（若後端已內建，可忽略）
  if(payload?.content_db_id) p.set("content_db_id", String(payload.content_db_id));
  if(payload?.sheet_name)    p.set("sheet_name", String(payload.sheet_name));

  // 兼容：有些後端用 payload 參數整包 JSON.parse
  p.set("payload", JSON.stringify(payload ?? {}));

  if(payload?.subject != null)  p.set("subject", String(payload.subject));
  if(payload?.stage != null)    p.set("stage", String(payload.stage));
  if(payload?.grade != null)    p.set("grade", String(payload.grade));
  if(payload?.semester != null) p.set("semester", String(payload.semester));

  const unit = payload?.unit;
  if(unit){
    if(unit.subject != null)          p.set("subject", String(unit.subject));
    if(unit.stage != null)            p.set("stage", String(unit.stage));
    if(unit.grade != null)            p.set("grade", String(unit.grade));
    if(unit.semester != null)         p.set("semester", String(unit.semester));
    if(unit.textbook_version != null) p.set("textbook_version", String(unit.textbook_version));
    if(unit.unit_name != null)        p.set("unit_name", String(unit.unit_name));
    if(unit.lesson_no != null)        p.set("lesson_no", String(unit.lesson_no));
    if(unit.lesson_name != null)      p.set("lesson_name", String(unit.lesson_name));
    if(unit.unit_key != null)         p.set("unit_key", String(unit.unit_key));
  }

  const sid = payload?.student_id ?? payload?.student?.student_id;
  if(sid != null) p.set("student_id", String(sid));

  const keys = ["test_id","item_id","response_option","max_items","min_items","stop_se","grade"];
  for(const k of keys){
    if(payload?.[k] != null) p.set(k, String(payload[k]));
  }

  const settings = payload?.settings;
  if(settings){
    if(settings.max_items != null && !p.has("max_items")) p.set("max_items", String(settings.max_items));
    if(settings.min_items != null && !p.has("min_items")) p.set("min_items", String(settings.min_items));
    if(settings.stop_se  != null && !p.has("stop_se"))   p.set("stop_se",  String(settings.stop_se));
  }

  return p;
}

function safeParseJSON(text){
  const t = String(text ?? "").trim().replace(/^\)\]\}'\s*\n?/, "");
  try { return JSON.parse(t); } catch { return null; }
}

function normalizeOk(obj){
  if(!obj || typeof obj !== "object") throw new Error("後端未回傳 JSON。");

  // ★ 新增：兼容你上方成功頁面的回傳格式
  const st = String(obj.status ?? "").toLowerCase();
  if(st === "error" || st === "fail" || st === "failed"){
    throw new Error(obj.message || obj.error || "後端回傳失敗（status=error）。");
  }
  if(st === "success"){
    return { ...obj, ok: true };
  }

  if(obj.ok === false) throw new Error(obj.error || obj.message || "後端回傳失敗（ok=false）。");
  if(obj.success === false) throw new Error(obj.error || obj.message || "後端回傳失敗（success=false）。");
  if(obj.ok === true) return obj;
  if(obj.success === true) return { ...obj, ok: true };
  if(obj.error) throw new Error(obj.error);
  if(obj.message && st) throw new Error(obj.message);

  return { ...obj, ok: true };
}


async function api(payload){
  let lastErr = null;

  // A) GET（對「載入選單」特別友善）
  try{
    const url = new URL(GAS_API_URL);
    if(payload?.action) url.searchParams.set("action", payload.action);

    // 常用參數
    if(payload?.content_db_id) url.searchParams.set("content_db_id", String(payload.content_db_id));
    if(payload?.sheet_name)    url.searchParams.set("sheet_name", String(payload.sheet_name));
    if(payload?.subject != null)  url.searchParams.set("subject", String(payload.subject));
    if(payload?.stage != null)    url.searchParams.set("stage", String(payload.stage));
    if(payload?.grade != null)    url.searchParams.set("grade", String(payload.grade));
    if(payload?.semester != null) url.searchParams.set("semester", String(payload.semester));

    const res = await fetch(url.toString(), { method: "GET", redirect: "follow" });
    const text = await res.text();
    const json = safeParseJSON(text);
    if(json) return normalizeOk(json);
    throw new Error("後端未回傳 JSON（GET）。");
  }catch(e){
    lastErr = e;
  }

  // B) POST x-www-form-urlencoded（最相容 e.parameter）
  try{
    const formBody = buildFormBody(payload);
    const res = await fetch(GAS_API_URL, { method: "POST", body: formBody, redirect: "follow" });
    const text = await res.text();
    const json = safeParseJSON(text);
    if(json) return normalizeOk(json);
    throw new Error("後端未回傳 JSON（form POST）。");
  }catch(e){
    lastErr = e;
  }

  // C) JSON POST（保底）
  try{
    const res = await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload), redirect: "follow" });
    const text = await res.text();
    const json = safeParseJSON(text);
    if(json) return normalizeOk(json);
    throw new Error("後端未回傳 JSON（JSON POST）。");
  }catch(e){
    throw new Error(String(e?.message || lastErr?.message || e));
  }
}

async function ping(){
  try{
    const r = await fetch(GAS_API_URL, { method:"GET", redirect:"follow" });
    UI.setConn(!!r.ok, r.ok ? "" : ("HTTP " + r.status));
  }catch(e){
    UI.setConn(false, String(e?.message||e));
  }
}

/* ===========================
   5) 由試算表建立「學習階段→年級→學期→版本→單元」樹
   - 盡量兼容不同後端回傳格式
=========================== */
function normStage(v){
  const s = String(v ?? "").trim();
  if(!s) return "";
  if(s.includes("國小") || s === "小學") return "國小";
  if(s.includes("國中") || s === "國中部") return "國中";
  return s;
}
function normSemester(v){
  const s = String(v ?? "").trim();
  if(!s) return "";
  if(s.includes("上")) return "上學期";
  if(s.includes("下")) return "下學期";
  return s;
}
function normVersion(v){
  return String(v ?? "").trim();
}
function normLessonNo(v){
  return String(v ?? "").trim();
}
function normLessonName(v){
  return String(v ?? "").trim();
}
function toIntGrade(v){
  const n = Number(String(v ?? "").replace(/[^\d]/g, ""));
  return Number.isFinite(n) ? n : NaN;
}

function buildTreeFromRows(rows){
  const tree = {};
  const unitIndex = {};

  for(const r of rows){
    const stage = normStage(r.stage ?? r["中小學"] ?? r["學習階段"] ?? r.level ?? r.school_stage);
    const grade = toIntGrade(r.grade ?? r["年級"]);
    const semester = normSemester(r.semester ?? r["學期"]);
    const version = normVersion(r.textbook_version ?? r.publisher ?? r["版本"] ?? r["出版社"]);
    const lessonNo = normLessonNo(r.lesson_no ?? r["課別"] ?? r.unit_no ?? r["課序"]);
    const lessonName = normLessonName(r.lesson_name ?? r["課名"] ?? r.unit_name ?? r["單元"] ?? r["單元名稱"]);

    if(!stage || !Number.isFinite(grade) || !semester || !version || !lessonName) continue;

    const unitName = (lessonNo ? `${lessonNo} ${lessonName}` : lessonName).trim();
    const unitKey = `${stage}||${grade}||${semester}||${version}||${lessonNo}||${lessonName}`;

    if(!tree[stage]) tree[stage] = {};
    if(!tree[stage][grade]) tree[stage][grade] = {};
    if(!tree[stage][grade][semester]) tree[stage][grade][semester] = {};
    if(!tree[stage][grade][semester][version]) tree[stage][grade][semester][version] = [];

    tree[stage][grade][semester][version].push({ unit_key: unitKey, lesson_no: lessonNo, lesson_name: lessonName, unit_name: unitName });

    unitIndex[unitKey] = { unit_key: unitKey, stage, grade, semester, textbook_version: version, lesson_no: lessonNo, lesson_name: lessonName, unit_name: unitName };
  }

  // 去重 + 排序
  for(const st of Object.keys(tree)){
    for(const g of Object.keys(tree[st])){
      for(const sem of Object.keys(tree[st][g])){
        for(const ver of Object.keys(tree[st][g][sem])){
          const arr = tree[st][g][sem][ver] || [];
          const seen = new Set();
          const uniq = [];
          for(const u of arr){
            if(seen.has(u.unit_key)) continue;
            seen.add(u.unit_key);
            uniq.push(u);
          }
          uniq.sort((a,b)=>{
            // 課別可排序：先比數字（若可抽），再比字串
            const an = Number(String(a.lesson_no||"").replace(/[^\d]/g,""));
            const bn = Number(String(b.lesson_no||"").replace(/[^\d]/g,""));
            if(Number.isFinite(an) && Number.isFinite(bn) && an !== bn) return an - bn;
            return String(a.unit_name).localeCompare(String(b.unit_name), "zh-Hant");
          });
          tree[st][g][sem][ver] = uniq;
        }
      }
    }
  }

  return { tree, unitIndex };
}

/* 後端若只回傳 publishers / unitsByPublisher（舊 getUnitOptions），仍可做最低限度相容 */
function buildTreeFromLegacy(publishers, unitsByPublisher, grade, semester){
  const tree = {};
  const unitIndex = {};
  const st = (grade <= 6) ? "國小" : "國中";
  const sem = normSemester(semester);
  tree[st] = {};
  tree[st][grade] = {};
  tree[st][grade][sem] = {};

  for(const ver of (publishers || [])){
    const units = (unitsByPublisher && unitsByPublisher[ver]) ? unitsByPublisher[ver] : [];
    tree[st][grade][sem][ver] = [];
    for(const u of units){
      const unitName = String(u ?? "").trim();
      if(!unitName) continue;
      const unitKey = `${st}||${grade}||${sem}||${ver}||||${unitName}`;
      tree[st][grade][sem][ver].push({ unit_key: unitKey, lesson_no: "", lesson_name: unitName, unit_name: unitName });
      unitIndex[unitKey] = { unit_key: unitKey, stage: st, grade, semester: sem, textbook_version: ver, lesson_no: "", lesson_name: unitName, unit_name: unitName };
    }
  }

  return { tree, unitIndex };
}

/* 嘗試從後端抓完整教材樹（一次載入、下拉選單全連動） */
async function loadMaterialTree(){
  let lastErr = null;

  for(const act of META_ACTION_CANDIDATES){
    try{
      const json = await api({
        action: act,
        content_db_id: CONTENT_DB_ID,
        sheet_name: CONTENT_SHEET_NAME,
        // 若後端需要 subject 才會過濾
        subject: "自然科學"
      });

      // 1) 直接給 tree
      if(json.tree && typeof json.tree === "object"){
        // 期待格式：tree[stage][grade][semester][version] = units[]
        // 若後端已給 unitIndex 也吃
        Meta.tree = json.tree;
        Meta.unitIndex = json.unitIndex || {};
        Meta.mode = "tree";
        return true;
      }

      // 2) rows / data / items 形式
      const rows = json.rows || json.data || json.items || json.materials;
      if(Array.isArray(rows) && rows.length){
        const built = buildTreeFromRows(rows);
        Meta.tree = built.tree;
        Meta.unitIndex = built.unitIndex;
        Meta.mode = "tree";
        return true;
      }

      // 3) 舊 getUnitOptions：publishers + unitsByPublisher
      if(Array.isArray(json.publishers) && json.unitsByPublisher){
        // 只能依「年級+學期」載入（仍可運作，但連動範圍較小）
        Meta.publishers = json.publishers;
        Meta.unitsByPublisher = json.unitsByPublisher;
        Meta.mode = "legacy";
        return true;
      }

      // 4) 其他格式：嘗試把 json 當 rows（保守）
      if(Array.isArray(json) && json.length){
        const built = buildTreeFromRows(json);
        Meta.tree = built.tree;
        Meta.unitIndex = built.unitIndex;
        Meta.mode = "tree";
        return true;
      }

      throw new Error("回傳格式不含教材選單資料。");
    }catch(e){
      lastErr = e;
    }
  }

  throw new Error(String(lastErr?.message || lastErr || "無法載入教材選單。"));
}

/* ===========================
   6) 下拉選單：全連動（stage→grade→semester→version→unit）
=========================== */
function setOptions(selectEl, options, placeholder){
  selectEl.innerHTML = "";
  if(!options || options.length === 0){
    const op = document.createElement("option");
    op.value = "";
    op.textContent = placeholder || "（無資料）";
    selectEl.appendChild(op);
    return;
  }
  for(const {value, label} of options){
    const op = document.createElement("option");
    op.value = String(value);
    op.textContent = String(label);
    selectEl.appendChild(op);
  }
}

function getSelStage(){ return document.getElementById("selStage").value.trim(); }
function getSelGrade(){ return Number(document.getElementById("selGrade").value); }
function getSelSemester(){ return document.getElementById("selSemester").value.trim(); }
function getSelVersion(){ return document.getElementById("selPublisher").value.trim(); }
function getSelUnitKey(){ return document.getElementById("selUnit").value.trim(); }

function refreshAllDropdowns(){
  const selStage = document.getElementById("selStage");
  const selGrade = document.getElementById("selGrade");
  const selSem = document.getElementById("selSemester");
  const selVer = document.getElementById("selPublisher");
  const selUnit = document.getElementById("selUnit");

  const stageKeys = Object.keys(Meta.tree || {});
  stageKeys.sort((a,b)=> String(a).localeCompare(String(b), "zh-Hant"));
  const prevStage = selStage.value;
  setOptions(selStage, stageKeys.map(s=>({value:s, label:s})), "（尚無資料）");
  if(prevStage && stageKeys.includes(prevStage)) selStage.value = prevStage;

  const stage = getSelStage();
  const gradesObj = (Meta.tree && stage && Meta.tree[stage]) ? Meta.tree[stage] : {};
  const gradeKeys = Object.keys(gradesObj).map(x=>Number(x)).filter(n=>Number.isFinite(n)).sort((a,b)=>a-b);
  const prevGrade = selGrade.value;
  setOptions(selGrade, gradeKeys.map(g=>({value:g, label:`${g}年級`})), "（此學習階段尚無年級）");
  if(prevGrade && gradeKeys.map(String).includes(String(prevGrade))) selGrade.value = prevGrade;

  const grade = getSelGrade();
  const semObj = (gradesObj && Number.isFinite(grade) && gradesObj[grade]) ? gradesObj[grade] : {};
  const semKeys = Object.keys(semObj);
  // 固定順序：上、下（若存在）
  const semOrder = ["上學期","下學期"];
  semKeys.sort((a,b)=> semOrder.indexOf(a) - semOrder.indexOf(b));
  const prevSem = selSem.value;
  setOptions(selSem, semKeys.map(s=>({value:s, label:s})), "（此年級尚無學期資料）");
  if(prevSem && semKeys.includes(prevSem)) selSem.value = prevSem;

  const semester = getSelSemester();
  const verObj = (semObj && semester && semObj[semester]) ? semObj[semester] : {};
  const verKeys = Object.keys(verObj);
  verKeys.sort((a,b)=> String(a).localeCompare(String(b), "zh-Hant"));
  const prevVer = selVer.value;
  setOptions(selVer, verKeys.map(v=>({value:v, label:v})), "（此條件尚無題庫）");
  if(prevVer && verKeys.includes(prevVer)) selVer.value = prevVer;

  const version = getSelVersion();
  const unitsArr = (verObj && version && Array.isArray(verObj[version])) ? verObj[version] : [];
  const prevUnit = selUnit.value;

  setOptions(
    selUnit,
    unitsArr.map(u=>({ value: u.unit_key, label: u.unit_name })),
    "（此版本尚無單元）"
  );
  if(prevUnit && unitsArr.some(u=>u.unit_key===prevUnit)) selUnit.value = prevUnit;

  // hints
  const hasVer = verKeys.length > 0;
  document.getElementById("publisherHint").textContent = hasVer ? "已載入版本，請選擇。" : "請先確認此條件是否已有題庫。";

  const hasUnit = unitsArr.length > 0;
  document.getElementById("unitHint").textContent = hasUnit ? "已載入單元，請選擇。" : "請先確認此版本是否已建立單元題庫。";
}

/* legacy 模式：只會依 grade+semester 呼叫 getUnitOptions */
async function loadLegacyByGradeSemester(){
  const selStage = document.getElementById("selStage");
  const selGrade = document.getElementById("selGrade");
  const selSem = document.getElementById("selSemester");
  const selVer = document.getElementById("selPublisher");
  const selUnit = document.getElementById("selUnit");

  // stage / grade / semester 的選單（仍提供，至少全頁一致）
  const stageOptions = [{value:"國小",label:"國小"},{value:"國中",label:"國中"}];
  setOptions(selStage, stageOptions, "（無資料）");

  const stage = getSelStage() || "國小";
  selStage.value = stage;

  const gradeList = (stage === "國中") ? [7,8,9] : [3,4,5,6];
  setOptions(selGrade, gradeList.map(g=>({value:g,label:`${g}年級`})), "（無資料）");

  // semester 固定兩個
  setOptions(selSem, [{value:"上學期",label:"上學期"},{value:"下學期",label:"下學期"}], "（無資料）");

  const grade = getSelGrade() || gradeList[0];
  const semester = getSelSemester() || "上學期";

  document.getElementById("publisherHint").textContent = "載入中…";
  document.getElementById("unitHint").textContent = "";

  const json = await api({
    action: ACTION.GET_UNIT_OPTIONS,
    content_db_id: CONTENT_DB_ID,
    sheet_name: CONTENT_SHEET_NAME,
    subject: "自然科學",
    stage,
    grade,
    semester
  });

  Meta.publishers = Array.isArray(json.publishers) ? json.publishers : [];
  Meta.unitsByPublisher = json.unitsByPublisher || {};

  const publishers = Meta.publishers || [];
  setOptions(selVer, publishers.map(p=>({value:p,label:p})), "（此條件尚無題庫）");

  // 用 legacy 資料建一個 tree，讓後續連動一致
  const built = buildTreeFromLegacy(publishers, Meta.unitsByPublisher, grade, semester);
  Meta.tree = built.tree;
  Meta.unitIndex = built.unitIndex;

  refreshAllDropdowns();
}

/* 一次載入：真正從試算表欄位建立全連動 */
async function bootstrapMaterials(){
  document.getElementById("publisherHint").textContent = "載入中…";
  document.getElementById("unitHint").textContent = "";

  // 先清空
  Meta.mode = "tree";
  Meta.tree = {};
  Meta.unitIndex = {};

  // 先試「完整教材樹」
  await loadMaterialTree();

  if(Meta.mode === "tree"){
    refreshAllDropdowns();
    document.getElementById("publisherHint").textContent = "已載入版本，請選擇。";
    document.getElementById("unitHint").textContent = "已載入單元，請選擇。";
    return;
  }

  // 若只拿到 legacy（publishers / unitsByPublisher），就改走 legacy 方式
  await loadLegacyByGradeSemester();
}

/* ===========================
   7) 測驗流程（固定題數 N；UI 不顯示額外統計）
=========================== */
function getUnit(){
  const stage = getSelStage();
  const grade = getSelGrade();
  const semester = getSelSemester();
  const textbook_version = getSelVersion();
  const unit_key = getSelUnitKey();

  const u = Meta.unitIndex[unit_key] || {};
  const unit_name = (u.unit_name || "").trim();

  // 兼容：也把課別/課名拆開送（後端可用可不用）
  return {
    subject: "自然科學",
    stage,
    grade,
    semester,
    textbook_version,
    unit_name,
    unit_key,
    lesson_no: u.lesson_no || "",
    lesson_name: u.lesson_name || ""
  };
}

function normalizeItem(raw){
  if(!raw) return null;
  const optObj = raw.options || {};
  return {
    item_id: String(raw.item_id || "").trim(),
    stem: String(raw.stem || "").trim(),
    options: {
      A: String(raw.option_A ?? optObj.A ?? ""),
      B: String(raw.option_B ?? optObj.B ?? ""),
      C: String(raw.option_C ?? optObj.C ?? ""),
      D: String(raw.option_D ?? optObj.D ?? "")
    }
  };
}

function renderItem(item){
  UI.showQuestion(true);

  document.getElementById("qStem").textContent = item.stem || "";
  const wrap = document.getElementById("optWrap");
  wrap.innerHTML = "";

  CAT.selected = "";
  document.getElementById("btnSubmit").disabled = true;
  document.getElementById("btnNext").disabled = true;
  document.getElementById("hint").textContent = "選擇一個選項後再送出。";

  const letters = ["A","B","C","D"];
  for(const L of letters){
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className =
      "text-left w-full px-4 py-4 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 " +
      "focus:outline-none focus:ring-4 focus:ring-student/15";

    btn.setAttribute("data-letter", L);
    btn.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="w-10 h-10 rounded-xl bg-student/10 text-student flex items-center justify-center font-extrabold">${L}</div>
        <div class="flex-1 text-slate-800 leading-relaxed">${escapeHtml(item.options[L] || "")}</div>
      </div>
    `;

    btn.onclick = () => selectOption(L);
    wrap.appendChild(btn);
  }
}

function selectOption(letter){
  CAT.selected = letter;
  document.querySelectorAll("#optWrap button").forEach(b=>{
    const isSel = b.getAttribute("data-letter") === letter;
    b.classList.toggle("border-student", isSel);
    b.classList.toggle("bg-student/5", isSel);
  });
  document.getElementById("btnSubmit").disabled = false;
  document.getElementById("hint").textContent = `已選擇 ${letter}，請按「送出答案」。`;
}

async function startTest(){
  const unit = getUnit();
  if(!unit.stage || !unit.grade || !unit.semester || !unit.textbook_version || !unit.unit_name){
    UI.toast("資料不足", "請先完成：學習階段、年級、學期、版本、單元。", "warn");
    return;
  }

  const sid = getStudentIdFromLogin();
  if(!sid){
    UI.toast("未登入", "找不到你的登入資訊。請先回到學習中心登入後再進入。", "warn");
    return;
  }

  const n = clampNum(Number(document.getElementById("inpN").value), 5, 40, 15);
  CAT.n = n;

  document.getElementById("btnStart").disabled = true;

  try{
    const json = await api({
      action: ACTION.START_CAT,
      student: { student_id: sid },
      unit,
      settings: { max_items: n }
    });

    CAT.started = true;
    CAT.student_id = sid;
    CAT.test_id = json.test_id || "";
    CAT.step = 0;

    const first = normalizeItem(json.item);
    if(!first) throw new Error("後端未提供第一題。");

    CAT.current = first;
    CAT.next = null;

    UI.setProgress(0, CAT.n);
    document.getElementById("btnFinish").disabled = false;

    renderItem(first);
    UI.toast("開始作答", "測驗已開始。", "good");
  }catch(e){
    UI.toast("開始失敗", String(e?.message || e), "bad");
  }finally{
    document.getElementById("btnStart").disabled = false;
  }
}

async function submitAnswer(){
  if(!CAT.started || !CAT.current) return;
  if(!CAT.selected){
    UI.toast("尚未選擇", "請先選擇一個選項。", "warn");
    return;
  }

  document.getElementById("btnSubmit").disabled = true;
  document.getElementById("btnNext").disabled = true;
  document.getElementById("hint").textContent = "送出中…";

  const unit = getUnit();

  try{
    const json = await api({
      action: ACTION.SUBMIT_NEXT,
      test_id: CAT.test_id,
      student_id: CAT.student_id,
      item_id: CAT.current.item_id,
      response_option: CAT.selected,

      // 固定題數：送給後端做控制（前端不顯示）
      max_items: CAT.n,
      min_items: CAT.n,
      stop_se: 0,

      // 記錄欄位（若後端有用）
      grade: String(unit.grade || "")
    });

    const prog = json.progress || {};
    CAT.step = Number(prog.n_admin || (CAT.step + 1));
    UI.setProgress(CAT.step, CAT.n);

    if(json.done === true || CAT.step >= CAT.n){
      await finishTest();
      return;
    }

    const next = normalizeItem(json.item);
    if(!next) throw new Error("後端未提供下一題。");

    CAT.next = next;
    document.getElementById("btnNext").disabled = false;
    document.getElementById("hint").textContent = "已取得下一題，按「下一題」繼續。";
  }catch(e){
    UI.toast("送出失敗", String(e?.message||e), "bad");
    document.getElementById("btnSubmit").disabled = false;
    document.getElementById("hint").textContent = "送出失敗，請重試。";
  }
}

function goNext(){
  if(!CAT.next) return;
  CAT.current = CAT.next;
  CAT.next = null;
  renderItem(CAT.current);
}

async function finishTest(){
  document.getElementById("btnFinish").disabled = true;
  document.getElementById("btnSubmit").disabled = true;
  document.getElementById("btnNext").disabled = true;

  try{
    const json = await api({
      action: ACTION.FINISH_CAT,
      test_id: CAT.test_id,
      student_id: CAT.student_id
    });

    UI.showResult(true);
    document.getElementById("resScore").textContent = json.score ?? "—";
    document.getElementById("resTestId").textContent = json.test_id ?? "—";
    document.getElementById("resFeedback").textContent = json.feedback_student ?? "—";
    document.getElementById("resWrong").innerHTML = renderWrong(json.wrong_items || []);

    UI.toast("完成", "已產生結果。", "good");

    CAT.started = false;
    document.getElementById("btnFinish").disabled = true;
  }catch(e){
    UI.toast("結束失敗", String(e?.message||e), "bad");
    document.getElementById("btnFinish").disabled = false;
  }
}

function resetAll(){
  CAT.started = false;
  CAT.test_id = "";
  CAT.current = null;
  CAT.next = null;
  CAT.selected = "";
  CAT.step = 0;

  UI.setProgress(0, Number(document.getElementById("inpN").value) || 0);
  UI.showQuestion(false);
  UI.showResult(false);

  document.getElementById("btnFinish").disabled = true;
  document.getElementById("btnSubmit").disabled = true;
  document.getElementById("btnNext").disabled = true;
}

/* ===========================
   8) 輔助
=========================== */
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}
function clampNum(x, lo, hi, fallback){
  const n = Number(x);
  if(!Number.isFinite(n)) return fallback;
  return Math.max(lo, Math.min(hi, n));
}
function renderWrong(arr){
  const xs = Array.isArray(arr) ? arr : [];
  if(xs.length === 0) return `<div class="text-slate-500">沒有錯題</div>`;
  return xs.map(w=>{
    const id = escapeHtml(w.item_id || "");
    const ct = escapeHtml(w.concept_tag || "");
    const src = escapeHtml(w.textbook_source || "");
    const meta = [ct, src].filter(Boolean).join("｜");
    return `
      <div class="py-2 border-b border-slate-200 last:border-b-0">
        <div class="font-bold text-slate-800">${id}</div>
        <div class="text-xs text-slate-500 mt-1">${meta || "—"}</div>
      </div>
    `;
  }).join("");
}

/* ===========================
   9) 初始化與事件
=========================== */
document.addEventListener("DOMContentLoaded", async ()=>{
  resetAll();

  UI.setProgress(0, clampNum(Number(document.getElementById("inpN").value),5,40,15));

  // 連線
  await ping();

  // 載入教材（一次抓試算表欄位→全連動）
  try{
    await bootstrapMaterials();
    UI.toast("載入完成", "教材選單已載入。", "good");
  }catch(e){
    UI.toast("載入失敗", String(e?.message||e), "bad");
    // 基本回退：至少讓使用者看見 stage/grade
    // 但不硬塞假資料，避免誤導
    document.getElementById("selStage").innerHTML = `<option value="">（無法載入）</option>`;
    document.getElementById("selGrade").innerHTML = `<option value="">（無法載入）</option>`;
    document.getElementById("selSemester").innerHTML = `<option value="">（無法載入）</option>`;
    document.getElementById("selPublisher").innerHTML = `<option value="">（無法載入）</option>`;
    document.getElementById("selUnit").innerHTML = `<option value="">（無法載入）</option>`;
  }

  // 事件：重新載入
  document.getElementById("btnReload").addEventListener("click", async ()=>{
    try{
      await bootstrapMaterials();
      UI.toast("已更新", "教材選單已重新載入。", "good");
    }catch(e){
      UI.toast("載入失敗", String(e?.message||e), "bad");
    }
  });

  // 事件：任一選單變動 → 全連動更新（tree 模式）
  document.getElementById("selStage").addEventListener("change", ()=>{
    if(Meta.mode === "tree") refreshAllDropdowns();
    else loadLegacyByGradeSemester().catch(e=>UI.toast("載入失敗", String(e?.message||e), "bad"));
  });
  document.getElementById("selGrade").addEventListener("change", ()=>{
    if(Meta.mode === "tree") refreshAllDropdowns();
    else loadLegacyByGradeSemester().catch(e=>UI.toast("載入失敗", String(e?.message||e), "bad"));
  });
  document.getElementById("selSemester").addEventListener("change", ()=>{
    if(Meta.mode === "tree") refreshAllDropdowns();
    else loadLegacyByGradeSemester().catch(e=>UI.toast("載入失敗", String(e?.message||e), "bad"));
  });
  document.getElementById("selPublisher").addEventListener("change", ()=>{
    if(Meta.mode === "tree") refreshAllDropdowns();
  });

  document.getElementById("inpN").addEventListener("change", ()=>{
    const n = clampNum(Number(document.getElementById("inpN").value),5,40,15);
    document.getElementById("inpN").value = n;
    if(!CAT.started) UI.setProgress(0, n);
  });

  document.getElementById("btnStart").addEventListener("click", startTest);
  document.getElementById("btnSubmit").addEventListener("click", submitAnswer);
  document.getElementById("btnNext").addEventListener("click", goNext);
  document.getElementById("btnFinish").addEventListener("click", finishTest);

  document.getElementById("btnRestart").addEventListener("click", ()=>{
    resetAll();
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  document.getElementById("btnCopy").addEventListener("click", async ()=>{
    const text =
`score: ${document.getElementById("resScore").textContent}
test_id: ${document.getElementById("resTestId").textContent}

feedback:
${document.getElementById("resFeedback").textContent}`;
    try{
      await navigator.clipboard.writeText(text);
      UI.toast("已複製", "結果已複製到剪貼簿。", "good");
    }catch(_){
      UI.toast("複製失敗", "瀏覽器未授權剪貼簿。", "warn");
    }
  });

  // 鍵盤 A/B/C/D 直接選，Enter 送出
  document.addEventListener("keydown", (ev)=>{
    if(!CAT.started) return;
    const k = String(ev.key||"").toUpperCase();
    if(["A","B","C","D"].includes(k)){
      selectOption(k);
      ev.preventDefault();
    }
    if(k === "ENTER"){
      if(!document.getElementById("btnSubmit").disabled) submitAnswer();
      ev.preventDefault();
    }
  });
});
</script>
</body>
</html>
