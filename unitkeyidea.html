<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å–®å…ƒé‡é»æ•´ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        tailwind.config = { 
            theme: { 
                extend: { 
                    colors: { student: '#3b82f6' }, 
                    animation: { "fade-in-up": "fadeInUp 0.5s ease-out forwards" }, 
                    keyframes: { fadeInUp: { "0%": { opacity: "0", transform: "translateY(20px)" }, "100%": { opacity: "1", transform: "translateY(0)" } } } 
                } 
            } 
        }
        mermaid.initialize({ 
    startOnLoad: false, 
    theme: 'neutral', 
    securityLevel: 'loose',
    flowchart: { useMaxWidth: false, htmlLabels: true } 
});
    </script>
    
    <style>
        body { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); font-family: "Microsoft JhengHei", sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.7); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .chat-window { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: bottom right; }
        .chat-window.closed { transform: scale(0); opacity: 0; pointer-events: none; }

        /* æ‘˜è¦æ’ç‰ˆ */
        #summary-text h3 { 
            font-size: 1.3rem; font-weight: 800; color: #1e3a8a; 
            margin-top: 1.5rem; margin-bottom: 0.75rem; 
            padding: 0.5rem 0.75rem; border-left: 5px solid #3b82f6; 
            background: linear-gradient(90deg, #eff6ff 0%, rgba(255,255,255,0) 100%); 
            border-radius: 0 8px 8px 0; 
        }
        #summary-text ul { list-style-type: none; padding-left: 0.5rem; }
        #summary-text li { position: relative; padding-left: 1.5rem; margin-bottom: 0.5rem; color: #374151; font-size: 1.05rem; }
        #summary-text li::before { content: "â€¢"; color: #3b82f6; font-weight: bold; font-size: 1.2em; position: absolute; left: 0.25rem; top: -2px; }
        
        .vocab-item { transition: transform 0.2s; }
        .vocab-item:hover { transform: translateY(-2px); }

        /* Mermaid åœ–è¡¨æ¨£å¼ (è‡ªå‹•é©æ‡‰æ¡†æ¡†) */
        #mermaid-chart {
            width: 100%;
            display: flex;
            justify-content: center;
            overflow: hidden; /* éš±è—è¶…å‡ºéƒ¨åˆ† */
            padding: 10px 0;
            pointer-events: none; /* è®“é»æ“Šç©¿é€ */
        }
        #mermaid-chart .mermaid svg {
            width: 100% !important;      
            max-width: 100% !important;  
            height: auto !important;
            font-family: "Microsoft JhengHei", sans-serif !important; 
        }

        /* å…¨è¢å¹•ç‡ˆç®± (å¯æ²å‹•) */
        #image-modal { z-index: 99999; overflow: auto; -webkit-overflow-scrolling: touch; }
        #modal-content {
            width: 95vw; height: auto; min-height: 50vh;
            max-width: none !important; overflow: visible;
            background: white; border-radius: 12px; padding: 15px;
            display: flex; align-items: flex-start; justify-content: center;
        }

        /* PDF ä¸‹è¼‰ */
        .pdf-page-break { page-break-before: always; break-before: page; }
        .pdf-rotate-map {
            transform: rotate(90deg); transform-origin: top left;
            width: 130% !important; margin-left: 40px; margin-top: -40px; 
            overflow: visible !important;
        }
        .no-pdf { display: none !important; }
        
        .click-mask { position: absolute; inset: 0; z-index: 50; background-color: transparent; cursor: pointer; }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col">

    <nav class="glass-panel sticky top-0 z-50 px-6 py-4 flex justify-between items-center no-print">
        <div class="flex items-center gap-4">
            <a href="student.html" class="group flex items-center gap-2 text-slate-500 hover:text-blue-600 transition decoration-0">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow group-hover:shadow-md transition">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <span class="font-bold hidden md:block" data-i18n="back_home">è¿”å›å­¸ç¿’ä¸­å¿ƒ</span>
            </a>
            <a href="sciencebilingual.html" class="group flex items-center gap-2 text-slate-500 hover:text-purple-600 transition decoration-0">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow group-hover:shadow-md transition">
                    <i class="fa-solid fa-book-open-reader"></i>
                </div>
                <span class="font-bold hidden md:block" data-i18n="btn_bilingual">ç§‘å­¸é›™èªé–±è®€</span>
            </a>
            <div class="h-8 w-px bg-slate-300 mx-2 hidden sm:block"></div>
            <div class="hidden sm:block">
                <h1 class="font-bold text-lg" data-i18n="page_title">å–®å…ƒé‡é»æ•´ç†</h1>
                <p class="text-xs text-slate-500" data-i18n="page_subtitle">AI æ™ºèƒ½ç­†è¨˜ç”Ÿæˆ</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <a href="aievaluation.html" class="group flex items-center gap-2 text-slate-500 hover:text-green-600 transition decoration-0 mr-2">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow group-hover:shadow-md transition border border-slate-100">
                    <i class="fa-solid fa-clipboard-check"></i>
                </div>
                <span class="font-bold hidden lg:block" data-i18n="btn_eval">AI è©•åˆ†è¨ºæ–·</span>
            </a>
            <select id="language-selector" onchange="changeLanguage()" class="bg-white/50 border text-xs rounded-lg p-1.5 cursor-pointer outline-none focus:ring-1 focus:ring-blue-300">
                <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                <option value="en">English</option>
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
            </select>
            <div class="flex items-center gap-2 pl-2 border-l border-slate-300">
                 <div id="user-info" class="text-sm font-bold text-blue-600">è¨ªå®¢</div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8 flex-1 w-full pb-24">
        <div id="selection-panel" class="glass-panel rounded-2xl p-6 mb-8 no-print">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-database"></i> <span data-i18n="settings_title">è«‹æŒ‘é¸ä½ è¦çš„å­¸ç¿’å–®å…ƒ</span></h2>
                <span id="db-status" class="text-xs font-bold text-orange-500"><i class="fa-solid fa-circle-notch fa-spin"></i> Loading...</span>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_stage">å­¸ç¿’éšæ®µ</label><select id="sel-stage" class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500"><option value="" disabled selected>Loading...</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_publisher">ç‰ˆæœ¬</label><select id="sel-publisher" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>Select...</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_grade">å¹´ç´š</label><select id="sel-grade" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>Select...</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_semester">å­¸æœŸ</label><select id="sel-semester" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>Select...</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_unit">å–®å…ƒåç¨±</label><select id="sel-unit" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>Select...</option></select></div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="btn-generate" onclick="startGeneration()" disabled class="bg-blue-600 text-white px-8 py-2.5 rounded-xl font-bold shadow-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> <span data-i18n="btn_generate">AI åˆ†æä¸¦ç”Ÿæˆ</span>
                </button>
            </div>
        </div>

        <div id="loading-view" class="hidden flex-col items-center justify-center py-20">
            <div class="loader mb-4"></div>
            <h3 class="text-xl font-bold text-slate-700">AI å–®å…ƒé‡é»æ•´ç†ä¸­...</h3>
        </div>

        <div id="content-view" class="hidden animate-fade-in-up">
            <div class="mb-6 flex flex-col md:flex-row justify-between md:items-end gap-4 relative z-20">
                <div>
                    <span id="result-tag" class="text-xs font-bold bg-blue-100 text-blue-600 px-3 py-1 rounded-full">TAG</span>
                    <h1 id="result-title" class="text-3xl font-black text-slate-800 mt-2">Title</h1>
                </div>
                
                <div class="flex flex-wrap gap-2 no-print relative w-full md:w-auto justify-start md:justify-end" style="z-index: 500;">
                    <button onclick="downloadTXT()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-6 py-3 rounded-xl font-bold text-sm transition cursor-pointer border border-slate-200 shadow-sm flex items-center active:scale-95">
                        <i class="fa-solid fa-file-lines mr-2"></i> 
                        <span data-i18n="btn_txt">ä¸‹è¼‰ TXT</span>
                    </button>
                    <button onclick="downloadPDF()" class="bg-red-50 hover:bg-red-100 text-red-600 px-6 py-3 rounded-xl font-bold text-sm transition cursor-pointer border border-red-100 shadow-sm flex items-center active:scale-95">
                        <i class="fa-solid fa-file-pdf mr-2"></i> 
                        <span data-i18n="btn_pdf">ä¸‹è¼‰ PDF</span>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start"> 
                
                <div id="summary-panel" class="md:col-span-2 glass-panel p-6 rounded-2xl bg-white border-l-4 border-blue-500 shadow-sm">
                    <h3 class="font-bold text-blue-800 mb-4 text-xl"><i class="fa-solid fa-star text-yellow-400"></i> <span data-i18n="title_summary">æ ¸å¿ƒæ¦‚å¿µæ‘˜è¦</span></h3>
                    <div id="summary-text" class="prose max-w-none text-slate-600 leading-relaxed"></div>
                </div>
                
                <div id="vocab-panel" class="glass-panel p-6 rounded-2xl bg-gradient-to-br from-white to-blue-50 border-l-4 border-blue-500 h-full flex flex-col shadow-sm">
                    <h3 class="font-bold text-slate-700 mb-4 text-xl"><span data-i18n="title_vocab">ç§‘å­¸è©å½™èˆ‡å®šç¾©</span></h3>
                    
                    <div class="flex-1 overflow-y-auto custom-scrollbar min-h-0 pr-2">
                        <div id="keywords-list" class="space-y-3 pb-2"></div>
                    </div>
                </div>

                <div class="md:col-span-3 glass-panel p-6 rounded-2xl bg-white pdf-page-break shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-purple-700 text-xl cursor-pointer hover:text-purple-900 transition w-fit select-none flex items-center gap-2" onclick="openModal()" ontouchend="openModal()">
                            <i class="fa-solid fa-project-diagram"></i> 
                            <span data-i18n="title_map">çŸ¥è­˜æ¶æ§‹åœ–</span> 
                            <span class="text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full ml-2">é»æ“Šæ”¾å¤§</span>
                        </h3>
                        <button onclick="openModal()" class="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg text-sm font-bold border border-blue-200 hover:bg-blue-100 transition no-pdf">
                            <i class="fa-solid fa-expand mr-1"></i> å…¨è¢å¹•
                        </button>
                    </div>
                    
                    <div class="bg-slate-50 rounded-xl p-4 md:p-6 border border-slate-100 overflow-hidden w-full relative h-auto" id="chart-container">
                        <div class="click-mask" onclick="openModal()"></div>
                        <div id="mermaid-chart" class="w-full flex justify-center"></div>
                    </div>
                </div>
                
                <div class="md:col-span-3 glass-panel p-6 rounded-2xl bg-red-50/50 border border-red-100 pdf-page-break shadow-sm">
                    <h3 class="font-bold text-red-600 mb-4 text-xl"><i class="fa-solid fa-circle-exclamation"></i> <span data-i18n="title_myth">å¸¸è¦‹è¿·æ€è¨ºæ–·</span></h3>
                    <div id="myth-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="floating-chat" class="hidden fixed bottom-6 right-6 z-[100] flex flex-col items-end gap-4 no-print">
        <div id="xiaoke-window" class="chat-window closed w-80 md:w-96 bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col overflow-hidden h-[500px]">
            <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <img src="https://raw.githubusercontent.com/Shiwen6674/sciencelearninghub/main/irob.png" alt="å°ç§‘" class="w-8 h-8 rounded-full object-cover bg-white">
                    <span class="font-bold">å°ç§‘ AI</span>
                </div>
                <button onclick="toggleChat()" class="text-white/80 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex-1 p-4 bg-slate-50 overflow-y-auto text-sm space-y-3" id="chat-messages"></div>
            <div class="p-3 bg-white border-t border-slate-100 flex gap-2">
                <input type="text" id="chat-input" placeholder="..." class="flex-1 bg-slate-100 border-none rounded-full px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" onkeypress="if(event.key==='Enter') sendChatMessage()">
                <button onclick="sendChatMessage()" class="bg-blue-600 text-white w-10 h-10 rounded-full hover:bg-blue-700 transition flex items-center justify-center"><i class="fa-solid fa-paper-plane text-xs"></i></button>
            </div>
        </div>
        <button onclick="toggleChat()" class="w-14 h-14 bg-white rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition overflow-hidden border-2 border-blue-600 p-1">
            <img src="https://raw.githubusercontent.com/Shiwen6674/sciencelearninghub/main/irob.png" alt="å°ç§‘" class="w-full h-full object-cover rounded-full">
        </button>
    </div>

    <div id="image-modal" class="fixed inset-0 z-[200] bg-black/95 hidden flex-col items-center justify-center p-2 transition-opacity duration-300" onclick="closeModal()">
        <button class="absolute top-4 right-4 text-white/90 hover:text-white text-5xl font-bold p-2 z-[201]" onclick="closeModal()">&times;</button>
        <div id="modal-content" class="bg-white rounded-lg shadow-2xl" onclick="event.stopPropagation()"></div>
    </div>

    <script>
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxBWrZCp-xLckDGZnhe64K0IUa_8CJZRzqZbrgL8lQdNn3S1WgaEzbdOtpo4mGwN6_H/exec";
    
    let allData = [];
    let filters = {};
    let currentResultData = null;

    const i18n = {
        "zh-TW": { back_home:"è¿”å›å­¸ç¿’ä¸­å¿ƒ", btn_bilingual:"ç§‘å­¸é›™èªé–±è®€", btn_eval:"AI è©•åˆ†è¨ºæ–·", page_title:"å–®å…ƒé‡é»æ•´ç†", page_subtitle:"AI æ™ºèƒ½ç­†è¨˜ç”Ÿæˆ", settings_title:"è«‹æŒ‘é¸ä½ è¦çš„å­¸ç¿’å–®å…ƒ", label_stage:"å­¸ç¿’éšæ®µ", label_publisher:"ç‰ˆæœ¬", label_grade:"å¹´ç´š", label_semester:"å­¸æœŸ", label_unit:"å–®å…ƒåç¨±", btn_generate:"AI åˆ†æä¸¦ç”Ÿæˆ", btn_txt:"ä¸‹è¼‰ TXT", btn_pdf:"ä¸‹è¼‰ PDF", title_summary:"æ ¸å¿ƒæ¦‚å¿µæ‘˜è¦", title_vocab:"ç§‘å­¸è©å½™èˆ‡å®šç¾©", title_map:"çŸ¥è­˜æ¶æ§‹åœ–", title_myth:"å¸¸è¦‹è¿·æ€è¨ºæ–·" },
        "en": { back_home:"Back Home", btn_bilingual:"Bilingual Reading", btn_eval:"AI Assessment", page_title:"Unit Summary", page_subtitle:"AI Generator", settings_title:"Select Learning Unit", label_stage:"Level", label_publisher:"Publisher", label_grade:"Grade", label_semester:"Semester", label_unit:"Unit", btn_generate:"Generate", btn_txt:"Download TXT", btn_pdf:"Download PDF", title_summary:"Core Concepts", title_vocab:"Vocabulary", title_map:"Mind Map", title_myth:"Common Myths" },
        "ja": { back_home:"ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹", btn_bilingual:"äºŒè¨€èªèª­è§£", btn_eval:"AI è¨ºæ–­ãƒ»æ¡ç‚¹", page_title:"å˜å…ƒã®ã¾ã¨ã‚", page_subtitle:"AIãƒãƒ¼ãƒˆç”Ÿæˆ", settings_title:"å­¦ç¿’å˜å…ƒã‚’é¸æŠ", label_stage:"æ®µéš", label_publisher:"å‡ºç‰ˆç¤¾", label_grade:"å­¦å¹´", label_semester:"å­¦æœŸ", label_unit:"å˜å…ƒ", btn_generate:"ç”Ÿæˆã™ã‚‹", btn_txt:"TXTã‚’ä¿å­˜", btn_pdf:"PDFã‚’ä¿å­˜", title_summary:"æ ¸å¿ƒæ¦‚å¿µ", title_vocab:"ç§‘å­¦ç”¨èª", title_map:"çŸ¥è­˜ãƒãƒƒãƒ—", title_myth:"ã‚ˆãã‚ã‚‹èª¤è§£" },
        "zh-CN": { back_home:"è¿”å›å­¦ä¹ ä¸­å¿ƒ", btn_bilingual:"ç§‘å­¦åŒè¯­é˜…è¯»", btn_eval:"AI è¯„åˆ†è¯Šæ–­", page_title:"å•å…ƒé‡ç‚¹æ•´ç†", page_subtitle:"AI æ™ºèƒ½ç¬”è®°ç”Ÿæˆ", settings_title:"è¯·æŒ‘é€‰ä½ è¦çš„å­¦ä¹ å•å…ƒ", label_stage:"å­¦ä¹ é˜¶æ®µ", label_publisher:"ç‰ˆæœ¬", label_grade:"å¹´çº§", label_semester:"å­¦æœŸ", label_unit:"å•å…ƒåç§°", btn_generate:"AI åˆ†æå¹¶ç”Ÿæˆ", btn_txt:"ä¸‹è½½ TXT", btn_pdf:"ä¸‹è½½ PDF", title_summary:"æ ¸å¿ƒæ¦‚å¿µæ‘˜è¦", title_vocab:"ç§‘å­¦è¯æ±‡ä¸å®šä¹‰", title_map:"çŸ¥è¯†æ¶æ„å›¾", title_myth:"å¸¸è§è¿·æ€è¯Šæ–­" }
    };

   window.onload = async () => {
    // ... (è®€å–ä½¿ç”¨è€…è³‡è¨Šçš„ç¨‹å¼ç¢¼ä¸è®Š) ...
    const user = JSON.parse(sessionStorage.getItem("currentUser") || '{"name":"è¨ªå®¢"}');
    const userInfo = document.getElementById("user-info");
    if (userInfo) userInfo.innerText = user.name;
    
    // ç¢ºä¿é¸å–®å…ƒç´ å­˜åœ¨
    const selStage = document.getElementById("sel-stage");

    try {
        const res = await fetch(GAS_API_URL + "?action=get_metadata");
        
        // 1. æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼ (é 200/OK ç‹€æ…‹)
        if (!res.ok) {
            throw new Error(`ä¼ºæœå™¨ HTTP éŒ¯èª¤: ${res.status}`);
        }

        // 2. å…ˆè®€å–ç‚ºæ–‡å­—ï¼Œä»¥ä¾¿æ•æ‰ JSON è§£æéŒ¯èª¤
        const text = await res.text();
        let json;
        try {
            json = JSON.parse(text); // å˜—è©¦å°‡æ–‡å­—è§£æç‚º JSON
        } catch (parseError) {
            // ğŸš¨ å¦‚æœé€™è£¡ç™¼ç”ŸéŒ¯èª¤ï¼Œä»£è¡¨ GAS è…³æœ¬è¼¸å‡ºäº†é JSON æ ¼å¼çš„å…§å®¹ (ä¾‹å¦‚ HTML éŒ¯èª¤é )
            console.error("JSON è§£æå¤±æ•—çš„åŸå§‹æ–‡æœ¬:", text);
            throw new Error(`API å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼ŒåŸå§‹å…§å®¹é–‹é ­: ${text.substring(0, 50)}...`);
        }
        
        // 3. æª¢æŸ¥ API å›æ‡‰çš„ status æ¬„ä½
        if(json.status === "success") {
            // è³‡æ–™åº«é€£ç·šæˆåŠŸé‚è¼¯
            allData = json.data;
            const dbStatus = document.getElementById("db-status");
            if (dbStatus) {
                dbStatus.innerHTML = `<i class="fa-solid fa-check"></i> è³‡æ–™åº«é€£ç·šæˆåŠŸ`;
                dbStatus.className = "text-xs font-bold text-green-600";
            }
            initSelectors(); // å‘¼å«å¡«å……ä¸‹æ‹‰é¸å–®çš„å‡½å¼
        } else {
            // API å›æ‡‰ç‹€æ…‹ç‚ºå¤±æ•— (status:"error")
            throw new Error(json.message || "API å›æ‡‰ç‹€æ…‹éæˆåŠŸ");
        }
    } catch(e) {
        // 4. æ•æ‰æ‰€æœ‰éŒ¯èª¤ä¸¦åœæ­¢ Loading
        console.error("è¼‰å…¥å…ƒæ•¸æ“šå¤±æ•—:", e);
        const dbStatus = document.getElementById("db-status");
        
        // æ›´æ–°ç‹€æ…‹
        if (dbStatus) {
            dbStatus.innerText = "é€£ç·šå¤±æ•—";
            dbStatus.className = "text-xs font-bold text-red-500";
        }
        
        // ä¿®æ­£ Loading å¡ä½ï¼šæ¸…ç©ºç¬¬ä¸€å€‹é¸å–®ç‹€æ…‹
        if (selStage) {
            selStage.innerHTML = '<option value="" disabled selected>é€£ç·šå¤±æ•—ï¼Œè«‹é‡è©¦...</option>';
            selStage.disabled = true;
        }
        
        // çµ¦ä½¿ç”¨è€…æ˜ç¢ºçš„æç¤ºï¼Œå¹«åŠ©æ‚¨é™¤éŒ¯
        alert(`ç„¡æ³•è¼‰å…¥è³‡æ–™åº«ï¼\néŒ¯èª¤é¡å‹: ${e.message}`);
    }
};

    function changeLanguage() {
        const langSel = document.getElementById("language-selector");
        if (!langSel) return;
        const lang = langSel.value;
        document.querySelectorAll("[data-i18n]").forEach(el => {
            const key = el.getAttribute("data-i18n");
            if (i18n[lang][key]) el.innerText = i18n[lang][key];
        });
    }

    function initSelectors() {
        const stages = [...new Set(allData.map(d => d.stage))];
        populate("sel-stage", stages);

        const selStage = document.getElementById("sel-stage");
        const selPublisher = document.getElementById("sel-publisher");
        const selGrade = document.getElementById("sel-grade");
        const selSemester = document.getElementById("sel-semester");
        const selUnit = document.getElementById("sel-unit");

        if (selStage) selStage.onchange = (e) => updateLevel(1, e.target.value);
        if (selPublisher) selPublisher.onchange = (e) => updateLevel(2, e.target.value);
        if (selGrade) selGrade.onchange = (e) => updateLevel(3, e.target.value);
        if (selSemester) selSemester.onchange = (e) => updateLevel(4, e.target.value);
        if (selUnit) selUnit.onchange = (e) => { 
            filters.unitName = e.target.value; 
            const btn = document.getElementById("btn-generate");
            if (btn) btn.disabled = false; 
        };
    }

    function updateLevel(level, value) {
        if(level===1) filters={stage:value};
        if(level===2){filters.publisher=value; delete filters.grade; delete filters.semester; delete filters.unitName;}
        if(level===3){filters.grade=value; delete filters.semester; delete filters.unitName;}
        if(level===4){filters.semester=value; delete filters.unitName;}

        const ids=["sel-publisher","sel-grade","sel-semester","sel-unit"];
        for(let i=level;i<4;i++){
            const el = document.getElementById(ids[i]);
            if (el) {
                el.innerHTML='<option disabled selected>Select...</option>';
                el.disabled=true;
            }
        }
        const btn = document.getElementById("btn-generate");
        if (btn) btn.disabled=true;

        const relevantData = allData.filter(d => {
            const safeMatch = (dVal, fVal) => !fVal || String(dVal).trim() == String(fVal).trim();
            return safeMatch(d.stage, filters.stage) &&
                   safeMatch(d.publisher, filters.publisher) &&
                   safeMatch(d.grade, filters.grade) &&
                   safeMatch(d.semester, filters.semester);
        });

        if(level===1) populate("sel-publisher", [...new Set(relevantData.map(d=>d.publisher))]);
        if(level===2) populate("sel-grade", [...new Set(relevantData.map(d=>d.grade))].sort((a,b)=>a-b), "grade");
        if(level===3) populate("sel-semester", [...new Set(relevantData.map(d=>d.semester))], "semester");
        if(level===4) {
            const unitSelect = document.getElementById("sel-unit");
            if (!unitSelect) return;
            unitSelect.innerHTML='<option disabled selected>Select...</option>';
            if(relevantData.length>0) {
                relevantData.forEach(d => {
                    const opt = document.createElement("option");
                    opt.value = d.unitName;
                    opt.text = (d.unitType && !isNaN(d.unitType)) ? `ç¬¬${d.unitType}èª² ${d.unitName}` : d.unitName;
                    unitSelect.add(opt);
                });
                unitSelect.disabled=false;
            }
        }
    }

    function populate(id, list, type) {
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML='<option disabled selected>Select...</option>';
        list.forEach(o => {
            const opt = document.createElement("option");
            opt.value = o;
            if(type==="grade") opt.text=o+"å¹´ç´š";
            else if(type==="semester") opt.text=(o==="ä¸Š"?"ä¸Šå­¸æœŸ":(o==="ä¸‹"?"ä¸‹å­¸æœŸ":o));
            else opt.text=o;
            el.add(opt);
        });
        el.disabled=false;
    }

    // ã€ä¸éœ€è¦æ”¹å‹•æ­¤è™•ã€‘
async function startGeneration() {
Â  Â  const selPanel = document.getElementById("selection-panel");
Â  Â  const loading = document.getElementById("loading-view");
Â  Â  if (selPanel) selPanel.classList.add("hidden");
Â  Â  if (loading) {
Â  Â  Â  Â  loading.classList.remove("hidden");
Â  Â  Â  Â  loading.classList.add("flex");
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  const res = await fetch(GAS_API_URL, {Â 
Â  Â  Â  Â  Â  Â  method: "POST",Â 
Â  Â  Â  Â  Â  Â  body: JSON.stringify({ action: "get_content_and_generate", filters: filters })Â 
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  // â˜… æ ¸å¿ƒä¿®æ­£ï¼šåŠ å…¥å›æ‡‰ç‹€æ…‹æª¢æŸ¥åŠæ›´ç©©å®šçš„ JSON è§£æ â˜…
Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  Â  throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${res.status}`);
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  const text = await res.text();
Â  Â  Â  Â  let json;
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  json = JSON.parse(text);
Â  Â  Â  Â  } catch(parseError) {
Â  Â  Â  Â  Â  Â  console.error("JSON è§£æå¤±æ•—çš„åŸå§‹æ–‡æœ¬:", text);
Â  Â  Â  Â  Â  Â  throw new Error("API è¿”å›è³‡æ–™æ ¼å¼éŒ¯èª¤ (éå®Œæ•´ JSON)ã€‚");
Â  Â  Â  Â  }
Â  Â  Â  Â  // â˜… ä¿®æ­£çµæŸ â˜…

Â  Â  Â  Â  if(json.status === "success") {Â 
Â  Â  Â  Â  Â  Â  currentResultData = json.data;Â 
Â  Â  Â  Â  Â  Â  renderResult(json.data);Â 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  throw new Error(json.message || "API è¿”å›ç‹€æ…‹ç‚ºå¤±æ•—");
Â  Â  Â  Â  }
Â  Â  } catch(e) {Â 
Â  Â  Â  Â  alert("AI ç”Ÿæˆå¤±æ•—ï¼è«‹æª¢æŸ¥ API æˆ–é‡è©¦ã€‚\néŒ¯èª¤è¨Šæ¯: " + e.message);Â 
Â  Â  Â  Â  
Â  Â  Â  Â  // è¼‰å…¥å¤±æ•—æ™‚ï¼ŒæŠŠé¸å–®å«å›ä¾†
Â  Â  Â  Â  if (selPanel) selPanel.classList.remove("hidden");
Â  Â  Â  Â  if (loading) {
Â  Â  Â  Â  Â  Â  loading.classList.add("hidden");
Â  Â  Â  Â  Â  Â  loading.classList.remove("flex");
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // è®“ä½¿ç”¨è€…å¯ä»¥å†æ¬¡é»æ“Šç”ŸæˆæŒ‰éˆ•
Â  Â  Â  Â  const btn = document.getElementById("btn-generate");
Â  Â  Â  Â  if (btn) btn.disabled = false;
Â  Â  }
Â  Â  
}

    // â˜… ä¿®æ­£é‡é»ï¼šè‡ªå‹•åˆ¤æ–·æ˜¯æ–‡å­—é‚„æ˜¯ç‰©ä»¶ï¼Œè§£æ±º [object Object] å•é¡Œ â˜…
    // â˜… ä¿®æ­£ç‰ˆï¼šå°é½Šå¾Œç«¯æ¬„ä½ + é˜²æ­¢ [object Object] + ä¿ç•™ç›¸å®¹æ€§ â˜…
function renderResult(data) {
    console.log("æ¸²æŸ“æ•¸æ“š:", data);

    // 0. ä¿éšªï¼šå…ˆæŠ“ raw_contentï¼Œå¾Œé¢ç•¶ä½œå‚™æ´
    const raw = data.raw_content || {};

    // 1. æ¨™é¡Œèˆ‡ TAG
    const resultTitle = document.getElementById('result-title');
    if (resultTitle) {
        resultTitle.innerText =
            data.topic ||
            data.unitName ||
            raw.unitName ||
            filters.unitName ||
            'ç„¡æ¨™é¡Œ';
    }

const resultTag = document.getElementById('result-tag');
if (resultTag) {
    const p = data.publisher || filters.publisher || '';      // ä¾‹å¦‚ï¼šå—ä¸€
    const g = data.grade || filters.grade || '';              // ä¾‹å¦‚ï¼š3
    const rawS = data.semester || filters.semester || '';     // ä¾‹å¦‚ï¼šä¸Š æˆ– ä¸‹

    let s = rawS;
    if (rawS === 'ä¸Š') s = 'ä¸Šå­¸æœŸ';
    else if (rawS === 'ä¸‹') s = 'ä¸‹å­¸æœŸ';

    resultTag.innerText = `${p} ${g}å¹´ç´š ${s}`;                // å—ä¸€ 3å¹´ç´š ä¸Šå­¸æœŸ
}


    // 2. æ‘˜è¦ï¼ˆé¿å… [object Object]ï¼Œä¸¦å„ªå…ˆä½¿ç”¨ summary_htmlï¼‰
    const summaryBox = document.getElementById('summary-text');
    if (summaryBox) {
        let summaryContent = data.summary;

        if (summaryContent && typeof summaryContent === 'object') {
            summaryContent =
                summaryContent.summary_html ||   // ä½ åŸæœ¬çš„æ¬„ä½
                summaryContent.html ||
                summaryContent.content ||
                summaryContent.text ||
                summaryContent.summary ||
                '';
        }

        if (!summaryContent && raw.text_summary) {
            summaryContent = raw.text_summary;
        }

        summaryBox.innerHTML = summaryContent || 'ç”Ÿæˆæ‘˜è¦å¤±æ•—...';
    }

    // 3. ç§‘å­¸è©å½™ï¼ˆæ”¯æ´å¤šç¨®æ¬„ä½åç¨±ï¼škeywords / summary.keywords / summary.vocab_list / raw_content.vocab_listï¼‰
    const keywordList = document.getElementById('keywords-list');
    if (keywordList) {
        keywordList.innerHTML = '';

        let kList =
            data.keywords ||
            (data.summary && (data.summary.keywords || data.summary.vocab_list)) ||
            raw.vocab_list ||
            [];

        if (Array.isArray(kList) && kList.length > 0) {
            kList.forEach(k => {
                const term = typeof k === 'object' ? (k.term || k.word || '') : k;
                const def  = typeof k === 'object' ? (k.def || k.definition || '') : '';

                if (!term) return;

                const div = document.createElement('div');
                div.className = 'vocab-item bg-white p-3 rounded-xl border border-blue-100 hover:border-blue-300 transition shadow-sm mb-2';
                div.innerHTML =
                    `<span class="font-bold text-blue-700 text-lg block mb-1">${term}</span>` +
                    `<span class="text-sm text-slate-600 leading-relaxed block">${def}</span>`;
                keywordList.appendChild(div);
            });
        } else {
            keywordList.innerHTML = '<div class="text-slate-400 p-2">ç„¡è©å½™è³‡æ–™</div>';
        }
    }

    // 4. Mermaid æ¶æ§‹åœ–ï¼ˆæ”¯æ´ summary.mermaid / summary.mindMap / data.mindMapï¼‰
    // 4. Mermaid æ¶æ§‹åœ–ï¼ˆä¿®æ­£ç¸®æ”¾å•é¡Œï¼‰
    const chartDiv = document.getElementById('mermaid-chart');
    if (chartDiv) {
        let mapData =
            data.mindMap ||
            (data.summary && (data.summary.mindMap || data.summary.mermaid)) ||
            '';

        if (mapData && typeof mapData === 'string') {
            // å»æ‰ ```mermaid``` åŒ…è£¹
            mapData = mapData
                .replace(/```mermaid/i, '')
                .replace(/```/g, '')
                .trim();
        }

  if (mapData) {
    // ã€ä¿®æ”¹é» 1ã€‘å¤–å±¤å®¹å™¨åŠ ä¸Š width: 100%ï¼Œç¢ºä¿å®ƒèƒ½ä½”æ»¿æ•´å€‹å¯¬åº¦
    chartDiv.innerHTML = `<div class="mermaid" style="width: 100%; display: flex; justify-content: center;">${mapData}</div>`;
    
    try {
        mermaid.init(undefined, document.querySelectorAll('.mermaid')).then(() => {
            const svg = chartDiv.querySelector('svg');
            if (svg) {
                // ã€ä¿®æ”¹é» 2ã€‘å¼·åˆ¶ç§»é™¤å¯«æ­»çš„å°ºå¯¸ï¼Œä¸¦ç”¨ CSS æ‹‰å¤§
                svg.removeAttribute('style');
                svg.removeAttribute('width');
                svg.removeAttribute('height');
                
                svg.style.width = "100%";      // é—œéµï¼šå¼·è¿«å¯¬åº¦æ’æ»¿å®¹å™¨
                svg.style.height = "auto";     // é«˜åº¦è‡ªå‹•ç­‰æ¯”ä¾‹
                svg.style.maxWidth = "none";   // é—œéµï¼šè§£é™¤æœ€å¤§å¯¬åº¦é™åˆ¶ï¼Œå…è¨±åœ–è¡¨è¢«æ‹‰å¤§
                svg.style.display = "block";
                svg.style.margin = "0 auto";
                svg.style.fontFamily = '"Microsoft JhengHei", sans-serif';
            }
        });
    } catch (e) {
        console.error('Mermaid ç¹ªåœ–å¤±æ•—', e);
        chartDiv.innerText = 'æ¶æ§‹åœ–ç¹ªè£½å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚';
    }
} else {
    chartDiv.innerText = 'ç„¡æ¶æ§‹åœ–æ•¸æ“š';
}
           // 5. è¿·æ€æ¦‚å¿µï¼ˆæ”¯æ´ data.myths / summary.mythsï¼‰
    const mythList = document.getElementById('myth-list');
    if (mythList) {
        mythList.innerHTML = '';

        let mList = data.myths || (data.summary && data.summary.myths) || [];
        if (Array.isArray(mList) && mList.length > 0) {
            mList.forEach(m => {
                const myth    = m.myth || m.misconception || '';
                const correct = m.correct || m.explanation || '';

                if (!myth && !correct) return;

                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-xl border-l-4 border-red-400 shadow-sm';
                div.innerHTML = `
                    <div class="font-bold text-red-500 mb-2 flex items-start gap-2">
                        <i class="fa-solid fa-xmark mt-1"></i> <span>${myth}</span>
                    </div>
                    <div class="text-sm text-slate-600 pl-6 border-t border-red-50 pt-2 mt-2">
                        <i class="fa-solid fa-check text-green-500 mr-1"></i> æ­£ç¢ºï¼š${correct}
                    </div>`;
                mythList.appendChild(div);
            });
        } else {
            mythList.innerHTML = '<div class="text-slate-400 p-2">ç„¡è¿·æ€è³‡æ–™</div>';
        }
    }

    // 6. åˆ‡æ›ç•«é¢
    const loadingView = document.getElementById('loading-view');
    const contentView = document.getElementById('content-view');
    if (loadingView) {
        loadingView.classList.add('hidden');
        loadingView.classList.remove('flex');
    }
    if (contentView) {
        contentView.classList.remove('hidden');
    }

    const btn = document.getElementById('btn-generate');
    if (btn) btn.disabled = false;
        const chatBtn = document.getElementById('floating-chat');
    if (chatBtn) chatBtn.classList.remove('hidden');
setTimeout(syncVocabHeight, 100);
     }


      function downloadTXT() {
        if(!currentResultData) { 
            alert("è«‹å…ˆç”Ÿæˆå…§å®¹å¾Œå†ä¸‹è¼‰ï¼"); 
            return; 
        }
        let content = `========================================\n  å–®å…ƒé‡é»æ•´ç†ï¼š${currentResultData.raw_content ? currentResultData.raw_content.unitName : filters.unitName}\n========================================\n\n`;
        const summaryEl = document.getElementById("summary-text");
        let summary = summaryEl ? summaryEl.innerText.replace(/\n\s*\n/g, '\n\n').trim() : "";
        content += `ã€ æ ¸å¿ƒæ¦‚å¿µæ‘˜è¦ ã€‘\n----------------------------------------\n${summary}\n\n\n`;
        content += `ã€ ç§‘å­¸è©å½™èˆ‡å®šç¾© ã€‘\n----------------------------------------\n`;
        
        // ä¿®æ­£ä¸‹è¼‰é‚è¼¯ï¼Œç¢ºä¿èƒ½æŠ“åˆ°è³‡æ–™
        let vList = currentResultData.keywords || (currentResultData.summary ? currentResultData.summary.keywords : []) || [];
        if (Array.isArray(vList)) {
            vList.forEach((v, i) => {
                const term = v.term || v;
                const def = v.def || "";
                content += `${i+1}. ${term}\n   èªªæ˜ï¼š${def}\n\n`;
            });
        }
        
        content += `\nã€ å¸¸è¦‹è¿·æ€è¨ºæ–· ã€‘\n----------------------------------------\n`;
        let mList = currentResultData.myths || (currentResultData.summary ? currentResultData.summary.myths : []) || [];
        if (Array.isArray(mList)) {
            mList.forEach((m, i) => {
                content += `â— è¿·æ€ ${i+1}ï¼š${m.myth}\n   æ­£ç¢ºï¼š${m.correct}\n\n`;
            });
        }

        try {
            const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `${filters.unitName || 'unit'}_é‡é»æ•´ç†.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        } catch (e) {
            console.error(e);
            alert("TXT ä¸‹è¼‰å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡æˆ–æ›ä¸€å€‹ç€è¦½å™¨ã€‚");
        }
    }

    function downloadPDF() {
        if (!currentResultData) { 
            alert("è«‹å…ˆç”Ÿæˆå…§å®¹å¾Œå†ä¸‹è¼‰ï¼"); 
            return; 
        }

        if (typeof html2pdf === "undefined") {
            alert("PDF æ¨¡çµ„è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡æ–°æ•´ç†é é¢ã€‚");
            return;
        }
        
        const source = document.getElementById("content-view");
        if (!source) return;

        const element = source.cloneNode(true);
        element.querySelectorAll(".no-print, select, button").forEach(e => e.remove());
        
        const vocabContainer = element.querySelector("#keywords-list");
        if(vocabContainer) {
            vocabContainer.style.height = "auto";
            vocabContainer.style.overflow = "visible";
        }

        const vocabPanel = element.querySelector("#vocab-panel");
        if(vocabPanel) {
            vocabPanel.style.height = "auto";
            vocabPanel.classList.add("pdf-page-break"); 
        }

        const mapContainer = element.querySelector("#mermaid-chart");
        if(mapContainer && mapContainer.parentElement && mapContainer.parentElement.parentElement) {
            const parent = mapContainer.parentElement;
            parent.parentElement.classList.add("pdf-page-break");
            parent.style.height = "auto"; 
            mapContainer.classList.add("pdf-rotate-map");
        }

        const mythList = element.querySelector("#myth-list");
        if(mythList && mythList.parentElement) {
            mythList.parentElement.classList.add("pdf-page-break");
        }

        const opt = {
            margin:       10,
            filename:     (filters.unitName || 'unit') + "_é‡é»æ•´ç†.pdf",
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak:    { mode: ['css', 'legacy'] }
        };

        try {
            html2pdf().set(opt).from(element).save();
        } catch (e) {
            console.error(e);
            alert("PDF ä¸‹è¼‰å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡æˆ–æ›ä¸€å€‹ç€è¦½å™¨ã€‚");
        }
    }

    function toggleChat() { 
        const win = document.getElementById("xiaoke-window");
        if (win) win.classList.toggle("closed");
    }

    async function sendChatMessage() {
        const input = document.getElementById("chat-input"); 
        if (!input) return;
        const msg = input.value.trim(); 
        if(!msg) return;

        const chatBody = document.getElementById("chat-messages");
        if (chatBody) {
            chatBody.innerHTML += `<div class="self-end bg-blue-600 text-white p-3 rounded-lg rounded-tr-none shadow-sm max-w-[85%] ml-auto text-sm">${msg}</div>`;
            chatBody.scrollTop = chatBody.scrollHeight;
        }
        input.value = "";

        try {
            const currentUser = JSON.parse(sessionStorage.getItem("currentUser") || '{"name":"è¨ªå®¢"}');
            const contextText = currentResultData ? (currentResultData.raw_content ? currentResultData.raw_content.text : "") : "";
            const contextVocab = currentResultData ? (currentResultData.raw_content ? currentResultData.raw_content.vocab_str : "") : "";
            const res = await fetch(GAS_API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ 
                    action: 'chat_with_ai', 
                    message: msg, 
                    currentUnit: filters.unitName || "",
                    contextText: contextText,
                    contextVocab: contextVocab,
                    userName: currentUser.name,
                    stage: filters.stage,
                    publisher: filters.publisher,
                    grade: filters.grade,
                    semester: filters.semester 
                }) 
            });
            const json = await res.json();
            const cleanReply = (json.data || "").replace(/\*\*/g, "");
            if (chatBody) {
                chatBody.innerHTML += `<div class="self-start bg-white border border-slate-100 p-3 rounded-lg rounded-tr-none shadow-sm max-w-[85%] text-sm"><span class="font-bold text-blue-600 block mb-1 text-xs">å°ç§‘ AI</span>${cleanReply}</div>`;
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        } catch(e) { 
            console.error(e); 
        }
    }

    function openModal() {
        const chartDiv = document.getElementById("mermaid-chart");
        if (!chartDiv || !chartDiv.innerHTML.trim() || chartDiv.innerHTML.includes("éŒ¯èª¤")) {
            return;
        }
        const modal = document.getElementById("image-modal");
        const content = document.getElementById("modal-content");
        if (!modal || !content) return;

        content.innerHTML = chartDiv.innerHTML;
        
        const svg = content.querySelector('svg');
        if (svg) {
            svg.removeAttribute('style');
            svg.style.width = '100%';      
            svg.style.height = 'auto';    
            svg.style.minWidth = '100%';  
            svg.style.maxWidth = '1500px';  
            svg.style.pointerEvents = 'auto';
        }
        
        modal.classList.remove("hidden");
        modal.classList.add("flex");
    }

    function closeModal() {
        const modal = document.getElementById("image-modal");
        if (!modal) return;
        modal.classList.add("hidden");
        modal.classList.remove("flex");
    }
      // â˜… æ–°å¢é€™å€‹å‡½å¼ï¼šå¼·åˆ¶è®“è©å½™æ¬„é«˜åº¦ = æ‘˜è¦æ¬„é«˜åº¦ â˜…
function syncVocabHeight() {
    const summaryPanel = document.getElementById("summary-panel");
    const vocabPanel   = document.getElementById("vocab-panel");
    
    // å¦‚æœæ‰¾ä¸åˆ°å…ƒç´ ï¼Œæˆ–ç¾åœ¨æ˜¯æ‰‹æ©Ÿç‰ˆç›´å‘æ’åˆ— (è¢å¹•å¯¬åº¦å°æ–¼ 768px)ï¼Œå°±ä¸è¦åŸ·è¡Œ
    if (!summaryPanel || !vocabPanel) return;
    if (window.innerWidth < 768) {
        vocabPanel.style.height = "auto"; // æ‰‹æ©Ÿç‰ˆæ¢å¾©è‡ªå‹•é«˜åº¦
        return;
    }

    // 1. å…ˆé‡ç½®è©å½™æ¬„é«˜åº¦ï¼Œç¢ºä¿ä¸æœƒå½±éŸ¿æ¸¬é‡
    vocabPanel.style.height = "auto";
    
    // 2. æŠ“å–æ‘˜è¦æ¬„ç›®å‰çš„å¯¦éš›é«˜åº¦
    const targetHeight = summaryPanel.offsetHeight;

    // 3. è¨­å®šçµ¦è©å½™æ¬„
    vocabPanel.style.height = targetHeight + "px";
}

// ç›£è½è¦–çª—ç¸®æ”¾ï¼Œå³æ™‚èª¿æ•´
window.addEventListener('resize', syncVocabHeight);  
</script>
</body>
</html>
