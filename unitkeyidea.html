<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>單元重點整理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { student: '#3b82f6' }, animation: { "fade-in-up": "fadeInUp 0.5s ease-out forwards" }, keyframes: { fadeInUp: { "0%": { opacity: "0", transform: "translateY(20px)" }, "100%": { opacity: "1", transform: "translateY(0)" } } } } } }
        mermaid.initialize({ startOnLoad: false, theme: 'neutral' });
    </script>
    <style>
        body { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); font-family: sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.7); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sci-vocab { background: #fef08a; padding: 0 4px; border-radius: 4px; font-weight: bold; color: #854d0e; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chat-window { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: bottom right; }
        .chat-window.closed { transform: scale(0); opacity: 0; pointer-events: none; }

        /* --- 核心摘要標題美化 (正確位置) --- */
        #summary-text h3 {
            font-size: 1.35rem;       
            font-weight: 800;         
            color: #1e3a8a;           
            margin-top: 1.5rem;       
            margin-bottom: 0.75rem;   
            padding: 0.5rem 0.75rem;          
            border-left: 5px solid #3b82f6;   
            background: linear-gradient(90deg, #eff6ff 0%, rgba(255,255,255,0) 100%); 
            border-radius: 0 8px 8px 0;       
            text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
        }
        #summary-text ul { list-style-type: none; padding-left: 0.5rem; }
        #summary-text li { position: relative; padding-left: 1.5rem; margin-bottom: 0.5rem; color: #374151; }
        #summary-text li::before { content: "•"; color: #3b82f6; font-weight: bold; font-size: 1.2em; position: absolute; left: 0.25rem; top: -2px; }
        
        /* 詞彙列表樣式 */
        .vocab-item { transition: all 0.2s; }
        .vocab-item:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

        /* 列印專用樣式 (PDF分頁設定) */
        @media print {
            body { background: white; }
            nav, #selection-panel, #floating-chat, .no-print { display: none !important; }
            ..glass-panel { box-shadow: none; border: none; margin-bottom: 20px; padding: 0; break-inside: avoid; page-break-inside: avoid; }
            .page-break { break-before: page; page-break-before: always; display: block; margin-top: 20px; }
            .grid { display: block; }
            .md\:col-span-2, .md\:col-span-3 { width: 100%; margin-bottom: 20px; }
            #content-view { display: block !important; }
            #keywords-list { max-height: none !important; overflow: visible !important; }
        }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col">

<nav class="glass-panel sticky top-0 z-50 px-6 py-4 flex justify-between items-center no-print">
        
        <div class="flex items-center gap-4">
            <a href="student.html" class="group flex items-center gap-2 text-slate-500 hover:text-blue-600 transition decoration-0">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow group-hover:shadow-md transition">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <span class="font-bold hidden md:block" data-i18n="back_home">返回學習中心</span>
            </a>

            <a href="sciencebilingual.html" class="group flex items-center gap-2 text-slate-500 hover:text-purple-600 transition decoration-0">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow group-hover:shadow-md transition">
                    <i class="fa-solid fa-book-open-reader"></i>
                </div>
                <span class="font-bold hidden md:block" data-i18n="btn_bilingual">科學雙語閱讀</span>
            </a>

            <div class="h-8 w-px bg-slate-300 mx-2 hidden sm:block"></div>

            <div class="hidden sm:block">
                <h1 class="font-bold text-lg" data-i18n="page_title">單元重點整理</h1>
                <p class="text-xs text-slate-500" data-i18n="page_subtitle">AI 智能筆記生成</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            
            <a href="aievaluation.html" class="group flex items-center gap-2 text-slate-500 hover:text-green-600 transition decoration-0 mr-2">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow group-hover:shadow-md transition border border-slate-100">
                    <i class="fa-solid fa-clipboard-check"></i>
                </div>
                <span class="font-bold hidden lg:block" data-i18n="btn_eval">AI 評分診斷</span>
            </a>

            <select id="language-selector" onchange="changeLanguage()" class="bg-white/50 border text-xs rounded-lg p-1.5 cursor-pointer outline-none focus:ring-1 focus:ring-blue-300">
                <option value="zh-TW">繁體中文</option>
                <option value="en">English</option>
                <option value="ja">日本語</option>
                <option value="zh-CN">简体中文</option>
            </select>
            
            <div class="flex items-center gap-2 pl-2 border-l border-slate-300">
                 <div id="user-info" class="text-sm font-bold text-blue-600">訪客</div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8 flex-1 w-full pb-24">
        <div id="selection-panel" class="glass-panel rounded-2xl p-6 mb-8 no-print">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-database"></i> <span data-i18n="settings_title">請挑選你要的學習單元</span></h2>
                <span id="db-status" class="text-xs font-bold text-orange-500"><i class="fa-solid fa-circle-notch fa-spin"></i> Loading...</span>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_stage">學習階段</label><select id="sel-stage" class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500"><option value="" disabled selected>Loading...</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_publisher">版本</label><select id="sel-publisher" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>Select...</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_grade">年級</label><select id="sel-grade" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>Select...</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_semester">學期</label><select id="sel-semester" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>Select...</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_unit">單元名稱</label><select id="sel-unit" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>Select...</option></select></div>
            </div>

            <div class="mt-6 flex justify-end">
                <button id="btn-generate" onclick="startGeneration()" disabled class="bg-blue-600 text-white px-8 py-2.5 rounded-xl font-bold shadow-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> <span data-i18n="btn_generate">AI 開始分析</span>
                </button>
            </div>
        </div>

        <div id="loading-view" class="hidden flex-col items-center justify-center py-20">
            <div class="loader mb-4"></div>
            <h3 class="text-xl font-bold text-slate-700">AI 單元重點整理中...</h3>
        </div>

        <div id="content-view" class="hidden animate-fade-in-up">
            <div class="mb-6 flex justify-between items-end">
                <div>
                    <span id="result-tag" class="text-xs font-bold bg-blue-100 text-blue-600 px-3 py-1 rounded-full">TAG</span>
                    <h1 id="result-title" class="text-3xl font-black text-slate-800 mt-2">Title</h1>
                </div>
                <div class="flex gap-2 no-print">
                    <button onclick="downloadTXT()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-lg font-bold text-sm transition">
                        <i class="fa-solid fa-file-lines"></i> <span data-i18n="btn_txt">下載 TXT</span>
                    </button>
                    <button onclick="window.print()" class="bg-red-50 hover:bg-red-100 text-red-600 px-4 py-2 rounded-lg font-bold text-sm transition">
                        <i class="fa-solid fa-file-pdf"></i> <span data-i18n="btn_pdf">下載 PDF</span>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
                
                <div id="summary-panel" class="md:col-span-2 glass-panel p-6 rounded-2xl bg-white border-l-4 border-blue-500">
                    <h3 class="font-bold text-blue-800 mb-4"><i class="fa-solid fa-star text-yellow-400"></i> <span data-i18n="title_summary">核心概念摘要</span></h3>
                    <div id="summary-text" class="prose max-w-none text-slate-600 leading-relaxed"></div>
                </div>
                
                <div id="vocab-panel" class="glass-panel p-6 rounded-2xl bg-gradient-to-br from-white to-blue-50 page-break">
                    <h3 class="font-bold text-slate-700 mb-4"><span data-i18n="title_vocab">科學詞彙與定義</span></h3>
                    <div id="keywords-list" class="space-y-3 overflow-y-auto custom-scrollbar pr-2"></div>
                </div>
                
                <div class="md:col-span-3 glass-panel p-6 rounded-2xl bg-white page-break">
                    <h3 class="font-bold text-purple-700 mb-4"><i class="fa-solid fa-project-diagram"></i> <span data-i18n="title_map">知識架構圖</span></h3>
                    <div class="relative group">
    <button onclick="openModal()" class="absolute top-2 right-2 bg-white/80 hover:bg-white text-slate-600 hover:text-blue-600 p-2 rounded-lg shadow-sm border border-slate-200 transition opacity-0 group-hover:opacity-100 z-10" title="全螢幕放大">
        <i class="fa-solid fa-expand"></i>
    </button>

    <div class="bg-slate-50 rounded-xl p-6 border border-slate-100 overflow-x-auto w-full custom-scrollbar">
        <div id="mermaid-chart" class="w-full min-w-[800px] flex justify-center"></div>
    </div>
</div>
                </div>
                
                <div class="md:col-span-3 glass-panel p-6 rounded-2xl bg-red-50/50 border border-red-100 page-break">
                    <h3 class="font-bold text-red-600 mb-4"><i class="fa-solid fa-circle-exclamation"></i> <span data-i18n="title_myth">常見迷思診斷</span></h3>
                    <div id="myth-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="floating-chat" class="hidden fixed bottom-6 right-6 z-[100] flex flex-col items-end gap-4 no-print">
        <div id="xiaoke-window" class="chat-window closed w-80 md:w-96 bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col overflow-hidden h-[500px]">
            <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
                <div class="flex items-center gap-2">
    <img src="https://raw.githubusercontent.com/Shiwen6674/sciencelearninghub/main/irob.png" alt="小科" class="w-8 h-8 rounded-full object-cover bg-white">
    <span class="font-bold">小科 AI</span>
</div>
                <button onclick="toggleChat()" class="text-white/80 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex-1 p-4 bg-slate-50 overflow-y-auto text-sm space-y-3" id="chat-messages"></div>
            <div class="p-3 bg-white border-t border-slate-100 flex gap-2">
                <input type="text" id="chat-input" placeholder="..." class="flex-1 bg-slate-100 border-none rounded-full px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" onkeypress="if(event.key==='Enter') sendChatMessage()">
                <button onclick="sendChatMessage()" class="bg-blue-600 text-white w-10 h-10 rounded-full hover:bg-blue-700 transition flex items-center justify-center"><i class="fa-solid fa-paper-plane text-xs"></i></button>
            </div>
        </div>
        <button onclick="toggleChat()" class="w-14 h-14 bg-white rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition overflow-hidden border-2 border-blue-600 p-1">
    <img src="https://raw.githubusercontent.com/Shiwen6674/sciencelearninghub/main/irob.png" alt="小科" class="w-full h-full object-cover rounded-full">
</button>
    </div>

    <script>
        // ★★★ 請務必確認這是您最新部署的永久網址 ★★★
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxBWrZCp-xLckDGZnhe64K0IUa_8CJZRzqZbrgL8lQdNn3S1WgaEzbdOtpo4mGwN6_H/exec";
        
        let allData = [];
        let filters = {};
        let currentResultData = null; // 儲存生成的資料供下載用

        // 多語系字典
       // 多語系字典 (已更新 settings_title 為「請挑選你要的學習單元」)
        // 多語系字典 (已加入 btn_eval)
        const i18n = {
            "zh-TW": { 
                back_home:"返回學習中心", 
                btn_bilingual:"科學雙語閱讀", 
                btn_eval:"AI 評分診斷", // ★ 新增
                page_title:"單元重點整理", page_subtitle:"AI 智能筆記生成", 
                settings_title:"請挑選你要的學習單元", label_stage:"學習階段", label_publisher:"版本", 
                label_grade:"年級", label_semester:"學期", label_unit:"單元名稱", 
                btn_generate:"AI 分析並生成", btn_txt:"下載 TXT", btn_pdf:"下載 PDF", 
                title_summary:"核心概念摘要", title_vocab:"科學詞彙與定義", title_map:"知識架構圖", title_myth:"常見迷思診斷" 
            },
            "en": { 
                back_home:"Back Home", 
                btn_bilingual:"Bilingual Reading", 
                btn_eval:"AI Assessment", // ★ 新增
                page_title:"Unit Summary", page_subtitle:"AI Generator", 
                settings_title:"Select Learning Unit", label_stage:"Level", label_publisher:"Publisher", 
                label_grade:"Grade", label_semester:"Semester", label_unit:"Unit", 
                btn_generate:"Generate", btn_txt:"Download TXT", btn_pdf:"Download PDF", 
                title_summary:"Core Concepts", title_vocab:"Vocabulary", title_map:"Mind Map", title_myth:"Common Myths" 
            },
            "ja": { 
                back_home:"ホームに戻る", 
                btn_bilingual:"二言語読解", 
                btn_eval:"AI 診断・採点", // ★ 新增
                page_title:"単元のまとめ", page_subtitle:"AIノート生成", 
                settings_title:"学習単元を選択", label_stage:"段階", label_publisher:"出版社", 
                label_grade:"学年", label_semester:"学期", label_unit:"単元", 
                btn_generate:"生成する", btn_txt:"TXTを保存", btn_pdf:"PDFを保存", 
                title_summary:"核心概念", title_vocab:"科学用語", title_map:"知識マップ", title_myth:"よくある誤解" 
            },
            "zh-CN": { 
                back_home:"返回学习中心", 
                btn_bilingual:"科学双语阅读", 
                btn_eval:"AI 评分诊断", // ★ 新增
                page_title:"单元重点整理", page_subtitle:"AI 智能笔记生成", 
                settings_title:"请挑选你要的学习单元", label_stage:"学习阶段", label_publisher:"版本", 
                label_grade:"年级", label_semester:"学期", label_unit:"单元名称", 
                btn_generate:"AI 分析并生成", btn_txt:"下载 TXT", btn_pdf:"下载 PDF", 
                title_summary:"核心概念摘要", title_vocab:"科学词汇与定义", title_map:"知识架构图", title_myth:"常见迷思诊断" 
            }
        };

        window.onload = async () => {
            const user = JSON.parse(sessionStorage.getItem("currentUser") || '{"name":"訪客"}');
            document.getElementById("user-info").innerText = user.name;
            try {
                const res = await fetch(GAS_API_URL + "?action=get_metadata");
                const json = await res.json();
                if(json.status === "success") {
                    allData = json.data;
                    document.getElementById("db-status").innerHTML = `<i class="fa-solid fa-check"></i> 資料庫連線成功`;
                    document.getElementById("db-status").className = "text-xs font-bold text-green-600";
                    initSelectors();
                } else throw new Error(json.message);
            } catch(e) { console.error(e); document.getElementById("db-status").innerText = "連線失敗"; document.getElementById("db-status").className = "text-xs font-bold text-red-500"; }
        };

        function changeLanguage() {
            const lang = document.getElementById("language-selector").value;
            document.querySelectorAll("[data-i18n]").forEach(el => {
                const key = el.getAttribute("data-i18n");
                if (i18n[lang][key]) el.innerText = i18n[lang][key];
            });
        }

        // --- 全頁連動邏輯 ---
        function initSelectors() {
            const stages = [...new Set(allData.map(d => d.stage))];
            populate("sel-stage", stages);
            document.getElementById("sel-stage").onchange = (e) => updateLevel(1, e.target.value);
            document.getElementById("sel-publisher").onchange = (e) => updateLevel(2, e.target.value);
            document.getElementById("sel-grade").onchange = (e) => updateLevel(3, e.target.value);
            document.getElementById("sel-semester").onchange = (e) => updateLevel(4, e.target.value);
            document.getElementById("sel-unit").onchange = (e) => { filters.unitName = e.target.value; document.getElementById("btn-generate").disabled = false; };
        }
        function updateLevel(level, value) {
            if(level===1) filters={stage:value}; if(level===2){filters.publisher=value; delete filters.grade; delete filters.semester; delete filters.unitName;} if(level===3){filters.grade=value; delete filters.semester; delete filters.unitName;} if(level===4){filters.semester=value; delete filters.unitName;}
            const ids=["sel-publisher","sel-grade","sel-semester","sel-unit"]; for(let i=level;i<4;i++){ document.getElementById(ids[i]).innerHTML='<option disabled selected>Select...</option>'; document.getElementById(ids[i]).disabled=true; } document.getElementById("btn-generate").disabled=true;
            const relevantData = allData.filter(d => {
                const safeMatch = (dVal, fVal) => !fVal || String(dVal).trim() == String(fVal).trim();
                return safeMatch(d.stage, filters.stage) && safeMatch(d.publisher, filters.publisher) && safeMatch(d.grade, filters.grade) && safeMatch(d.semester, filters.semester);
            });
            if(level===1) populate("sel-publisher", [...new Set(relevantData.map(d=>d.publisher))]);
            if(level===2) populate("sel-grade", [...new Set(relevantData.map(d=>d.grade))].sort((a,b)=>a-b), "grade");
            if(level===3) populate("sel-semester", [...new Set(relevantData.map(d=>d.semester))], "semester");
            if(level===4) {
                const unitSelect = document.getElementById("sel-unit"); unitSelect.innerHTML='<option disabled selected>Select...</option>';
                if(relevantData.length>0) {
                    relevantData.forEach(d => {
                        const opt = document.createElement("option"); opt.value = d.unitName;
                        opt.text = (d.unitType && !isNaN(d.unitType)) ? `第${d.unitType}課 ${d.unitName}` : d.unitName;
                        unitSelect.add(opt);
                    });
                    unitSelect.disabled=false;
                }
            }
        }
        function populate(id, list, type) {
            const el = document.getElementById(id); el.innerHTML='<option disabled selected>Select...</option>';
            list.forEach(o => { const opt = document.createElement("option"); opt.value = o; 
                if(type==="grade") opt.text=o+"年級"; else if(type==="semester") opt.text=(o==="上"?"上學期":(o==="下"?"下學期":o)); else opt.text=o; el.add(opt); });
            el.disabled=false;
        }

        async function startGeneration() {
            document.getElementById("selection-panel").classList.add("hidden");
            document.getElementById("loading-view").classList.remove("hidden");
            document.getElementById("loading-view").classList.add("flex");
            try {
                const res = await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "get_content_and_generate", filters: filters }) });
                const json = await res.json();
                if(json.status === "success") { 
                    currentResultData = json.data; // 儲存資料供下載用
                    renderResult(json.data); 
                } else throw new Error(json.message);
            } catch(e) { alert("Error: " + e.message); location.reload(); }
        }

        function renderResult(data) {
            // 1. 顯示內容區塊，隱藏 Loading
            document.getElementById("floating-chat").classList.remove("hidden");
            document.getElementById("loading-view").classList.add("hidden");
            document.getElementById("loading-view").classList.remove("flex");
            document.getElementById("content-view").classList.remove("hidden");

            // 2. 自動插入小科開場白
            const chatBody = document.getElementById("chat-messages");
            chatBody.innerHTML = `
                <div class="self-start bg-white border border-slate-100 p-3 rounded-lg rounded-tl-none shadow-sm max-w-[85%] text-sm">
                    <span class="font-bold text-blue-600 block mb-1 text-xs">小科 AI</span>
                    嗨，同學你好！我是小科，關於【${data.raw_content.unitName}】單元，你有什麼問題要問我呢？
                </div>
            `;
            
            // 3. 填入標題與標籤
            document.getElementById("result-title").innerText = data.raw_content.unitName;
            
            // 處理課次與學期
            const uType = data.raw_content.unitType;
            const lessonStr = (uType && !isNaN(uType)) ? `第${uType}課` : (uType || "");
            const semRaw = filters.semester;
            const semStr = (semRaw === "上" ? "上學期" : (semRaw === "下" ? "下學期" : semRaw));
            document.getElementById("result-tag").innerText = `${filters.publisher} • ${filters.grade}年級${semStr} • ${lessonStr}`;

            // 4. 填入核心概念摘要
            document.getElementById("summary-text").innerHTML = data.summary.summary_html;

            // 5. 填入科學詞彙
            const vocabContainer = document.getElementById("keywords-list");
            vocabContainer.innerHTML = "";
            if(data.summary.vocab_list) {
                data.summary.vocab_list.forEach((item, index) => {
                    vocabContainer.innerHTML += `<div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm mb-2 vocab-item"><div class="flex gap-3"><span class="bg-blue-100 text-blue-700 font-bold px-2 py-1 rounded text-sm h-fit">${index+1}</span><div><div class="font-bold text-slate-800">${item.term}</div><div class="text-sm text-slate-600">${item.def}</div></div></div></div>`;
                });
            }

            // ★★★ 6. 修復知識架構圖 (強力清洗語法錯誤) ★★★
            const chartDiv = document.getElementById("mermaid-chart");
            if(data.summary.mermaid) {
                // 先移除 markdown 標記
                let mermaidCode = data.summary.mermaid.replace(/```mermaid/g, "").replace(/```/g, "");
                
                // 【關鍵修正】強力替換所有可能導致語法錯誤的半形符號為全形
                mermaidCode = mermaidCode.replace(/\(/g, "（").replace(/\)/g, "）")  // 替換小括號
                                         .replace(/\[/g, "【").replace(/\]/g, "】")  // 替換中括號
                                         .replace(/:/g, "：")                       // 替換冒號
                                         .replace(/"/g, "")                         // 移除雙引號
                                         .replace(/'/g, "");                        // 移除單引號

                chartDiv.innerHTML = mermaidCode;
                chartDiv.removeAttribute("data-processed"); // 重置 mermaid 狀態
                mermaid.init(undefined, chartDiv); // 重新渲染
            }

            // ★★★ 7. 修改迷思診斷格式 (紅字迷思 + 綠字正確) ★★★
            const mythDiv = document.getElementById("myth-list");
            mythDiv.innerHTML = "";
            if(data.summary.myths) {
                data.summary.myths.forEach(m => {
                    // 使用新的 HTML 結構，加入顏色與粗體
                    mythDiv.innerHTML += `
                        <div class="bg-white p-4 rounded-xl border border-red-100 shadow-sm">
                            <div class="font-bold text-lg text-slate-800 mb-2 flex items-start">
                                <i class="fa-solid fa-circle-xmark text-red-500 mt-1 mr-2"></i>
                                <div><span class="text-red-600 font-black">迷思：</span>${m.title}</div>
                            </div>
                            <div class="text-sm text-slate-700 leading-relaxed pl-6 border-l-2 border-green-200">
                                <span class="text-green-600 font-black">正確：</span>${m.desc}
                            </div>
                        </div>`;
                });
            }

            // 8. 高度對齊調整 (維持不變)
            setTimeout(() => {
                const summaryHeight = document.getElementById("summary-panel").clientHeight;
                const vocabPanel = document.getElementById("vocab-panel");
                const vocabList = document.getElementById("keywords-list");
                if(summaryHeight > 0) {
                    vocabPanel.style.height = summaryHeight + "px";
                    vocabPanel.style.display = "flex";
                    vocabPanel.style.flexDirection = "column";
                    vocabList.style.flex = "1";
                    vocabList.style.overflowY = "auto";
                    vocabList.style.maxHeight = "none";
                }
            }, 500);
        }

// --- 下載 TXT 功能 (美化排版版) ---
        function downloadTXT() {
            if(!currentResultData) { 
                alert("請先生成內容後再下載！"); 
                return; 
            }
            
            // --- 頁首資訊 ---
            let content = `========================================\n`;
            content += `  單元重點整理：${currentResultData.raw_content.unitName}\n`;
            content += `  標籤：${filters.grade}年級 • ${filters.publisher}\n`;
            content += `========================================\n\n`;
            
            // --- 1. 核心概念摘要 ---
            content += `【 核心概念摘要 】\n`;
            content += `----------------------------------------\n`;
            // 處理摘要文字：將連續空白縮減，並確保段落間有空行
            let summary = document.getElementById("summary-text").innerText;
            // 簡單的正則表達式處理，讓段落分明
            summary = summary.replace(/\n\s*\n/g, '\n\n').trim(); 
            content += `${summary}\n\n\n`;
            
            // --- 2. 科學詞彙 ---
            content += `【 科學詞彙與定義 】\n`;
            content += `----------------------------------------\n`;
            if (currentResultData.summary.vocab_list) {
                currentResultData.summary.vocab_list.forEach((v, i) => {
                    content += `${i+1}. ${v.term}\n`;
                    content += `   說明：${v.def}\n\n`; // 縮排並空一行
                });
            } else {
                content += "   (無特定詞彙)\n\n";
            }
            content += `\n`;
            
            // --- 3. 常見迷思 ---
            content += `【 常見迷思診斷 】\n`;
            content += `----------------------------------------\n`;
            if (currentResultData.summary.myths) {
                currentResultData.summary.myths.forEach((m, i) => {
                    content += `● 迷思 ${i+1}：${m.title}\n`;
                    content += `   解析：${m.desc}\n\n`; // 縮排並空一行
                });
            } else {
                content += "   (無迷思資料)\n";
            }
            
            content += `\n========================================\n`;
            content += ` Generated by AI Science Learning Hub\n`;
            content += `========================================\n`;
            
            // 建立檔案並觸發下載
            const blob = new Blob([content], { type: "text/plain" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${currentResultData.raw_content.unitName}_重點整理.txt`;
            link.click();
        }

        function toggleChat() { document.getElementById("xiaoke-window").classList.toggle("closed"); }
       async function sendChatMessage() {
            const input = document.getElementById("chat-input"); 
            const msg = input.value.trim(); 
            if(!msg) return;

            // 1. ★★★ 關鍵：先抓取目前的使用者資料 ★★★
            const currentUser = JSON.parse(sessionStorage.getItem("currentUser") || '{"name":"訪客"}');

            const chatBody = document.getElementById("chat-messages");
            chatBody.innerHTML += `<div class="self-end bg-blue-600 text-white p-3 rounded-lg rounded-tr-none shadow-sm max-w-[85%] ml-auto text-sm">${msg}</div>`;
            input.value = "";
            chatBody.scrollTop = chatBody.scrollHeight;

            try {
                // 準備 Context 資料
                const contextText = currentResultData ? currentResultData.raw_content.text : "";
                const contextVocab = currentResultData ? currentResultData.raw_content.vocab_str : "";

                const res = await fetch(GAS_API_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ 
                        action: 'chat_with_ai', 
                        message: msg, 
                        currentUnit: filters.unitName || "",
                        contextText: contextText,
                        contextVocab: contextVocab,
                        
                        // ★★★ 新增：這裡就是您缺少的那一行，以及其他篩選條件 ★★★
                        userName: currentUser.name,  // 傳送使用者姓名
                        stage: filters.stage,        // 傳送學習階段
                        publisher: filters.publisher,// 傳送版本
                        grade: filters.grade,        // 傳送年級
                        semester: filters.semester   // 傳送學期
                    }) 
                });
                const json = await res.json();
                
                // 前端清洗文字
                const cleanReply = json.data.replace(/\*\*/g, "");

                chatBody.innerHTML += `<div class="self-start bg-white border border-slate-100 p-3 rounded-lg rounded-tl-none shadow-sm max-w-[85%] text-sm"><span class="font-bold text-blue-600 block mb-1 text-xs">小科 AI</span>${cleanReply}</div>`;
                chatBody.scrollTop = chatBody.scrollHeight;
            } catch(e) { console.error(e); }
        }
      // --- 全螢幕放大功能 ---
        function openModal() {
            const chartHtml = document.getElementById("mermaid-chart").innerHTML;
            if (!chartHtml) return;
            
            const modal = document.getElementById("image-modal");
            const content = document.getElementById("modal-content");
            
            // 複製圖表進去
            content.innerHTML = chartHtml;
            // 移除原本的 min-width 限制，讓它在全螢幕中自由伸展
            content.firstElementChild.style.minWidth = "auto"; 
            
            modal.classList.remove("hidden");
            modal.classList.add("flex");
        }

        function closeModal() {
            const modal = document.getElementById("image-modal");
            modal.classList.add("hidden");
            modal.classList.remove("flex");
        }  
    </script>
    <div id="image-modal" class="fixed inset-0 z-[200] bg-black/90 hidden flex-col items-center justify-center p-4 transition-opacity duration-300" onclick="closeModal()">
        <button class="absolute top-4 right-4 text-white/70 hover:text-white text-4xl font-bold">&times;</button>
        <div id="modal-content" class="bg-white p-4 rounded-lg overflow-auto max-w-full max-h-full" onclick="event.stopPropagation()">
            </div>
    </div>
</body>
</html>
