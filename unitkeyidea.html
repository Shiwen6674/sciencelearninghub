<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>單元重點實驗室</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { student: '#3b82f6' }, animation: { "fade-in-up": "fadeInUp 0.5s ease-out forwards" }, keyframes: { fadeInUp: { "0%": { opacity: "0", transform: "translateY(20px)" }, "100%": { opacity: "1", transform: "translateY(0)" } } } } } }
        mermaid.initialize({ startOnLoad: false, theme: 'neutral' });
    </script>
    <style>
        body { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); font-family: sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.7); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sci-vocab { background: #fef08a; padding: 0 4px; border-radius: 4px; font-weight: bold; color: #854d0e; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col">

    <nav class="glass-panel sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <a href="student.html" class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow text-slate-500 hover:text-blue-600"><i class="fa-solid fa-arrow-left"></i></a>
            <div>
                <h1 class="font-bold text-lg">單元重點實驗室</h1>
                <p class="text-xs text-slate-500">AI 智能筆記生成 (DB 連動版)</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
             <div id="user-info" class="text-sm font-bold text-blue-600">訪客</div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8 flex-1 w-full">
        
        <div id="selection-panel" class="glass-panel rounded-2xl p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-sliders"></i> 設定學習參數</h2>
                <span id="db-status" class="text-xs font-bold text-orange-500"><i class="fa-solid fa-circle-notch fa-spin"></i> 資料庫連線中...</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1">學習階段</label>
                    <select id="sel-stage" class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500"><option value="" disabled selected>載入中...</option></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1">版本</label>
                    <select id="sel-publisher" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>請選擇...</option></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1">年級</label>
                    <select id="sel-grade" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>請選擇...</option></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1">學期</label>
                    <select id="sel-semester" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>請選擇...</option></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1">單元名稱</label>
                    <select id="sel-unit" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>請選擇...</option></select>
                </div>
            </div>

            <div class="mt-6 flex justify-end">
                <button id="btn-generate" onclick="startGeneration()" disabled class="bg-blue-600 text-white px-8 py-2.5 rounded-xl font-bold shadow-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> AI 分析並生成
                </button>
            </div>
        </div>

        <div id="loading-view" class="hidden flex-col items-center justify-center py-20">
            <div class="loader mb-4"></div>
            <h3 class="text-xl font-bold text-slate-700">AI 正在閱讀課文...</h3>
            <p class="text-slate-500 mt-2">分析迷思概念 • 提取科學詞彙 • 繪製知識圖譜</p>
        </div>

        <div id="content-view" class="hidden animate-fade-in-up">
            <div class="mb-6">
                <span id="result-tag" class="text-xs font-bold bg-blue-100 text-blue-600 px-3 py-1 rounded-full">TAG</span>
                <h1 id="result-title" class="text-3xl font-black text-slate-800 mt-2">單元標題</h1>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 glass-panel p-6 rounded-2xl bg-white border-l-4 border-blue-500">
                    <h3 class="font-bold text-blue-800 mb-4"><i class="fa-solid fa-star text-yellow-400"></i> 核心概念摘要</h3>
                    <div id="summary-text" class="prose max-w-none text-slate-600 leading-relaxed"></div>
                </div>
                <div class="glass-panel p-6 rounded-2xl bg-gradient-to-br from-white to-blue-50">
                    <h3 class="font-bold text-slate-700 mb-4">科學詞彙</h3>
                    <div id="keywords-list" class="space-y-2 max-h-[400px] overflow-y-auto"></div>
                </div>
                <div class="md:col-span-3 glass-panel p-6 rounded-2xl bg-white">
                    <h3 class="font-bold text-purple-700 mb-4"><i class="fa-solid fa-project-diagram"></i> 知識架構圖</h3>
                    <div class="flex justify-center bg-slate-50 rounded-xl p-4 border border-slate-100 overflow-x-auto">
                        <div id="mermaid-chart"></div>
                    </div>
                </div>
                <div class="md:col-span-3 glass-panel p-6 rounded-2xl bg-red-50/50 border border-red-100">
                    <h3 class="font-bold text-red-600 mb-4"><i class="fa-solid fa-circle-exclamation"></i> 常見迷思診斷</h3>
                    <div id="myth-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ★★★ 請務必確認這裡換成了「新版本」的 GAS URL ★★★
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxBWrZCp-xLckDGZnhe64K0IUa_8CJZRzqZbrgL8lQdNn3S1WgaEzbdOtpo4mGwN6_H/exec";
        
        let allData = [];
        let filters = {};

        window.onload = async () => {
            const user = JSON.parse(sessionStorage.getItem("currentUser") || '{}');
            if(user.name) document.getElementById("user-info").innerText = user.name;
            
            // 載入資料庫
            try {
                const res = await fetch(GAS_API_URL + "?action=get_metadata");
                const json = await res.json();
                if(json.status === "success") {
                    allData = json.data;
                    document.getElementById("db-status").innerHTML = `<i class="fa-solid fa-check"></i> 已連線 (${allData.length} 筆)`;
                    document.getElementById("db-status").className = "text-xs font-bold text-green-600";
                    initSelectors();
                } else {
                    throw new Error(json.message);
                }
            } catch(e) {
                console.error(e);
                document.getElementById("db-status").innerText = "連線失敗 (CORS/Deploy)";
                document.getElementById("db-status").className = "text-xs font-bold text-red-500";
            }
        };

        // --- 全頁連動邏輯 (Cascading) ---
        function initSelectors() {
            const stages = [...new Set(allData.map(d => d.stage))];
            populate("sel-stage", stages);
            
            document.getElementById("sel-stage").onchange = (e) => updateLevel(1, e.target.value);
            document.getElementById("sel-publisher").onchange = (e) => updateLevel(2, e.target.value);
            document.getElementById("sel-grade").onchange = (e) => updateLevel(3, e.target.value);
            document.getElementById("sel-semester").onchange = (e) => updateLevel(4, e.target.value);
            document.getElementById("sel-unit").onchange = (e) => {
                filters.unitName = e.target.value;
                document.getElementById("btn-generate").disabled = false;
            };
        }

        function updateLevel(level, value) {
            if(level === 1) filters = { stage: value };
            if(level === 2) filters.publisher = value;
            if(level === 3) filters.grade = value; // 這裡是 raw value (如 3)
            if(level === 4) filters.semester = value; // 這裡是 raw value (如 上)

            // 清空下層
            const ids = ["sel-publisher", "sel-grade", "sel-semester", "sel-unit"];
            for(let i = level; i < 4; i++) {
                const el = document.getElementById(ids[i]);
                el.innerHTML = '<option value="" disabled selected>請選擇...</option>';
                el.disabled = true;
            }
            document.getElementById("btn-generate").disabled = true;

            // 篩選資料
            const relevantData = allData.filter(d => {
                return (!filters.stage || d.stage === filters.stage) &&
                       (!filters.publisher || d.publisher === filters.publisher) &&
                       (!filters.grade || d.grade == filters.grade) && // 使用 == 寬鬆比對
                       (!filters.semester || d.semester == filters.semester);
            });

            // 填充下一層
            if(level === 1) {
                const opts = [...new Set(relevantData.map(d => d.publisher))];
                populate("sel-publisher", opts);
            }
            if(level === 2) {
                const opts = [...new Set(relevantData.map(d => d.grade))].sort((a,b)=>a-b);
                populate("sel-grade", opts, "grade"); // 標記為年級
            }
            if(level === 3) {
                const opts = [...new Set(relevantData.map(d => d.semester))];
                populate("sel-semester", opts, "semester"); // 標記為學期
            }
            if(level === 4) {
                // 組合顯示文字: 第1課 認識植物
                const unitSelect = document.getElementById("sel-unit");
                unitSelect.innerHTML = '<option value="" disabled selected>請選擇單元...</option>';
                relevantData.forEach(d => {
                    const opt = document.createElement("option");
                    opt.value = d.unitName; // 給後端的值 (Col H)
                    opt.text = `第${d.unitType}課 ${d.unitName}`; // 給人看的文字
                    unitSelect.add(opt);
                });
                unitSelect.disabled = false;
            }
        }

        function populate(id, options, type) {
            const el = document.getElementById(id);
            el.innerHTML = '<option value="" disabled selected>請選擇...</option>';
            options.forEach(o => {
                const opt = document.createElement("option");
                opt.value = o; // 原始值 (3, 上)
                
                // 顯示轉換
                if(type === "grade") opt.text = o + "年級";
                else if(type === "semester") opt.text = o + "學期";
                else opt.text = o;
                
                el.add(opt);
            });
            el.disabled = false;
        }

        async function startGeneration() {
            document.getElementById("selection-panel").classList.add("hidden");
            document.getElementById("loading-view").classList.remove("hidden");
            document.getElementById("loading-view").classList.add("flex");

            try {
                const res = await fetch(GAS_API_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "get_content_and_generate", filters: filters })
                });
                const json = await res.json();
                
                if(json.status === "success") {
                    renderResult(json.data);
                } else {
                    throw new Error(json.message);
                }
            } catch(e) {
                alert("錯誤: " + e.message);
                location.reload();
            }
        }

        function renderResult(data) {
            document.getElementById("loading-view").classList.add("hidden");
            document.getElementById("loading-view").classList.remove("flex");
            document.getElementById("content-view").classList.remove("hidden");

            // 標題
            document.getElementById("result-title").innerText = data.raw_content.unitName;
            document.getElementById("result-tag").innerText = `${filters.grade}年級 • ${filters.publisher}`;

            // 詞彙與螢光筆
            const vocab = (data.raw_content.vocab_str || "").split(/[,、]/).filter(v=>v);
            let summary = data.summary.summary_html;
            
            const kwList = document.getElementById("keywords-list");
            kwList.innerHTML = "";
            vocab.forEach(v => {
                kwList.innerHTML += `<span class="inline-block bg-slate-100 text-slate-700 px-3 py-1 rounded-full text-sm mr-2 mb-2">#${v.trim()}</span>`;
                // 替換摘要中的詞彙
                const reg = new RegExp(v.trim(), "g");
                summary = summary.replace(reg, `<span class="sci-vocab">${v.trim()}</span>`);
            });
            
            document.getElementById("summary-text").innerHTML = summary;

            // Mermaid
            const chartDiv = document.getElementById("mermaid-chart");
            chartDiv.innerHTML = data.mermaid.replace(/```mermaid/g, "").replace(/```/g, "");
            chartDiv.removeAttribute("data-processed");
            mermaid.init(undefined, chartDiv);

            // 迷思
            const mythDiv = document.getElementById("myth-list");
            mythDiv.innerHTML = "";
            data.myths.forEach(m => {
                mythDiv.innerHTML += `
                <div class="bg-white p-4 rounded-xl border border-red-100 shadow-sm">
                    <div class="font-bold text-red-600 mb-1"><i class="fa-solid fa-circle-question"></i> ${m.title}</div>
                    <div class="text-xs text-slate-600">${m.desc}</div>
                </div>`;
            });
        }
    </script>
</body>
</html>
