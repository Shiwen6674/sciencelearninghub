<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>單元重點實驗室</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { student: '#3b82f6' }, animation: { "fade-in-up": "fadeInUp 0.5s ease-out forwards" }, keyframes: { fadeInUp: { "0%": { opacity: "0", transform: "translateY(20px)" }, "100%": { opacity: "1", transform: "translateY(0)" } } } } } }
        mermaid.initialize({ startOnLoad: false, theme: 'neutral' });
    </script>
    <style>
        body { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); font-family: sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.7); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sci-vocab { background: #fef08a; padding: 0 4px; border-radius: 4px; font-weight: bold; color: #854d0e; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chat-window { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: bottom right; }
        .chat-window.closed { transform: scale(0); opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col">

    <nav class="glass-panel sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <a href="student.html" class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow text-slate-500 hover:text-blue-600"><i class="fa-solid fa-arrow-left"></i></a>
            <div>
                <h1 class="font-bold text-lg">單元重點實驗室</h1>
                <p class="text-xs text-slate-500">AI 智能筆記生成 (Fix v2.0)</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
             <div id="user-info" class="text-sm font-bold text-blue-600">訪客</div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8 flex-1 w-full">
        <div id="selection-panel" class="glass-panel rounded-2xl p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-database"></i> 設定學習參數</h2>
                <span id="db-status" class="text-xs font-bold text-orange-500"><i class="fa-solid fa-circle-notch fa-spin"></i> 連線資料庫中...</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1">學習階段</label>
                    <select id="sel-stage" class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500"><option value="" disabled selected>載入中...</option></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1">版本</label>
                    <select id="sel-publisher" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>請先選階段</option></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1">年級</label>
                    <select id="sel-grade" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>請先選版本</option></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1">學期</label>
                    <select id="sel-semester" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>請先選年級</option></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1">單元名稱 (課別+課名)</label>
                    <select id="sel-unit" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>請先選學期</option></select>
                </div>
            </div>

            <div class="mt-6 flex justify-end">
                <button id="btn-generate" onclick="startGeneration()" disabled class="bg-blue-600 text-white px-8 py-2.5 rounded-xl font-bold shadow-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> AI 分析並生成
                </button>
            </div>
        </div>

        <div id="loading-view" class="hidden flex-col items-center justify-center py-20">
            <div class="loader mb-4"></div>
            <h3 class="text-xl font-bold text-slate-700">AI 正在閱讀課文...</h3>
            <p class="text-slate-500 mt-2">正在分析資料庫中的課文內容...</p>
        </div>

        <div id="content-view" class="hidden animate-fade-in-up">
            <div class="mb-6">
                <span id="result-tag" class="text-xs font-bold bg-blue-100 text-blue-600 px-3 py-1 rounded-full">TAG</span>
                <h1 id="result-title" class="text-3xl font-black text-slate-800 mt-2">單元標題</h1>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 glass-panel p-6 rounded-2xl bg-white border-l-4 border-blue-500">
                    <h3 class="font-bold text-blue-800 mb-4"><i class="fa-solid fa-star text-yellow-400"></i> 核心概念摘要</h3>
                    <div id="summary-text" class="prose max-w-none text-slate-600 leading-relaxed"></div>
                </div>
                <div class="glass-panel p-6 rounded-2xl bg-gradient-to-br from-white to-blue-50">
                    <h3 class="font-bold text-slate-700 mb-4">科學詞彙</h3>
                    <div id="keywords-list" class="space-y-2 max-h-[400px] overflow-y-auto"></div>
                </div>
                <div class="md:col-span-3 glass-panel p-6 rounded-2xl bg-white">
                    <h3 class="font-bold text-purple-700 mb-4"><i class="fa-solid fa-project-diagram"></i> 知識架構圖</h3>
                    <div class="flex justify-center bg-slate-50 rounded-xl p-4 border border-slate-100 overflow-x-auto">
                        <div id="mermaid-chart"></div>
                    </div>
                </div>
                <div class="md:col-span-3 glass-panel p-6 rounded-2xl bg-red-50/50 border border-red-100">
                    <h3 class="font-bold text-red-600 mb-4"><i class="fa-solid fa-circle-exclamation"></i> 常見迷思診斷</h3>
                    <div id="myth-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="floating-chat" class="fixed bottom-6 right-6 z-[100] flex flex-col items-end gap-4">
        <div id="xiaoke-window" class="chat-window closed w-80 md:w-96 bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col overflow-hidden h-[500px]">
            <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
                <div class="flex items-center gap-2"><i class="fa-solid fa-robot"></i> <span class="font-bold">小科 AI</span></div>
                <button onclick="toggleChat()" class="text-white/80 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex-1 p-4 bg-slate-50 overflow-y-auto text-sm space-y-3" id="chat-messages"></div>
            <div class="p-3 bg-white border-t border-slate-100 flex gap-2">
                <input type="text" id="chat-input" placeholder="問問小科..." class="flex-1 bg-slate-100 border-none rounded-full px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" onkeypress="if(event.key==='Enter') sendChatMessage()">
                <button onclick="sendChatMessage()" class="bg-blue-600 text-white w-10 h-10 rounded-full hover:bg-blue-700 transition flex items-center justify-center"><i class="fa-solid fa-paper-plane text-xs"></i></button>
            </div>
        </div>
        <button onclick="toggleChat()" class="w-14 h-14 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full shadow-lg text-white flex items-center justify-center text-2xl hover:scale-110 transition"><i class="fa-solid fa-comment-dots"></i></button>
    </div>

    <script>
        // ★ 這是您提供的最新 GAS URL
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxBWrZCp-xLckDGZnhe64K0IUa_8CJZRzqZbrgL8lQdNn3S1WgaEzbdOtpo4mGwN6_H/exec";
        
        let allData = [];
        let filters = {};

        window.onload = async () => {
            const user = JSON.parse(sessionStorage.getItem("currentUser") || '{"name":"訪客"}');
            document.getElementById("user-info").innerText = user.name;
            
            try {
                // 1. 抓取完整 Metadata
                const res = await fetch(GAS_API_URL + "?action=get_metadata");
                const json = await res.json();
                
                if(json.status === "success") {
                    allData = json.data;
                    document.getElementById("db-status").innerHTML = `<i class="fa-solid fa-check"></i> 資料庫連線成功 (${allData.length} 筆)`;
                    document.getElementById("db-status").className = "text-xs font-bold text-green-600";
                    initSelectors();
                } else {
                    throw new Error(json.message);
                }
            } catch(e) {
                console.error(e);
                document.getElementById("db-status").innerText = "連線失敗: " + e.message;
                document.getElementById("db-status").className = "text-xs font-bold text-red-500";
            }
        };

        // --- 全頁連動邏輯 (Cascading) ---
        function initSelectors() {
            // 第一層：學習階段
            const stages = [...new Set(allData.map(d => d.stage))];
            populate("sel-stage", stages);
            
            // 綁定事件
            document.getElementById("sel-stage").onchange = (e) => updateLevel(1, e.target.value);
            document.getElementById("sel-publisher").onchange = (e) => updateLevel(2, e.target.value);
            document.getElementById("sel-grade").onchange = (e) => updateLevel(3, e.target.value);
            document.getElementById("sel-semester").onchange = (e) => updateLevel(4, e.target.value);
            document.getElementById("sel-unit").onchange = (e) => {
                filters.unitName = e.target.value; // 這會是課名 (Col H)
                document.getElementById("btn-generate").disabled = false;
            };
        }

function updateLevel(level, value) {
            // 1. 更新篩選條件
            if (level === 1) filters = { stage: value }; 
            if (level === 2) { filters.publisher = value; delete filters.grade; delete filters.semester; delete filters.unitName; }
            if (level === 3) { filters.grade = value; delete filters.semester; delete filters.unitName; }
            if (level === 4) { filters.semester = value; delete filters.unitName; }

            // 2. 介面重置
            const ids = ["sel-publisher", "sel-grade", "sel-semester", "sel-unit"];
            for (let i = level; i < 4; i++) {
                const el = document.getElementById(ids[i]);
                el.innerHTML = '<option value="" disabled selected>請選擇...</option>';
                el.disabled = true;
            }
            document.getElementById("btn-generate").disabled = true;

            // 3. 篩選資料 (寬容比對)
            const relevantData = allData.filter(d => {
                const safeMatch = (dataVal, filterVal) => {
                    if (!filterVal) return true;
                    return String(dataVal).trim() == String(filterVal).trim();
                };
                return safeMatch(d.stage, filters.stage) &&
                       safeMatch(d.publisher, filters.publisher) &&
                       safeMatch(d.grade, filters.grade) && 
                       safeMatch(d.semester, filters.semester);
            });

            // 4. 填充下層選單
            if (level === 1) {
                const opts = [...new Set(relevantData.map(d => d.publisher))];
                populate("sel-publisher", opts);
            }
            if (level === 2) {
                const opts = [...new Set(relevantData.map(d => d.grade))].sort((a, b) => a - b);
                populate("sel-grade", opts, "grade");
            }
            if (level === 3) {
                const opts = [...new Set(relevantData.map(d => d.semester))];
                populate("sel-semester", opts, "semester");
            }
            
            // ★★★ 單元名稱處理 (G欄+H欄) ★★★
            if (level === 4) {
                const unitSelect = document.getElementById("sel-unit");
                unitSelect.innerHTML = '<option value="" disabled selected>請選擇單元...</option>';
                
                if (relevantData.length > 0) {
                    // 智慧讀取函式
                    const getValue = (item, possibleKeys) => {
                        const keys = Object.keys(item);
                        for (let key of keys) {
                            if (possibleKeys.includes(key.trim())) return item[key];
                        }
                        return "";
                    };

                    relevantData.forEach(d => {
                        const opt = document.createElement("option");
                        
                        // 抓取 G欄(課別) 與 H欄(課名)
                        const unitType = getValue(d, ["課別", "unitType", "課次"]);
                        const unitName = getValue(d, ["課名", "unitName", "課文", "單元名稱"]); // 確保能抓到 H 欄

                        opt.value = unitName; // 傳給後端的值
                        
                        // 顯示文字：處理 "第1課" 這種格式
                        const typeStr = String(unitType).trim();
                        const prefix = (typeStr && !isNaN(typeStr)) ? `第${typeStr}課 ` : `${typeStr} `;
                        opt.text = `${prefix}${unitName}`;
                        
                        unitSelect.add(opt);
                    });
                    unitSelect.disabled = false;
                } else {
                    unitSelect.innerHTML = '<option disabled>無符合單元</option>';
                }
            }
        }

        function populate(id, options, type) {
            const el = document.getElementById(id);
            el.innerHTML = '<option value="" disabled selected>請選擇...</option>';
            options.forEach(o => {
                const opt = document.createElement("option");
                opt.value = o; // Value 保持原始資料 (例如 "3", "上")
                
                // Text 進行友善轉換
                if(type === "grade") opt.text = o + "年級";
                else if(type === "semester") opt.text = (o === "上" ? "上學期" : (o === "下" ? "下學期" : o));
                else opt.text = o;
                
                el.add(opt);
            });
            el.disabled = false;
        }

        async function startGeneration() {
            document.getElementById("selection-panel").classList.add("hidden");
            document.getElementById("loading-view").classList.remove("hidden");
            document.getElementById("loading-view").classList.add("flex");

            try {
                // 發送請求
                const res = await fetch(GAS_API_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "get_content_and_generate", filters: filters })
                });
                const json = await res.json();
                
                if(json.status === "success") {
                    renderResult(json.data);
                } else {
                    throw new Error(json.message);
                }
            } catch(e) {
                alert("生成失敗: " + e.message);
                location.reload();
            }
        }

        function renderResult(data) {
            document.getElementById("loading-view").classList.add("hidden");
            document.getElementById("loading-view").classList.remove("flex");
            document.getElementById("content-view").classList.remove("hidden");

            // 標題
            document.getElementById("result-title").innerText = data.raw_content.unitName;
            document.getElementById("result-tag").innerText = `${filters.grade}年級 • ${filters.publisher}`;

            // 摘要與螢光筆
            let summary = data.summary.summary_html;
            document.getElementById("summary-text").innerHTML = summary;

            // 詞彙
            const vocab = (data.raw_content.vocab_str || "").split(/[,、]/).filter(v=>v);
            const kwList = document.getElementById("keywords-list");
            kwList.innerHTML = "";
            if (vocab.length === 0) kwList.innerHTML = "<span class='text-gray-400'>無特定科學詞彙</span>";
            else vocab.forEach(v => kwList.innerHTML += `<span class="inline-block bg-slate-100 text-slate-700 px-3 py-1 rounded-full text-sm mr-2 mb-2">#${v.trim()}</span>`);

            // Mermaid
            const chartDiv = document.getElementById("mermaid-chart");
            if (data.mermaid) {
                chartDiv.innerHTML = data.mermaid.replace(/```mermaid/g, "").replace(/```/g, "");
                chartDiv.removeAttribute("data-processed");
                mermaid.init(undefined, chartDiv);
            } else {
                chartDiv.innerHTML = "無法生成圖表";
            }

            // 迷思
            const mythDiv = document.getElementById("myth-list");
            mythDiv.innerHTML = "";
            if (data.myths) {
                data.myths.forEach(m => {
                    mythDiv.innerHTML += `
                    <div class="bg-white p-4 rounded-xl border border-red-100 shadow-sm">
                        <div class="font-bold text-red-600 mb-1"><i class="fa-solid fa-circle-question"></i> ${m.title}</div>
                        <div class="text-xs text-slate-600">${m.desc}</div>
                    </div>`;
                });
            }
        }

        function toggleChat() { document.getElementById("xiaoke-window").classList.toggle("closed"); }
        
        async function sendChatMessage() {
            const input = document.getElementById("chat-input");
            const msg = input.value.trim();
            if(!msg) return;

            const chatBody = document.getElementById("chat-messages");
            chatBody.innerHTML += `<div class="self-end bg-blue-600 text-white p-3 rounded-lg rounded-tr-none shadow-sm max-w-[85%] ml-auto text-sm">${msg}</div>`;
            input.value = "";
            chatBody.scrollTop = chatBody.scrollHeight;

            try {
                const res = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'chat_with_ai', message: msg })
                });
                const json = await res.json();
                
                chatBody.innerHTML += `<div class="self-start bg-white border border-slate-100 p-3 rounded-lg rounded-tl-none shadow-sm max-w-[85%] text-sm">
                    <span class="font-bold text-blue-600 block mb-1 text-xs">小科 AI</span>
                    ${json.data}
                </div>`;
                chatBody.scrollTop = chatBody.scrollHeight;
            } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>
