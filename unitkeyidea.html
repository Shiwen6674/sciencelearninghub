<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>單元重點整理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        tailwind.config = { 
            theme: { 
                extend: { 
                    colors: { student: '#3b82f6' }, 
                    animation: { "fade-in-up": "fadeInUp 0.5s ease-out forwards" }, 
                    keyframes: { fadeInUp: { "0%": { opacity: "0", transform: "translateY(20px)" }, "100%": { opacity: "1", transform: "translateY(0)" } } } 
                } 
            } 
        }
        // 初始化 Mermaid，允許寬鬆語法
        mermaid.initialize({ startOnLoad: false, theme: 'neutral', securityLevel: 'loose' });
    </script>
    
    <style>
        body { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); font-family: "Microsoft JhengHei", sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.7); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* 聊天視窗動畫 */
        .chat-window { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: bottom right; }
        .chat-window.closed { transform: scale(0); opacity: 0; pointer-events: none; }

        /* --- 摘要排版優化 --- */
        #summary-text h3 { 
            font-size: 1.3rem; font-weight: 800; color: #1e3a8a; 
            margin-top: 1.5rem; margin-bottom: 0.75rem; 
            padding: 0.5rem 0.75rem; border-left: 5px solid #3b82f6; 
            background: linear-gradient(90deg, #eff6ff 0%, rgba(255,255,255,0) 100%); 
            border-radius: 0 8px 8px 0; 
        }
        #summary-text ul { list-style-type: none; padding-left: 0.5rem; }
        #summary-text li { position: relative; padding-left: 1.5rem; margin-bottom: 0.5rem; color: #374151; font-size: 1.05rem; }
        #summary-text li::before { content: "•"; color: #3b82f6; font-weight: bold; font-size: 1.2em; position: absolute; left: 0.25rem; top: -2px; }
        
        /* 詞彙卡片懸浮效果 */
        .vocab-item { transition: transform 0.2s; }
        .vocab-item:hover { transform: translateY(-2px); }

        /* --- Mermaid 圖表樣式 (RWD + 捲動) --- */
        #mermaid-chart {
            width: 100%;
            overflow-x: auto;       /* 內容太寬時，出現下方捲軸 */
            padding: 20px 0;
            display: flex;
            justify-content: center; /* 內容少時置中 */
            cursor: pointer;        /* 游標變手手，提示可點擊 */
        }
        #mermaid-chart .mermaid svg {
            height: auto;
            width: auto !important;      /* 自動寬度，不強迫拉伸 */
            max-width: none !important;  /* 解除限制，讓它能超出容器 */
            min-width: 100%;             /* 至少跟容器一樣寬 */
            font-family: "Microsoft JhengHei", sans-serif !important; 
        }

        /* --- PDF 下載專用樣式 --- */
        /* 強制分頁 */
        .pdf-page-break { 
            page-break-before: always; 
            break-before: page; 
            margin-top: 20px; 
            display: block; 
        }
        
        /* 圖表旋轉 (僅在 PDF 生成時生效) */
        .pdf-rotate-map {
            transform: rotate(90deg);
            transform-origin: top left;
            width: 140% !important; /* 旋轉後變橫向，放大寬度以填滿直向頁面 */
            margin-left: 20px;
            margin-top: -20px; 
            overflow: visible !important;
        }
        
        /* 隱藏不列印的元素 */
        .no-pdf { display: none !important; }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col">

    <nav class="glass-panel sticky top-0 z-50 px-6 py-4 flex justify-between items-center no-print">
        <div class="flex items-center gap-4">
            <a href="student.html" class="group flex items-center gap-2 text-slate-500 hover:text-blue-600 transition decoration-0">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow group-hover:shadow-md transition">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <span class="font-bold hidden md:block" data-i18n="back_home">返回學習中心</span>
            </a>
            <div class="h-8 w-px bg-slate-300 mx-2 hidden sm:block"></div>
            <div class="hidden sm:block">
                <h1 class="font-bold text-lg" data-i18n="page_title">單元重點整理</h1>
                <p class="text-xs text-slate-500" data-i18n="page_subtitle">AI 智能筆記生成</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <a href="aievaluation.html" class="group flex items-center gap-2 text-slate-500 hover:text-green-600 transition decoration-0 mr-2">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow group-hover:shadow-md transition border border-slate-100">
                    <i class="fa-solid fa-clipboard-check"></i>
                </div>
                <span class="font-bold hidden lg:block" data-i18n="btn_eval">AI 評分診斷</span>
            </a>
            <select id="language-selector" onchange="changeLanguage()" class="bg-white/50 border text-xs rounded-lg p-1.5 cursor-pointer outline-none focus:ring-1 focus:ring-blue-300">
                <option value="zh-TW">繁體中文</option>
                <option value="en">English</option>
                <option value="ja">日本語</option>
                <option value="zh-CN">简体中文</option>
            </select>
            <div class="flex items-center gap-2 pl-2 border-l border-slate-300">
                 <div id="user-info" class="text-sm font-bold text-blue-600">訪客</div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8 flex-1 w-full pb-24">
        <div id="selection-panel" class="glass-panel rounded-2xl p-6 mb-8 no-print">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-database"></i> <span data-i18n="settings_title">請挑選你要的學習單元</span></h2>
                <span id="db-status" class="text-xs font-bold text-orange-500"><i class="fa-solid fa-circle-notch fa-spin"></i> Loading...</span>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_stage">學習階段</label><select id="sel-stage" class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500"><option value="" disabled selected>Loading...</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_publisher">版本</label><select id="sel-publisher" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>Select...</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_grade">年級</label><select id="sel-grade" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>Select...</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_semester">學期</label><select id="sel-semester" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>Select...</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_unit">單元名稱</label><select id="sel-unit" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>Select...</option></select></div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="btn-generate" onclick="startGeneration()" disabled class="bg-blue-600 text-white px-8 py-2.5 rounded-xl font-bold shadow-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> <span data-i18n="btn_generate">AI 分析並生成</span>
                </button>
            </div>
        </div>

        <div id="loading-view" class="hidden flex-col items-center justify-center py-20">
            <div class="loader mb-4"></div>
            <h3 class="text-xl font-bold text-slate-700">AI 單元重點整理中...</h3>
        </div>

        <div id="content-view" class="hidden animate-fade-in-up">
            <div class="mb-6 flex justify-between items-end">
                <div>
                    <span id="result-tag" class="text-xs font-bold bg-blue-100 text-blue-600 px-3 py-1 rounded-full">TAG</span>
                    <h1 id="result-title" class="text-3xl font-black text-slate-800 mt-2">Title</h1>
                </div>
                <div class="flex gap-2 no-print">
                    <button onclick="downloadTXT()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-lg font-bold text-sm transition">
                        <i class="fa-solid fa-file-lines"></i> <span data-i18n="btn_txt">下載 TXT</span>
                    </button>
                    <button onclick="downloadPDF()" class="bg-red-50 hover:bg-red-100 text-red-600 px-4 py-2 rounded-lg font-bold text-sm transition">
                        <i class="fa-solid fa-file-pdf"></i> <span data-i18n="btn_pdf">下載 PDF</span>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-stretch">
                
                <div id="summary-panel" class="md:col-span-2 glass-panel p-6 rounded-2xl bg-white border-l-4 border-blue-500 h-full flex flex-col">
                    <h3 class="font-bold text-blue-800 mb-4 text-xl"><i class="fa-solid fa-star text-yellow-400"></i> <span data-i18n="title_summary">核心概念摘要</span></h3>
                    <div id="summary-text" class="prose max-w-none text-slate-600 leading-relaxed flex-1"></div>
                </div>
                
                <div id="vocab-panel" class="glass-panel p-6 rounded-2xl bg-gradient-to-br from-white to-blue-50 h-auto md:h-auto flex flex-col pdf-page-break">
                    <h3 class="font-bold text-slate-700 mb-4 text-xl"><span data-i18n="title_vocab">科學詞彙與定義</span></h3>
                    
                    <div class="relative flex-1 md:h-0 md:min-h-full">
                        <div id="keywords-list" class="space-y-3 md:absolute md:inset-0 md:overflow-y-auto custom-scrollbar pr-2"></div>
                    </div>
                </div>
                
                <div class="md:col-span-3 glass-panel p-6 rounded-2xl bg-white pdf-page-break">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-purple-700 text-xl"><i class="fa-solid fa-project-diagram"></i> <span data-i18n="title_map">知識架構圖</span></h3>
                        <button onclick="openModal()" class="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg text-sm font-bold border border-blue-200 hover:bg-blue-100 transition no-pdf">
                            <i class="fa-solid fa-expand mr-1"></i> 全螢幕
                        </button>
                    </div>
                    
                    <div class="bg-slate-50 rounded-xl p-6 border border-slate-100 overflow-hidden w-full cursor-pointer hover:border-blue-300 transition" onclick="openModal()" title="點擊放大">
                        <div id="mermaid-chart" class="w-full flex justify-center"></div>
                    </div>
                </div>
                
                <div class="md:col-span-3 glass-panel p-6 rounded-2xl bg-red-50/50 border border-red-100 pdf-page-break">
                    <h3 class="font-bold text-red-600 mb-4 text-xl"><i class="fa-solid fa-circle-exclamation"></i> <span data-i18n="title_myth">常見迷思診斷</span></h3>
                    <div id="myth-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="floating-chat" class="hidden fixed bottom-6 right-6 z-[100] flex flex-col items-end gap-4 no-print">
        <div id="xiaoke-window" class="chat-window closed w-80 md:w-96 bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col overflow-hidden h-[500px]">
            <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <img src="https://raw.githubusercontent.com/Shiwen6674/sciencelearninghub/main/irob.png" alt="小科" class="w-8 h-8 rounded-full object-cover bg-white">
                    <span class="font-bold">小科 AI</span>
                </div>
                <button onclick="toggleChat()" class="text-white/80 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex-1 p-4 bg-slate-50 overflow-y-auto text-sm space-y-3" id="chat-messages"></div>
            <div class="p-3 bg-white border-t border-slate-100 flex gap-2">
                <input type="text" id="chat-input" placeholder="..." class="flex-1 bg-slate-100 border-none rounded-full px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" onkeypress="if(event.key==='Enter') sendChatMessage()">
                <button onclick="sendChatMessage()" class="bg-blue-600 text-white w-10 h-10 rounded-full hover:bg-blue-700 transition flex items-center justify-center"><i class="fa-solid fa-paper-plane text-xs"></i></button>
            </div>
        </div>
        <button onclick="toggleChat()" class="w-14 h-14 bg-white rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition overflow-hidden border-2 border-blue-600 p-1">
            <img src="https://raw.githubusercontent.com/Shiwen6674/sciencelearninghub/main/irob.png" alt="小科" class="w-full h-full object-cover rounded-full">
        </button>
    </div>

    <div id="image-modal" class="fixed inset-0 z-[200] bg-black/90 hidden flex-col items-center justify-center p-4 transition-opacity duration-300" onclick="closeModal()">
        <button class="absolute top-4 right-4 text-white/70 hover:text-white text-4xl font-bold">&times;</button>
        <div id="modal-content" class="bg-white p-4 rounded-lg overflow-auto max-w-full max-h-full" onclick="event.stopPropagation()"></div>
    </div>

    <script>
        // ★★★ 請確認您的 GAS 網址 ★★★
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxBWrZCp-xLckDGZnhe64K0IUa_8CJZRzqZbrgL8lQdNn3S1WgaEzbdOtpo4mGwN6_H/exec";
        
        let allData = [];
        let filters = {};
        let currentResultData = null;

        const i18n = {
            "zh-TW": { back_home:"返回學習中心", btn_bilingual:"科學雙語閱讀", btn_eval:"AI 評分診斷", page_title:"單元重點整理", page_subtitle:"AI 智能筆記生成", settings_title:"請挑選你要的學習單元", label_stage:"學習階段", label_publisher:"版本", label_grade:"年級", label_semester:"學期", label_unit:"單元名稱", btn_generate:"AI 分析並生成", btn_txt:"下載 TXT", btn_pdf:"下載 PDF", title_summary:"核心概念摘要", title_vocab:"科學詞彙與定義", title_map:"知識架構圖", title_myth:"常見迷思診斷" },
            "en": { back_home:"Back Home", btn_bilingual:"Bilingual Reading", btn_eval:"AI Assessment", page_title:"Unit Summary", page_subtitle:"AI Generator", settings_title:"Select Learning Unit", label_stage:"Level", label_publisher:"Publisher", label_grade:"Grade", label_semester:"Semester", label_unit:"Unit", btn_generate:"Generate", btn_txt:"Download TXT", btn_pdf:"Download PDF", title_summary:"Core Concepts", title_vocab:"Vocabulary", title_map:"Mind Map", title_myth:"Common Myths" },
            "ja": { back_home:"ホームに戻る", btn_bilingual:"二言語読解", btn_eval:"AI 診断・採点", page_title:"単元のまとめ", page_subtitle:"AIノート生成", settings_title:"学習単元を選択", label_stage:"段階", label_publisher:"出版社", label_grade:"学年", label_semester:"学期", label_unit:"単元", btn_generate:"生成する", btn_txt:"TXTを保存", btn_pdf:"PDFを保存", title_summary:"核心概念", title_vocab:"科学用語", title_map:"知識マップ", title_myth:"よくある誤解" },
            "zh-CN": { back_home:"返回学习中心", btn_bilingual:"科学双语阅读", btn_eval:"AI 评分诊断", page_title:"单元重点整理", page_subtitle:"AI 智能笔记生成", settings_title:"请挑选你要的学习单元", label_stage:"学习阶段", label_publisher:"版本", label_grade:"年级", label_semester:"学期", label_unit:"单元名称", btn_generate:"AI 分析并生成", btn_txt:"下载 TXT", btn_pdf:"下载 PDF", title_summary:"核心概念摘要", title_vocab:"科学词汇与定义", title_map:"知识架构图", title_myth:"常见迷思诊断" }
        };

        window.onload = async () => {
            const user = JSON.parse(sessionStorage.getItem("currentUser") || '{"name":"訪客"}');
            document.getElementById("user-info").innerText = user.name;
            try {
                const res = await fetch(GAS_API_URL + "?action=get_metadata");
                const json = await res.json();
                if(json.status === "success") {
                    allData = json.data;
                    document.getElementById("db-status").innerHTML = `<i class="fa-solid fa-check"></i> 資料庫連線成功`;
                    document.getElementById("db-status").className = "text-xs font-bold text-green-600";
                    initSelectors();
                } else throw new Error(json.message);
            } catch(e) { console.error(e); document.getElementById("db-status").innerText = "連線失敗"; document.getElementById("db-status").className = "text-xs font-bold text-red-500"; }
        };

        function changeLanguage() {
            const lang = document.getElementById("language-selector").value;
            document.querySelectorAll("[data-i18n]").forEach(el => {
                const key = el.getAttribute("data-i18n");
                if (i18n[lang][key]) el.innerText = i18n[lang][key];
            });
        }

        function initSelectors() {
            const stages = [...new Set(allData.map(d => d.stage))];
            populate("sel-stage", stages);
            document.getElementById("sel-stage").onchange = (e) => updateLevel(1, e.target.value);
            document.getElementById("sel-publisher").onchange = (e) => updateLevel(2, e.target.value);
            document.getElementById("sel-grade").onchange = (e) => updateLevel(3, e.target.value);
            document.getElementById("sel-semester").onchange = (e) => updateLevel(4, e.target.value);
            document.getElementById("sel-unit").onchange = (e) => { filters.unitName = e.target.value; document.getElementById("btn-generate").disabled = false; };
        }
        function updateLevel(level, value) {
            if(level===1) filters={stage:value}; if(level===2){filters.publisher=value; delete filters.grade; delete filters.semester; delete filters.unitName;} if(level===3){filters.grade=value; delete filters.semester; delete filters.unitName;} if(level===4){filters.semester=value; delete filters.unitName;}
            const ids=["sel-publisher","sel-grade","sel-semester","sel-unit"]; for(let i=level;i<4;i++){ document.getElementById(ids[i]).innerHTML='<option disabled selected>Select...</option>'; document.getElementById(ids[i]).disabled=true; } document.getElementById("btn-generate").disabled=true;
            const relevantData = allData.filter(d => {
                const safeMatch = (dVal, fVal) => !fVal || String(dVal).trim() == String(fVal).trim();
                return safeMatch(d.stage, filters.stage) && safeMatch(d.publisher, filters.publisher) && safeMatch(d.grade, filters.grade) && safeMatch(d.semester, filters.semester);
            });
            if(level===1) populate("sel-publisher", [...new Set(relevantData.map(d=>d.publisher))]);
            if(level===2) populate("sel-grade", [...new Set(relevantData.map(d=>d.grade))].sort((a,b)=>a-b), "grade");
            if(level===3) populate("sel-semester", [...new Set(relevantData.map(d=>d.semester))], "semester");
            if(level===4) {
                const unitSelect = document.getElementById("sel-unit"); unitSelect.innerHTML='<option disabled selected>Select...</option>';
                if(relevantData.length>0) {
                    relevantData.forEach(d => {
                        const opt = document.createElement("option"); opt.value = d.unitName;
                        opt.text = (d.unitType && !isNaN(d.unitType)) ? `第${d.unitType}課 ${d.unitName}` : d.unitName;
                        unitSelect.add(opt);
                    });
                    unitSelect.disabled=false;
                }
            }
        }
        function populate(id, list, type) {
            const el = document.getElementById(id); el.innerHTML='<option disabled selected>Select...</option>';
            list.forEach(o => { const opt = document.createElement("option"); opt.value = o; 
                if(type==="grade") opt.text=o+"年級"; else if(type==="semester") opt.text=(o==="上"?"上學期":(o==="下"?"下學期":o)); else opt.text=o; el.add(opt); });
            el.disabled=false;
        }

        async function startGeneration() {
            document.getElementById("selection-panel").classList.add("hidden");
            document.getElementById("loading-view").classList.remove("hidden");
            document.getElementById("loading-view").classList.add("flex");
            try {
                const res = await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "get_content_and_generate", filters: filters }) });
                const json = await res.json();
                if(json.status === "success") { 
                    currentResultData = json.data; 
                    renderResult(json.data); 
                } else throw new Error(json.message);
            } catch(e) { alert("Error: " + e.message); location.reload(); }
        }

        function renderResult(data) {
            document.getElementById("floating-chat").classList.remove("hidden");
            document.getElementById("loading-view").classList.add("hidden");
            document.getElementById("loading-view").classList.remove("flex");
            document.getElementById("content-view").classList.remove("hidden");

            const chatBody = document.getElementById("chat-messages");
            chatBody.innerHTML = `<div class="self-start bg-white border border-slate-100 p-3 rounded-lg rounded-tl-none shadow-sm max-w-[85%] text-sm"><span class="font-bold text-blue-600 block mb-1 text-xs">小科 AI</span>嗨，同學你好！我是小科，關於【${data.raw_content.unitName}】單元，你有什麼問題要問我呢？</div>`;

            document.getElementById("result-title").innerText = data.raw_content.unitName;
            const uType = data.raw_content.unitType;
            const lessonStr = (uType && !isNaN(uType)) ? `第${uType}課` : (uType || "");
            const semStr = (filters.semester === "上" ? "上學期" : (filters.semester === "下" ? "下學期" : filters.semester));
            document.getElementById("result-tag").innerText = `${filters.publisher} • ${filters.grade}年級${semStr} • ${lessonStr}`;

            const cleanedSummary = data.summary.summary_html.replace(/\*\*/g, ""); 
            document.getElementById("summary-text").innerHTML = cleanedSummary;

            const vocabContainer = document.getElementById("keywords-list");
            vocabContainer.innerHTML = "";
            if(data.summary.vocab_list) {
                data.summary.vocab_list.forEach((item, index) => {
                    const cleanedDef = item.def.replace(/\*\*/g, ""); 
                    vocabContainer.innerHTML += `<div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm mb-2 vocab-item"><div class="flex gap-3"><span class="bg-blue-100 text-blue-700 font-bold px-2 py-1 rounded text-sm h-fit">${index+1}</span><div><div class="font-bold text-slate-800">${item.term}</div><div class="text-sm text-slate-600">${cleanedDef}</div></div></div></div>`;
                });
            }

            // ★★★ Knowledge Map Rendering (強力修復版) ★★★
            const chartDiv = document.getElementById("mermaid-chart");
            chartDiv.innerHTML = "";
            if(data.summary.mermaid) {
                let mCode = data.summary.mermaid.replace(/```(mermaid|json)?/gi, "").replace(/```/g, "").trim();
                
                // 強制轉向 + 符號清洗
                if (/^graph\s+[A-Z]{2}/i.test(mCode)) {
                    mCode = mCode.replace(/^graph\s+[A-Z]{2}/i, "graph TD");
                } else {
                    mCode = "graph TD\n" + mCode;
                }
                
                mCode = mCode.replace(/\[(.*?)\]/g, (match, content) => {
                    let safe = content
                        .replace(/:/g, "：").replace(/\(/g, "（").replace(/\)/g, "）")
                        .replace(/"/g, "").replace(/'/g, "").replace(/,/g, "，");
                    return `[${safe}]`;
                });

                const mermaidEl = document.createElement("div");
                mermaidEl.className = "mermaid";
                mermaidEl.textContent = mCode;
                chartDiv.appendChild(mermaidEl);

                try {
                    // 禁止自動縮放 (useMaxWidth: false)
                    mermaid.initialize({ startOnLoad: false, theme: 'neutral', securityLevel: 'loose', flowchart: { useMaxWidth: false, htmlLabels: true } });
                    mermaid.init(undefined, mermaidEl);
                } catch (err) {
                    console.error("Mermaid Error:", err);
                    chartDiv.innerHTML = `<div class="text-red-500 bg-red-50 p-4 rounded border border-red-200">圖表語法錯誤</div>`;
                }
            }

            // ★★★ Myths Rendering (對齊修復版) ★★★
            const mythDiv = document.getElementById("myth-list");
            mythDiv.innerHTML = "";
            if(data.summary.myths) {
                data.summary.myths.forEach(m => {
                    let title = m.myth || m.title || "迷思";
                    let desc = m.correct || m.correct_concept || m.desc || "正確觀念";
                    const cleanLabel = (text) => { if (!text) return ""; return text.replace(/\*\*/g, "").replace(/^(迷思|正確觀念|正確|Misconception|Correction)\s*[:：]\s*/i, "").trim(); };
                    // items-center 修復對齊
                    mythDiv.innerHTML += `<div class="bg-white p-5 rounded-xl border border-red-100 shadow-sm hover:shadow-md transition h-full flex flex-col"><div class="flex items-center gap-3 mb-3"><div class="bg-red-100 text-red-600 w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-xmark font-bold"></i></div><div><div class="text-slate-800 font-bold"><span class="text-red-600 font-black text-base">迷思：</span>${cleanLabel(title)}</div></div></div><div class="mt-auto pt-3 border-t border-slate-100 pl-11"><div class="text-green-600 font-bold text-sm mb-1"><i class="fa-solid fa-check mr-1"></i> 正確觀念</div><div class="text-sm text-slate-600 leading-relaxed text-justify">${cleanLabel(desc)}</div></div></div>`;
                });
            }
        }

        function downloadTXT() {
            if(!currentResultData) { alert("請先生成內容後再下載！"); return; }
            let content = `========================================\n  單元重點整理：${currentResultData.raw_content.unitName}\n========================================\n\n`;
            let summary = document.getElementById("summary-text").innerText.replace(/\n\s*\n/g, '\n\n').trim();
            content += `【 核心概念摘要 】\n----------------------------------------\n${summary}\n\n\n`;
            content += `【 科學詞彙與定義 】\n----------------------------------------\n`;
            if (currentResultData.summary.vocab_list) { currentResultData.summary.vocab_list.forEach((v, i) => { content += `${i+1}. ${v.term}\n   說明：${v.def}\n\n`; }); }
            content += `\n【 常見迷思診斷 】\n----------------------------------------\n`;
            if (currentResultData.summary.myths) { currentResultData.summary.myths.forEach((m, i) => { content += `● 迷思 ${i+1}：${m.myth}\n   正確：${m.correct}\n\n`; }); }
            const blob = new Blob([content], { type: "text/plain" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${currentResultData.raw_content.unitName}_重點整理.txt`;
            link.click();
        }

        // ★★★ PDF 下載 (分頁 + 轉向) ★★★
        function downloadPDF() {
            if (!currentResultData) { alert("請先生成內容後再下載！"); return; }
            
            // 1. 複製內容
            const element = document.getElementById("content-view").cloneNode(true);
            
            // 2. 清理按鈕
            element.querySelectorAll(".no-pdf, button").forEach(e => e.remove());
            
            // 3. 展開詞彙捲軸
            const vocabContainer = element.querySelector("#keywords-list");
            if(vocabContainer) {
                vocabContainer.classList.remove("md:absolute", "md:inset-0", "md:overflow-y-auto");
                vocabContainer.style.height = "auto";
                vocabContainer.style.overflow = "visible";
            }
            const vocabPanel = element.querySelector("#vocab-panel");
            if(vocabPanel) {
                vocabPanel.style.height = "auto";
                vocabPanel.classList.add("pdf-page-break"); // 詞彙強制分頁
            }

            // 4. 圖表旋轉與分頁
            const mapContainer = element.querySelector("#mermaid-chart");
            if(mapContainer) {
                const parent = mapContainer.parentElement;
                parent.parentElement.classList.add("pdf-page-break"); // 圖表強制分頁
                parent.style.height = "1000px"; // 預留旋轉空間
                mapContainer.classList.add("pdf-rotate-map"); // 加上旋轉 class
            }

            // 5. 迷思分頁
            const mythPanel = element.querySelector("#myth-list").parentElement;
            if(mythPanel) {
                mythPanel.classList.add("pdf-page-break");
            }

            // 6. 生成
            const opt = {
                margin:       10,
                filename:     currentResultData.raw_content.unitName + "_重點整理.pdf",
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak:    { mode: ['css', 'legacy'] }
            };

            html2pdf().set(opt).from(element).save();
        }

        function toggleChat() { document.getElementById("xiaoke-window").classList.toggle("closed"); }
        async function sendChatMessage() {
            const input = document.getElementById("chat-input"); 
            const msg = input.value.trim(); 
            if(!msg) return;
            const currentUser = JSON.parse(sessionStorage.getItem("currentUser") || '{"name":"訪客"}');
            const chatBody = document.getElementById("chat-messages");
            chatBody.innerHTML += `<div class="self-end bg-blue-600 text-white p-3 rounded-lg rounded-tr-none shadow-sm max-w-[85%] ml-auto text-sm">${msg}</div>`;
            input.value = ""; chatBody.scrollTop = chatBody.scrollHeight;
            try {
                const contextText = currentResultData ? currentResultData.raw_content.text : "";
                const contextVocab = currentResultData ? currentResultData.raw_content.vocab_str : "";
                const res = await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'chat_with_ai', message: msg, currentUnit: filters.unitName || "", contextText: contextText, contextVocab: contextVocab, userName: currentUser.name, stage: filters.stage, publisher: filters.publisher, grade: filters.grade, semester: filters.semester }) });
                const json = await res.json();
                const cleanReply = json.data.replace(/\*\*/g, "");
                chatBody.innerHTML += `<div class="self-start bg-white border border-slate-100 p-3 rounded-lg rounded-tr-none shadow-sm max-w-[85%] text-sm"><span class="font-bold text-blue-600 block mb-1 text-xs">小科 AI</span>${cleanReply}</div>`;
                chatBody.scrollTop = chatBody.scrollHeight;
            } catch(e) { console.error(e); }
        }

        function openModal() {
            const chartHtml = document.getElementById("mermaid-chart").innerHTML;
            if (!chartHtml) return;
            const modal = document.getElementById("image-modal");
            const content = document.getElementById("modal-content");
            content.innerHTML = chartHtml;
            content.firstElementChild.style.minWidth = "auto"; 
            modal.classList.remove("hidden");
            modal.classList.add("flex");
        }
        function closeModal() {
            const modal = document.getElementById("image-modal");
            modal.classList.add("hidden");
            modal.classList.remove("flex");
        }  
    </script>
</body>
</html>
