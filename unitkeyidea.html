<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unit Key Ideas | Science Learning Hub</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <script>
        // 設定 Tailwind 主題顏色，與 student.html 保持一致
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        student: { light: '#bfdbfe', DEFAULT: '#3b82f6', dark: '#1d4ed8' },
                        glass: 'rgba(255, 255, 255, 0.85)'
                    }
                }
            }
        }
        // 初始化 Mermaid
        mermaid.initialize({ startOnLoad: false, theme: 'neutral' });
    </script>

    <style>
        /* 玻璃擬態背景 */
        body {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        /* 載入動畫 */
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* 隱藏卷軸但保持功能 */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-800 font-sans">

    <nav class="glass-panel sticky top-0 z-50 w-full border-b border-white/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-4">
                    <a href="student.html" class="flex items-center justify-center w-10 h-10 rounded-full bg-white text-slate-500 hover:text-blue-600 hover:bg-blue-50 transition shadow-sm">
                        <i class="fa-solid fa-arrow-left"></i>
                    </a>
                    <div class="flex flex-col">
                        <span class="font-bold text-lg text-slate-800 tracking-tight" data-i18n="page_title">單元重點實驗室</span>
                        <span class="text-xs text-slate-500" data-i18n="page_subtitle">AI 智能筆記生成</span>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <select id="language-selector" onchange="changeLanguage()" class="bg-white/50 border-none text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 cursor-pointer text-slate-600 font-medium">
                        <option value="zh-TW">繁體中文</option>
                        <option value="en">English</option>
                        <option value="ja">日本語</option>
                    </select>
                    
                    <div class="flex items-center gap-2 pl-4 border-l border-slate-300">
                        <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold shadow-md" id="user-avatar">?</div>
                        <span class="text-sm font-semibold hidden md:block" id="user-name">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div id="selection-panel" class="glass-panel rounded-2xl p-6 mb-8 transition-all duration-500">
            <div class="flex items-center gap-2 mb-4">
                <i class="fa-solid fa-filter text-blue-600"></i>
                <h2 class="font-bold text-lg" data-i18n="select_unit">選擇學習範圍</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1" data-i18n="label_stage">階段</label>
                    <select id="sel-stage" onchange="updateGrades()" class="w-full rounded-xl border-slate-200 bg-white p-2.5 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="" disabled selected>請選擇...</option>
                        <option value="elem">國小 (Elementary)</option>
                        <option value="junior">國中 (Junior High)</option>
                        <option value="senior">高中 (Senior High)</option>
                    </select>
                </div>

                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1" data-i18n="label_grade">年級</label>
                    <select id="sel-grade" onchange="updateSemesters()" disabled class="w-full rounded-xl border-slate-200 bg-gray-50 p-2.5 text-sm shadow-sm disabled:opacity-50">
                        <option value="" disabled selected>請先選階段</option>
                    </select>
                </div>

                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1" data-i18n="label_version">版本</label>
                    <select id="sel-version" class="w-full rounded-xl border-slate-200 bg-white p-2.5 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="kang">康軒 (Kang Hsuan)</option>
                        <option value="han">翰林 (Han Lin)</option>
                        <option value="nan">南一 (Nan Yi)</option>
                    </select>
                </div>

                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1" data-i18n="label_semester">學期</label>
                    <select id="sel-semester" onchange="updateUnits()" disabled class="w-full rounded-xl border-slate-200 bg-gray-50 p-2.5 text-sm shadow-sm disabled:opacity-50">
                        <option value="" disabled selected>請先選年級</option>
                    </select>
                </div>

                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1" data-i18n="label_unit">單元</label>
                    <select id="sel-unit" disabled class="w-full rounded-xl border-slate-200 bg-gray-50 p-2.5 text-sm shadow-sm disabled:opacity-50">
                        <option value="" disabled selected>請先選學期</option>
                    </select>
                </div>
            </div>

            <div class="mt-6 flex justify-end">
                <button onclick="generateContent()" id="btn-generate" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-8 rounded-xl shadow-lg shadow-blue-500/30 transition transform active:scale-95 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                    <span data-i18n="btn_generate">生成重點整理</span>
                </button>
            </div>
        </div>

        <div id="loading-view" class="hidden flex-col items-center justify-center py-20">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-16 w-16 mb-6"></div>
            <h3 class="text-xl font-bold text-slate-700" data-i18n="msg_generating">AI 正在分析課文並繪製圖表...</h3>
            <p class="text-slate-500 mt-2" data-i18n="msg_wait">請稍候，這可能需要幾秒鐘</p>
        </div>

        <div id="content-view" class="hidden animate-fade-in-up">
            
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div>
                    <span class="inline-block px-3 py-1 bg-blue-100 text-blue-600 rounded-full text-xs font-bold tracking-wider mb-2" id="result-tag">SCIENCE • G7 • UNIT 3</span>
                    <h1 class="text-3xl font-black text-slate-800" id="result-title">光與影的奇幻旅程</h1>
                </div>
                <div class="flex gap-2">
                    <button class="bg-white hover:bg-slate-50 text-slate-600 font-medium py-2 px-4 rounded-lg border border-slate-200 shadow-sm transition">
                        <i class="fa-solid fa-print mr-1"></i> PDF
                    </button>
                    <a href="AIevaluation.html" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow-md shadow-green-500/20 transition flex items-center gap-2">
                        <i class="fa-solid fa-clipboard-check"></i> <span data-i18n="go_quiz">自我評量</span>
                    </a>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <div class="md:col-span-2 glass-panel rounded-2xl p-6 border-l-4 border-blue-500">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2 text-blue-800">
                        <i class="fa-solid fa-star text-yellow-400"></i> <span data-i18n="card_summary">核心概念摘要</span>
                    </h3>
                    <div class="prose prose-blue max-w-none text-slate-600 leading-relaxed" id="summary-text">
                        </div>
                </div>

                <div class="glass-panel rounded-2xl p-6 bg-gradient-to-br from-white to-blue-50">
                    <h3 class="font-bold text-lg mb-4 text-slate-700" data-i18n="card_keywords">關鍵詞彙</h3>
                    <div class="space-y-3" id="keywords-list">
                        </div>
                </div>

                <div class="md:col-span-3 glass-panel rounded-2xl p-6 overflow-hidden">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2 text-purple-700">
                        <i class="fa-solid fa-project-diagram"></i> <span data-i18n="card_map">知識架構圖 (AI Generated)</span>
                    </h3>
                    <div class="w-full overflow-x-auto bg-white/50 rounded-xl p-4 flex justify-center">
                        <div class="mermaid" id="mermaid-chart">
                            </div>
                    </div>
                </div>

                <div class="md:col-span-3 glass-panel rounded-2xl p-6 border border-red-100 bg-red-50/30">
                    <h3 class="font-bold text-lg mb-4 text-red-600 flex items-center gap-2">
                        <i class="fa-solid fa-triangle-exclamation"></i> <span data-i18n="card_myth">常見迷思與陷阱</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="myth-list">
                        </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        // 1. 用戶身份驗證邏輯
        const currentUserStr = sessionStorage.getItem("currentUser");
        let currentUser = null;

        if (!currentUserStr) {
            // 未登入，強制導回 student.html 或首頁
            alert("請先登入學生專區");
            window.location.href = "index.html";
        } else {
            currentUser = JSON.parse(currentUserStr);
            document.getElementById("user-name").innerText = currentUser.name;
            document.getElementById("user-avatar").innerText = currentUser.name.charAt(0).toUpperCase();
        }

        // 2. 模擬課程資料庫 (Cascading Data)
        const curriculumData = {
            "elem": { grades: ["小學五年級", "小學六年級"], semesters: ["上學期", "下學期"], units: ["植物的構造", "熱對流", "天氣變化"] },
            "junior": { grades: ["國中七年級", "國中八年級", "國中九年級"], semesters: ["上學期", "下學期"], units: ["光與影", "細胞分裂", "牛頓運動定律", "遺傳"] },
            "senior": { grades: ["高中一年級", "高中二年級"], semesters: ["全學年"], units: ["化學計量", "量子物理入門"] }
        };

        // 3. 多語系翻譯包
        const translations = {
            "zh-TW": {
                "page_title": "單元重點實驗室", "page_subtitle": "AI 智能筆記生成",
                "select_unit": "選擇學習範圍", "label_stage": "階段", "label_grade": "年級", "label_version": "版本", "label_semester": "學期", "label_unit": "單元",
                "btn_generate": "生成重點整理", "msg_generating": "AI 正在分析課文並繪製圖表...", "msg_wait": "請稍候，這可能需要幾秒鐘",
                "go_quiz": "自我評量", "card_summary": "核心概念摘要", "card_keywords": "關鍵詞彙", "card_map": "知識架構圖", "card_myth": "常見迷思"
            },
            "en": {
                "page_title": "Unit Key Ideas Lab", "page_subtitle": "AI Smart Note Generator",
                "select_unit": "Select Scope", "label_stage": "Stage", "label_grade": "Grade", "label_version": "Publisher", "label_semester": "Semester", "label_unit": "Unit",
                "btn_generate": "Generate Notes", "msg_generating": "AI is analyzing text and drawing charts...", "msg_wait": "Please wait a moment",
                "go_quiz": "Self Assessment", "card_summary": "Core Summary", "card_keywords": "Keywords", "card_map": "Knowledge Map", "card_myth": "Common Myths"
            },
            "ja": {
                "page_title": "単元ポイントラボ", "page_subtitle": "AIスマートノート生成",
                "select_unit": "学習範囲を選択", "label_stage": "段階", "label_grade": "学年", "label_version": "出版社", "label_semester": "学期", "label_unit": "単元",
                "btn_generate": "ノート生成", "msg_generating": "AIがテキストを分析し、図を作成中...", "msg_wait": "少々お待ちください",
                "go_quiz": "自己評価", "card_summary": "核心要約", "card_keywords": "キーワード", "card_map": "知識マップ", "card_myth": "よくある誤解"
            }
        };

        // 4. UI 連動邏輯
        function updateGrades() {
            const stage = document.getElementById("sel-stage").value;
            const gradeSel = document.getElementById("sel-grade");
            gradeSel.innerHTML = '<option value="" disabled selected>請選擇...</option>';
            
            if(stage && curriculumData[stage]) {
                curriculumData[stage].grades.forEach(g => {
                    gradeSel.innerHTML += `<option value="${g}">${g}</option>`;
                });
                gradeSel.disabled = false;
            }
            // 重置後續
            document.getElementById("sel-semester").innerHTML = '<option value="" disabled selected>請先選年級</option>';
            document.getElementById("sel-semester").disabled = true;
            document.getElementById("sel-unit").innerHTML = '<option value="" disabled selected>請先選學期</option>';
            document.getElementById("sel-unit").disabled = true;
        }

        function updateSemesters() {
            const stage = document.getElementById("sel-stage").value;
            const semSel = document.getElementById("sel-semester");
            semSel.innerHTML = '<option value="" disabled selected>請選擇...</option>';
            
            if(stage && curriculumData[stage]) {
                curriculumData[stage].semesters.forEach(s => {
                    semSel.innerHTML += `<option value="${s}">${s}</option>`;
                });
                semSel.disabled = false;
            }
        }

        function updateUnits() {
            const stage = document.getElementById("sel-stage").value;
            const unitSel = document.getElementById("sel-unit");
            unitSel.innerHTML = '<option value="" disabled selected>請選擇...</option>';
            
            if(stage && curriculumData[stage]) {
                curriculumData[stage].units.forEach(u => {
                    unitSel.innerHTML += `<option value="${u}">${u}</option>`;
                });
                unitSel.disabled = false;
            }
        }

        // 5. 生成內容 (核心功能)
        function generateContent() {
            const unitName = document.getElementById("sel-unit").value;
            if(!unitName) { alert("請完整選擇單元"); return; }

            // 切換 UI 狀態
            document.getElementById("selection-panel").classList.add("hidden");
            document.getElementById("loading-view").classList.remove("hidden");
            document.getElementById("loading-view").classList.add("flex");

            // 模擬 API 延遲 (此處應換成 fetch 呼叫 GAS API)
            setTimeout(() => {
                document.getElementById("loading-view").classList.add("hidden");
                document.getElementById("loading-view").classList.remove("flex");
                document.getElementById("content-view").classList.remove("hidden");
                
                // 填入模擬數據 (實際應來自 JSON response)
                renderMockData(unitName);
                
                // 渲染 Mermaid 圖表
                mermaid.init();
            }, 1500);
        }

        function renderMockData(unitName) {
            // 設定標題
            document.getElementById("result-title").innerText = unitName + "的奧秘";
            document.getElementById("result-tag").innerText = `SCIENCE • ${document.getElementById("sel-grade").value} • ${unitName}`;

            // 1. 摘要內容
            document.getElementById("summary-text").innerHTML = `
                <p class="mb-2"><strong class="text-blue-600">光的直線傳播</strong>是本單元的核心。光在均勻介質中是沿直線前進的，這解釋了影子的形成以及針孔成像的原理。</p>
                <p>當光遇到不透明物體時，會在物體後方形成<span class="bg-yellow-200 px-1 rounded">本影</span>與<span class="bg-yellow-100 px-1 rounded">半影</span>。影子的形狀與光源的性質（點光源或面光源）密切相關。</p>
            `;

            // 2. 關鍵字卡片
            const keywords = [
                { term: "直線傳播", def: "光在同一介質中沿直線前進的特性" },
                { term: "反射定律", def: "入射角等於反射角" },
                { term: "漫反射", def: "光照射在粗糙表面向四面八方反射" }
            ];
            const kwContainer = document.getElementById("keywords-list");
            kwContainer.innerHTML = "";
            keywords.forEach(k => {
                kwContainer.innerHTML += `
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:border-blue-300 transition cursor-help group">
                        <div class="font-bold text-blue-600 text-sm group-hover:text-blue-800">${k.term}</div>
                        <div class="text-xs text-slate-500 mt-1">${k.def}</div>
                    </div>
                `;
            });

            // 3. Mermaid 圖表 (動態生成)
            // 實際應用時，這裡的字串應由 AI 生成
            const mermaidCode = `
                graph LR
                A[光 Light] --> B(直線傳播)
                A --> C(反射 Reflection)
                B --> D[影子 Shadow]
                B --> E[針孔成像]
                C --> F[平面鏡]
                C --> G[凹凸面鏡]
                F --> H(虛像)
            `;
            document.getElementById("mermaid-chart").innerHTML = mermaidCode;
            document.getElementById("mermaid-chart").removeAttribute("data-processed"); // 重置 Mermaid 狀態

            // 4. 迷思概念
            const myths = [
                { title: "影子是黑色的光？", desc: "錯。影子是光被遮擋的區域，是「無光」或「少光」的結果，不是一種物質。" },
                { title: "鏡子裡的人是真實大小？", desc: "平面鏡成像是等大虛像，但若距離改變，視角大小會改變，容易產生誤解。" }
            ];
            const mythContainer = document.getElementById("myth-list");
            mythContainer.innerHTML = "";
            myths.forEach(m => {
                mythContainer.innerHTML += `
                    <div class="bg-white p-4 rounded-xl border-l-4 border-red-400 shadow-sm">
                        <div class="font-bold text-red-700 mb-1 text-sm"><i class="fa-solid fa-xmark"></i> ${m.title}</div>
                        <div class="text-xs text-slate-600">${m.desc}</div>
                    </div>
                `;
            });
        }

        // 6. 語言切換邏輯
        function initLanguage() {
            const savedLang = localStorage.getItem("slh_lang") || "zh-TW";
            document.getElementById("language-selector").value = savedLang;
            changeLanguage();
        }

        function changeLanguage() {
            const lang = document.getElementById("language-selector").value;
            localStorage.setItem("slh_lang", lang);
            
            // 替換靜態文字
            document.querySelectorAll("[data-i18n]").forEach(el => {
                const key = el.getAttribute("data-i18n");
                if (translations[lang][key]) {
                    el.innerText = translations[lang][key];
                }
            });

            // 注意：已生成的動態內容(如AI摘要)通常需要重新呼叫 API 才能翻譯
            // 這裡僅作 UI 示範
        }

        // 啟動
        window.addEventListener('DOMContentLoaded', initLanguage);

    </script>
</body>
</html>
