<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å–®å…ƒé‡é»æ•´ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        tailwind.config = { theme: { extend: { colors: { student: '#3b82f6' }, animation: { "fade-in-up": "fadeInUp 0.5s ease-out forwards" }, keyframes: { fadeInUp: { "0%": { opacity: "0", transform: "translateY(20px)" }, "100%": { opacity: "1", transform: "translateY(0)" } } } } } }
        mermaid.initialize({ startOnLoad: false, theme: 'neutral', securityLevel: 'loose' });
    </script>
    
    <style>
        body { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); font-family: "Microsoft JhengHei", sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.7); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .chat-window { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: bottom right; }
        .chat-window.closed { transform: scale(0); opacity: 0; pointer-events: none; }

        /* æ‘˜è¦æ’ç‰ˆ */
        #summary-text h3 { 
            font-size: 1.3rem; font-weight: 800; color: #1e3a8a; 
            margin-top: 1.5rem; margin-bottom: 0.75rem; 
            padding: 0.5rem 0.75rem; border-left: 5px solid #3b82f6; 
            background: linear-gradient(90deg, #eff6ff 0%, rgba(255,255,255,0) 100%); 
            border-radius: 0 8px 8px 0; 
        }
        #summary-text ul { list-style-type: none; padding-left: 0.5rem; }
        #summary-text li { position: relative; padding-left: 1.5rem; margin-bottom: 0.5rem; color: #374151; font-size: 1.05rem; }
        #summary-text li::before { content: "â€¢"; color: #3b82f6; font-weight: bold; font-size: 1.2em; position: absolute; left: 0.25rem; top: -2px; }
        
        .vocab-item { transition: transform 0.2s; }
        .vocab-item:hover { transform: translateY(-2px); }

        /* Mermaid åœ–è¡¨æ¨£å¼ */
        #mermaid-chart {
            width: 100%;
            overflow-x: auto;       
            padding: 20px 0;
            display: flex;
            justify-content: center;
            /* è®“åœ–è¡¨æœ¬èº«ä¸é˜»æ“‹é»æ“Š */
            pointer-events: none; 
        }
        #mermaid-chart .mermaid svg {
            width: 100% !important;      
            max-width: 100% !important;  
            height: auto !important;
            font-family: "Microsoft JhengHei", sans-serif !important; 
        }

        /* æ‰‹æ©Ÿå…¨è¢å¹•ç‡ˆç®± (å…è¨±æ²å‹•) */
        #image-modal { z-index: 99999; overflow: auto; -webkit-overflow-scrolling: touch; }
        #modal-content {
            width: 95vw; height: auto; min-height: 50vh;
            max-width: none !important; overflow: visible; /* å…è¨±æº¢å‡º */
            background: white; border-radius: 12px; padding: 15px;
            display: flex; align-items: flex-start; justify-content: center;
        }

        /* PDF ä¸‹è¼‰å°ˆç”¨ */
        .pdf-page-break { page-break-before: always; break-before: page; margin-top: 20px; display: block; }
        .pdf-rotate-map {
            transform: rotate(90deg); transform-origin: top left;
            width: 130% !important; margin-left: 40px; margin-top: -40px; 
            overflow: visible !important;
        }
        .no-pdf { display: none !important; }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col">

    <nav class="glass-panel sticky top-0 z-50 px-6 py-4 flex justify-between items-center no-print">
        <div class="flex items-center gap-4">
            <a href="student.html" class="group flex items-center gap-2 text-slate-500 hover:text-blue-600 transition decoration-0">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow group-hover:shadow-md transition">
                    <i class="fa-solid fa-arrow-left"></i>
                </div>
                <span class="font-bold hidden md:block" data-i18n="back_home">è¿”å›å­¸ç¿’ä¸­å¿ƒ</span>
            </a>
            <div class="h-8 w-px bg-slate-300 mx-2 hidden sm:block"></div>
            <div class="hidden sm:block">
                <h1 class="font-bold text-lg" data-i18n="page_title">å–®å…ƒé‡é»æ•´ç†</h1>
                <p class="text-xs text-slate-500" data-i18n="page_subtitle">AI æ™ºèƒ½ç­†è¨˜ç”Ÿæˆ</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <a href="aievaluation.html" class="group flex items-center gap-2 text-slate-500 hover:text-green-600 transition decoration-0 mr-2">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow group-hover:shadow-md transition border border-slate-100">
                    <i class="fa-solid fa-clipboard-check"></i>
                </div>
                <span class="font-bold hidden lg:block" data-i18n="btn_eval">AI è©•åˆ†è¨ºæ–·</span>
            </a>
            <select id="language-selector" onchange="changeLanguage()" class="bg-white/50 border text-xs rounded-lg p-1.5 cursor-pointer outline-none focus:ring-1 focus:ring-blue-300">
                <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                <option value="en">English</option>
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
            </select>
            <div class="flex items-center gap-2 pl-2 border-l border-slate-300">
                 <div id="user-info" class="text-sm font-bold text-blue-600">è¨ªå®¢</div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8 flex-1 w-full pb-24">
        <div id="selection-panel" class="glass-panel rounded-2xl p-6 mb-8 no-print">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-database"></i> <span data-i18n="settings_title">è«‹æŒ‘é¸ä½ è¦çš„å­¸ç¿’å–®å…ƒ</span></h2>
                <span id="db-status" class="text-xs font-bold text-orange-500"><i class="fa-solid fa-circle-notch fa-spin"></i> Loading...</span>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_stage">å­¸ç¿’éšæ®µ</label><select id="sel-stage" class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-blue-500"><option value="" disabled selected>Loading...</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_publisher">ç‰ˆæœ¬</label><select id="sel-publisher" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>Select...</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_grade">å¹´ç´š</label><select id="sel-grade" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>Select...</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_semester">å­¸æœŸ</label><select id="sel-semester" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>Select...</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 ml-1" data-i18n="label_unit">å–®å…ƒåç¨±</label><select id="sel-unit" disabled class="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none disabled:bg-slate-50"><option value="" disabled selected>Select...</option></select></div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="btn-generate" onclick="startGeneration()" disabled class="bg-blue-600 text-white px-8 py-2.5 rounded-xl font-bold shadow-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> <span data-i18n="btn_generate">AI åˆ†æä¸¦ç”Ÿæˆ</span>
                </button>
            </div>
        </div>

        <div id="loading-view" class="hidden flex-col items-center justify-center py-20">
            <div class="loader mb-4"></div>
            <h3 class="text-xl font-bold text-slate-700">AI å–®å…ƒé‡é»æ•´ç†ä¸­...</h3>
        </div>

        <div id="content-view" class="hidden animate-fade-in-up">
            <div class="mb-6 flex flex-col md:flex-row justify-between md:items-end gap-4 relative z-20">
                <div>
                    <span id="result-tag" class="text-xs font-bold bg-blue-100 text-blue-600 px-3 py-1 rounded-full">TAG</span>
                    <h1 id="result-title" class="text-3xl font-black text-slate-800 mt-2">Title</h1>
                </div>
                
                <div class="flex gap-2 no-print relative" style="z-index: 9999;">
                    <button onclick="downloadTXT()" ontouchend="downloadTXT()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-6 py-3 rounded-xl font-bold text-sm transition cursor-pointer border border-slate-200 shadow-sm flex-1 md:flex-none justify-center flex items-center active:scale-95">
                        <i class="fa-solid fa-file-lines mr-2"></i> <span data-i18n="btn_txt">ä¸‹è¼‰ TXT</span>
                    </button>
                    <button onclick="downloadPDF()" ontouchend="downloadPDF()" class="bg-red-50 hover:bg-red-100 text-red-600 px-6 py-3 rounded-xl font-bold text-sm transition cursor-pointer border border-red-100 shadow-sm flex-1 md:flex-none justify-center flex items-center active:scale-95">
                        <i class="fa-solid fa-file-pdf mr-2"></i> <span data-i18n="btn_pdf">ä¸‹è¼‰ PDF</span>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-stretch">
                
                <div id="summary-panel" class="md:col-span-2 glass-panel p-6 rounded-2xl bg-white border-l-4 border-blue-500 h-full flex flex-col shadow-sm">
                    <h3 class="font-bold text-blue-800 mb-4 text-xl"><i class="fa-solid fa-star text-yellow-400"></i> <span data-i18n="title_summary">æ ¸å¿ƒæ¦‚å¿µæ‘˜è¦</span></h3>
                    <div id="summary-text" class="prose max-w-none text-slate-600 leading-relaxed flex-1"></div>
                </div>
                
                <div id="vocab-panel" class="glass-panel p-6 rounded-2xl bg-gradient-to-br from-white to-blue-50 border-l-4 border-blue-500 h-full flex flex-col shadow-sm pdf-page-break">
                    <h3 class="font-bold text-slate-700 mb-4 text-xl"><span data-i18n="title_vocab">ç§‘å­¸è©å½™èˆ‡å®šç¾©</span></h3>
                    <div class="flex-1 overflow-y-auto custom-scrollbar min-h-0 pr-1">
                        <div id="keywords-list" class="space-y-3 pb-2"></div>
                    </div>
                </div>
                
                <div class="md:col-span-3 glass-panel p-6 rounded-2xl bg-white pdf-page-break shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-purple-700 text-xl"><i class="fa-solid fa-project-diagram"></i> <span data-i18n="title_map">çŸ¥è­˜æ¶æ§‹åœ–</span></h3>
                        <button onclick="openModal()" ontouchend="openModal()" class="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg text-sm font-bold border border-blue-200 hover:bg-blue-100 transition no-pdf">
                            <i class="fa-solid fa-expand mr-1"></i> å…¨è¢å¹•
                        </button>
                    </div>
                    
                    <div class="bg-slate-50 rounded-xl p-4 md:p-6 border border-slate-100 overflow-hidden w-full cursor-pointer hover:border-blue-300 transition relative" 
                         onclick="openModal()" 
                         ontouchend="openModal()" 
                         title="é»æ“Šæ”¾å¤§" 
                         id="chart-container">
                        <div class="absolute inset-0 z-10 bg-transparent flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
                            <span class="bg-black/50 text-white px-3 py-1 rounded text-sm">ğŸ‘† é»æ“Šæ”¾å¤§</span>
                        </div>
                        <div id="mermaid-chart" class="w-full flex justify-center"></div>
                    </div>
                </div>
                
                <div class="md:col-span-3 glass-panel p-6 rounded-2xl bg-red-50/50 border border-red-100 pdf-page-break shadow-sm">
                    <h3 class="font-bold text-red-600 mb-4 text-xl"><i class="fa-solid fa-circle-exclamation"></i> <span data-i18n="title_myth">å¸¸è¦‹è¿·æ€è¨ºæ–·</span></h3>
                    <div id="myth-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="floating-chat" class="hidden fixed bottom-6 right-6 z-[100] flex flex-col items-end gap-4 no-print">
        <div id="xiaoke-window" class="chat-window closed w-80 md:w-96 bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col overflow-hidden h-[500px]">
            <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <img src="https://raw.githubusercontent.com/Shiwen6674/sciencelearninghub/main/irob.png" alt="å°ç§‘" class="w-8 h-8 rounded-full object-cover bg-white">
                    <span class="font-bold">å°ç§‘ AI</span>
                </div>
                <button onclick="toggleChat()" class="text-white/80 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex-1 p-4 bg-slate-50 overflow-y-auto text-sm space-y-3" id="chat-messages"></div>
            <div class="p-3 bg-white border-t border-slate-100 flex gap-2">
                <input type="text" id="chat-input" placeholder="..." class="flex-1 bg-slate-100 border-none rounded-full px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" onkeypress="if(event.key==='Enter') sendChatMessage()">
                <button onclick="sendChatMessage()" class="bg-blue-600 text-white w-10 h-10 rounded-full hover:bg-blue-700 transition flex items-center justify-center"><i class="fa-solid fa-paper-plane text-xs"></i></button>
            </div>
        </div>
        <button onclick="toggleChat()" class="w-14 h-14 bg-white rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition overflow-hidden border-2 border-blue-600 p-1">
            <img src="https://raw.githubusercontent.com/Shiwen6674/sciencelearninghub/main/irob.png" alt="å°ç§‘" class="w-full h-full object-cover rounded-full">
        </button>
    </div>

    <div id="image-modal" class="fixed inset-0 z-[200] bg-black/95 hidden flex-col items-center justify-center p-2 transition-opacity duration-300" onclick="closeModal()">
        <button class="absolute top-4 right-4 text-white/90 hover:text-white text-5xl font-bold p-2 z-[201]" onclick="closeModal()">&times;</button>
        <div id="modal-content" class="bg-white rounded-lg shadow-2xl" onclick="event.stopPropagation()"></div>
    </div>

    <script>
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxBWrZCp-xLckDGZnhe64K0IUa_8CJZRzqZbrgL8lQdNn3S1WgaEzbdOtpo4mGwN6_H/exec";
        
        let allData = [];
        let filters = {};
        let currentResultData = null;

        const i18n = {
            "zh-TW": { back_home:"è¿”å›å­¸ç¿’ä¸­å¿ƒ", btn_bilingual:"ç§‘å­¸é›™èªé–±è®€", btn_eval:"AI è©•åˆ†è¨ºæ–·", page_title:"å–®å…ƒé‡é»æ•´ç†", page_subtitle:"AI æ™ºèƒ½ç­†è¨˜ç”Ÿæˆ", settings_title:"è«‹æŒ‘é¸ä½ è¦çš„å­¸ç¿’å–®å…ƒ", label_stage:"å­¸ç¿’éšæ®µ", label_publisher:"ç‰ˆæœ¬", label_grade:"å¹´ç´š", label_semester:"å­¸æœŸ", label_unit:"å–®å…ƒåç¨±", btn_generate:"AI åˆ†æä¸¦ç”Ÿæˆ", btn_txt:"ä¸‹è¼‰ TXT", btn_pdf:"ä¸‹è¼‰ PDF", title_summary:"æ ¸å¿ƒæ¦‚å¿µæ‘˜è¦", title_vocab:"ç§‘å­¸è©å½™èˆ‡å®šç¾©", title_map:"çŸ¥è­˜æ¶æ§‹åœ–", title_myth:"å¸¸è¦‹è¿·æ€è¨ºæ–·" },
            "en": { back_home:"Back Home", btn_bilingual:"Bilingual Reading", btn_eval:"AI Assessment", page_title:"Unit Summary", page_subtitle:"AI Generator", settings_title:"Select Learning Unit", label_stage:"Level", label_publisher:"Publisher", label_grade:"Grade", label_semester:"Semester", label_unit:"Unit", btn_generate:"Generate", btn_txt:"Download TXT", btn_pdf:"Download PDF", title_summary:"Core Concepts", title_vocab:"Vocabulary", title_map:"Mind Map", title_myth:"Common Myths" },
            "ja": { back_home:"ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹", btn_bilingual:"äºŒè¨€èªèª­è§£", btn_eval:"AI è¨ºæ–­ãƒ»æ¡ç‚¹", page_title:"å˜å…ƒã®ã¾ã¨ã‚", page_subtitle:"AIãƒãƒ¼ãƒˆç”Ÿæˆ", settings_title:"å­¦ç¿’å˜å…ƒã‚’é¸æŠ", label_stage:"æ®µéš", label_publisher:"å‡ºç‰ˆç¤¾", label_grade:"å­¦å¹´", label_semester:"å­¦æœŸ", label_unit:"å˜å…ƒ", btn_generate:"ç”Ÿæˆã™ã‚‹", btn_txt:"TXTã‚’ä¿å­˜", btn_pdf:"PDFã‚’ä¿å­˜", title_summary:"æ ¸å¿ƒæ¦‚å¿µ", title_vocab:"ç§‘å­¦ç”¨èª", title_map:"çŸ¥è­˜ãƒãƒƒãƒ—", title_myth:"ã‚ˆãã‚ã‚‹èª¤è§£" },
            "zh-CN": { back_home:"è¿”å›å­¦ä¹ ä¸­å¿ƒ", btn_bilingual:"ç§‘å­¦åŒè¯­é˜…è¯»", btn_eval:"AI è¯„åˆ†è¯Šæ–­", page_title:"å•å…ƒé‡ç‚¹æ•´ç†", page_subtitle:"AI æ™ºèƒ½ç¬”è®°ç”Ÿæˆ", settings_title:"è¯·æŒ‘é€‰ä½ è¦çš„å­¦ä¹ å•å…ƒ", label_stage:"å­¦ä¹ é˜¶æ®µ", label_publisher:"ç‰ˆæœ¬", label_grade:"å¹´çº§", label_semester:"å­¦æœŸ", label_unit:"å•å…ƒåç§°", btn_generate:"AI åˆ†æå¹¶ç”Ÿæˆ", btn_txt:"ä¸‹è½½ TXT", btn_pdf:"ä¸‹è½½ PDF", title_summary:"æ ¸å¿ƒæ¦‚å¿µæ‘˜è¦", title_vocab:"ç§‘å­¦è¯æ±‡ä¸å®šä¹‰", title_map:"çŸ¥è¯†æ¶æ„å›¾", title_myth:"å¸¸è§è¿·æ€è¯Šæ–­" }
        };

        window.onload = async () => {
            const user = JSON.parse(sessionStorage.getItem("currentUser") || '{"name":"è¨ªå®¢"}');
            document.getElementById("user-info").innerText = user.name;
            try {
                const res = await fetch(GAS_API_URL + "?action=get_metadata");
                const json = await res.json();
                if(json.status === "success") {
                    allData = json.data;
                    document.getElementById("db-status").innerHTML = `<i class="fa-solid fa-check"></i> è³‡æ–™åº«é€£ç·šæˆåŠŸ`;
                    document.getElementById("db-status").className = "text-xs font-bold text-green-600";
                    initSelectors();
                } else throw new Error(json.message);
            } catch(e) { console.error(e); document.getElementById("db-status").innerText = "é€£ç·šå¤±æ•—"; document.getElementById("db-status").className = "text-xs font-bold text-red-500"; }
        };

        function changeLanguage() {
            const lang = document.getElementById("language-selector").value;
            document.querySelectorAll("[data-i18n]").forEach(el => {
                const key = el.getAttribute("data-i18n");
                if (i18n[lang][key]) el.innerText = i18n[lang][key];
            });
        }

        function initSelectors() {
            const stages = [...new Set(allData.map(d => d.stage))];
            populate("sel-stage", stages);
            document.getElementById("sel-stage").onchange = (e) => updateLevel(1, e.target.value);
            document.getElementById("sel-publisher").onchange = (e) => updateLevel(2, e.target.value);
            document.getElementById("sel-grade").onchange = (e) => updateLevel(3, e.target.value);
            document.getElementById("sel-semester").onchange = (e) => updateLevel(4, e.target.value);
            document.getElementById("sel-unit").onchange = (e) => { filters.unitName = e.target.value; document.getElementById("btn-generate").disabled = false; };
        }
        function updateLevel(level, value) {
            if(level===1) filters={stage:value}; if(level===2){filters.publisher=value; delete filters.grade; delete filters.semester; delete filters.unitName;} if(level===3){filters.grade=value; delete filters.semester; delete filters.unitName;} if(level===4){filters.semester=value; delete filters.unitName;}
            const ids=["sel-publisher","sel-grade","sel-semester","sel-unit"]; for(let i=level;i<4;i++){ document.getElementById(ids[i]).innerHTML='<option disabled selected>Select...</option>'; document.getElementById(ids[i]).disabled=true; } document.getElementById("btn-generate").disabled=true;
            const relevantData = allData.filter(d => {
                const safeMatch = (dVal, fVal) => !fVal || String(dVal).trim() == String(fVal).trim();
                return safeMatch(d.stage, filters.stage) && safeMatch(d.publisher, filters.publisher) && safeMatch(d.grade, filters.grade) && safeMatch(d.semester, filters.semester);
            });
            if(level===1) populate("sel-publisher", [...new Set(relevantData.map(d=>d.publisher))]);
            if(level===2) populate("sel-grade", [...new Set(relevantData.map(d=>d.grade))].sort((a,b)=>a-b), "grade");
            if(level===3) populate("sel-semester", [...new Set(relevantData.map(d=>d.semester))], "semester");
            if(level===4) {
                const unitSelect = document.getElementById("sel-unit"); unitSelect.innerHTML='<option disabled selected>Select...</option>';
                if(relevantData.length>0) {
                    relevantData.forEach(d => {
                        const opt = document.createElement("option"); opt.value = d.unitName;
                        opt.text = (d.unitType && !isNaN(d.unitType)) ? `ç¬¬${d.unitType}èª² ${d.unitName}` : d.unitName;
                        unitSelect.add(opt);
                    });
                    unitSelect.disabled=false;
                }
            }
        }
        function populate(id, list, type) {
            const el = document.getElementById(id); el.innerHTML='<option disabled selected>Select...</option>';
            list.forEach(o => { const opt = document.createElement("option"); opt.value = o; 
                if(type==="grade") opt.text=o+"å¹´ç´š"; else if(type==="semester") opt.text=(o==="ä¸Š"?"ä¸Šå­¸æœŸ":(o==="ä¸‹"?"ä¸‹å­¸æœŸ":o)); else opt.text=o; el.add(opt); });
            el.disabled=false;
        }

        async function startGeneration() {
            document.getElementById("selection-panel").classList.add("hidden");
            document.getElementById("loading-view").classList.remove("hidden");
            document.getElementById("loading-view").classList.add("flex");
            try {
                const res = await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "get_content_and_generate", filters: filters }) });
                const json = await res.json();
                if(json.status === "success") { 
                    currentResultData = json.data; 
                    renderResult(json.data); 
                } else throw new Error(json.message);
            } catch(e) { alert("Error: " + e.message); location.reload(); }
        }

        function renderResult(data) {
            document.getElementById("floating-chat").classList.remove("hidden");
            document.getElementById("loading-view").classList.add("hidden");
            document.getElementById("loading-view").classList.remove("flex");
            document.getElementById("content-view").classList.remove("hidden");

            const chatBody = document.getElementById("chat-messages");
            chatBody.innerHTML = `<div class="self-start bg-white border border-slate-100 p-3 rounded-lg rounded-tl-none shadow-sm max-w-[85%] text-sm"><span class="font-bold text-blue-600 block mb-1 text-xs">å°ç§‘ AI</span>å—¨ï¼ŒåŒå­¸ä½ å¥½ï¼æˆ‘æ˜¯å°ç§‘ï¼Œé—œæ–¼ã€${data.raw_content.unitName}ã€‘å–®å…ƒï¼Œä½ æœ‰ä»€éº¼å•é¡Œè¦å•æˆ‘å‘¢ï¼Ÿ</div>`;

            document.getElementById("result-title").innerText = data.raw_content.unitName;
            const uType = data.raw_content.unitType;
            const lessonStr = (uType && !isNaN(uType)) ? `ç¬¬${uType}èª²` : (uType || "");
            const semStr = (filters.semester === "ä¸Š" ? "ä¸Šå­¸æœŸ" : (filters.semester === "ä¸‹" ? "ä¸‹å­¸æœŸ" : filters.semester));
            document.getElementById("result-tag").innerText = `${filters.publisher} â€¢ ${filters.grade}å¹´ç´š${semStr} â€¢ ${lessonStr}`;

            const cleanedSummary = data.summary.summary_html.replace(/\*\*/g, ""); 
            document.getElementById("summary-text").innerHTML = cleanedSummary;

            const vocabContainer = document.getElementById("keywords-list");
            vocabContainer.innerHTML = "";
            if(data.summary.vocab_list) {
                data.summary.vocab_list.forEach((item, index) => {
                    const cleanedDef = item.def.replace(/\*\*/g, ""); 
                    vocabContainer.innerHTML += `<div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm mb-2 vocab-item"><div class="flex gap-3"><span class="bg-blue-100 text-blue-700 font-bold px-2 py-1 rounded text-sm h-fit">${index+1}</span><div><div class="font-bold text-slate-800">${item.term}</div><div class="text-sm text-slate-600">${cleanedDef}</div></div></div></div>`;
                });
            }

            // Knowledge Map Rendering
            const chartDiv = document.getElementById("mermaid-chart");
            chartDiv.innerHTML = "";
            if(data.summary.mermaid) {
                let mCode = data.summary.mermaid.replace(/```(mermaid|json)?/gi, "").replace(/```/g, "").trim();
                
                if (/^graph\s+[A-Z]{2}/i.test(mCode)) {
                    mCode = mCode.replace(/^graph\s+[A-Z]{2}/i, "graph TD");
                } else {
                    mCode = "graph TD\n" + mCode;
                }
                
                mCode = mCode.replace(/\[(.*?)\]/g, (match, content) => {
                    let safe = content
                        .replace(/:/g, "ï¼š").replace(/\(/g, "ï¼ˆ").replace(/\)/g, "ï¼‰")
                        .replace(/"/g, "").replace(/'/g, "").replace(/,/g, "ï¼Œ");
                    return `[${safe}]`;
                });

                const mermaidEl = document.createElement("div");
                mermaidEl.className = "mermaid";
                mermaidEl.textContent = mCode;
                chartDiv.appendChild(mermaidEl);

                try {
                    mermaid.initialize({ startOnLoad: false, theme: 'neutral', securityLevel: 'loose', flowchart: { useMaxWidth: false, htmlLabels: true } });
                    mermaid.init(undefined, mermaidEl);
                } catch (err) {
                    console.error("Mermaid Error:", err);
                    chartDiv.innerHTML = `<div class="text-red-500 bg-red-50 p-4 rounded border border-red-200">åœ–è¡¨èªæ³•éŒ¯èª¤</div>`;
                }
            }

            // Myths Rendering
            const mythDiv = document.getElementById("myth-list");
            mythDiv.innerHTML = "";
            if(data.summary.myths) {
                data.summary.myths.forEach(m => {
                    let title = m.myth || m.title || "è¿·æ€";
                    let desc = m.correct || m.correct_concept || m.desc || "æ­£ç¢ºè§€å¿µ";
                    const cleanLabel = (text) => { if (!text) return ""; return text.replace(/\*\*/g, "").replace(/^(è¿·æ€|æ­£ç¢ºè§€å¿µ|æ­£ç¢º|Misconception|Correction)\s*[:ï¼š]\s*/i, "").trim(); };
                    mythDiv.innerHTML += `<div class="bg-white p-5 rounded-xl border border-red-100 shadow-sm hover:shadow-md transition h-full flex flex-col"><div class="flex items-center gap-3 mb-3"><div class="bg-red-100 text-red-600 w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-xmark font-bold"></i></div><div><div class="text-slate-800 font-bold"><span class="text-red-600 font-black text-base">è¿·æ€ï¼š</span>${cleanLabel(title)}</div></div></div><div class="mt-auto pt-3 border-t border-slate-100 pl-11"><div class="text-green-600 font-bold text-sm mb-1"><i class="fa-solid fa-check mr-1"></i> æ­£ç¢ºè§€å¿µ</div><div class="text-sm text-slate-600 leading-relaxed text-justify">${cleanLabel(desc)}</div></div></div>`;
                });
            }
        }

        // â˜…â˜…â˜… ä¸‹è¼‰ TXT å‡½æ•¸ (é˜²æ­¢é›™é‡è§¸ç™¼) â˜…â˜…â˜…
        let isDownloading = false;
        function downloadTXT() {
            if (isDownloading) return;
            isDownloading = true;
            setTimeout(() => isDownloading = false, 1000); // 1ç§’å†·å»

            if(!currentResultData) { alert("è«‹å…ˆç”Ÿæˆå…§å®¹å¾Œå†ä¸‹è¼‰ï¼"); return; }
            
            // æç¤ºç”¨æˆ¶é–‹å§‹ä¸‹è¼‰ (Debug ç”¨)
            // alert('é–‹å§‹è£½ä½œ TXT...'); 

            let content = `========================================\n  å–®å…ƒé‡é»æ•´ç†ï¼š${currentResultData.raw_content.unitName}\n========================================\n\n`;
            let summary = document.getElementById("summary-text").innerText.replace(/\n\s*\n/g, '\n\n').trim();
            content += `ã€ æ ¸å¿ƒæ¦‚å¿µæ‘˜è¦ ã€‘\n----------------------------------------\n${summary}\n\n\n`;
            content += `ã€ ç§‘å­¸è©å½™èˆ‡å®šç¾© ã€‘\n----------------------------------------\n`;
            if (currentResultData.summary.vocab_list) { currentResultData.summary.vocab_list.forEach((v, i) => { content += `${i+1}. ${v.term}\n   èªªæ˜ï¼š${v.def}\n\n`; }); }
            content += `\nã€ å¸¸è¦‹è¿·æ€è¨ºæ–· ã€‘\n----------------------------------------\n`;
            if (currentResultData.summary.myths) { currentResultData.summary.myths.forEach((m, i) => { content += `â— è¿·æ€ ${i+1}ï¼š${m.myth}\n   æ­£ç¢ºï¼š${m.correct}\n\n`; }); }
            const blob = new Blob([content], { type: "text/plain" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${currentResultData.raw_content.unitName}_é‡é»æ•´ç†.txt`;
            link.click();
        }

        // â˜…â˜…â˜… ä¸‹è¼‰ PDF å‡½æ•¸ â˜…â˜…â˜…
        function downloadPDF() {
            if (isDownloading) return;
            isDownloading = true;
            setTimeout(() => isDownloading = false, 2000); 

            if (!currentResultData) { alert("è«‹å…ˆç”Ÿæˆå…§å®¹å¾Œå†ä¸‹è¼‰ï¼"); return; }
            
            // alert('é–‹å§‹è£½ä½œ PDFï¼Œè«‹ç¨å€™...'); // æ‰‹æ©Ÿç«¯å›é¥‹

            const element = document.getElementById("content-view").cloneNode(true);
            element.querySelectorAll(".no-pdf, button").forEach(e => e.remove());
            
            const vocabContainer = element.querySelector("#keywords-list");
            if(vocabContainer) {
                vocabContainer.classList.remove("md:absolute", "md:inset-0", "md:overflow-y-auto");
                vocabContainer.style.height = "auto";
                vocabContainer.style.overflow = "visible";
            }
            const vocabPanel = element.querySelector("#vocab-panel");
            if(vocabPanel) {
                vocabPanel.style.height = "auto";
                vocabPanel.classList.add("pdf-page-break"); 
            }

            const mapContainer = element.querySelector("#mermaid-chart");
            if(mapContainer) {
                const parent = mapContainer.parentElement;
                parent.parentElement.classList.add("pdf-page-break");
                parent.style.height = "1000px"; 
                mapContainer.classList.add("pdf-rotate-map");
            }

            const mythPanel = element.querySelector("#myth-list").parentElement;
            if(mythPanel) {
                mythPanel.classList.add("pdf-page-break");
            }

            const opt = {
                margin:       10,
                filename:     currentResultData.raw_content.unitName + "_é‡é»æ•´ç†.pdf",
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak:    { mode: ['css', 'legacy'] }
            };

            html2pdf().set(opt).from(element).save();
        }

        function toggleChat() { document.getElementById("xiaoke-window").classList.toggle("closed"); }
        async function sendChatMessage() {
            const input = document.getElementById("chat-input"); 
            const msg = input.value.trim(); 
            if(!msg) return;
            const currentUser = JSON.parse(sessionStorage.getItem("currentUser") || '{"name":"è¨ªå®¢"}');
            const chatBody = document.getElementById("chat-messages");
            chatBody.innerHTML += `<div class="self-end bg-blue-600 text-white p-3 rounded-lg rounded-tr-none shadow-sm max-w-[85%] ml-auto text-sm">${msg}</div>`;
            input.value = ""; chatBody.scrollTop = chatBody.scrollHeight;
            try {
                const contextText = currentResultData ? currentResultData.raw_content.text : "";
                const contextVocab = currentResultData ? currentResultData.raw_content.vocab_str : "";
                const res = await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'chat_with_ai', message: msg, currentUnit: filters.unitName || "", contextText: contextText, contextVocab: contextVocab, userName: currentUser.name, stage: filters.stage, publisher: filters.publisher, grade: filters.grade, semester: filters.semester }) });
                const json = await res.json();
                const cleanReply = json.data.replace(/\*\*/g, "");
                chatBody.innerHTML += `<div class="self-start bg-white border border-slate-100 p-3 rounded-lg rounded-tr-none shadow-sm max-w-[85%] text-sm"><span class="font-bold text-blue-600 block mb-1 text-xs">å°ç§‘ AI</span>${cleanReply}</div>`;
                chatBody.scrollTop = chatBody.scrollHeight;
            } catch(e) { console.error(e); }
        }

        // â˜…â˜…â˜… å…¨è¢å¹•ç‡ˆç®± (å¼·åˆ¶ä¿®å¾©ç‰ˆï¼šæ‰‹æ©Ÿé»æ“Šå¿…ä¸­) â˜…â˜…â˜…
        function openModal() {
            const chartDiv = document.getElementById("mermaid-chart");
            
            // é›™é‡æª¢æŸ¥ï¼šç¢ºä¿æœ‰å…§å®¹ä¸”å…§å®¹ä¸ç‚ºç©º
            if (!chartDiv || !chartDiv.innerHTML.trim() || chartDiv.innerHTML.includes("éŒ¯èª¤")) {
                return; // å¦‚æœåœ–è¡¨æ²’ç”Ÿæˆæˆ–æœ‰éŒ¯èª¤ï¼Œå°±ä¸é–‹ç‡ˆç®±
            }
            
            const modal = document.getElementById("image-modal");
            const content = document.getElementById("modal-content");
            
            // è¤‡è£½å…§å®¹
            content.innerHTML = chartDiv.innerHTML;
            
            // å¼·åˆ¶æ”¾å¤§ SVGï¼Œè§£é™¤ RWD é™åˆ¶
            const svg = content.querySelector('svg');
            if (svg) {
                svg.removeAttribute('style'); // æ¸…é™¤èˆŠæ¨£å¼
                svg.style.width = 'auto';     
                svg.style.height = 'auto';    
                svg.style.minWidth = '100%';  
                svg.style.maxWidth = 'none';  
                svg.style.pointerEvents = 'auto'; // æ¢å¾©äº’å‹•
            }
            
            modal.classList.remove("hidden");
            modal.classList.add("flex");
        }
        function closeModal() {
            const modal = document.getElementById("image-modal");
            modal.classList.add("hidden");
            modal.classList.remove("flex");
        }  
    </script>
</body>
</html>
