<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Researcher Dashboard | Science Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        researcher: { light: '#f3e8ff', DEFAULT: '#a855f7', dark: '#7e22ce' },
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none; }
        
        /* 背景 Canvas 定位 */
        #science-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* 置於最底層 */
            background: linear-gradient(to bottom right, #f8fafc, #f3e8ff);
        }
    </style>
</head>
<body class="h-screen flex flex-col font-sans text-slate-800 overflow-hidden relative">

    <!-- 1. 背景特效 Canvas -->
    <canvas id="science-bg"></canvas>

    <!-- 2. 頂部導航列 -->
    <nav class="bg-white/90 backdrop-blur-md shadow-sm border-b border-purple-100 p-4 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="bg-purple-100 p-2 rounded-lg text-purple-600"><i class="fa-solid fa-microscope text-xl"></i></div>
                <span class="text-lg font-bold tracking-tight text-slate-800">Researcher Workbench</span>
            </div>
            <div class="flex items-center space-x-4">
                <select id="language-selector" onchange="changeLanguage()" class="border-purple-200 rounded-lg py-1.5 px-3 text-sm bg-white/80 outline-none focus:ring-2 focus:ring-purple-500 transition cursor-pointer hover:bg-white">
                    <option value="zh-TW">繁體中文</option>
                    <option value="en">English</option>
                    <option value="ja">日本語</option>
                    <option value="zh-CN">简体中文</option>
                </select>
                <div class="flex items-center gap-3 pl-4 border-l border-purple-200">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center text-sm font-bold shadow-md" id="user-avatar">R</div>
                        <span class="text-sm font-medium text-slate-600 hidden md:block" id="user-name-display">Researcher</span>
                    </div>
                    <button onclick="logout()" class="text-slate-400 hover:text-rose-500 transition p-2" title="登出"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 3. 主內容區 -->
    <main class="flex-1 overflow-y-auto p-6 md:p-10">
        <div class="max-w-7xl mx-auto">
            
            <!-- 儀表板視圖 (方塊選單) -->
            <div id="dashboard-view" class="fade-in">
                <div class="text-center mb-12">
                    <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-3" data-i18n="welcome_researcher">歡迎來到研究者分析系統</h1>
                    <p class="text-slate-600 text-lg" data-i18n="select_tool">請選擇分析工具</p>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <!-- 卡片 1-8 -->
                    <div onclick="openTool('segmentation')" class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg shadow-purple-100/50 hover:shadow-xl hover:shadow-purple-300 border border-purple-100 cursor-pointer transition transform hover:-translate-y-1 group text-center">
                        <i class="fa-solid fa-scissors text-4xl text-purple-500 mb-4 group-hover:scale-110 transition"></i>
                        <h4 class="font-bold text-slate-700 group-hover:text-purple-600 transition" data-i18n="feat_r_1">科學文本斷詞</h4>
                    </div>
                    <div onclick="openTool('query')" class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg shadow-purple-100/50 hover:shadow-xl hover:shadow-purple-300 border border-purple-100 cursor-pointer transition transform hover:-translate-y-1 group text-center">
                        <i class="fa-solid fa-magnifying-glass text-4xl text-purple-500 mb-4 group-hover:scale-110 transition"></i>
                        <h4 class="font-bold text-slate-700 group-hover:text-purple-600 transition" data-i18n="feat_r_2">科學文本查詢</h4>
                    </div>
                    <div onclick="openTool('comparison')" class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg shadow-purple-100/50 hover:shadow-xl hover:shadow-purple-300 border border-purple-100 cursor-pointer transition transform hover:-translate-y-1 group text-center">
                        <i class="fa-solid fa-scale-balanced text-4xl text-purple-500 mb-4 group-hover:scale-110 transition"></i>
                        <h4 class="font-bold text-slate-700 group-hover:text-purple-600 transition" data-i18n="feat_r_3">文本詞彙比較</h4>
                    </div>
                    <div onclick="openTool('readability')" class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg shadow-purple-100/50 hover:shadow-xl hover:shadow-purple-300 border border-purple-100 cursor-pointer transition transform hover:-translate-y-1 group text-center">
                        <i class="fa-solid fa-book-open-reader text-4xl text-purple-500 mb-4 group-hover:scale-110 transition"></i>
                        <h4 class="font-bold text-slate-700 group-hover:text-purple-600 transition" data-i18n="feat_r_4">文本可讀性分析</h4>
                    </div>
                    <div onclick="openTool('conceptnet')" class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg shadow-purple-100/50 hover:shadow-xl hover:shadow-purple-300 border border-purple-100 cursor-pointer transition transform hover:-translate-y-1 group text-center">
                        <i class="fa-solid fa-circle-nodes text-4xl text-purple-500 mb-4 group-hover:scale-110 transition"></i>
                        <h4 class="font-bold text-slate-700 group-hover:text-purple-600 transition" data-i18n="feat_r_5">概念網絡分析</h4>
                    </div>
                    <div onclick="openTool('sfl')" class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg shadow-purple-100/50 hover:shadow-xl hover:shadow-purple-300 border border-purple-100 cursor-pointer transition transform hover:-translate-y-1 group text-center">
                        <i class="fa-solid fa-spell-check text-4xl text-purple-500 mb-4 group-hover:scale-110 transition"></i>
                        <h4 class="font-bold text-slate-700 group-hover:text-purple-600 transition" data-i18n="feat_r_6">系統功能語言分析</h4>
                    </div>
                    <div onclick="openTool('wordcloud')" class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg shadow-purple-100/50 hover:shadow-xl hover:shadow-purple-300 border border-purple-100 cursor-pointer transition transform hover:-translate-y-1 group text-center">
                        <i class="fa-solid fa-cloud text-4xl text-purple-500 mb-4 group-hover:scale-110 transition"></i>
                        <h4 class="font-bold text-slate-700 group-hover:text-purple-600 transition" data-i18n="feat_r_7">文本文字雲系統</h4>
                    </div>
                    <div onclick="openTool('similarity')" class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg shadow-purple-100/50 hover:shadow-xl hover:shadow-purple-300 border border-purple-100 cursor-pointer transition transform hover:-translate-y-1 group text-center">
                        <i class="fa-solid fa-clone text-4xl text-purple-500 mb-4 group-hover:scale-110 transition"></i>
                        <h4 class="font-bold text-slate-700 group-hover:text-purple-600 transition" data-i18n="feat_r_8">文本相似性分析</h4>
                    </div>
                </div>
            </div>

            <!-- 功能視窗容器 (預設隱藏) -->
            <div id="tool-container" class="hidden fade-in">
                <button onclick="backToDashboard()" class="mb-6 flex items-center gap-2 text-slate-500 hover:text-purple-600 transition font-medium bg-white/50 px-4 py-2 rounded-full">
                    <i class="fa-solid fa-arrow-left"></i> <span data-i18n="back_dashboard">返回儀表板</span>
                </button>

                <!-- 1. 斷詞 -->
                <div id="tool-segmentation" class="tool-view hidden bg-white/95 p-8 rounded-3xl shadow-md border border-purple-100">
                    <h2 class="text-2xl font-bold text-purple-800 mb-6 border-b pb-4">科學文本斷詞 (Segmentation)</h2>
                    <textarea class="w-full h-64 p-4 border border-slate-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none mb-6" placeholder="請在此貼上需要斷詞的文章..."></textarea>
                    <div class="flex justify-end">
                        <button class="bg-purple-600 text-white px-8 py-3 rounded-xl hover:bg-purple-700 transition shadow-md font-bold">開始斷詞</button>
                    </div>
                </div>

                <!-- 5. 概念網絡分析 (Canvas Demo) -->
                <div id="tool-conceptnet" class="tool-view hidden bg-white/95 p-8 rounded-3xl shadow-md border border-purple-100">
                    <h2 class="text-2xl font-bold text-purple-800 mb-6">概念網絡分析 (Concept Net)</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 bg-slate-50 p-6 rounded-xl border border-slate-200">
                            <label class="block font-bold mb-2">上傳文本</label>
                            <input type="file" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"/>
                            <button class="mt-4 w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">分析關聯性</button>
                        </div>
                        <div class="lg:col-span-2 h-96 bg-slate-900 rounded-xl overflow-hidden relative">
                            <!-- 這裡放置用於繪圖的 Canvas -->
                            <canvas id="concept-canvas" class="w-full h-full"></canvas>
                            <div class="absolute top-4 right-4 bg-black/50 text-white text-xs px-2 py-1 rounded">Canvas Visualization Demo</div>
                        </div>
                    </div>
                </div>

                <!-- 7. 文字雲系統 (Canvas Demo) -->
                <div id="tool-wordcloud" class="tool-view hidden bg-white/95 p-8 rounded-3xl shadow-md border border-purple-100">
                    <h2 class="text-2xl font-bold text-purple-800 mb-6">文本文字雲系統 (Word Cloud)</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1">
                            <textarea class="w-full h-48 p-4 border rounded-xl mb-4 text-sm" placeholder="輸入文本..."></textarea>
                            <button class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700" onclick="drawWordCloud()">生成文字雲</button>
                        </div>
                        <div class="lg:col-span-2 h-80 bg-white border-2 border-dashed border-slate-300 rounded-xl flex items-center justify-center overflow-hidden">
                            <canvas id="cloud-canvas" width="600" height="320"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 其他功能 placeholder -->
                <div id="tool-query" class="tool-view hidden bg-white/95 p-8 rounded-3xl shadow-md"><h2 class="text-2xl font-bold text-purple-800 mb-6">科學文本查詢</h2><p class="text-slate-500">功能介面開發中...</p></div>
                <div id="tool-comparison" class="tool-view hidden bg-white/95 p-8 rounded-3xl shadow-md"><h2 class="text-2xl font-bold text-purple-800 mb-6">文本詞彙比較</h2><p class="text-slate-500">功能介面開發中...</p></div>
                <div id="tool-readability" class="tool-view hidden bg-white/95 p-8 rounded-3xl shadow-md"><h2 class="text-2xl font-bold text-purple-800 mb-6">文本可讀性分析</h2><p class="text-slate-500">功能介面開發中...</p></div>
                <div id="tool-sfl" class="tool-view hidden bg-white/95 p-8 rounded-3xl shadow-md"><h2 class="text-2xl font-bold text-purple-800 mb-6">系統功能語言分析</h2><p class="text-slate-500">功能介面開發中...</p></div>
                <div id="tool-similarity" class="tool-view hidden bg-white/95 p-8 rounded-3xl shadow-md"><h2 class="text-2xl font-bold text-purple-800 mb-6">文本相似性分析</h2><p class="text-slate-500">功能介面開發中...</p></div>

            </div>
        </div>
    </main>

    <script>
        // **********************************************
        // Canvas 1: 背景粒子網絡特效 (Background Effect)
        // **********************************************
        const bgCanvas = document.getElementById('science-bg');
        const bgCtx = bgCanvas.getContext('2d');
        let width, height, particles;

        function initBg() {
            width = bgCanvas.width = window.innerWidth;
            height = bgCanvas.height = window.innerHeight;
            particles = [];
            // 產生粒子 (減少數量以提升效能)
            for(let i=0; i<60; i++) {
                particles.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    size: Math.random() * 2 + 1
                });
            }
        }

        function drawBg() {
            bgCtx.clearRect(0, 0, width, height);
            bgCtx.fillStyle = 'rgba(168, 85, 247, 0.3)'; // 紫色粒子
            bgCtx.strokeStyle = 'rgba(168, 85, 247, 0.1)'; // 紫色連線

            // 更新與繪製粒子
            particles.forEach((p, index) => {
                p.x += p.vx;
                p.y += p.vy;

                // 邊界反彈
                if(p.x < 0 || p.x > width) p.vx *= -1;
                if(p.y < 0 || p.y > height) p.vy *= -1;

                bgCtx.beginPath();
                bgCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                bgCtx.fill();

                // 繪製連線 (距離夠近時)
                for(let j=index+1; j<particles.length; j++) {
                    const p2 = particles[j];
                    const dist = Math.hypot(p.x - p2.x, p.y - p2.y);
                    if(dist < 150) {
                        bgCtx.beginPath();
                        bgCtx.moveTo(p.x, p.y);
                        bgCtx.lineTo(p2.x, p2.y);
                        bgCtx.stroke();
                    }
                }
            });
            requestAnimationFrame(drawBg);
        }

        window.addEventListener('resize', initBg);
        initBg();
        drawBg();

        // **********************************************
        // Canvas 2: 概念網絡分析演示 (Concept Net Demo)
        // **********************************************
        const conceptCanvas = document.getElementById('concept-canvas');
        // 在 switchTool 時初始化大小

        function initConceptNet() {
            const ctx = conceptCanvas.getContext('2d');
            const w = conceptCanvas.width = conceptCanvas.parentElement.offsetWidth;
            const h = conceptCanvas.height = conceptCanvas.parentElement.offsetHeight;
            
            // 模擬節點
            const nodes = [
                {x: w/2, y: h/2, label: "Science", color: "#a855f7"},
                {x: w/2-100, y: h/2-50, label: "Physics", color: "#3b82f6"},
                {x: w/2+100, y: h/2-50, label: "Biology", color: "#22c55e"},
                {x: w/2-50, y: h/2+80, label: "Energy", color: "#eab308"},
                {x: w/2+80, y: h/2+60, label: "Cells", color: "#ef4444"}
            ];

            function animateNet() {
                ctx.fillStyle = "#0f172a"; // 深色背景
                ctx.fillRect(0,0,w,h);
                
                // 畫線
                ctx.strokeStyle = "#64748b";
                ctx.lineWidth = 1;
                ctx.beginPath();
                nodes.forEach((n, i) => {
                    if(i>0) { ctx.moveTo(nodes[0].x, nodes[0].y); ctx.lineTo(n.x, n.y); }
                });
                ctx.stroke();

                // 畫節點
                nodes.forEach(n => {
                    ctx.beginPath();
                    ctx.arc(n.x, n.y, 20, 0, Math.PI*2);
                    ctx.fillStyle = n.color;
                    ctx.fill();
                    ctx.fillStyle = "white";
                    ctx.font = "12px Arial";
                    ctx.textAlign = "center";
                    ctx.fillText(n.label, n.x, n.y+4);
                });
            }
            animateNet(); // 靜態繪製一次，若要動態可加 loop
        }

        // **********************************************
        // Canvas 3: 文字雲演示 (Word Cloud Demo)
        // **********************************************
        function drawWordCloud() {
            const canvas = document.getElementById('cloud-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0,0,canvas.width, canvas.height);
            
            const words = ["Science", "Data", "Analysis", "Research", "Education", "AI", "Logic", "Hub"];
            const colors = ["#a855f7", "#3b82f6", "#22c55e", "#eab308", "#ef4444", "#6366f1"];

            words.forEach(word => {
                const size = Math.floor(Math.random() * 30) + 20;
                const x = Math.random() * (canvas.width - 100) + 50;
                const y = Math.random() * (canvas.height - 50) + 50;
                
                ctx.font = `bold ${size}px Arial`;
                ctx.fillStyle = colors[Math.floor(Math.random() * colors.length)];
                ctx.fillText(word, x, y);
            });
        }

        // ==============================================
        // 核心邏輯區 (GAS, Login, Language)
        // ==============================================
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzcDKkz8Tilzb3qbx0_fDR7QoG4-c2JCtsa4p9V8_1gBjZaEMlvQHd72OD0kZq_jW8H/exec";

        const translations = {
            "zh-TW": {
                "welcome_researcher": "歡迎來到研究分析工作台", "select_tool": "請選擇高階分析工具", "back_dashboard": "返回儀表板",
                "feat_r_1": "科學文本斷詞", "feat_r_2": "科學文本查詢", "feat_r_3": "文本詞彙比較", "feat_r_4": "文本可讀性分析",
                "feat_r_5": "概念網絡分析", "feat_r_6": "系統功能語言分析", "feat_r_7": "文本文字雲系統", "feat_r_8": "文本相似性分析",
                "logout": "登出"
            },
            "en": {
                "welcome_researcher": "Researcher Workbench", "select_tool": "Select analytical tool", "back_dashboard": "Back to Dashboard",
                "feat_r_1": "Segmentation", "feat_r_2": "Text Query", "feat_r_3": "Vocabulary Comp.", "feat_r_4": "Readability",
                "feat_r_5": "Concept Net", "feat_r_6": "System Functional Ling.", "feat_r_7": "Word Cloud", "feat_r_8": "Similarity Analysis",
                "logout": "Logout"
            },
            "ja": {
                "welcome_researcher": "研究分析台へようこそ", "select_tool": "分析ツールを選択してください", "back_dashboard": "ダッシュボードに戻る",
                "feat_r_1": "テキスト分かち書き", "feat_r_2": "テキスト検索", "feat_r_3": "語彙比較", "feat_r_4": "可読性分析",
                "feat_r_5": "概念ネットワーク", "feat_r_6": "体系機能言語学", "feat_r_7": "ワードクラウド", "feat_r_8": "類似性分析",
                "logout": "ログアウト"
            },
            "zh-CN": {
                "welcome_researcher": "欢迎来到研究分析工作台", "select_tool": "请选择高阶分析工具", "back_dashboard": "返回仪表板",
                "feat_r_1": "科学文本断词", "feat_r_2": "科学文本查询", "feat_r_3": "文本词汇比较", "feat_r_4": "文本可读性分析",
                "feat_r_5": "概念网络分析", "feat_r_6": "系统功能语言分析", "feat_r_7": "文本文字雲系統", "feat_r_8": "文本相似性分析",
                "logout": "登出"
            }
        };

        const userJson = sessionStorage.getItem("currentUser");
        if (!userJson) { alert("請先登入！"); window.location.href = "index.html"; }
        const currentUser = JSON.parse(userJson);
        
        document.getElementById("user-name-display").innerText = currentUser.name;
        document.getElementById("user-avatar").innerText = currentUser.name.charAt(0).toUpperCase();

        function initLanguage() {
            const savedLang = localStorage.getItem("slh_lang");
            if (savedLang) {
                document.getElementById("language-selector").value = savedLang;
                changeLanguage();
            }
        }

        function changeLanguage() {
            const lang = document.getElementById("language-selector").value;
            localStorage.setItem("slh_lang", lang);
            const elements = document.querySelectorAll("[data-i18n]");
            elements.forEach(el => {
                const key = el.getAttribute("data-i18n");
                if (translations[lang] && translations[lang][key]) {
                    el.innerText = translations[lang][key];
                }
            });
        }

        window.addEventListener('DOMContentLoaded', initLanguage);

        function openTool(toolId) {
            document.getElementById("dashboard-view").classList.add("hidden");
            document.getElementById("tool-container").classList.remove("hidden");
            document.querySelectorAll(".tool-view").forEach(el => el.classList.add("hidden"));
            document.getElementById("tool-" + toolId).classList.remove("hidden");
            
            // 特殊處理：若開啟的是 Canvas 相關工具，需觸發繪圖
            if(toolId === 'conceptnet') setTimeout(initConceptNet, 100);
            if(toolId === 'wordcloud') setTimeout(drawWordCloud, 100);

            logAction(toolId);
        }

        function backToDashboard() {
            document.getElementById("tool-container").classList.add("hidden");
            document.getElementById("dashboard-view").classList.remove("hidden");
        }

        function logAction(actionName) {
            const payload = { type: "log", name: currentUser.name, role: currentUser.role, action: "use_tool", page: actionName };
            fetch(GAS_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        }

        function logout() {
            if(confirm("確定要登出嗎？")) { sessionStorage.removeItem("currentUser"); window.location.href = "index.html"; }
        }
    </script>
</body>
</html>
